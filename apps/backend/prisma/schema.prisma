// ============================================================================
// OPTIQ - Enhanced Core Domain Model
// ============================================================================
// This is the enhanced schema with all core entities:
// - Users & Workspaces (Organizations)
// - Memberships & Roles
// - Ad Platform Connections (Google, Meta, TikTok)
// - Integration Tokens (Credentials)
// - Events (Tracking Events & Touch Points)
// - Costs (Daily Metrics)
// - Conversions (Tracking Events with type CONVERSION)
// - Journeys (Customer Journey tracking)
// - Alert Rules & Alert Events
// - Subscription Plans
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum PlatformCode {
  META
  GOOGLE_ADS
  TIKTOK
  LINKEDIN
  X
}

enum EntityStatus {
  ACTIVE
  PAUSED
  ARCHIVED
  DELETED
}

enum IngestionJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum IngestionJobType {
  DAILY_SYNC
  BACKFILL
  MANUAL
}

enum TrackingEventType {
  PAGE_VIEW
  CONVERSION
  CUSTOM
}

enum AttributionModel {
  FIRST_TOUCH
  LAST_TOUCH
  LINEAR
  TIME_DECAY
  POSITION_BASED
  DATA_DRIVEN
}

enum JourneyStatus {
  IN_PROGRESS
  CONVERTED
  ABANDONED
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AlertRuleType {
  SPEND_THRESHOLD
  CONVERSION_DROP
  CPA_SPIKE
  ROAS_DROP
  CLICK_ANOMALY
  IMPRESSION_ANOMALY
  CUSTOM
}

enum AlertRuleStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

enum AlertEventStatus {
  TRIGGERED
  ACKNOWLEDGED
  RESOLVED
  DISMISSED
}

enum SubscriptionPlan {
  FREE
  STARTER
  GROWTH
  SCALE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
  PAUSED
}

enum IntegrationConnectionStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  EXPIRED
}

enum CostGrain {
  CAMPAIGN
  ADSET
  AD
  ADGROUP
}

// ============================================================================
// USER & AUTHENTICATION
// ============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String?
  name          String?
  image         String?
  emailVerified DateTime?
  activeOrgId   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts    Account[]
  sessions    Session[]
  memberships Membership[]

  activeOrg     Organization?       @relation("ActiveOrg", fields: [activeOrgId], references: [id], onDelete: SetNull)
  notifications InAppNotification[]
  alertEvents   AlertEvent[]

  @@index([activeOrgId])
  @@index([email])
}

// Add back relations after WasteScore is defined
// This is a workaround for Prisma's forward reference limitation

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// WORKSPACE (ORGANIZATION) & MEMBERSHIP
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members     Membership[]
  activeUsers User[]       @relation("ActiveOrg")

  // Ad Platform Data
  adAccounts           AdAccount[]
  campaigns            Campaign[]
  ads                  Ad[]
  dailyAdMetrics       DailyAdMetric[]
  dailyCampaignMetrics DailyCampaignMetric[]
  dailyAccountMetrics  DailyAdAccountMetric[]

  // Integration Credentials
  googleAdsCredentials GoogleAdsCredential[]
  metaAdsCredentials   MetaAdsCredential[]
  tikTokAdsCredentials TikTokAdsCredential[]

  // Tracking & Attribution
  trackingSites TrackingSite[]
  journeys      Journey[]

  // Alerts
  alertRules  AlertRule[]
  alertEvents AlertEvent[]

  // System
  notifications  InAppNotification[]
  ingestionJobs  IngestionJob[]
  settings       OrganizationSettings?
  subscription   Subscription?
  identities     Identity[]
  identityMerges IdentityMerge[]

  // Cost & Integration Data
  costFacts              CostFact[]
  integrationConnections IntegrationConnection[]
  dailyRollups           DailyRollup[]

  @@index([slug])
}

model Membership {
  id             String         @id @default(cuid())
  userId         String
  organizationId String
  role           MembershipRole
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

// ============================================================================
// SUBSCRIPTION & BILLING
// ============================================================================

model Subscription {
  id             String             @id @default(cuid())
  organizationId String             @unique
  plan           SubscriptionPlan
  status         SubscriptionStatus

  // Stripe integration
  stripeCustomerId     String? @unique
  stripeSubscriptionId String? @unique
  stripePriceId        String?

  // Billing
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?
  trialStart         DateTime?
  trialEnd           DateTime?

  // Plan limits (can override defaults)
  maxWorkspaces       Int?
  maxConnectors       Int?
  monthlyEventLimit   Int?
  dataRetentionDays   Int?
  attributionModels   String[]  // e.g. ["FIRST_TOUCH", "LAST_TOUCH", "LINEAR"]
  alertsEnabled       Boolean   @default(false)
  ssoEnabled          Boolean   @default(false)
  prioritySupport     Boolean   @default(false)

  // Overage pricing (cents per unit)
  overageEventsPer10k   Int?  // cents per 10k events over limit
  overageConnectorPrice Int?  // cents per extra connector per month

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usageRecords  UsageRecord[]

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

model UsageRecord {
  id             String   @id @default(cuid())
  subscriptionId String
  organizationId String

  periodStart DateTime
  periodEnd   DateTime

  // Usage metrics
  trackedEvents      Int      @default(0)
  connectedAccounts  Int      @default(0)
  workspacesUsed     Int      @default(0)

  // Overage calculations (computed at period end)
  eventsOverage      Int      @default(0)
  connectorsOverage  Int      @default(0)
  overageAmountCents Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, periodStart])
  @@index([organizationId, periodStart])
  @@index([subscriptionId, periodEnd])
}

model DailyUsageCounter {
  id             String   @id @default(cuid())
  organizationId String
  date           DateTime @db.Date

  // Event counters
  pageViews      Int      @default(0)
  conversions    Int      @default(0)
  customEvents   Int      @default(0)
  totalEvents    Int      @default(0)

  // API request counters
  apiRequests    Int      @default(0)
  webhookCalls   Int      @default(0)

  // Resource counters (snapshot at end of day)
  activeConnectors Int    @default(0)
  activeCampaigns  Int    @default(0)

  // Throttle tracking
  throttledRequests Int   @default(0)
  softLimitHit      Boolean @default(false)
  hardLimitHit      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, date])
  @@index([organizationId, date])
  @@index([date])
}

model MeteringAuditLog {
  id             String   @id @default(cuid())
  organizationId String
  eventType      String   // "event_ingested", "limit_exceeded", "throttle_applied", "overage_calculated"
  eventCount     Int      @default(1)
  metadata       Json?
  timestamp      DateTime @default(now())

  @@index([organizationId, timestamp])
  @@index([eventType, timestamp])
}

// ============================================================================
// AD PLATFORMS & CONNECTIONS
// ============================================================================

model Platform {
  id        String       @id @default(cuid())
  code      PlatformCode @unique
  name      String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  adAccounts AdAccount[]
  campaigns  Campaign[]
  ads        Ad[]

  dailyAdMetrics       DailyAdMetric[]
  dailyCampaignMetrics DailyCampaignMetric[]
  dailyAccountMetrics  DailyAdAccountMetric[]
  costFacts            CostFact[]
  dailyRollups         DailyRollup[]
}

model AdAccount {
  id             String       @id @default(cuid())
  organizationId String
  platformId     String
  externalId     String
  name           String
  currency       String
  timezone       String
  status         EntityStatus @default(ACTIVE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform     Platform     @relation(fields: [platformId], references: [id], onDelete: Restrict)

  campaigns Campaign[]
  ads       Ad[]

  dailyAccountMetrics  DailyAdAccountMetric[]
  dailyCampaignMetrics DailyCampaignMetric[]
  dailyAdMetrics       DailyAdMetric[]
  costFacts            CostFact[]

  @@unique([organizationId, platformId, externalId])
  @@index([organizationId, platformId])
  @@index([platformId])
}

model Campaign {
  id             String       @id @default(cuid())
  organizationId String
  platformId     String
  adAccountId    String
  externalId     String
  name           String
  status         EntityStatus @default(ACTIVE)
  objective      String?
  startDate      DateTime?    @db.Date
  endDate        DateTime?    @db.Date
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform     Platform     @relation(fields: [platformId], references: [id], onDelete: Restrict)
  adAccount    AdAccount    @relation(fields: [adAccountId], references: [id], onDelete: Cascade)

  ads Ad[]

  dailyCampaignMetrics DailyCampaignMetric[]
  dailyAdMetrics       DailyAdMetric[]
  dailyRollups         DailyRollup[]

  @@unique([organizationId, platformId, externalId])
  @@index([organizationId, adAccountId])
  @@index([organizationId, platformId])
  @@index([adAccountId])
}

model Ad {
  id             String       @id @default(cuid())
  organizationId String
  platformId     String
  adAccountId    String
  campaignId     String
  externalId     String
  name           String
  status         EntityStatus @default(ACTIVE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform     Platform     @relation(fields: [platformId], references: [id], onDelete: Restrict)
  adAccount    AdAccount    @relation(fields: [adAccountId], references: [id], onDelete: Cascade)
  campaign     Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  dailyAdMetrics DailyAdMetric[]

  @@unique([organizationId, platformId, externalId])
  @@index([organizationId, campaignId])
  @@index([organizationId, adAccountId])
  @@index([campaignId])
}

// ============================================================================
// COSTS (AD SPEND METRICS)
// ============================================================================

model DailyAdAccountMetric {
  id             String   @id @default(cuid())
  organizationId String
  platformId     String
  adAccountId    String
  date           DateTime @db.Date

  impressions   BigInt @default(0)
  clicks        BigInt @default(0)
  spendMicros   BigInt @default(0)
  conversions   BigInt @default(0)
  revenueMicros BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform     Platform     @relation(fields: [platformId], references: [id], onDelete: Restrict)
  adAccount    AdAccount    @relation(fields: [adAccountId], references: [id], onDelete: Cascade)

  @@unique([organizationId, adAccountId, date])
  @@index([organizationId, date])
  @@index([organizationId, platformId, date])
  @@index([adAccountId, date])
}

model DailyCampaignMetric {
  id             String   @id @default(cuid())
  organizationId String
  platformId     String
  adAccountId    String
  campaignId     String
  date           DateTime @db.Date

  impressions   BigInt @default(0)
  clicks        BigInt @default(0)
  spendMicros   BigInt @default(0)
  conversions   BigInt @default(0)
  revenueMicros BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform     Platform     @relation(fields: [platformId], references: [id], onDelete: Restrict)
  adAccount    AdAccount    @relation(fields: [adAccountId], references: [id], onDelete: Cascade)
  campaign     Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([organizationId, campaignId, date])
  @@index([organizationId, date])
  @@index([organizationId, platformId, date])
  @@index([campaignId, date])
  @@index([adAccountId, date])
}

model DailyAdMetric {
  id             String   @id @default(cuid())
  organizationId String
  platformId     String
  adAccountId    String
  campaignId     String
  adId           String
  date           DateTime @db.Date

  impressions   BigInt @default(0)
  clicks        BigInt @default(0)
  spendMicros   BigInt @default(0)
  conversions   BigInt @default(0)
  revenueMicros BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform     Platform     @relation(fields: [platformId], references: [id], onDelete: Restrict)
  adAccount    AdAccount    @relation(fields: [adAccountId], references: [id], onDelete: Cascade)
  campaign     Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  ad           Ad           @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@unique([organizationId, adId, date])
  @@index([organizationId, date])
  @@index([organizationId, platformId, date])
  @@index([campaignId, date])
  @@index([adAccountId, date])
  @@index([adId, date])
}

model CostFact {
  id             String   @id @default(cuid())
  organizationId String
  platformId     String
  adAccountId    String
  date           DateTime @db.Date

  grain          CostGrain
  entityExternalId   String
  entityName         String?

  campaignExternalId String?
  campaignName       String?
  adsetExternalId    String?
  adsetName          String?
  adExternalId       String?
  adName             String?

  publisherPlatform String?

  impressions   BigInt @default(0)
  clicks        BigInt @default(0)
  spendMicros   BigInt @default(0)
  conversions   BigInt @default(0)
  revenueMicros BigInt @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform     Platform     @relation(fields: [platformId], references: [id], onDelete: Restrict)
  adAccount    AdAccount    @relation(fields: [adAccountId], references: [id], onDelete: Cascade)

  @@unique([organizationId, platformId, adAccountId, date, grain, entityExternalId, publisherPlatform])
  @@index([organizationId, date])
  @@index([organizationId, platformId, date])
  @@index([adAccountId, date])
}

// ============================================================================
// DAILY ROLLUPS (AGGREGATED METRICS)
// ============================================================================

model DailyRollup {
  id             String   @id @default(cuid())
  organizationId String
  date           DateTime @db.Date

  // Grain: organization, platform, campaign, adset, ad
  grain          String   @default("organization")
  platformId     String?
  campaignId     String?
  adsetId        String?
  adId           String?

  // Cost metrics (from ad platforms)
  impressions    BigInt   @default(0)
  clicks         BigInt   @default(0)
  spendMicros    BigInt   @default(0)

  // Conversion metrics (from attribution)
  conversions           Float    @default(0)  // Can be fractional due to attribution
  conversionValue       BigInt   @default(0)  // Revenue in micros
  attributedConversions Float    @default(0)  // Attributed conversions (weighted)

  // Calculated metrics
  cpa            Float?   // Cost per acquisition (spend / conversions)
  roas           Float?   // Return on ad spend (revenue / spend)
  ctr            Float?   // Click-through rate (clicks / impressions)
  cpc            Float?   // Cost per click (spend / clicks)

  // Waste metrics
  wasteSpendMicros BigInt   @default(0)  // Spend with no conversions
  wastePct         Float    @default(0)  // Waste percentage

  // Attribution model used
  attributionModel String   @default("LAST_TOUCH")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform     Platform?    @relation(fields: [platformId], references: [id], onDelete: Restrict)
  campaign     Campaign?    @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([organizationId, date, grain, platformId, campaignId, adsetId, adId, attributionModel])
  @@index([organizationId, date])
  @@index([organizationId, platformId, date])
  @@index([organizationId, campaignId, date])
  @@index([date, grain])
}

// ============================================================================
// INTEGRATION TOKENS (CREDENTIALS)
// ============================================================================

model GoogleAdsCredential {
  id                   String    @id @default(cuid())
  organizationId       String
  customerId           String
  refreshTokenEnc      String
  accessTokenEnc       String?
  accessTokenExpiresAt DateTime?
  scope                String
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, customerId])
  @@index([organizationId])
}

model MetaAdsCredential {
  id                   String    @id @default(cuid())
  organizationId       String
  adAccountId          String
  userId               String?
  accessTokenEnc       String
  accessTokenExpiresAt DateTime?
  scope                String
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, adAccountId])
  @@index([organizationId])
}

model TikTokAdsCredential {
  id                    String    @id @default(cuid())
  organizationId        String
  advertiserId          String
  accessTokenEnc        String
  refreshTokenEnc       String
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, advertiserId])
  @@index([organizationId])
}

model IntegrationConnection {
  id                String                     @id @default(cuid())
  organizationId    String
  platformCode      PlatformCode
  externalAccountId String

  externalAccountName String?
  currency            String?
  timezone            String?
  status              IntegrationConnectionStatus @default(CONNECTED)

  accessTokenEnc        String?
  refreshTokenEnc       String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                String?
  tokenType            String?

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, platformCode, externalAccountId])
  @@index([organizationId])
  @@index([organizationId, platformCode])
}

// ============================================================================
// EVENTS (TRACKING & TOUCHPOINTS)
// ============================================================================

model TrackingSite {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  domain         String
  publicKey      String   @unique
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  events           TrackingEvent[]
  touchPoints      TouchPoint[]
  attributionLinks AttributionLink[]
  identities       Identity[]

  @@unique([organizationId, domain])
  @@index([organizationId])
}

model TrackingEvent {
  id         String            @id @default(cuid())
  siteId     String
  eventId    String
  type       TrackingEventType
  name       String?
  occurredAt DateTime          @default(now())

  url      String
  path     String
  referrer String?
  title    String?

  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?

  anonId    String
  sessionId String

  userAgent String?
  ipHash    String?

  // Conversion value (for CONVERSION type events)
  valueMicros BigInt?

  properties Json?

  site TrackingSite @relation(fields: [siteId], references: [id], onDelete: Cascade)

  attributionLinks AttributionLink[]
  journeyEvents    JourneyEvent[]

  @@unique([siteId, eventId])
  @@index([siteId, occurredAt])
  @@index([siteId, type, occurredAt])
  @@index([siteId, utmSource, occurredAt])
  @@index([siteId, anonId, occurredAt])
  @@index([siteId, sessionId, occurredAt])
}

model TouchPoint {
  id         String   @id @default(cuid())
  siteId     String
  anonId     String
  sessionId  String
  occurredAt DateTime @default(now())

  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?

  gclid   String?
  fbclid  String?
  ttclid  String?
  msclkid String?
  clickId String?

  referrer   String?
  landingUrl String?

  platformCode String?
  campaignId   String?
  adAccountId  String?
  adId         String?

  createdAt DateTime @default(now())

  site             TrackingSite      @relation(fields: [siteId], references: [id], onDelete: Cascade)
  attributionLinks AttributionLink[]

  @@index([siteId, anonId, occurredAt])
  @@index([siteId, sessionId, occurredAt])
  @@index([siteId, gclid])
  @@index([siteId, fbclid])
  @@index([siteId, ttclid])
  @@index([siteId, utmSource, utmCampaign])
}

model AttributionLink {
  id              String           @id @default(cuid())
  siteId          String
  conversionId    String
  touchPointId    String
  model           AttributionModel
  weight          Float            @default(1.0)
  position        Int
  touchPointCount Int
  createdAt       DateTime         @default(now())

  site       TrackingSite  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  conversion TrackingEvent @relation(fields: [conversionId], references: [id], onDelete: Cascade)
  touchPoint TouchPoint    @relation(fields: [touchPointId], references: [id], onDelete: Cascade)

  @@unique([conversionId, touchPointId, model])
  @@index([siteId, model, createdAt])
  @@index([touchPointId])
  @@index([conversionId])
}

// ============================================================================
// JOURNEYS (CUSTOMER JOURNEY TRACKING)
// ============================================================================

model Journey {
  id             String        @id @default(cuid())
  organizationId String
  anonId         String
  sessionId      String
  status         JourneyStatus @default(IN_PROGRESS)

  startedAt      DateTime  @default(now())
  convertedAt    DateTime?
  lastActivityAt DateTime  @default(now())

  // Conversion details
  conversionValue BigInt? // in micros
  conversionName  String?

  // Journey metadata
  firstUtmSource   String?
  firstUtmMedium   String?
  firstUtmCampaign String?
  lastUtmSource    String?
  lastUtmMedium    String?
  lastUtmCampaign  String?

  touchPointCount Int @default(0)
  eventCount      Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  events       JourneyEvent[]

  @@index([organizationId, status, lastActivityAt])
  @@index([organizationId, anonId])
  @@index([organizationId, sessionId])
  @@index([organizationId, convertedAt])
}

model JourneyEvent {
  id              String   @id @default(cuid())
  journeyId       String
  trackingEventId String
  sequenceNumber  Int
  occurredAt      DateTime @default(now())

  journey       Journey       @relation(fields: [journeyId], references: [id], onDelete: Cascade)
  trackingEvent TrackingEvent @relation(fields: [trackingEventId], references: [id], onDelete: Cascade)

  @@unique([journeyId, trackingEventId])
  @@index([journeyId, sequenceNumber])
  @@index([trackingEventId])
}

// ============================================================================
// ALERTS
// ============================================================================

model AlertRule {
  id             String          @id @default(cuid())
  organizationId String
  name           String
  description    String?
  type           AlertRuleType
  severity       AlertSeverity
  status         AlertRuleStatus @default(ACTIVE)

  // Rule configuration (JSON with type-specific fields)
  config Json

  // Evaluation settings
  evaluationInterval Int       @default(3600) // seconds
  lastEvaluatedAt    DateTime?

  // Notification settings
  notifyEmail Boolean @default(true)
  notifyInApp Boolean @default(true)
  notifySlack Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  alertEvents  AlertEvent[]

  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([status, lastEvaluatedAt])
}

model AlertEvent {
  id             String           @id @default(cuid())
  organizationId String
  alertRuleId    String
  status         AlertEventStatus @default(TRIGGERED)
  severity       AlertSeverity

  title   String
  message String

  // Context data (metrics, thresholds, etc.)
  context Json

  triggeredAt    DateTime  @default(now())
  acknowledgedAt DateTime?
  acknowledgedBy String?
  resolvedAt     DateTime?
  resolvedBy     String?
  dismissedAt    DateTime?
  dismissedBy    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  alertRule          AlertRule    @relation(fields: [alertRuleId], references: [id], onDelete: Cascade)
  acknowledgedByUser User?        @relation(fields: [acknowledgedBy], references: [id], onDelete: SetNull)

  @@index([organizationId, status, triggeredAt])
  @@index([organizationId, severity, triggeredAt])
  @@index([alertRuleId, triggeredAt])
  @@index([status, triggeredAt])
}

// ============================================================================
// SYSTEM & BACKGROUND JOBS
// ============================================================================

model IngestionJob {
  id             String             @id @default(cuid())
  organizationId String
  platform       PlatformCode
  jobType        IngestionJobType
  status         IngestionJobStatus @default(QUEUED)
  idempotencyKey String             @unique

  payload Json

  runAt       DateTime  @default(now())
  attempts    Int       @default(0)
  maxAttempts Int       @default(8)
  lockedAt    DateTime?
  lockedBy    String?

  lastError String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([status, runAt])
  @@index([organizationId, platform, jobType])
}

model InAppNotification {
  id             String    @id @default(cuid())
  organizationId String
  userId         String
  title          String
  message        String
  priority       String    @default("normal")
  status         String    @default("pending")
  actionUrl      String?
  metadata       Json?
  createdAt      DateTime  @default(now())
  readAt         DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
  @@index([organizationId, createdAt])
  @@index([userId, organizationId, status])
}

model OrganizationSettings {
  id                  String   @id @default(cuid())
  organizationId      String   @unique
  alertSettings       Json?
  attributionSettings Json?
  trackingSettings    Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ============================================================================
// IDENTITY RESOLUTION
// ============================================================================

model Identity {
  id             String @id @default(cuid())
  organizationId String
  siteId         String

  // Primary identity key (canonical identifier)
  identityKey String @unique

  // Identity signals
  anonymousId String?
  deviceId    String?
  emailHash   String?
  phoneHash   String?
  customerId  String?
  externalId  String?

  // Metadata
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())
  eventCount  Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  site         TrackingSite @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Relationships
  aliases      IdentityAlias[]
  mergeHistory IdentityMerge[] @relation("SourceIdentity")
  mergedInto   IdentityMerge[] @relation("TargetIdentity")

  @@index([organizationId, siteId])
  @@index([organizationId, anonymousId])
  @@index([organizationId, emailHash])
  @@index([organizationId, phoneHash])
  @@index([organizationId, customerId])
  @@index([siteId, anonymousId])
  @@index([siteId, emailHash])
}

model IdentityAlias {
  id         String @id @default(cuid())
  identityId String

  // Alias type and value
  aliasType  String // "anonymousId", "deviceId", "emailHash", "phoneHash", "customerId", "externalId"
  aliasValue String

  // Metadata
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now())

  createdAt DateTime @default(now())

  identity Identity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  @@unique([identityId, aliasType, aliasValue])
  @@index([aliasType, aliasValue])
  @@index([identityId])
}

model IdentityMerge {
  id             String @id @default(cuid())
  organizationId String

  // Merge details
  sourceIdentityId String
  targetIdentityId String

  // Merge reason
  mergeReason   String // "emailHash", "phoneHash", "customerId", "manual"
  matchingField String? // The field that triggered the merge
  matchingValue String? // The value that matched (hashed if sensitive)

  // Audit trail
  mergedAt DateTime @default(now())
  mergedBy String? // User ID if manual merge

  // Metadata
  sourceAliasCount Int @default(0)
  targetAliasCount Int @default(0)

  createdAt DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sourceIdentity Identity     @relation("SourceIdentity", fields: [sourceIdentityId], references: [id], onDelete: Cascade)
  targetIdentity Identity     @relation("TargetIdentity", fields: [targetIdentityId], references: [id], onDelete: Cascade)

  @@index([organizationId, mergedAt])
  @@index([sourceIdentityId])
  @@index([targetIdentityId])
  @@index([mergeReason])
}
