module.exports=[93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},55007,(e,t,r)=>{},60806,e=>{"use strict";e.i(55007);var t=e.i(29173);let r=globalThis.prisma??new t.PrismaClient({log:["error","warn"]});e.s(["prisma",0,r])},66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},49709,e=>{"use strict";var t=e.i(70081);e.i(25330);var r=e.i(96685);function a(e,a){let n=e.headers.get("authorization"),o=process.env.CRON_SECRET;if(!o)return r.appLogger.error("CRON_SECRET not configured",{job:a}),{authorized:!1,response:t.NextResponse.json({error:"Server misconfiguration"},{status:500})};let i=`Bearer ${o}`;return n?n!==i?(r.appLogger.warn("Invalid authorization on cron request",{job:a,ip:e.headers.get("x-forwarded-for")||"unknown"}),{authorized:!1,response:t.NextResponse.json({error:"Unauthorized"},{status:401})}):(r.appLogger.debug("Cron request authorized",{job:a}),{authorized:!0}):(r.appLogger.warn("Missing authorization header on cron request",{job:a,ip:e.headers.get("x-forwarded-for")||"unknown"}),{authorized:!1,response:t.NextResponse.json({error:"Unauthorized"},{status:401})})}e.s(["verifyCronAuth",()=>a])},65643,e=>{"use strict";var t=e.i(56884),r=e.i(42064),a=e.i(1824),n=e.i(99326),o=e.i(18794),i=e.i(83629),s=e.i(41446),l=e.i(61251),d=e.i(5708),p=e.i(59092),u=e.i(99563),c=e.i(39870),g=e.i(8016),h=e.i(7624),f=e.i(70065),m=e.i(36141),v=e.i(93695);e.i(58762);var x=e.i(24378),R=e.i(70081),w=e.i(49709),C=e.i(37474);e.i(25330);var E=e.i(96685);e.i(55007);var y=e.i(60806);async function A(e,t){let r=E.appLogger.child({alert:"cpa-spike"}),a=0,n=await y.prisma.organizationSettings.findUnique({where:{organizationId:e}});if(!n?.trackingSettings)return r.debug("No tracking settings found",{organizationId:e}),0;let o=n.trackingSettings,i=o?.targetCpa;if(!i)return r.debug("No target CPA configured",{organizationId:e}),0;for(let n of(await y.prisma.dailyRollup.findMany({where:{organizationId:e,date:{gte:t.from,lte:t.to},grain:"CAMPAIGN",cpa:{not:null},conversions:{gt:0}},include:{campaign:{select:{name:!0}},platform:{select:{name:!0}}}}))){if(!n.cpa)continue;let t=(n.cpa-i)/i*100,o=null,s=0;t>100?(o="CRITICAL",s=100):t>50?(o="WARNING",s=50):t>25&&(o="INFO",s=25),o&&await b({organizationId:e,type:"CPA_SPIKE",severity:o,title:`CPA Spike: ${n.campaign?.name||"Unknown Campaign"}`,message:`CPA of $${n.cpa.toFixed(2)} is ${t.toFixed(0)}% above target of $${i.toFixed(2)}`,context:{campaignId:n.campaignId,campaignName:n.campaign?.name,platformName:n.platform?.name,actualCpa:n.cpa,targetCpa:i,exceedancePct:t,thresholdPct:s,date:n.date.toISOString(),spend:Number(n.spendMicros)/1e6,conversions:n.conversions},dedupeKey:`cpa-spike-${n.campaignId}-${n.date.toISOString().split("T")[0]}`})&&(a++,r.info("CPA spike alert triggered",{campaignId:n.campaignId,cpa:n.cpa,targetCpa:i,exceedancePct:t}))}return a}async function N(e,t){let r=E.appLogger.child({alert:"spend-threshold"}),a=0;for(let n of(await y.prisma.dailyRollup.findMany({where:{organizationId:e,date:{gte:t.from,lte:t.to},grain:"CAMPAIGN",conversions:0,spendMicros:{gt:0}},include:{campaign:{select:{name:!0}},platform:{select:{name:!0}}}}))){let t=Number(n.spendMicros)/1e6,o=null,i=0;t>1e3?(o="CRITICAL",i=1e3):t>500?(o="WARNING",i=500):t>100&&(o="INFO",i=100),o&&await b({organizationId:e,type:"SPEND_THRESHOLD",severity:o,title:`Wasted Spend: ${n.campaign?.name||"Unknown Campaign"}`,message:`Spent $${t.toFixed(2)} with zero conversions`,context:{campaignId:n.campaignId,campaignName:n.campaign?.name,platformName:n.platform?.name,spend:t,threshold:i,conversions:0,date:n.date.toISOString()},dedupeKey:`spend-threshold-${n.campaignId}-${n.date.toISOString().split("T")[0]}`})&&(a++,r.info("Spend threshold alert triggered",{campaignId:n.campaignId,spend:t,threshold:i}))}return a}async function b(e){let{organizationId:t,type:r,severity:a,title:n,message:o,context:i,dedupeKey:s}=e;if(await y.prisma.alertEvent.findFirst({where:{organizationId:t,title:n,status:{in:["TRIGGERED","ACKNOWLEDGED"]},triggeredAt:{gte:new Date(Date.now()-864e5)}}}))return!1;let l=await y.prisma.alertRule.findFirst({where:{organizationId:t,type:r,status:"ACTIVE"}});return l||(l=await y.prisma.alertRule.create({data:{organizationId:t,name:`${r} Alert`,type:r,severity:a,status:"ACTIVE",config:{}}})),await y.prisma.alertEvent.create({data:{organizationId:t,alertRuleId:l.id,severity:a,title:n,message:o,context:i,status:"TRIGGERED"}}),!0}async function I(e){let t=E.appLogger.child({job:"alert-evaluation"}),r=0,a=0,n=0,o=new Date,i=new Date(Date.now()-6048e5);try{for(let s of(await y.prisma.organization.findMany({where:e?{id:e}:{},select:{id:!0}})))try{let e=await A(s.id,{from:i,to:o});r+=e,a++;let t=await N(s.id,{from:i,to:o});r+=t,a++}catch(e){n++,t.error("Failed to evaluate alerts for organization",{organizationId:s.id,error:e})}t.info("Alert evaluation completed",{alertsTriggered:r,alertsEvaluated:a,errors:n})}catch(e){throw t.error("Alert evaluation failed",e),e}return{alertsTriggered:r,alertsEvaluated:a,errors:n}}let S="alerts-evaluation";async function _(e){let t=(0,w.verifyCronAuth)(e,S);if(!t.authorized)return t.response;E.appLogger.info("Starting alerts evaluation cron job");let r=await (0,C.withJobLock)(S,async()=>{let e=await I();return E.appLogger.info("Alerts evaluation completed",{alertsTriggered:e.alertsTriggered,alertsEvaluated:e.alertsEvaluated,errors:e.errors}),e},{ttlSeconds:300,bufferSeconds:60});return r.skipped?(E.appLogger.info("Alerts evaluation cron job skipped (already running)"),R.NextResponse.json({success:!0,skipped:!0,message:"Job already running"})):r.executed&&r.result?R.NextResponse.json({success:!0,data:r.result}):(E.appLogger.error("Alerts evaluation cron job failed"),R.NextResponse.json({success:!1,error:"Job execution failed"},{status:500}))}e.s(["GET",()=>_,"maxDuration",0,300,"runtime",0,"nodejs"],38557);var k=e.i(38557);let j=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/cron/alerts-evaluation/route",pathname:"/api/cron/alerts-evaluation",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/cron/alerts-evaluation/route.ts",nextConfigOutput:"",userland:k}),{workAsyncStorage:P,workUnitAsyncStorage:T,serverHooks:O}=j;function D(){return(0,a.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:T})}async function q(e,t,a){j.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/cron/alerts-evaluation/route";R=R.replace(/\/index$/,"")||"/";let w=await j.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:C,params:E,nextConfig:y,parsedUrl:A,isDraftMode:N,prerenderManifest:b,routerServerContext:I,isOnDemandRevalidate:S,revalidateOnlyGenerated:_,resolvedPathname:k,clientReferenceManifest:P,serverActionsManifest:T}=w,O=(0,l.normalizeAppPath)(R),D=!!(b.dynamicRoutes[O]||b.routes[k]),q=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,A,!1):t.end("This page could not be found"),null);if(D&&!N){let e=!!b.routes[k],t=b.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await q();throw new v.NoFallbackError}}let M=null;!D||j.isDev||N||(M="/index"===(M=k)?"/":M);let $=!0===j.isDev||!D,L=D&&!$;T&&P&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:P,serverActionsManifest:T,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:T})});let U=e.method||"GET",H=(0,o.getTracer)(),z=H.getActiveScopeSpan(),F={params:E,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>j.onRequestError(e,t,a,I)},sharedContext:{buildId:C}},G=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),B=p.NextRequestAdapter.fromNodeNextRequest(G,(0,p.signalFromNodeResponse)(t));try{let i=async e=>j.handle(B,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${R}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var o,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&S&&_&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=F.renderOpts.collectedTags;if(!D)return await (0,g.sendResponse)(G,K,o,F.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await j.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:S})},I),t}},p=await j.handleResponse({req:e,nextConfig:y,cacheKey:M,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:_,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!D)return null;if((null==p||null==(o=p.value)?void 0:o.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",S?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(p.value.headers);return s&&D||u.delete(m.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(p.cacheControl)),await (0,g.sendResponse)(G,K,new Response(p.value.body,{headers:u,status:p.value.status||200})),null};z?await l(z):await H.withPropagatedContext(e.headers,()=>H.trace(u.BaseServerSpan.handleRequest,{spanName:`${U} ${R}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await j.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:S})}),D)throw t;return await (0,g.sendResponse)(G,K,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>D,"routeModule",()=>j,"serverHooks",()=>O,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>T],65643)},20992,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__0532331c._.js","server/chunks/[root-of-the-server]__68c1b7d0._.js"].map(t=>e.l(t))).then(()=>t(8588)))},91559,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__48db98cd._.js","server/chunks/OneDrive_Desktop_Optiq_CascadeProjects_windsurf-project_c2af6329._.js","server/chunks/c9d07_zod_v4_classic_external_0506f14c.js"].map(t=>e.l(t))).then(()=>t(94238)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__d949a6b8._.js.map