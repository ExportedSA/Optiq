module.exports=[72834,e=>{"use strict";var a=e.i(56884),t=e.i(42064),i=e.i(1824),n=e.i(99326),r=e.i(18794),o=e.i(83629),d=e.i(41446),s=e.i(61251),c=e.i(5708),l=e.i(59092),p=e.i(99563),u=e.i(39870),I=e.i(8016),m=e.i(7624),g=e.i(70065),w=e.i(36141),f=e.i(93695);e.i(58762);var A=e.i(24378),h=e.i(70081),v=e.i(46989);e.i(55007);var z=e.i(60806),E=e.i(63356),D=e.i(33108),R=e.i(53156),x=e.i(23354);async function y(e,a){let t=await z.prisma.platform.findUnique({where:{code:e},select:{id:!0}});return t||z.prisma.platform.create({data:{code:e,name:a},select:{id:!0}})}async function k(e){let a=x.DailySyncPayloadSchema.parse(e.payload),t="GOOGLE_ADS"===a.platform?await y("GOOGLE_ADS","Google Ads"):"META"===a.platform?await y("META","Meta Ads"):await y("TIKTOK","TikTok Ads"),i=await z.prisma.adAccount.upsert({where:{organizationId_platformId_externalId:{organizationId:e.organizationId,platformId:t.id,externalId:a.externalAccountId}},create:{organizationId:e.organizationId,platformId:t.id,externalId:a.externalAccountId,name:`${a.platform} ${a.externalAccountId}`,currency:"USD",timezone:"UTC",status:"ACTIVE"},update:{name:`${a.platform} ${a.externalAccountId}`,status:"ACTIVE"},select:{id:!0}});if("GOOGLE_ADS"===a.platform){let n=new E.GoogleAdsService,r="ad"===a.granularity?await n.fetchDailyAdMetrics({organizationId:e.organizationId,customerId:a.externalAccountId,startDate:a.startDate,endDate:a.endDate}):await n.fetchDailyCampaignMetrics({organizationId:e.organizationId,customerId:a.externalAccountId,startDate:a.startDate,endDate:a.endDate});return await z.prisma.$transaction(async n=>{for(let o of r){let r=await n.campaign.upsert({where:{organizationId_platformId_externalId:{organizationId:e.organizationId,platformId:t.id,externalId:o.campaignId}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,externalId:o.campaignId,name:o.campaignName,status:"ACTIVE"},update:{name:o.campaignName,status:"ACTIVE"},select:{id:!0}});if("ad"===a.granularity&&o.adId){let a=await n.ad.upsert({where:{organizationId_platformId_externalId:{organizationId:e.organizationId,platformId:t.id,externalId:o.adId}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,campaignId:r.id,externalId:o.adId,name:o.adName??o.adId,status:"ACTIVE"},update:{name:o.adName??o.adId,status:"ACTIVE"},select:{id:!0}});await n.dailyAdMetric.upsert({where:{organizationId_adId_date:{organizationId:e.organizationId,adId:a.id,date:new Date(o.date)}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,campaignId:r.id,adId:a.id,date:new Date(o.date),impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.costMicros,revenueMicros:0n},update:{impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.costMicros},select:{id:!0}})}else await n.dailyCampaignMetric.upsert({where:{organizationId_campaignId_date:{organizationId:e.organizationId,campaignId:r.id,date:new Date(o.date)}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,campaignId:r.id,date:new Date(o.date),impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.costMicros,revenueMicros:0n},update:{impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.costMicros},select:{id:!0}})}}),{rows:r.length}}if("META"===a.platform){let n=new D.MetaAdsService,r="ad"===a.granularity?await n.fetchDailyAdInsights({organizationId:e.organizationId,metaAdAccountId:a.externalAccountId,startDate:a.startDate,endDate:a.endDate}):await n.fetchDailyCampaignInsights({organizationId:e.organizationId,metaAdAccountId:a.externalAccountId,startDate:a.startDate,endDate:a.endDate});return await z.prisma.$transaction(async n=>{for(let o of r){let r=await n.campaign.upsert({where:{organizationId_platformId_externalId:{organizationId:e.organizationId,platformId:t.id,externalId:o.campaignId}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,externalId:o.campaignId,name:o.campaignName,status:"ACTIVE"},update:{name:o.campaignName,status:"ACTIVE"},select:{id:!0}});if("ad"===a.granularity&&o.adId){let a=await n.ad.upsert({where:{organizationId_platformId_externalId:{organizationId:e.organizationId,platformId:t.id,externalId:o.adId}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,campaignId:r.id,externalId:o.adId,name:o.adName??o.adId,status:"ACTIVE"},update:{name:o.adName??o.adId,status:"ACTIVE"},select:{id:!0}});await n.dailyAdMetric.upsert({where:{organizationId_adId_date:{organizationId:e.organizationId,adId:a.id,date:new Date(o.date)}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,campaignId:r.id,adId:a.id,date:new Date(o.date),impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.spendMicros,revenueMicros:0n},update:{impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.spendMicros},select:{id:!0}})}else await n.dailyCampaignMetric.upsert({where:{organizationId_campaignId_date:{organizationId:e.organizationId,campaignId:r.id,date:new Date(o.date)}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,campaignId:r.id,date:new Date(o.date),impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.spendMicros,revenueMicros:0n},update:{impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.spendMicros},select:{id:!0}})}}),{rows:r.length}}let n=new R.TikTokAdsService,r="ad"===a.granularity?await n.fetchDailyAdReport({organizationId:e.organizationId,advertiserId:a.externalAccountId,startDate:a.startDate,endDate:a.endDate}):await n.fetchDailyCampaignReport({organizationId:e.organizationId,advertiserId:a.externalAccountId,startDate:a.startDate,endDate:a.endDate});return await z.prisma.$transaction(async n=>{for(let o of r){let r=await n.campaign.upsert({where:{organizationId_platformId_externalId:{organizationId:e.organizationId,platformId:t.id,externalId:o.campaignId}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,externalId:o.campaignId,name:o.campaignName||o.campaignId,status:"ACTIVE"},update:{name:o.campaignName||o.campaignId,status:"ACTIVE"},select:{id:!0}});if("ad"===a.granularity&&o.adId){let a=await n.ad.upsert({where:{organizationId_platformId_externalId:{organizationId:e.organizationId,platformId:t.id,externalId:o.adId}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,campaignId:r.id,externalId:o.adId,name:o.adName??o.adId,status:"ACTIVE"},update:{name:o.adName??o.adId,status:"ACTIVE"},select:{id:!0}});await n.dailyAdMetric.upsert({where:{organizationId_adId_date:{organizationId:e.organizationId,adId:a.id,date:new Date(o.date)}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,campaignId:r.id,adId:a.id,date:new Date(o.date),impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.spendMicros,revenueMicros:0n},update:{impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.spendMicros},select:{id:!0}})}else await n.dailyCampaignMetric.upsert({where:{organizationId_campaignId_date:{organizationId:e.organizationId,campaignId:r.id,date:new Date(o.date)}},create:{organizationId:e.organizationId,platformId:t.id,adAccountId:i.id,campaignId:r.id,date:new Date(o.date),impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.spendMicros,revenueMicros:0n},update:{impressions:o.impressions,clicks:o.clicks,conversions:o.conversions,spendMicros:o.spendMicros},select:{id:!0}})}}),{rows:r.length}}var M=e.i(81897);async function C(e){let a=new Date,t=await z.prisma.ingestionJob.findMany({where:{status:"QUEUED",runAt:{lte:a},OR:[{lockedAt:null},{lockedAt:{lt:new Date(Date.now()-6e5)}}]},orderBy:{runAt:"asc"},take:e.limit,select:{id:!0,organizationId:!0,platform:!0,jobType:!0,payload:!0,attempts:!0,maxAttempts:!0}}),i=0,n=0,r=0;for(let a of t)if(1===(await z.prisma.ingestionJob.updateMany({where:{id:a.id,status:"QUEUED",OR:[{lockedAt:null},{lockedAt:{lt:new Date(Date.now()-6e5)}}]},data:{status:"RUNNING",lockedAt:new Date,lockedBy:e.workerId}})).count){i+=1;try{if("DAILY_SYNC"===a.jobType)await k({organizationId:a.organizationId,payload:a.payload});else throw Error("UNSUPPORTED_JOB_TYPE");await z.prisma.ingestionJob.update({where:{id:a.id},data:{status:"SUCCEEDED",lockedAt:null,lockedBy:null,lastError:null},select:{id:!0}}),n+=1}catch(i){let e=a.attempts+1,t=e>=a.maxAttempts;await z.prisma.ingestionJob.update({where:{id:a.id},data:{status:t?"FAILED":"QUEUED",attempts:e,runAt:t?new Date:(0,M.computeNextRunAt)(e),lockedAt:null,lockedBy:null,lastError:i instanceof Error?i.message:"UNKNOWN_ERROR"},select:{id:!0}}),r+=1}}return{processed:i,succeeded:n,failed:r}}let _=v.z.object({limit:v.z.number().int().min(1).max(50).default(10),workerId:v.z.string().min(1)});async function T(e){let a=await e.json().catch(()=>null),t=_.safeParse(a);if(!t.success)return h.NextResponse.json({error:"invalid_request"},{status:400});let i=await C({limit:t.data.limit,workerId:t.data.workerId});return h.NextResponse.json(i,{status:200})}e.s(["POST",()=>T],84967);var N=e.i(84967);let O=new a.AppRouteRouteModule({definition:{kind:t.RouteKind.APP_ROUTE,page:"/api/ingestion/worker/route",pathname:"/api/ingestion/worker",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/ingestion/worker/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:S,workUnitAsyncStorage:P,serverHooks:U}=O;function b(){return(0,i.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:P})}async function q(e,a,i){O.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let h="/api/ingestion/worker/route";h=h.replace(/\/index$/,"")||"/";let v=await O.prepare(e,a,{srcPage:h,multiZoneDraftMode:!1});if(!v)return a.statusCode=400,a.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:z,params:E,nextConfig:D,parsedUrl:R,isDraftMode:x,prerenderManifest:y,routerServerContext:k,isOnDemandRevalidate:M,revalidateOnlyGenerated:C,resolvedPathname:_,clientReferenceManifest:T,serverActionsManifest:N}=v,S=(0,s.normalizeAppPath)(h),P=!!(y.dynamicRoutes[S]||y.routes[_]),U=async()=>((null==k?void 0:k.render404)?await k.render404(e,a,R,!1):a.end("This page could not be found"),null);if(P&&!x){let e=!!y.routes[_],a=y.dynamicRoutes[S];if(a&&!1===a.fallback&&!e){if(D.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let b=null;!P||O.isDev||x||(b="/index"===(b=_)?"/":b);let q=!0===O.isDev||!P,H=P&&!q;N&&T&&(0,o.setReferenceManifestsSingleton)({page:h,clientReferenceManifest:T,serverActionsManifest:N,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:N})});let V=e.method||"GET",$=(0,r.getTracer)(),j=$.getActiveScopeSpan(),G={params:E,prerenderManifest:y,renderOpts:{experimental:{authInterrupts:!!D.experimental.authInterrupts},cacheComponents:!!D.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:D.cacheLife,waitUntil:i.waitUntil,onClose:e=>{a.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(a,t,i)=>O.onRequestError(e,a,i,k)},sharedContext:{buildId:z}},K=new c.NodeNextRequest(e),B=new c.NodeNextResponse(a),L=l.NextRequestAdapter.fromNodeNextRequest(K,(0,l.signalFromNodeResponse)(a));try{let o=async e=>O.handle(L,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":a.statusCode,"next.rsc":!1});let t=$.getRootSpanAttributes();if(!t)return;if(t.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${t.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=t.get("next.route");if(i){let a=`${V} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":a}),e.updateName(a)}else e.updateName(`${V} ${h}`)}),d=!!(0,n.getRequestMeta)(e,"minimalMode"),s=async n=>{var r,s;let c=async({previousCacheEntry:t})=>{try{if(!d&&M&&C&&!t)return a.statusCode=404,a.setHeader("x-nextjs-cache","REVALIDATED"),a.end("This page could not be found"),null;let r=await o(n);e.fetchMetrics=G.renderOpts.fetchMetrics;let s=G.renderOpts.pendingWaitUntil;s&&i.waitUntil&&(i.waitUntil(s),s=void 0);let c=G.renderOpts.collectedTags;if(!P)return await (0,I.sendResponse)(K,B,r,G.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),a=(0,m.toNodeOutgoingHttpHeaders)(r.headers);c&&(a[w.NEXT_CACHE_TAGS_HEADER]=c),!a["content-type"]&&e.type&&(a["content-type"]=e.type);let t=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,i=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:A.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:a},cacheControl:{revalidate:t,expire:i}}}}catch(a){throw(null==t?void 0:t.isStale)&&await O.onRequestError(e,a,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:M})},k),a}},l=await O.handleResponse({req:e,nextConfig:D,cacheKey:b,routeKind:t.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:M,revalidateOnlyGenerated:C,responseGenerator:c,waitUntil:i.waitUntil,isMinimalMode:d});if(!P)return null;if((null==l||null==(r=l.value)?void 0:r.kind)!==A.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(s=l.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});d||a.setHeader("x-nextjs-cache",M?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&a.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,m.fromNodeOutgoingHttpHeaders)(l.value.headers);return d&&P||p.delete(w.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||a.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(l.cacheControl)),await (0,I.sendResponse)(K,B,new Response(l.value.body,{headers:p,status:l.value.status||200})),null};j?await s(j):await $.withPropagatedContext(e.headers,()=>$.trace(p.BaseServerSpan.handleRequest,{spanName:`${V} ${h}`,kind:r.SpanKind.SERVER,attributes:{"http.method":V,"http.target":e.url}},s))}catch(a){if(a instanceof f.NoFallbackError||await O.onRequestError(e,a,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:M})}),P)throw a;return await (0,I.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>b,"routeModule",()=>O,"serverHooks",()=>U,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>P],72834)}];

//# sourceMappingURL=c9d07_next_dist_esm_build_templates_app-route_8d888aef.js.map