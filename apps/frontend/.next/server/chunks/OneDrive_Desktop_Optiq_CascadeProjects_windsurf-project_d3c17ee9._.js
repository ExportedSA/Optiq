module.exports=[25881,(e,t,n)=>{"use strict";t.exports=e.r(13493).vendored["react-rsc"].ReactServerDOMTurbopackServer},86040,(e,t,n)=>{"use strict";Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"registerServerReference",{enumerable:!0,get:function(){return r.registerServerReference}});let r=e.r(25881)},67650,(e,t,n)=>{"use strict";function r(e){for(let t=0;t<e.length;t++){let n=e[t];if("function"!=typeof n)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof n}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"ensureServerEntryExports",{enumerable:!0,get:function(){return r}})},38478,39063,12329,e=>{"use strict";e.i(55007);var t=e.i(60806);let n={spendThresholdMicros:BigInt(5e7),targetCpaMicros:BigInt(25e6),cpaTolerancePercent:50,minImpressions:1e3,minCtrPercent:.5,rollingWindowDays:7};function r(e){return Number(e)/1e6}function i(e,t){return t===BigInt(0)?null:Number(e)/Number(t)}function s(e,t){return t===BigInt(0)?0:Number(e)/Number(t)*100}function a(e,t,n){let i=r(e),s=r(t.spendThresholdMicros);if("zero_conversions_high_spend"===n)return i>=5*s?"critical":i>=2*s?"high":i>=s?"medium":"low";if("cpa_above_target"===n){if(i>=3*s)return"high";if(i>=s)return"medium"}return"low"}function o(e,t){let n=t??new Date;n.setHours(23,59,59,999);let r=new Date(n);return r.setDate(r.getDate()-e+1),r.setHours(0,0,0,0),{start:r,end:n,days:e}}function d(e,t,n,r){let i=r.toISOString().split("T")[0];return`${e}_${t}_${n}_${i}`}function c(e,t){switch(e){case"zero_conversions_high_spend":return`Consider pausing this ${t.entityType.replace("_"," ")} or reviewing targeting. Spent $${r(t.spendMicros).toFixed(2)} with no conversions.`;case"cpa_above_target":let n=i(t.spendMicros,t.conversions);return`CPA of $${n?.toFixed(2)??"N/A"} exceeds target. Review ad creative, landing page, or audience targeting.`;case"low_ctr_high_spend":let a=s(t.clicks,t.impressions);return`CTR of ${a.toFixed(2)}% is below threshold. Consider refreshing creative or adjusting targeting.`;case"declining_performance":return"Performance has declined over the analysis period. Review recent changes and consider optimization.";default:return`Review this ${t.entityType.replace("_"," ")} for potential optimization opportunities.`}}e.s(["DEFAULT_WASTE_CONFIG",0,n,"computeCpa",()=>i,"computeCtr",()=>s,"determineWasteLevel",()=>a,"microsToDollars",()=>r],39063);class l{config;constructor(e={}){this.config={...n,...e}}async evaluateOrganization(e){let t=o(e.windowDays??this.config.rollingWindowDays,e.endDate),[n,r,i]=await Promise.all([this.evaluateAdAccounts(e.organizationId,t),this.evaluateCampaigns(e.organizationId,t),this.evaluateAds(e.organizationId,t)]),s=[...n,...r,...i],a=s.reduce((e,t)=>e+t.spendMicros,BigInt(0)),d={none:0,low:0,medium:0,high:0,critical:0},c={zero_conversions_high_spend:0,cpa_above_target:0,low_ctr_high_spend:0,declining_performance:0},l={ad_account:0,campaign:0,ad:0};for(let e of s)d[e.level]++,c[e.reason]++,l[e.entityType]++;return{organizationId:e.organizationId,windowStart:t.start,windowEnd:t.end,totalWastedSpendMicros:a,alerts:s,byLevel:d,byReason:c,byEntityType:l}}async evaluateAdAccounts(e,n){let r=await t.prisma.dailyAdAccountMetric.groupBy({by:["adAccountId"],where:{organizationId:e,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),i=[];for(let s of r){let r=await t.prisma.adAccount.findUnique({where:{id:s.adAccountId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!r)continue;let a={entityId:s.adAccountId,entityName:r.name,entityType:"ad_account",platformCode:r.platform.code,impressions:s._sum.impressions??BigInt(0),clicks:s._sum.clicks??BigInt(0),spendMicros:s._sum.spendMicros??BigInt(0),conversions:s._sum.conversions??BigInt(0),revenueMicros:s._sum.revenueMicros??BigInt(0)},o=this.detectWaste(a,n,e);i.push(...o)}return i}async evaluateCampaigns(e,n){let r=await t.prisma.dailyCampaignMetric.groupBy({by:["campaignId"],where:{organizationId:e,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),i=[];for(let s of r){let r=await t.prisma.campaign.findUnique({where:{id:s.campaignId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!r)continue;let a={entityId:s.campaignId,entityName:r.name,entityType:"campaign",platformCode:r.platform.code,impressions:s._sum.impressions??BigInt(0),clicks:s._sum.clicks??BigInt(0),spendMicros:s._sum.spendMicros??BigInt(0),conversions:s._sum.conversions??BigInt(0),revenueMicros:s._sum.revenueMicros??BigInt(0)},o=this.detectWaste(a,n,e);i.push(...o)}return i}async evaluateAds(e,n){let r=await t.prisma.dailyAdMetric.groupBy({by:["adId"],where:{organizationId:e,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),i=[];for(let s of r){let r=await t.prisma.ad.findUnique({where:{id:s.adId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!r)continue;let a={entityId:s.adId,entityName:r.name??`Ad ${s.adId}`,entityType:"ad",platformCode:r.platform.code,impressions:s._sum.impressions??BigInt(0),clicks:s._sum.clicks??BigInt(0),spendMicros:s._sum.spendMicros??BigInt(0),conversions:s._sum.conversions??BigInt(0),revenueMicros:s._sum.revenueMicros??BigInt(0)},o=this.detectWaste(a,n,e);i.push(...o)}return i}detectWaste(e,t,n){let s=[];if(e.spendMicros>=this.config.spendThresholdMicros&&e.conversions===BigInt(0)){let i="zero_conversions_high_spend",o=a(e.spendMicros,this.config,i);s.push({id:d(e.entityType,e.entityId,i,t.end),entityType:e.entityType,entityId:e.entityId,entityName:e.entityName,organizationId:n,platformCode:e.platformCode,reason:i,level:o,spendMicros:e.spendMicros,conversions:0,cpa:null,targetCpa:r(this.config.targetCpaMicros),windowStart:t.start,windowEnd:t.end,message:`${e.entityName} spent $${r(e.spendMicros).toFixed(2)} with zero conversions in the last ${t.days} days.`,recommendation:c(i,e)})}if(e.conversions>BigInt(0)){let o=i(e.spendMicros,e.conversions),l=r(this.config.targetCpaMicros),u=l*(1+this.config.cpaTolerancePercent/100);if(null!==o&&o>1e6*u){let r="cpa_above_target",i=a(e.spendMicros,this.config,r),u=e.spendMicros-BigInt(Math.round(1e6*l*Number(e.conversions)));s.push({id:d(e.entityType,e.entityId,r,t.end),entityType:e.entityType,entityId:e.entityId,entityName:e.entityName,organizationId:n,platformCode:e.platformCode,reason:r,level:i,spendMicros:u>BigInt(0)?u:e.spendMicros,conversions:Number(e.conversions),cpa:o/1e6,targetCpa:l,windowStart:t.start,windowEnd:t.end,message:`${e.entityName} has CPA of $${(o/1e6).toFixed(2)} vs target of $${l.toFixed(2)} (${((o/1e6/l-1)*100).toFixed(0)}% over).`,recommendation:c(r,e)})}}return s}async evaluateCampaign(e){let n=o(e.windowDays??this.config.rollingWindowDays,e.endDate),r=await t.prisma.dailyCampaignMetric.aggregate({where:{organizationId:e.organizationId,campaignId:e.campaignId,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),i=await t.prisma.campaign.findUnique({where:{id:e.campaignId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!i)return[];let s={entityId:e.campaignId,entityName:i.name,entityType:"campaign",platformCode:i.platform.code,impressions:r._sum.impressions??BigInt(0),clicks:r._sum.clicks??BigInt(0),spendMicros:r._sum.spendMicros??BigInt(0),conversions:r._sum.conversions??BigInt(0),revenueMicros:r._sum.revenueMicros??BigInt(0)};return this.detectWaste(s,n,e.organizationId)}async evaluateAd(e){let n=o(e.windowDays??this.config.rollingWindowDays,e.endDate),r=await t.prisma.dailyAdMetric.aggregate({where:{organizationId:e.organizationId,adId:e.adId,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),i=await t.prisma.ad.findUnique({where:{id:e.adId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!i)return[];let s={entityId:e.adId,entityName:i.name??`Ad ${e.adId}`,entityType:"ad",platformCode:i.platform.code,impressions:r._sum.impressions??BigInt(0),clicks:r._sum.clicks??BigInt(0),spendMicros:r._sum.spendMicros??BigInt(0),conversions:r._sum.conversions??BigInt(0),revenueMicros:r._sum.revenueMicros??BigInt(0)};return this.detectWaste(s,n,e.organizationId)}getConfig(){return{...this.config}}withConfig(e){return new l({...this.config,...e})}}let u=new l;e.s(["wasteEvaluator",0,u],12329),e.s([],38478)},30689,e=>{"use strict";var t=e.i(56884),n=e.i(42064),r=e.i(1824),i=e.i(99326),s=e.i(18794),a=e.i(83629),o=e.i(41446),d=e.i(61251),c=e.i(5708),l=e.i(59092),u=e.i(99563),p=e.i(39870),m=e.i(8016),g=e.i(7624),f=e.i(70065),v=e.i(36141),h=e.i(93695);e.i(58762);var y=e.i(24378),w=e.i(86040),I=e.i(70081),_=e.i(68050),M=e.i(46989),R=e.i(16336);e.i(38478);var C=e.i(12329),E=e.i(67650);let b=M.z.object({windowDays:M.z.coerce.number().int().min(1).max(90).default(7),level:M.z.string().optional(),reason:M.z.string().optional(),entityType:M.z.string().optional(),platformCode:M.z.string().optional(),sortBy:M.z.enum(["spend","level","reason","entityName"]).default("spend"),sortDir:M.z.enum(["asc","desc"]).default("desc")});async function T(e){let t=await (0,_.getServerSession)(R.authOptions),n=t?.user?.activeOrgId;if(!n)return I.NextResponse.json({error:"unauthorized"},{status:401});let r=new URL(e.url),i=b.safeParse({windowDays:r.searchParams.get("windowDays")??void 0,level:r.searchParams.get("level")??void 0,reason:r.searchParams.get("reason")??void 0,entityType:r.searchParams.get("entityType")??void 0,platformCode:r.searchParams.get("platformCode")??void 0,sortBy:r.searchParams.get("sortBy")??"spend",sortDir:r.searchParams.get("sortDir")??"desc"});if(!i.success)return I.NextResponse.json({error:"invalid_params"},{status:400});let{windowDays:s,level:a,reason:o,entityType:d,platformCode:c,sortBy:l,sortDir:u}=i.data;try{let e=await C.wasteEvaluator.evaluateOrganization({organizationId:n,windowDays:s}),t=e.alerts;a&&(t=t.filter(e=>e.level===a)),o&&(t=t.filter(e=>e.reason===o)),d&&(t=t.filter(e=>e.entityType===d)),c&&(t=t.filter(e=>e.platformCode===c));let r={none:0,low:1,medium:2,high:3,critical:4};return t=[...t].sort((e,t)=>{let n=0;return"spend"===l&&(n=Number(e.spendMicros-t.spendMicros)),"level"===l&&(n=(r[e.level]??0)-(r[t.level]??0)),"reason"===l&&(n=e.reason.localeCompare(t.reason)),"entityName"===l&&(n=e.entityName.localeCompare(t.entityName)),"asc"===u?n:-n}),I.NextResponse.json({window:{start:e.windowStart.toISOString(),end:e.windowEnd.toISOString(),days:s},totals:{totalWastedSpendMicros:e.totalWastedSpendMicros.toString(),byLevel:e.byLevel,byReason:e.byReason,byEntityType:e.byEntityType},alerts:t.map(e=>({...e,spendMicros:e.spendMicros.toString(),windowStart:e.windowStart.toISOString(),windowEnd:e.windowEnd.toISOString()}))})}catch(e){return console.error("waste alerts list error",e),I.NextResponse.json({error:"server_error"},{status:500})}}(0,E.ensureServerEntryExports)([T]),(0,w.registerServerReference)(T,"40b19b9d8a2d2d1ce8d4490030031e1eefef65829a",null),e.s(["GET",()=>T],92647);var N=e.i(92647);let A=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/waste/alerts/route",pathname:"/api/waste/alerts",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/waste/alerts/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:S,workUnitAsyncStorage:x,serverHooks:B}=A;function P(){return(0,r.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:x})}async function O(e,t,r){A.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/waste/alerts/route";w=w.replace(/\/index$/,"")||"/";let I=await A.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!I)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:_,params:M,nextConfig:R,parsedUrl:C,isDraftMode:E,prerenderManifest:b,routerServerContext:T,isOnDemandRevalidate:N,revalidateOnlyGenerated:S,resolvedPathname:x,clientReferenceManifest:B,serverActionsManifest:P}=I,O=(0,d.normalizeAppPath)(w),D=!!(b.dynamicRoutes[O]||b.routes[x]),$=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,C,!1):t.end("This page could not be found"),null);if(D&&!E){let e=!!b.routes[x],t=b.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await $();throw new h.NoFallbackError}}let k=null;!D||A.isDev||E||(k="/index"===(k=x)?"/":k);let z=!0===A.isDev||!D,U=D&&!z;P&&B&&(0,a.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:B,serverActionsManifest:P,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:P})});let j=e.method||"GET",q=(0,s.getTracer)(),H=q.getActiveScopeSpan(),F={params:M,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r)=>A.onRequestError(e,t,r,T)},sharedContext:{buildId:_}},W=new c.NodeNextRequest(e),L=new c.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(W,(0,l.signalFromNodeResponse)(t));try{let a=async e=>A.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=q.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${j} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${w}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var s,d;let c=async({previousCacheEntry:n})=>{try{if(!o&&N&&S&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(i);e.fetchMetrics=F.renderOpts.fetchMetrics;let d=F.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let c=F.renderOpts.collectedTags;if(!D)return await (0,m.sendResponse)(W,L,s,F.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[v.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:N})},T),t}},l=await A.handleResponse({req:e,nextConfig:R,cacheKey:k,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:S,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:o});if(!D)return null;if((null==l||null==(s=l.value)?void 0:s.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&D||u.delete(v.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(l.cacheControl)),await (0,m.sendResponse)(W,L,new Response(l.value.body,{headers:u,status:l.value.status||200})),null};H?await d(H):await q.withPropagatedContext(e.headers,()=>q.trace(u.BaseServerSpan.handleRequest,{spanName:`${j} ${w}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},d))}catch(t){if(t instanceof h.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:N})}),D)throw t;return await (0,m.sendResponse)(W,L,new Response(null,{status:500})),null}}e.s(["handler",()=>O,"patchFetch",()=>P,"routeModule",()=>A,"serverHooks",()=>B,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>x],30689)}];

//# sourceMappingURL=OneDrive_Desktop_Optiq_CascadeProjects_windsurf-project_d3c17ee9._.js.map