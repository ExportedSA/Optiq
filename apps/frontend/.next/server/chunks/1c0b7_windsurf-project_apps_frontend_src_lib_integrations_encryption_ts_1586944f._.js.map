{"version":3,"sources":["../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/integrations/encryption.ts"],"sourcesContent":["/**\r\n * Token Encryption Utilities\r\n * \r\n * Encrypts and decrypts OAuth tokens for secure storage\r\n */\r\n\r\nimport \"server-only\";\r\nimport crypto from \"crypto\";\r\n\r\nconst ALGORITHM = \"aes-256-gcm\";\r\nconst IV_LENGTH = 16;\r\nconst AUTH_TAG_LENGTH = 16;\r\nconst SALT_LENGTH = 32;\r\n\r\n/**\r\n * Get encryption key from environment\r\n */\r\nfunction getEncryptionKey(): Buffer {\r\n  const key = process.env.TOKEN_ENCRYPTION_KEY;\r\n  if (!key) {\r\n    throw new Error(\"TOKEN_ENCRYPTION_KEY environment variable is required\");\r\n  }\r\n  \r\n  // Key should be 32 bytes (64 hex chars) for AES-256\r\n  if (key.length !== 64) {\r\n    throw new Error(\"TOKEN_ENCRYPTION_KEY must be 64 hex characters (32 bytes)\");\r\n  }\r\n  \r\n  return Buffer.from(key, \"hex\");\r\n}\r\n\r\n/**\r\n * Encrypt a token\r\n */\r\nexport function encryptToken(plaintext: string): string {\r\n  if (!plaintext) {\r\n    throw new Error(\"Cannot encrypt empty token\");\r\n  }\r\n\r\n  const key = getEncryptionKey();\r\n  \r\n  // Generate random IV\r\n  const iv = crypto.randomBytes(IV_LENGTH);\r\n  \r\n  // Create cipher\r\n  const cipher = crypto.createCipheriv(ALGORITHM, key, iv);\r\n  \r\n  // Encrypt\r\n  const encrypted = Buffer.concat([\r\n    cipher.update(plaintext, \"utf8\"),\r\n    cipher.final(),\r\n  ]);\r\n  \r\n  // Get auth tag\r\n  const authTag = cipher.getAuthTag();\r\n  \r\n  // Combine: iv + authTag + encrypted\r\n  const combined = Buffer.concat([iv, authTag, encrypted]);\r\n  \r\n  // Return as base64\r\n  return combined.toString(\"base64\");\r\n}\r\n\r\n/**\r\n * Decrypt a token\r\n */\r\nexport function decryptToken(ciphertext: string): string {\r\n  if (!ciphertext) {\r\n    throw new Error(\"Cannot decrypt empty ciphertext\");\r\n  }\r\n\r\n  const key = getEncryptionKey();\r\n  \r\n  // Decode from base64\r\n  const combined = Buffer.from(ciphertext, \"base64\");\r\n  \r\n  // Extract components\r\n  const iv = combined.subarray(0, IV_LENGTH);\r\n  const authTag = combined.subarray(IV_LENGTH, IV_LENGTH + AUTH_TAG_LENGTH);\r\n  const encrypted = combined.subarray(IV_LENGTH + AUTH_TAG_LENGTH);\r\n  \r\n  // Create decipher\r\n  const decipher = crypto.createDecipheriv(ALGORITHM, key, iv);\r\n  decipher.setAuthTag(authTag);\r\n  \r\n  // Decrypt\r\n  const decrypted = Buffer.concat([\r\n    decipher.update(encrypted),\r\n    decipher.final(),\r\n  ]);\r\n  \r\n  return decrypted.toString(\"utf8\");\r\n}\r\n\r\n/**\r\n * Generate a new encryption key (for setup)\r\n */\r\nexport function generateEncryptionKey(): string {\r\n  return crypto.randomBytes(32).toString(\"hex\");\r\n}\r\n\r\n/**\r\n * Verify encryption/decryption works\r\n */\r\nexport function verifyEncryption(): boolean {\r\n  try {\r\n    const testData = \"test-token-\" + Date.now();\r\n    const encrypted = encryptToken(testData);\r\n    const decrypted = decryptToken(encrypted);\r\n    return testData === decrypted;\r\n  } catch (error) {\r\n    return false;\r\n  }\r\n}\r\n"],"names":[],"mappings":"uCAMA,EAAA,CAAA,CAAA,OACA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEA,IAAM,EAAY,cAQlB,SAAS,IACP,IAAM,EAAM,QAAQ,GAAG,CAAC,oBAAoB,CAC5C,GAAI,CAAC,EACH,GADQ,GACE,AAAJ,MAAU,yDAIlB,GAAmB,IAAI,CAAnB,EAAI,MAAM,CACZ,MAAM,AAAI,MAAM,6DAGlB,OAAO,OAAO,IAAI,CAAC,EAAK,MAC1B,CAKO,SAAS,EAAa,CAAiB,EAC5C,GAAI,CAAC,EACH,MAAM,AAAI,GADI,GACE,8BAGlB,IAAM,EAAM,IAGN,EAAK,EAAA,OAAM,CAAC,WAAW,CAAC,IAGxB,EAAS,EAAA,OAAM,CAAC,cAAc,CAAC,EAAW,EAAK,GAG/C,EAAY,OAAO,MAAM,CAAC,CAC9B,EAAO,MAAM,CAAC,EAAW,QACzB,EAAO,KAAK,GACb,EAGK,EAAU,EAAO,UAAU,GAMjC,OAAO,AAHU,OAAO,MAAM,CAAC,CAAC,EAAI,EAAS,EAAU,EAGvC,QAAQ,CAAC,SAC3B,CAKO,SAAS,EAAa,CAAkB,EAC7C,GAAI,CAAC,EACH,MAAM,AAAI,IADK,EACC,mCAGlB,IAAM,EAAM,IAGN,EAAW,OAAO,IAAI,CAAC,EAAY,UAGnC,EAAK,EAAS,QAAQ,CAAC,GAAG,GAC1B,EAAU,EAAS,QAAQ,CAAC,AApElB,GAoE6B,IACvC,EAAY,EAAS,IAD8B,IACtB,CAAC,IAG9B,EAAW,EAAA,IAH+B,GAGzB,CAAC,gBAAgB,CAAC,EAAW,EAAK,GASzD,OARA,EAAS,UAAU,CAAC,GAGF,AAKX,OALkB,MAAM,CAAC,CAC9B,EAAS,MAAM,CAAC,GAChB,EAAS,KAAK,GACf,EAEgB,QAAQ,CAAC,OAC5B"}