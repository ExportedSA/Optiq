{"version":3,"sources":["turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/node_modules/thread-stream/package.json","../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/jobs/usage-aggregation.ts"],"sourcesContent":["{\"name\":\"thread-stream\",\"version\":\"3.1.0\",\"description\":\"A streaming way to send data to a Node.js Worker Thread\",\"main\":\"index.js\",\"types\":\"index.d.ts\",\"dependencies\":{\"real-require\":\"^0.2.0\"},\"devDependencies\":{\"@types/node\":\"^20.1.0\",\"@types/tap\":\"^15.0.0\",\"@yao-pkg/pkg\":\"^5.11.5\",\"desm\":\"^1.3.0\",\"fastbench\":\"^1.0.1\",\"husky\":\"^9.0.6\",\"pino-elasticsearch\":\"^8.0.0\",\"sonic-boom\":\"^4.0.1\",\"standard\":\"^17.0.0\",\"tap\":\"^16.2.0\",\"ts-node\":\"^10.8.0\",\"typescript\":\"^5.3.2\",\"why-is-node-running\":\"^2.2.2\"},\"scripts\":{\"build\":\"tsc --noEmit\",\"test\":\"standard && npm run build && npm run transpile && tap \\\"test/**/*.test.*js\\\" && tap --ts test/*.test.*ts\",\"test:ci\":\"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts\",\"test:ci:js\":\"tap --no-check-coverage --timeout=120 --coverage-report=lcovonly \\\"test/**/*.test.*js\\\"\",\"test:ci:ts\":\"tap --ts --no-check-coverage --coverage-report=lcovonly \\\"test/**/*.test.*ts\\\"\",\"test:yarn\":\"npm run transpile && tap \\\"test/**/*.test.js\\\" --no-check-coverage\",\"transpile\":\"sh ./test/ts/transpile.sh\",\"prepare\":\"husky install\"},\"standard\":{\"ignore\":[\"test/ts/**/*\",\"test/syntax-error.mjs\"]},\"repository\":{\"type\":\"git\",\"url\":\"git+https://github.com/mcollina/thread-stream.git\"},\"keywords\":[\"worker\",\"thread\",\"threads\",\"stream\"],\"author\":\"Matteo Collina <hello@matteocollina.com>\",\"license\":\"MIT\",\"bugs\":{\"url\":\"https://github.com/mcollina/thread-stream/issues\"},\"homepage\":\"https://github.com/mcollina/thread-stream#readme\"}","import { prisma } from \"@/lib/prisma\";\r\nimport { appLogger } from \"@/lib/observability\";\r\nimport { PLAN_DEFINITIONS, calculateOverages, type PlanTier } from \"@optiq/shared\";\r\n\r\n/**\r\n * Usage Aggregation Job (Frontend Version)\r\n * \r\n * Runs daily to aggregate usage counters and update billing records.\r\n * This is a simplified version that can run in Vercel serverless functions.\r\n * \r\n * Features:\r\n * - Aggregates event counts per workspace per day\r\n * - Writes to DailyUsageCounter table (idempotent upsert)\r\n * - Updates UsageRecord for billing period\r\n * - Supports backfill for missing days via USAGE_BACKFILL_DAYS env var\r\n */\r\n\r\nexport interface AggregationResult {\r\n  processedSubscriptions: number;\r\n  processedDays: number;\r\n  errors: number;\r\n}\r\n\r\n/**\r\n * Run usage aggregation for all subscriptions\r\n * \r\n * @param options - Optional configuration\r\n * @param options.backfillDays - Number of days to backfill (default: 1 = yesterday only)\r\n * @param options.organizationId - Specific organization to process (optional)\r\n */\r\nexport async function runUsageAggregation(options?: {\r\n  backfillDays?: number;\r\n  organizationId?: string;\r\n}): Promise<AggregationResult> {\r\n  const logger = appLogger.child({ job: \"usage-aggregation\" });\r\n  \r\n  // Check for backfill mode via env var or options\r\n  const backfillDays = options?.backfillDays ?? \r\n    (process.env.USAGE_BACKFILL_DAYS ? parseInt(process.env.USAGE_BACKFILL_DAYS, 10) : 1);\r\n  \r\n  logger.info(\"Starting usage aggregation\", { backfillDays, organizationId: options?.organizationId });\r\n\r\n  const result: AggregationResult = {\r\n    processedSubscriptions: 0,\r\n    processedDays: 0,\r\n    errors: 0,\r\n  };\r\n\r\n  const today = new Date();\r\n  today.setHours(0, 0, 0, 0);\r\n\r\n  // Get all organizations with active subscriptions\r\n  const subscriptions = await prisma.subscription.findMany({\r\n    where: {\r\n      status: { in: [\"ACTIVE\", \"TRIALING\"] },\r\n    },\r\n    select: {\r\n      id: true,\r\n      organizationId: true,\r\n      plan: true,\r\n      monthlyEventLimit: true,\r\n      currentPeriodStart: true,\r\n      currentPeriodEnd: true,\r\n    },\r\n  });\r\n\r\n  // Filter by organization if specified\r\n  const filteredSubscriptions = options?.organizationId\r\n    ? subscriptions.filter((s) => s.organizationId === options.organizationId)\r\n    : subscriptions;\r\n\r\n  logger.info(`Processing ${filteredSubscriptions.length} subscriptions`);\r\n\r\n  // Process each day in the backfill range\r\n  for (let dayOffset = backfillDays; dayOffset >= 1; dayOffset--) {\r\n    const targetDate = new Date(today);\r\n    targetDate.setDate(targetDate.getDate() - dayOffset);\r\n    \r\n    const nextDate = new Date(targetDate);\r\n    nextDate.setDate(nextDate.getDate() + 1);\r\n\r\n    logger.debug(`Processing date: ${targetDate.toISOString().split(\"T\")[0]}`);\r\n\r\n    for (const subscription of filteredSubscriptions) {\r\n      try {\r\n        await aggregateSubscriptionUsage(subscription, targetDate, nextDate, logger);\r\n        result.processedDays++;\r\n      } catch (error) {\r\n        logger.error(`Error aggregating usage for subscription ${subscription.id}`, error as Error);\r\n        result.errors++;\r\n      }\r\n    }\r\n    \r\n    result.processedSubscriptions = filteredSubscriptions.length;\r\n  }\r\n\r\n  logger.info(\"Usage aggregation completed\", { ...result });\r\n  return result;\r\n}\r\n\r\nasync function aggregateSubscriptionUsage(\r\n  subscription: {\r\n    id: string;\r\n    organizationId: string;\r\n    plan: string;\r\n    monthlyEventLimit: number | null;\r\n    currentPeriodStart: Date;\r\n    currentPeriodEnd: Date;\r\n  },\r\n  startDate: Date,\r\n  endDate: Date,\r\n  logger: typeof appLogger\r\n): Promise<void> {\r\n  const { organizationId } = subscription;\r\n\r\n  // Get tracking sites for this org\r\n  const sites = await prisma.trackingSite.findMany({\r\n    where: { organizationId },\r\n    select: { id: true },\r\n  });\r\n\r\n  const siteIds = sites.map((s) => s.id);\r\n\r\n  // Count events by type for yesterday\r\n  let pageViews = 0;\r\n  let conversions = 0;\r\n  let customEvents = 0;\r\n\r\n  if (siteIds.length > 0) {\r\n    // Use raw query to avoid Prisma type issues\r\n    const eventCounts = await prisma.$queryRaw<Array<{ eventType: string; count: bigint }>>`\r\n      SELECT \"eventType\", COUNT(*) as count\r\n      FROM \"TrackingEvent\"\r\n      WHERE \"siteId\" = ANY(${siteIds})\r\n        AND \"occurredAt\" >= ${startDate}\r\n        AND \"occurredAt\" < ${endDate}\r\n      GROUP BY \"eventType\"\r\n    `;\r\n\r\n    for (const ec of eventCounts) {\r\n      const count = Number(ec.count);\r\n      switch (ec.eventType) {\r\n        case \"PAGE_VIEW\":\r\n          pageViews = count;\r\n          break;\r\n        case \"CONVERSION\":\r\n          conversions = count;\r\n          break;\r\n        default:\r\n          customEvents += count;\r\n      }\r\n    }\r\n  }\r\n\r\n  const totalEvents = pageViews + conversions + customEvents;\r\n\r\n  // Count active connectors\r\n  const activeConnectors = await prisma.adAccount.count({\r\n    where: { organizationId, status: \"ACTIVE\" },\r\n  });\r\n\r\n  // Count active campaigns\r\n  const activeCampaigns = await prisma.campaign.count({\r\n    where: { organizationId, status: \"ACTIVE\" },\r\n  });\r\n\r\n  // Upsert daily counter\r\n  await prisma.$executeRaw`\r\n    INSERT INTO \"DailyUsageCounter\" (\r\n      \"id\", \"organizationId\", \"date\",\r\n      \"pageViews\", \"conversions\", \"customEvents\", \"totalEvents\",\r\n      \"activeConnectors\", \"activeCampaigns\",\r\n      \"createdAt\", \"updatedAt\"\r\n    )\r\n    VALUES (\r\n      gen_random_uuid()::text, ${organizationId}, ${startDate},\r\n      ${pageViews}, ${conversions}, ${customEvents}, ${totalEvents},\r\n      ${activeConnectors}, ${activeCampaigns},\r\n      NOW(), NOW()\r\n    )\r\n    ON CONFLICT (\"organizationId\", \"date\")\r\n    DO UPDATE SET\r\n      \"pageViews\" = EXCLUDED.\"pageViews\",\r\n      \"conversions\" = EXCLUDED.\"conversions\",\r\n      \"customEvents\" = EXCLUDED.\"customEvents\",\r\n      \"totalEvents\" = EXCLUDED.\"totalEvents\",\r\n      \"activeConnectors\" = EXCLUDED.\"activeConnectors\",\r\n      \"activeCampaigns\" = EXCLUDED.\"activeCampaigns\",\r\n      \"updatedAt\" = NOW()\r\n  `;\r\n\r\n  // Sum all events in current billing period\r\n  const periodUsage = await prisma.$queryRaw<[{ total: bigint }]>`\r\n    SELECT COALESCE(SUM(\"totalEvents\"), 0) as total\r\n    FROM \"DailyUsageCounter\"\r\n    WHERE \"organizationId\" = ${organizationId}\r\n      AND \"date\" >= ${subscription.currentPeriodStart}\r\n      AND \"date\" <= ${subscription.currentPeriodEnd}\r\n  `;\r\n\r\n  const totalPeriodEvents = Number(periodUsage[0]?.total ?? 0);\r\n\r\n  // Get plan limits\r\n  const plan = subscription.plan as PlanTier;\r\n  const planDef = PLAN_DEFINITIONS[plan] ?? PLAN_DEFINITIONS.FREE;\r\n\r\n  const limits = {\r\n    maxWorkspaces: planDef.limits.maxWorkspaces,\r\n    maxConnectors: planDef.limits.maxConnectors,\r\n    monthlyEventLimit: subscription.monthlyEventLimit ?? planDef.limits.monthlyEventLimit,\r\n    dataRetentionDays: planDef.limits.dataRetentionDays,\r\n    attributionModels: planDef.limits.attributionModels,\r\n    alertsEnabled: planDef.limits.alertsEnabled,\r\n    ssoEnabled: planDef.limits.ssoEnabled,\r\n    prioritySupport: planDef.limits.prioritySupport,\r\n  };\r\n\r\n  const usage = {\r\n    trackedEvents: totalPeriodEvents,\r\n    connectedAccounts: activeConnectors,\r\n    workspacesUsed: 1,\r\n  };\r\n\r\n  const overages = calculateOverages(usage, limits, planDef.pricing);\r\n\r\n  // Upsert usage record\r\n  await prisma.$executeRaw`\r\n    INSERT INTO \"UsageRecord\" (\r\n      \"id\", \"subscriptionId\", \"organizationId\",\r\n      \"periodStart\", \"periodEnd\",\r\n      \"trackedEvents\", \"connectedAccounts\", \"workspacesUsed\",\r\n      \"eventsOverage\", \"connectorsOverage\", \"overageAmountCents\",\r\n      \"createdAt\", \"updatedAt\"\r\n    )\r\n    VALUES (\r\n      gen_random_uuid()::text, ${subscription.id}, ${organizationId},\r\n      ${subscription.currentPeriodStart}, ${subscription.currentPeriodEnd},\r\n      ${totalPeriodEvents}, ${activeConnectors}, 1,\r\n      ${overages.eventsOverage}, ${overages.connectorsOverage}, ${overages.totalOverageCents},\r\n      NOW(), NOW()\r\n    )\r\n    ON CONFLICT (\"subscriptionId\", \"periodStart\")\r\n    DO UPDATE SET\r\n      \"trackedEvents\" = EXCLUDED.\"trackedEvents\",\r\n      \"connectedAccounts\" = EXCLUDED.\"connectedAccounts\",\r\n      \"eventsOverage\" = EXCLUDED.\"eventsOverage\",\r\n      \"connectorsOverage\" = EXCLUDED.\"connectorsOverage\",\r\n      \"overageAmountCents\" = EXCLUDED.\"overageAmountCents\",\r\n      \"updatedAt\" = NOW()\r\n  `;\r\n\r\n  logger.debug(`Aggregated usage for org ${organizationId}: ${totalEvents} events yesterday, ${totalPeriodEvents} period total`);\r\n}\r\n"],"names":[],"mappings":"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"}