{"version":3,"sources":["../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/jobs/daily-rollups-v2.ts"],"sourcesContent":["/**\r\n * Daily Rollups Job V2\r\n * \r\n * Joins CostFact with AttributionLink weights to compute:\r\n * - Attributed conversions (fractional based on weights)\r\n * - Conversion value\r\n * - CPA, ROAS\r\n * - Waste spend (spend where conversions = 0)\r\n * \r\n * Persists to DailyRollup by grain (ORG, PLATFORM, CAMPAIGN, ADSET, AD)\r\n * and attributionModel with idempotent upsert.\r\n */\r\n\r\nimport \"server-only\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { appLogger } from \"@/lib/observability\";\r\nimport type { AttributionModel, RollupGrain } from \"@prisma/client\";\r\n\r\nexport interface DailyRollupJobOptions {\r\n  /** Specific organization to process */\r\n  organizationId?: string;\r\n  /** Start date for rollup period */\r\n  fromDate: Date;\r\n  /** End date for rollup period */\r\n  toDate: Date;\r\n  /** Attribution model to use */\r\n  attributionModel: AttributionModel;\r\n  /** Force rebuild even if rollups exist */\r\n  rebuild?: boolean;\r\n}\r\n\r\nexport interface DailyRollupJobResult {\r\n  startedAt: Date;\r\n  completedAt: Date;\r\n  attributionModel: AttributionModel;\r\n  daysProcessed: number;\r\n  rollupsCreated: number;\r\n  rollupsUpdated: number;\r\n  errors: number;\r\n}\r\n\r\ninterface RollupMetrics {\r\n  impressions: bigint;\r\n  clicks: bigint;\r\n  spendMicros: bigint;\r\n  conversions: number;\r\n  conversionValue: bigint;\r\n  cpa: number | null;\r\n  roas: number | null;\r\n  ctr: number | null;\r\n  cpc: number | null;\r\n  wasteSpendMicros: bigint;\r\n  wastePct: number;\r\n}\r\n\r\n/**\r\n * Run daily rollups job\r\n */\r\nexport async function runDailyRollupsV2(\r\n  options: DailyRollupJobOptions\r\n): Promise<DailyRollupJobResult> {\r\n  const logger = appLogger.child({ job: \"daily-rollups-v2\" });\r\n  const startedAt = new Date();\r\n\r\n  logger.info(\"Starting daily rollups job\", {\r\n    organizationId: options.organizationId,\r\n    fromDate: options.fromDate.toISOString(),\r\n    toDate: options.toDate.toISOString(),\r\n    attributionModel: options.attributionModel,\r\n    rebuild: options.rebuild,\r\n  });\r\n\r\n  let daysProcessed = 0;\r\n  let rollupsCreated = 0;\r\n  let rollupsUpdated = 0;\r\n  let errors = 0;\r\n\r\n  try {\r\n    // Get organizations to process\r\n    const organizations = await prisma.organization.findMany({\r\n      where: options.organizationId ? { id: options.organizationId } : {},\r\n      select: { id: true },\r\n    });\r\n\r\n    // Process each day in the range\r\n    const currentDate = new Date(options.fromDate);\r\n    currentDate.setHours(0, 0, 0, 0);\r\n\r\n    while (currentDate <= options.toDate) {\r\n      logger.debug(`Processing date: ${currentDate.toISOString()}`);\r\n\r\n      for (const org of organizations) {\r\n        try {\r\n          const result = await processDayRollups(\r\n            org.id,\r\n            currentDate,\r\n            options.attributionModel,\r\n            options.rebuild || false,\r\n            logger\r\n          );\r\n\r\n          rollupsCreated += result.created;\r\n          rollupsUpdated += result.updated;\r\n        } catch (error) {\r\n          errors++;\r\n          logger.error(`Failed to process rollups for ${org.id} on ${currentDate.toISOString()}`, error as Error);\r\n        }\r\n      }\r\n\r\n      daysProcessed++;\r\n      currentDate.setDate(currentDate.getDate() + 1);\r\n    }\r\n  } catch (error) {\r\n    logger.error(\"Daily rollups job failed\", error as Error);\r\n    throw error;\r\n  }\r\n\r\n  const completedAt = new Date();\r\n\r\n  logger.info(\"Daily rollups job completed\", {\r\n    attributionModel: options.attributionModel,\r\n    daysProcessed,\r\n    rollupsCreated,\r\n    rollupsUpdated,\r\n    errors,\r\n    durationMs: completedAt.getTime() - startedAt.getTime(),\r\n  });\r\n\r\n  return {\r\n    startedAt,\r\n    completedAt,\r\n    attributionModel: options.attributionModel,\r\n    daysProcessed,\r\n    rollupsCreated,\r\n    rollupsUpdated,\r\n    errors,\r\n  };\r\n}\r\n\r\n/**\r\n * Process rollups for a single day and organization\r\n */\r\nasync function processDayRollups(\r\n  organizationId: string,\r\n  date: Date,\r\n  attributionModel: AttributionModel,\r\n  rebuild: boolean,\r\n  logger: typeof appLogger\r\n): Promise<{ created: number; updated: number }> {\r\n  let created = 0;\r\n  let updated = 0;\r\n\r\n  // Get cost data for the day\r\n  const costData = await getCostData(organizationId, date);\r\n\r\n  // Get attribution data for the day\r\n  const attributionData = await getAttributionData(organizationId, date, attributionModel);\r\n\r\n  // Create rollups at each grain level\r\n  const grains: { grain: RollupGrain; groupBy: string[] }[] = [\r\n    { grain: \"ORGANIZATION\", groupBy: [] },\r\n    { grain: \"PLATFORM\", groupBy: [\"platformId\"] },\r\n    { grain: \"CAMPAIGN\", groupBy: [\"platformId\", \"campaignId\"] },\r\n    { grain: \"ADSET\", groupBy: [\"platformId\", \"campaignId\", \"adsetId\"] },\r\n    { grain: \"AD\", groupBy: [\"platformId\", \"campaignId\", \"adsetId\", \"adId\"] },\r\n  ];\r\n\r\n  for (const { grain, groupBy } of grains) {\r\n    const result = await createRollupsByGrain(\r\n      organizationId,\r\n      date,\r\n      grain,\r\n      groupBy,\r\n      costData,\r\n      attributionData,\r\n      attributionModel,\r\n      rebuild\r\n    );\r\n\r\n    created += result.created;\r\n    updated += result.updated;\r\n  }\r\n\r\n  return { created, updated };\r\n}\r\n\r\n/**\r\n * Get cost data from DailyCampaignMetric\r\n */\r\nasync function getCostData(organizationId: string, date: Date) {\r\n  return prisma.dailyCampaignMetric.findMany({\r\n    where: {\r\n      organizationId,\r\n      date,\r\n    },\r\n    select: {\r\n      platformId: true,\r\n      campaignId: true,\r\n      impressions: true,\r\n      clicks: true,\r\n      spendMicros: true,\r\n      campaign: {\r\n        select: {\r\n          id: true,\r\n          externalId: true,\r\n          name: true,\r\n        },\r\n      },\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Get attribution data by joining conversions with attribution links\r\n */\r\nasync function getAttributionData(\r\n  organizationId: string,\r\n  date: Date,\r\n  attributionModel: AttributionModel\r\n) {\r\n  const nextDate = new Date(date);\r\n  nextDate.setDate(nextDate.getDate() + 1);\r\n\r\n  // Get conversions that occurred on this date\r\n  const conversions = await prisma.trackingEvent.findMany({\r\n    where: {\r\n      type: \"CONVERSION\",\r\n      occurredAt: {\r\n        gte: date,\r\n        lt: nextDate,\r\n      },\r\n      site: {\r\n        organizationId,\r\n      },\r\n    },\r\n    select: {\r\n      id: true,\r\n      valueMicros: true,\r\n    },\r\n  });\r\n\r\n  if (conversions.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  const conversionIds = conversions.map(c => c.id);\r\n\r\n  // Get attribution links with weights\r\n  const attributionLinks = await prisma.attributionLink.findMany({\r\n    where: {\r\n      conversionId: { in: conversionIds },\r\n      model: attributionModel,\r\n      weight: { gt: 0 }, // Only links with calculated weights\r\n    },\r\n    include: {\r\n      touchPoint: {\r\n        select: {\r\n          platformCode: true,\r\n          campaignId: true,\r\n        },\r\n      },\r\n      conversion: {\r\n        select: {\r\n          valueMicros: true,\r\n        },\r\n      },\r\n    },\r\n  });\r\n\r\n  // Map attribution links to platform/campaign with weighted conversions\r\n  return attributionLinks.map(link => {\r\n    const conversion = conversions.find(c => c.id === link.conversionId);\r\n    \r\n    return {\r\n      platformCode: link.touchPoint.platformCode,\r\n      campaignId: link.touchPoint.campaignId,\r\n      conversions: link.weight, // Fractional conversion based on weight\r\n      conversionValue: conversion?.valueMicros \r\n        ? BigInt(Math.round(Number(conversion.valueMicros) * link.weight))\r\n        : BigInt(0),\r\n    };\r\n  });\r\n}\r\n\r\n/**\r\n * Create rollups for a specific grain level\r\n */\r\nasync function createRollupsByGrain(\r\n  organizationId: string,\r\n  date: Date,\r\n  grain: RollupGrain,\r\n  groupByFields: string[],\r\n  costData: any[],\r\n  attributionData: any[],\r\n  attributionModel: AttributionModel,\r\n  rebuild: boolean\r\n): Promise<{ created: number; updated: number }> {\r\n  let created = 0;\r\n  let updated = 0;\r\n\r\n  // Group data by the specified fields\r\n  const groups = new Map<string, any>();\r\n\r\n  // Group cost data\r\n  for (const cost of costData) {\r\n    const key = groupByFields.map(field => {\r\n      if (field === \"adsetId\" || field === \"adId\") {\r\n        return cost.campaign?.[field] || \"null\";\r\n      }\r\n      return cost[field] || \"null\";\r\n    }).join(\"|\");\r\n\r\n    if (!groups.has(key)) {\r\n      groups.set(key, {\r\n        platformId: cost.platformId,\r\n        campaignId: cost.campaignId,\r\n        adsetId: cost.campaign?.adsetId,\r\n        adId: cost.campaign?.adId,\r\n        impressions: BigInt(0),\r\n        clicks: BigInt(0),\r\n        spendMicros: BigInt(0),\r\n        conversions: 0,\r\n        conversionValue: BigInt(0),\r\n      });\r\n    }\r\n\r\n    const group = groups.get(key)!;\r\n    group.impressions += cost.impressions;\r\n    group.clicks += cost.clicks;\r\n    group.spendMicros += cost.spendMicros;\r\n  }\r\n\r\n  // Add attribution data\r\n  for (const attr of attributionData) {\r\n    const key = groupByFields.map(field => {\r\n      if (field === \"platformId\") {\r\n        // Map platformCode to platformId (would need platform lookup)\r\n        return attr.platformCode || \"null\";\r\n      }\r\n      return attr[field] || \"null\";\r\n    }).join(\"|\");\r\n\r\n    if (groups.has(key)) {\r\n      const group = groups.get(key)!;\r\n      group.conversions += attr.conversions;\r\n      group.conversionValue += attr.conversionValue;\r\n    }\r\n  }\r\n\r\n  // Create/update rollups for each group\r\n  for (const [key, data] of groups) {\r\n    const metrics = calculateMetrics(\r\n      data.impressions,\r\n      data.clicks,\r\n      data.spendMicros,\r\n      data.conversions,\r\n      data.conversionValue\r\n    );\r\n\r\n    const result = await upsertDailyRollup({\r\n      organizationId,\r\n      date,\r\n      grain,\r\n      platformId: groupByFields.includes(\"platformId\") ? data.platformId : null,\r\n      campaignId: groupByFields.includes(\"campaignId\") ? data.campaignId : null,\r\n      adsetId: groupByFields.includes(\"adsetId\") ? data.adsetId : null,\r\n      adId: groupByFields.includes(\"adId\") ? data.adId : null,\r\n      attributionModel,\r\n      metrics: {\r\n        ...metrics,\r\n        impressions: data.impressions,\r\n        clicks: data.clicks,\r\n        spendMicros: data.spendMicros,\r\n        conversions: data.conversions,\r\n        conversionValue: data.conversionValue,\r\n      },\r\n      rebuild,\r\n    });\r\n\r\n    if (result.created) created++;\r\n    else updated++;\r\n  }\r\n\r\n  return { created, updated };\r\n}\r\n\r\n/**\r\n * Calculate derived metrics\r\n */\r\nfunction calculateMetrics(\r\n  impressions: bigint,\r\n  clicks: bigint,\r\n  spendMicros: bigint,\r\n  conversions: number,\r\n  conversionValue: bigint\r\n): Omit<RollupMetrics, \"impressions\" | \"clicks\" | \"spendMicros\" | \"conversions\" | \"conversionValue\"> {\r\n  const spend = Number(spendMicros) / 1_000_000;\r\n  const revenue = Number(conversionValue) / 1_000_000;\r\n\r\n  // CPA (Cost Per Acquisition)\r\n  const cpa = conversions > 0 ? spend / conversions : null;\r\n\r\n  // ROAS (Return On Ad Spend)\r\n  const roas = spend > 0 ? revenue / spend : null;\r\n\r\n  // CTR (Click-Through Rate)\r\n  const ctr = impressions > 0 ? (Number(clicks) / Number(impressions)) * 100 : null;\r\n\r\n  // CPC (Cost Per Click)\r\n  const cpc = clicks > 0 ? spend / Number(clicks) : null;\r\n\r\n  // Waste spend (spend with no conversions)\r\n  const wasteSpendMicros = conversions === 0 ? spendMicros : BigInt(0);\r\n  const wastePct = spend > 0 ? (Number(wasteSpendMicros) / Number(spendMicros)) * 100 : 0;\r\n\r\n  return {\r\n    cpa,\r\n    roas,\r\n    ctr,\r\n    cpc,\r\n    wasteSpendMicros,\r\n    wastePct,\r\n  };\r\n}\r\n\r\n/**\r\n * Upsert DailyRollup record (idempotent)\r\n */\r\nasync function upsertDailyRollup(params: {\r\n  organizationId: string;\r\n  date: Date;\r\n  grain: RollupGrain;\r\n  platformId: string | null;\r\n  campaignId: string | null;\r\n  adsetId: string | null;\r\n  adId: string | null;\r\n  attributionModel: AttributionModel;\r\n  metrics: RollupMetrics;\r\n  rebuild: boolean;\r\n}): Promise<{ created: boolean }> {\r\n  const {\r\n    organizationId,\r\n    date,\r\n    grain,\r\n    platformId,\r\n    campaignId,\r\n    adsetId,\r\n    adId,\r\n    attributionModel,\r\n    metrics,\r\n    rebuild,\r\n  } = params;\r\n\r\n  // Check if rollup already exists\r\n  const existing = await prisma.dailyRollup.findFirst({\r\n    where: {\r\n      organizationId,\r\n      date,\r\n      grain,\r\n      platformId,\r\n      campaignId,\r\n      adsetId,\r\n      adId,\r\n      attributionModel,\r\n    },\r\n  });\r\n\r\n  if (existing && !rebuild) {\r\n    // Skip if already exists and not rebuilding\r\n    return { created: false };\r\n  }\r\n\r\n  // Upsert the rollup\r\n  await prisma.dailyRollup.upsert({\r\n    where: {\r\n      organizationId_date_grain_platformId_campaignId_adsetId_adId_attributionModel: {\r\n        organizationId,\r\n        date,\r\n        grain,\r\n        platformId: platformId || \"\",\r\n        campaignId: campaignId || \"\",\r\n        adsetId: adsetId || \"\",\r\n        adId: adId || \"\",\r\n        attributionModel,\r\n      },\r\n    },\r\n    create: {\r\n      organizationId,\r\n      date,\r\n      grain,\r\n      platformId,\r\n      campaignId,\r\n      adsetId,\r\n      adId,\r\n      attributionModel,\r\n      impressions: metrics.impressions,\r\n      clicks: metrics.clicks,\r\n      spendMicros: metrics.spendMicros,\r\n      conversions: metrics.conversions,\r\n      conversionValue: metrics.conversionValue,\r\n      attributedConversions: metrics.conversions,\r\n      cpa: metrics.cpa,\r\n      roas: metrics.roas,\r\n      ctr: metrics.ctr,\r\n      cpc: metrics.cpc,\r\n      wasteSpendMicros: metrics.wasteSpendMicros,\r\n      wastePct: metrics.wastePct,\r\n    },\r\n    update: {\r\n      impressions: metrics.impressions,\r\n      clicks: metrics.clicks,\r\n      spendMicros: metrics.spendMicros,\r\n      conversions: metrics.conversions,\r\n      conversionValue: metrics.conversionValue,\r\n      attributedConversions: metrics.conversions,\r\n      cpa: metrics.cpa,\r\n      roas: metrics.roas,\r\n      ctr: metrics.ctr,\r\n      cpc: metrics.cpc,\r\n      wasteSpendMicros: metrics.wasteSpendMicros,\r\n      wastePct: metrics.wastePct,\r\n      updatedAt: new Date(),\r\n    },\r\n  });\r\n\r\n  return { created: !existing };\r\n}\r\n"],"names":[],"mappings":"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"}