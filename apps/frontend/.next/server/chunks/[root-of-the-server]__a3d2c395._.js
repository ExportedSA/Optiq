module.exports=[49719,(e,t,r)=>{t.exports=e.x("assert",()=>require("assert"))},21517,(e,t,r)=>{t.exports=e.x("http",()=>require("http"))},24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},6461,(e,t,r)=>{t.exports=e.x("zlib",()=>require("zlib"))},45706,(e,t,r)=>{t.exports=e.x("querystring",()=>require("querystring"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},55007,(e,t,r)=>{},60806,e=>{"use strict";e.i(55007);var t=e.i(29173);let r=globalThis.prisma??new t.PrismaClient({log:["error","warn"]});e.s(["prisma",0,r])},1466,91490,42960,37966,e=>{"use strict";let t={fatal:60,error:50,warn:40,info:30,debug:20,trace:10,silent:1/0};class r{name;level;bindings;constructor(e={},r={}){this.name=e.name??"optiq",this.level=t[e.level??"info"],this.bindings=r}shouldLog(e){return t[e]>=this.level}formatMessage(e,t,r,s){if(!this.shouldLog(e))return;let n=new Date().toISOString(),a=`[${n}] ${e.toUpperCase()} (${this.name})`;if("string"==typeof t)return void console[e](a,t,...void 0!==r?[r,...s||[]]:s||[]);let i={...this.bindings,...t};Object.keys(i).length>0?console[e](a,r||"",i,...s||[]):console[e](a,r||"",...s||[])}fatal(e,t,...r){this.formatMessage("error",e,t,r)}error(e,t,...r){this.formatMessage("error",e,t,r)}warn(e,t,...r){this.formatMessage("warn",e,t,r)}info(e,t,...r){this.formatMessage("info",e,t,r)}debug(e,t,...r){this.formatMessage("debug",e,t,r)}trace(e,t,...r){this.formatMessage("debug",e,t,r)}child(e){return new r({name:this.name,level:Object.keys(t).find(e=>t[e]===this.level)},{...this.bindings,...e})}}!function(e={}){new r(e)}();var s=e.i(46989);let n=s.z.enum(["GOOGLE_ADS","META","TIKTOK","LINKEDIN","X"]),a=s.z.string().regex(/^\d{4}-\d{2}-\d{2}$/);s.z.object({channel:n,date:a,campaign_id:s.z.string().min(1),campaign_name:s.z.string().min(1).optional(),adset_id:s.z.string().min(1).optional(),adset_name:s.z.string().min(1).optional(),ad_id:s.z.string().min(1).optional(),ad_name:s.z.string().min(1).optional(),spend_micros:s.z.bigint().nonnegative(),clicks:s.z.bigint().nonnegative(),impressions:s.z.bigint().nonnegative(),publisher_platform:s.z.string().min(1).optional()});let i={FREE:{tier:"FREE",name:"Free",description:"Get started with basic tracking",limits:{maxWorkspaces:1,maxConnectors:1,monthlyEventLimit:1e3,dataRetentionDays:7,attributionModels:["LAST_TOUCH"],alertsEnabled:!1,ssoEnabled:!1,prioritySupport:!1},pricing:{monthlyPriceCents:0,annualPriceCents:0,overageEventsPer10kCents:0,overageConnectorCents:0},features:["1 workspace","1 ad platform connector","1,000 events/month","Last-touch attribution","7-day data retention"]},STARTER:{tier:"STARTER",name:"Starter",description:"For small teams getting started with attribution",limits:{maxWorkspaces:1,maxConnectors:2,monthlyEventLimit:1e4,dataRetentionDays:14,attributionModels:["FIRST_TOUCH","LAST_TOUCH","LINEAR"],alertsEnabled:!1,ssoEnabled:!1,prioritySupport:!1},pricing:{monthlyPriceCents:4900,annualPriceCents:47e3,overageEventsPer10kCents:500,overageConnectorCents:1500},features:["1 workspace","2 ad platform connectors","10,000 events/month","First, last & linear attribution","14-day data retention","Email support"]},GROWTH:{tier:"GROWTH",name:"Growth",description:"For growing teams who need full attribution insights",limits:{maxWorkspaces:3,maxConnectors:10,monthlyEventLimit:1e5,dataRetentionDays:90,attributionModels:["FIRST_TOUCH","LAST_TOUCH","LINEAR","TIME_DECAY","POSITION_BASED"],alertsEnabled:!0,ssoEnabled:!1,prioritySupport:!1},pricing:{monthlyPriceCents:14900,annualPriceCents:143e3,overageEventsPer10kCents:400,overageConnectorCents:1e3},features:["3 workspaces","All ad platform connectors","100,000 events/month","All attribution models","90-day data retention","Waste & CPA alerts","Priority email support"],recommended:!0},SCALE:{tier:"SCALE",name:"Scale",description:"For enterprises with advanced needs",limits:{maxWorkspaces:-1,maxConnectors:-1,monthlyEventLimit:1e6,dataRetentionDays:365,attributionModels:["FIRST_TOUCH","LAST_TOUCH","LINEAR","TIME_DECAY","POSITION_BASED","DATA_DRIVEN"],alertsEnabled:!0,ssoEnabled:!0,prioritySupport:!0},pricing:{monthlyPriceCents:49900,annualPriceCents:479e3,overageEventsPer10kCents:300,overageConnectorCents:500},features:["Unlimited workspaces","Unlimited connectors","1,000,000+ events/month","All attribution models + data-driven","365-day data retention","Custom lookback windows","SSO/SAML (coming soon)","Dedicated support","SLA guarantee"]}};function o(e){return i[e]}function c(e){return i[e].limits}function d(e){return -1===e}function _(e,t,r){let s=Math.max(0,e.trackedEvents-t.monthlyEventLimit),n=d(t.maxConnectors)?0:Math.max(0,e.connectedAccounts-t.maxConnectors),a=Math.ceil(s/1e4)*r.overageEventsPer10kCents,i=n*r.overageConnectorCents;return{eventsOverage:s,connectorsOverage:n,eventsOverageCents:a,connectorsOverageCents:i,totalOverageCents:a+i}}function l(e,t){let r=[];return!d(t.maxWorkspaces)&&e.workspacesUsed>t.maxWorkspaces&&r.push(`Workspace limit exceeded (${e.workspacesUsed}/${t.maxWorkspaces})`),!d(t.maxConnectors)&&e.connectedAccounts>t.maxConnectors&&r.push(`Connector limit exceeded (${e.connectedAccounts}/${t.maxConnectors})`),e.trackedEvents>1.5*t.monthlyEventLimit&&r.push(`Event limit significantly exceeded (${e.trackedEvents}/${t.monthlyEventLimit})`),{withinLimits:0===r.length,violations:r}}function p(e,t){let r=["FREE","STARTER","GROWTH","SCALE"];return r.indexOf(t)>r.indexOf(e)}function m(e,t){let r=["FREE","STARTER","GROWTH","SCALE"];return r.indexOf(t)<r.indexOf(e)}function E(e){let t=["FREE","STARTER","GROWTH","SCALE"],r=t.indexOf(e);return r<t.length-1?t[r+1]:null}e.s(["PLAN_DEFINITIONS",0,i,"calculateOverages",()=>_,"canDowngrade",()=>m,"canUpgrade",()=>p,"checkLimits",()=>l,"getPlanDefinition",()=>o,"getPlanLimits",()=>c,"getUpgradePath",()=>E,"isUnlimited",()=>d],91490),e.s([],42960),e.i(54799);let u=s.z.enum(["development","staging","production"]);class g extends Error{details;constructor(e,t){super(e),this.name="EnvValidationError",this.details=t}}function T(e,t,r={}){let s=e.safeParse(t);if(s.success)return s.data;let n=new Set(r.redactKeys??[]),a={};for(let[e,r]of Object.entries(t))a[e]=n.has(e)?"[REDACTED]":r;let i=function(e){let t=e.flatten(),r=[];for(let[e,s]of Object.entries(t.fieldErrors))Array.isArray(s)&&s.length>0&&r.push(`  • ${e}: ${s.join(", ")}`);return t.formErrors.length>0&&r.push(`  • ${t.formErrors.join(", ")}`),{formErrors:t.formErrors,fieldErrors:t.fieldErrors,readableMessage:r.length>0?`
${r.join("\n")}`:"Unknown validation error"}}(s.error);throw new g(`
╔════════════════════════════════════════════════════════════════════════════╗
║ ENVIRONMENT CONFIGURATION ERROR                                            ║
╚════════════════════════════════════════════════════════════════════════════╝

Your application failed to start due to invalid or missing environment variables.

ERRORS:${i.readableMessage}

TROUBLESHOOTING:
  1. Copy .env.example to .env if you haven't already
  2. Fill in all required values in your .env file
  3. Ensure all values match the expected format (URLs, numbers, etc.)
  4. Check that sensitive values meet minimum length requirements

For more details, see .env.example in the project root.
`,{errors:i,snapshot:a})}function h(e){return{appEnv:e,isDevelopment:"development"===e,isStaging:"staging"===e,isProduction:"production"===e}}e.s(["AppEnvSchema",0,u,"buildEnvMeta",()=>h,"loadEnv",()=>T],37966),e.s([],1466)},80608,e=>{"use strict";var t=e.i(46989);e.i(1466);var r=e.i(37966);let s=t.z.object({APP_ENV:r.AppEnvSchema.default("development"),NODE_ENV:t.z.enum(["development","production","test"]).default("development"),DATABASE_URL:t.z.string().url().describe("PostgreSQL connection string"),NEXTAUTH_SECRET:t.z.string().min(32).describe("Secret for NextAuth session encryption (min 32 chars)"),NEXTAUTH_URL:t.z.string().url().optional().describe("Canonical URL of your site"),DATA_ENCRYPTION_KEY:t.z.string().min(32).describe("AES-256 key for encrypting sensitive data (32+ chars)"),GOOGLE_OAUTH_CLIENT_ID:t.z.string().min(1).describe("Google OAuth 2.0 Client ID"),GOOGLE_OAUTH_CLIENT_SECRET:t.z.string().min(1).describe("Google OAuth 2.0 Client Secret"),GOOGLE_OAUTH_REDIRECT_URI:t.z.string().url().describe("OAuth redirect URI for Google"),GOOGLE_ADS_DEVELOPER_TOKEN:t.z.string().min(1).describe("Google Ads API Developer Token"),GOOGLE_ADS_LOGIN_CUSTOMER_ID:t.z.string().min(1).optional().describe("Google Ads Manager Account ID (optional)"),META_APP_ID:t.z.string().min(1).describe("Meta App ID"),META_APP_SECRET:t.z.string().min(1).describe("Meta App Secret"),META_OAUTH_REDIRECT_URI:t.z.string().url().describe("OAuth redirect URI for Meta"),META_API_VERSION:t.z.string().min(1).default("v20.0").describe("Meta Graph API version"),TIKTOK_APP_ID:t.z.string().min(1).describe("TikTok App ID"),TIKTOK_APP_SECRET:t.z.string().min(1).describe("TikTok App Secret"),TIKTOK_OAUTH_REDIRECT_URI:t.z.string().url().describe("OAuth redirect URI for TikTok"),TIKTOK_API_BASE_URL:t.z.string().url().default("https://business-api.tiktok.com").describe("TikTok Business API base URL"),STRIPE_SECRET_KEY:t.z.string().startsWith("sk_").optional().describe("Stripe secret key (must start with sk_)"),STRIPE_WEBHOOK_SECRET:t.z.string().startsWith("whsec_").optional().describe("Stripe webhook signing secret (must start with whsec_)"),NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:t.z.string().startsWith("pk_").optional().describe("Stripe publishable key (must start with pk_)"),SMTP_HOST:t.z.string().optional().describe("SMTP server hostname"),SMTP_PORT:t.z.coerce.number().int().min(1).max(65535).optional().describe("SMTP server port"),SMTP_USER:t.z.string().optional().describe("SMTP username"),SMTP_PASSWORD:t.z.string().optional().describe("SMTP password"),SMTP_FROM_EMAIL:t.z.string().email().optional().describe("From email address for notifications"),SMTP_FROM_NAME:t.z.string().optional().describe("From name for notifications")}),n=(0,r.loadEnv)(s,{APP_ENV:process.env.APP_ENV,NODE_ENV:"production",DATABASE_URL:process.env.DATABASE_URL,NEXTAUTH_SECRET:process.env.NEXTAUTH_SECRET,NEXTAUTH_URL:process.env.NEXTAUTH_URL,DATA_ENCRYPTION_KEY:process.env.DATA_ENCRYPTION_KEY,GOOGLE_OAUTH_CLIENT_ID:process.env.GOOGLE_OAUTH_CLIENT_ID,GOOGLE_OAUTH_CLIENT_SECRET:process.env.GOOGLE_OAUTH_CLIENT_SECRET,GOOGLE_OAUTH_REDIRECT_URI:process.env.GOOGLE_OAUTH_REDIRECT_URI,GOOGLE_ADS_DEVELOPER_TOKEN:process.env.GOOGLE_ADS_DEVELOPER_TOKEN,GOOGLE_ADS_LOGIN_CUSTOMER_ID:process.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID,META_APP_ID:process.env.META_APP_ID,META_APP_SECRET:process.env.META_APP_SECRET,META_OAUTH_REDIRECT_URI:process.env.META_OAUTH_REDIRECT_URI,META_API_VERSION:process.env.META_API_VERSION,TIKTOK_APP_ID:process.env.TIKTOK_APP_ID,TIKTOK_APP_SECRET:process.env.TIKTOK_APP_SECRET,TIKTOK_OAUTH_REDIRECT_URI:process.env.TIKTOK_OAUTH_REDIRECT_URI,TIKTOK_API_BASE_URL:process.env.TIKTOK_API_BASE_URL,STRIPE_SECRET_KEY:process.env.STRIPE_SECRET_KEY,STRIPE_WEBHOOK_SECRET:process.env.STRIPE_WEBHOOK_SECRET,NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY:process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,SMTP_HOST:process.env.SMTP_HOST,SMTP_PORT:process.env.SMTP_PORT,SMTP_USER:process.env.SMTP_USER,SMTP_PASSWORD:process.env.SMTP_PASSWORD,SMTP_FROM_EMAIL:process.env.SMTP_FROM_EMAIL,SMTP_FROM_NAME:process.env.SMTP_FROM_NAME},{redactKeys:["DATABASE_URL","NEXTAUTH_SECRET","DATA_ENCRYPTION_KEY","GOOGLE_OAUTH_CLIENT_SECRET","GOOGLE_ADS_DEVELOPER_TOKEN","META_APP_SECRET","TIKTOK_APP_SECRET","STRIPE_SECRET_KEY","STRIPE_WEBHOOK_SECRET","SMTP_PASSWORD"]}),a={...n,...(0,r.buildEnvMeta)(n.APP_ENV)};e.s(["env",0,a])},66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},75912,e=>{"use strict";e.i(55007);var t=e.i(66680),r=e.i(80608);let s="aes-256-gcm";function n(){let e=r.env.DATA_ENCRYPTION_KEY,t=Buffer.from(e,"base64");if(32!==t.length)throw Error("DATA_ENCRYPTION_KEY must be base64-encoded 32 bytes");return t}function a(e){let r=t.default.randomBytes(12),a=t.default.createCipheriv(s,n(),r),i=Buffer.concat([a.update(e,"utf8"),a.final()]),o=a.getAuthTag(),c={v:1,iv:r.toString("base64"),tag:o.toString("base64"),ct:i.toString("base64")};return Buffer.from(JSON.stringify(c),"utf8").toString("base64")}function i(e){let r=JSON.parse(Buffer.from(e,"base64").toString("utf8"));if(1!==r.v)throw Error("Unsupported encryption payload version");let a=Buffer.from(r.iv,"base64"),i=Buffer.from(r.tag,"base64"),o=Buffer.from(r.ct,"base64"),c=t.default.createDecipheriv(s,n(),a);return c.setAuthTag(i),Buffer.concat([c.update(o),c.final()]).toString("utf8")}function o(e){return a(JSON.stringify(e))}function c(e){return JSON.parse(i(e))}e.s(["decryptJson",()=>c,"decryptString",()=>i,"encryptJson",()=>o,"encryptString",()=>a])},33108,e=>{"use strict";e.i(55007);var t=e.i(80608),r=e.i(60806),s=e.i(75912);class n{baseUrl;constructor(){this.baseUrl=`https://graph.facebook.com/${t.env.META_API_VERSION}`}buildAuthUrl(e){let r=new URL("https://www.facebook.com/v20.0/dialog/oauth");return r.searchParams.set("client_id",t.env.META_APP_ID),r.searchParams.set("redirect_uri",t.env.META_OAUTH_REDIRECT_URI),r.searchParams.set("scope","ads_read,read_insights,business_management"),r.searchParams.set("response_type","code"),r.searchParams.set("state",e),r.toString()}async exchangeCode(e){let r=new URL(`${this.baseUrl}/oauth/access_token`);r.searchParams.set("client_id",t.env.META_APP_ID),r.searchParams.set("client_secret",t.env.META_APP_SECRET),r.searchParams.set("redirect_uri",t.env.META_OAUTH_REDIRECT_URI),r.searchParams.set("code",e);let s=await fetch(r,{method:"GET"}),n=await s.json().catch(()=>null);if(!s.ok||!n?.access_token)throw Error(`META_OAUTH_EXCHANGE_FAILED_${s.status}:${JSON.stringify(n)}`);return{access_token:String(n.access_token),token_type:n.token_type?String(n.token_type):void 0,expires_in:n.expires_in?Number(n.expires_in):void 0}}async exchangeForLongLivedToken(e){let r=new URL(`${this.baseUrl}/oauth/access_token`);r.searchParams.set("grant_type","fb_exchange_token"),r.searchParams.set("client_id",t.env.META_APP_ID),r.searchParams.set("client_secret",t.env.META_APP_SECRET),r.searchParams.set("fb_exchange_token",e);let s=await fetch(r,{method:"GET"}),n=await s.json().catch(()=>null);if(!s.ok||!n?.access_token)throw Error(`META_OAUTH_LONG_LIVED_FAILED_${s.status}:${JSON.stringify(n)}`);return{access_token:String(n.access_token),token_type:n.token_type?String(n.token_type):void 0,expires_in:n.expires_in?Number(n.expires_in):void 0}}async getValidAccessToken(e){let t=await r.prisma.metaAdsCredential.findUnique({where:{organizationId_adAccountId:{organizationId:e.organizationId,adAccountId:e.metaAdAccountId}},select:{accessTokenEnc:!0,accessTokenExpiresAt:!0}});if(!t)throw Error("META_ADS_NOT_CONNECTED");let n=Date.now();if((t.accessTokenExpiresAt?.getTime()??0)-n>6048e5)return{accessToken:(0,s.decryptString)(t.accessTokenEnc)};let a=(0,s.decryptString)(t.accessTokenEnc),i=await this.exchangeForLongLivedToken(a),o=i.expires_in?new Date(Date.now()+1e3*i.expires_in):null;return await r.prisma.metaAdsCredential.update({where:{organizationId_adAccountId:{organizationId:e.organizationId,adAccountId:e.metaAdAccountId}},data:{accessTokenEnc:(0,s.encryptString)(i.access_token),accessTokenExpiresAt:o},select:{id:!0}}),{accessToken:i.access_token}}async fetchWithRetry(e,t=0){let r=await fetch(e,{method:"GET"});if(429!==r.status&&503!==r.status||t>=6)return r;let s=r.headers.get("retry-after"),n=s?1e3*Number.parseInt(s,10):0,a=Math.min(3e4,2**t*500+Math.floor(250*Math.random()));return await new Promise(e=>setTimeout(e,Math.max(n,a))),this.fetchWithRetry(e,t+1)}async fetchDailyCampaignInsights(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,metaAdAccountId:e.metaAdAccountId}),r=new URL(`${this.baseUrl}/${e.metaAdAccountId}/insights`);r.searchParams.set("fields","date_start,campaign_id,campaign_name,impressions,clicks,spend,actions,publisher_platform"),r.searchParams.set("level","campaign"),r.searchParams.set("time_increment","1"),r.searchParams.set("time_range",JSON.stringify({since:e.startDate,until:e.endDate})),r.searchParams.set("breakdowns","publisher_platform"),r.searchParams.set("access_token",t);let s=await this.fetchWithRetry(r.toString()),n=await s.json().catch(()=>null);if(!s.ok)throw Error(`META_API_ERROR_${s.status}:${JSON.stringify(n)}`);return(n?.data??[]).map(a)}async fetchDailyAdInsights(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,metaAdAccountId:e.metaAdAccountId}),r=new URL(`${this.baseUrl}/${e.metaAdAccountId}/insights`);r.searchParams.set("fields","date_start,campaign_id,campaign_name,ad_id,ad_name,impressions,clicks,spend,actions,publisher_platform"),r.searchParams.set("level","ad"),r.searchParams.set("time_increment","1"),r.searchParams.set("time_range",JSON.stringify({since:e.startDate,until:e.endDate})),r.searchParams.set("breakdowns","publisher_platform"),r.searchParams.set("access_token",t);let s=await this.fetchWithRetry(r.toString()),n=await s.json().catch(()=>null);if(!s.ok)throw Error(`META_API_ERROR_${s.status}:${JSON.stringify(n)}`);return(n?.data??[]).map(a)}}function a(e){let t;return{date:String(e?.date_start),publisherPlatform:String(e?.publisher_platform??"facebook"),campaignId:String(e?.campaign_id),campaignName:String(e?.campaign_name??""),adId:e?.ad_id?String(e.ad_id):void 0,adName:e?.ad_name?String(e.ad_name):void 0,impressions:BigInt(e?.impressions??0),clicks:BigInt(e?.clicks??0),spendMicros:Number.isFinite(t=Number(e?.spend??0))?BigInt(Math.round(1e6*t)):0n,conversions:function(e){if(!Array.isArray(e))return 0n;let t=new Set(["purchase","offsite_conversion.purchase","omni_purchase","complete_registration","lead"]),r=0n;for(let s of e){let e=s?.action_type,n=s?.value;e&&t.has(e)&&(r+=BigInt(Number(n??0)))}return r}(e?.actions)}}e.s(["MetaAdsService",()=>n])},53156,e=>{"use strict";e.i(55007);var t=e.i(80608),r=e.i(60806),s=e.i(75912);class n{baseUrl;constructor(){this.baseUrl=t.env.TIKTOK_API_BASE_URL}buildAuthUrl(e){let r=new URL("https://www.tiktok.com/v2/auth/authorize/");return r.searchParams.set("client_key",t.env.TIKTOK_APP_ID),r.searchParams.set("redirect_uri",t.env.TIKTOK_OAUTH_REDIRECT_URI),r.searchParams.set("response_type","code"),r.searchParams.set("scope","ads.read,reporting.read"),r.searchParams.set("state",e.state),r.toString()}async exchangeCode(e){let r=new URL("/open_api/v1.3/oauth2/access_token/",this.baseUrl),s=await fetch(r,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:t.env.TIKTOK_APP_ID,secret:t.env.TIKTOK_APP_SECRET,auth_code:e,grant_type:"authorization_code"})}),n=await s.json().catch(()=>null);if(!s.ok||!n||0!==n.code||!n.data)throw Error(`TIKTOK_OAUTH_EXCHANGE_FAILED_${s.status}:${JSON.stringify(n)}`);return n.data}async refreshToken(e){let r=new URL("/open_api/v1.3/oauth2/refresh_token/",this.baseUrl),s=await fetch(r,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:t.env.TIKTOK_APP_ID,secret:t.env.TIKTOK_APP_SECRET,refresh_token:e,grant_type:"refresh_token"})}),n=await s.json().catch(()=>null);if(!s.ok||!n||0!==n.code||!n.data)throw Error(`TIKTOK_OAUTH_REFRESH_FAILED_${s.status}:${JSON.stringify(n)}`);return n.data}async getValidAccessToken(e){let t=await r.prisma.tikTokAdsCredential.findUnique({where:{organizationId_advertiserId:{organizationId:e.organizationId,advertiserId:e.advertiserId}},select:{accessTokenEnc:!0,refreshTokenEnc:!0,accessTokenExpiresAt:!0,refreshTokenExpiresAt:!0}});if(!t)throw Error("TIKTOK_ADS_NOT_CONNECTED");let n=Date.now(),a=t.accessTokenExpiresAt?.getTime()??0;if(t.accessTokenEnc&&a-n>6e4)return{accessToken:(0,s.decryptString)(t.accessTokenEnc)};let i=t.refreshTokenExpiresAt?.getTime()??0;if(i&&i-n<=0)throw Error("TIKTOK_REFRESH_TOKEN_EXPIRED");let o=(0,s.decryptString)(t.refreshTokenEnc),c=await this.refreshToken(o),d=new Date(Date.now()+1e3*c.expires_in),_=new Date(Date.now()+1e3*c.refresh_expires_in);return await r.prisma.tikTokAdsCredential.update({where:{organizationId_advertiserId:{organizationId:e.organizationId,advertiserId:e.advertiserId}},data:{accessTokenEnc:(0,s.encryptString)(c.access_token),refreshTokenEnc:(0,s.encryptString)(c.refresh_token),accessTokenExpiresAt:d,refreshTokenExpiresAt:_},select:{id:!0}}),{accessToken:c.access_token}}async fetchWithRetry(e,t,r=0){let s=await fetch(e,t);if(429!==s.status&&503!==s.status||r>=6)return s;let n=s.headers.get("retry-after"),a=n?1e3*Number.parseInt(n,10):0,i=Math.min(3e4,2**r*500+Math.floor(250*Math.random()));return await new Promise(e=>setTimeout(e,Math.max(a,i))),this.fetchWithRetry(e,t,r+1)}async fetchDailyCampaignReport(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,advertiserId:e.advertiserId}),r=new URL("/open_api/v1.3/report/integrated/get/",this.baseUrl),s={advertiser_id:e.advertiserId,report_type:"BASIC",dimensions:["stat_time_day","campaign_id"],metrics:["spend","impressions","clicks","conversion"],start_date:e.startDate,end_date:e.endDate,page:1,page_size:1e3},n=await this.fetchWithRetry(r.toString(),{method:"POST",headers:{"content-type":"application/json","access-token":t},body:JSON.stringify(s)}),a=await n.json().catch(()=>null);if(!n.ok||!a||0!==a.code)throw Error(`TIKTOK_REPORT_ERROR_${n.status}:${JSON.stringify(a)}`);return(a.data?.list??[]).map(i)}async fetchDailyAdReport(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,advertiserId:e.advertiserId}),r=new URL("/open_api/v1.3/report/integrated/get/",this.baseUrl),s={advertiser_id:e.advertiserId,report_type:"BASIC",dimensions:["stat_time_day","campaign_id","ad_id"],metrics:["spend","impressions","clicks","conversion"],start_date:e.startDate,end_date:e.endDate,page:1,page_size:1e3},n=await this.fetchWithRetry(r.toString(),{method:"POST",headers:{"content-type":"application/json","access-token":t},body:JSON.stringify(s)}),a=await n.json().catch(()=>null);if(!n.ok||!a||0!==a.code)throw Error(`TIKTOK_REPORT_ERROR_${n.status}:${JSON.stringify(a)}`);return(a.data?.list??[]).map(o)}}function a(e){let t=Number(e??0);return Number.isFinite(t)?BigInt(Math.round(1e6*t)):0n}function i(e){return{date:String(e?.dimensions?.stat_time_day??e?.stat_time_day),campaignId:String(e?.dimensions?.campaign_id??e?.campaign_id),campaignName:String(e?.dimensions?.campaign_name??""),impressions:BigInt(e?.metrics?.impressions??e?.impressions??0),clicks:BigInt(e?.metrics?.clicks??e?.clicks??0),conversions:BigInt(e?.metrics?.conversion??e?.conversion??0),spendMicros:a(e?.metrics?.spend??e?.spend??0)}}function o(e){return{date:String(e?.dimensions?.stat_time_day??e?.stat_time_day),campaignId:String(e?.dimensions?.campaign_id??e?.campaign_id),campaignName:String(e?.dimensions?.campaign_name??""),adId:String(e?.dimensions?.ad_id??e?.ad_id),adName:e?.dimensions?.ad_name?String(e.dimensions.ad_name):void 0,impressions:BigInt(e?.metrics?.impressions??e?.impressions??0),clicks:BigInt(e?.metrics?.clicks??e?.clicks??0),conversions:BigInt(e?.metrics?.conversion??e?.conversion??0),spendMicros:a(e?.metrics?.spend??e?.spend??0)}}e.s(["TikTokAdsService",()=>n])},33405,(e,t,r)=>{t.exports=e.x("child_process",()=>require("child_process"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},46786,(e,t,r)=>{t.exports=e.x("os",()=>require("os"))},70722,(e,t,r)=>{t.exports=e.x("tty",()=>require("tty"))},46926,(e,t,r)=>{"use strict";t.exports=(e,t=process.argv)=>{let r=e.startsWith("-")?"":1===e.length?"-":"--",s=t.indexOf(r+e),n=t.indexOf("--");return -1!==s&&(-1===n||s<n)}},72743,(e,t,r)=>{"use strict";let s,n=e.r(46786),a=e.r(70722),i=e.r(46926),{env:o}=process;function c(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function d(e,t){if(0===s)return 0;if(i("color=16m")||i("color=full")||i("color=truecolor"))return 3;if(i("color=256"))return 2;if(e&&!t&&void 0===s)return 0;let r=s||0;if("dumb"===o.TERM)return r;{let e=n.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}}i("no-color")||i("no-colors")||i("color=false")||i("color=never")?s=0:(i("color")||i("colors")||i("color=true")||i("color=always"))&&(s=1),"FORCE_COLOR"in o&&(s="true"===o.FORCE_COLOR?1:"false"===o.FORCE_COLOR?0:0===o.FORCE_COLOR.length?1:Math.min(parseInt(o.FORCE_COLOR,10),3)),t.exports={supportsColor:function(e){return c(d(e,e&&e.isTTY))},stdout:c(d(!0,a.isatty(1))),stderr:c(d(!0,a.isatty(2)))}},12057,(e,t,r)=>{t.exports=e.x("node:util",()=>require("node:util"))},63356,e=>{"use strict";e.i(55007);var t=e.i(80268),r=e.i(80608),s=e.i(60806),n=e.i(75912);class a{oauth;constructor(){this.oauth=new t.OAuth2Client({clientId:r.env.GOOGLE_OAUTH_CLIENT_ID,clientSecret:r.env.GOOGLE_OAUTH_CLIENT_SECRET,redirectUri:r.env.GOOGLE_OAUTH_REDIRECT_URI})}buildAuthUrl(e){return this.oauth.generateAuthUrl({access_type:"offline",prompt:"consent",scope:["https://www.googleapis.com/auth/adwords"],include_granted_scopes:!0,state:e})}async exchangeCode(e){let{tokens:t}=await this.oauth.getToken(e);return{access_token:t.access_token??"",expires_in:t.expiry_date?Math.max(0,Math.floor((t.expiry_date-Date.now())/1e3)):void 0,scope:t.scope??void 0,refresh_token:t.refresh_token??void 0,token_type:t.token_type??void 0}}async refreshAccessToken(e){this.oauth.setCredentials({refresh_token:e});let{credentials:t}=await this.oauth.refreshAccessToken();return{access_token:t.access_token??"",expires_in:t.expiry_date?Math.max(0,Math.floor((t.expiry_date-Date.now())/1e3)):void 0,scope:t.scope??void 0,token_type:t.token_type??void 0}}async getValidAccessToken(e){let t=await s.prisma.googleAdsCredential.findUnique({where:{organizationId_customerId:{organizationId:e.organizationId,customerId:e.customerId}},select:{refreshTokenEnc:!0,accessTokenEnc:!0,accessTokenExpiresAt:!0}});if(!t)throw Error("GOOGLE_ADS_NOT_CONNECTED");let r=Date.now(),a=t.accessTokenExpiresAt?.getTime()??0;if(t.accessTokenEnc&&a-r>6e4)return{accessToken:(0,n.decryptString)(t.accessTokenEnc)};let i=(0,n.decryptString)(t.refreshTokenEnc),o=await this.refreshAccessToken(i);if(!o.access_token)throw Error("GOOGLE_OAUTH_REFRESH_FAILED");let c=o.expires_in?new Date(Date.now()+1e3*o.expires_in):null;return await s.prisma.googleAdsCredential.update({where:{organizationId_customerId:{organizationId:e.organizationId,customerId:e.customerId}},data:{accessTokenEnc:(0,n.encryptString)(o.access_token),accessTokenExpiresAt:c},select:{id:!0}}),{accessToken:o.access_token}}async fetchWithRetry(e,t,r=0){let s=await fetch(e,t);if(429!==s.status&&503!==s.status||r>=6)return s;let n=s.headers.get("retry-after"),a=n?1e3*Number.parseInt(n,10):0,i=Math.min(3e4,2**r*500+Math.floor(250*Math.random()));return await new Promise(e=>setTimeout(e,Math.max(a,i))),this.fetchWithRetry(e,t,r+1)}async googleAdsSearch(e){let t=`https://googleads.googleapis.com/v16/customers/${e.customerId}/googleAds:searchStream`,s={authorization:`Bearer ${e.accessToken}`,"developer-token":r.env.GOOGLE_ADS_DEVELOPER_TOKEN,"content-type":"application/json"};r.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID&&(s["login-customer-id"]=r.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID);let n=await this.fetchWithRetry(t,{method:"POST",headers:s,body:JSON.stringify({query:e.query})});if(!n.ok){let e=await n.text().catch(()=>"");throw Error(`GOOGLE_ADS_API_ERROR_${n.status}:${e}`)}return await n.json()}async fetchDailyCampaignMetrics(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,customerId:e.customerId}),r=`
      SELECT
        segments.date,
        campaign.id,
        campaign.name,
        metrics.impressions,
        metrics.clicks,
        metrics.conversions,
        metrics.cost_micros
      FROM campaign
      WHERE segments.date BETWEEN '${e.startDate}' AND '${e.endDate}'
    `,s=await this.googleAdsSearch({customerId:e.customerId,accessToken:t,query:r}),n=[];for(let e of s){let t=e?.results;if(t)for(let e of t)n.push({date:String(e?.segments?.date),campaignId:String(e?.campaign?.id),campaignName:String(e?.campaign?.name??""),impressions:BigInt(e?.metrics?.impressions??0),clicks:BigInt(e?.metrics?.clicks??0),conversions:BigInt(e?.metrics?.conversions??0),costMicros:BigInt(e?.metrics?.costMicros??e?.metrics?.cost_micros??0)})}return n}async fetchDailyAdMetrics(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,customerId:e.customerId}),r=`
      SELECT
        segments.date,
        campaign.id,
        campaign.name,
        ad_group_ad.ad.id,
        ad_group_ad.ad.name,
        metrics.impressions,
        metrics.clicks,
        metrics.conversions,
        metrics.cost_micros
      FROM ad_group_ad
      WHERE segments.date BETWEEN '${e.startDate}' AND '${e.endDate}'
    `,s=await this.googleAdsSearch({customerId:e.customerId,accessToken:t,query:r}),n=[];for(let e of s){let t=e?.results;if(t)for(let e of t)n.push({date:String(e?.segments?.date),campaignId:String(e?.campaign?.id),campaignName:String(e?.campaign?.name??""),adId:String(e?.adGroupAd?.ad?.id??e?.ad_group_ad?.ad?.id),adName:String(e?.adGroupAd?.ad?.name??e?.ad_group_ad?.ad?.name??""),impressions:BigInt(e?.metrics?.impressions??0),clicks:BigInt(e?.metrics?.clicks??0),conversions:BigInt(e?.metrics?.conversions??0),costMicros:BigInt(e?.metrics?.costMicros??e?.metrics?.cost_micros??0)})}return n}}e.s(["GoogleAdsService",()=>a])},81897,23354,e=>{"use strict";e.i(55007);var t=e.i(60806),r=e.i(46989);let s=r.z.object({platform:r.z.enum(["GOOGLE_ADS","META","TIKTOK"]),externalAccountId:r.z.string().min(1),startDate:r.z.string().regex(/^\d{4}-\d{2}-\d{2}$/),endDate:r.z.string().regex(/^\d{4}-\d{2}-\d{2}$/),granularity:r.z.enum(["campaign","ad"])});function n(e){return["daily-sync",e.organizationId,e.platform,e.externalAccountId,e.startDate,e.endDate,e.granularity].join(":")}async function a(e){let r=n({organizationId:e.organizationId,platform:e.payload.platform,externalAccountId:e.payload.externalAccountId,startDate:e.payload.startDate,endDate:e.payload.endDate,granularity:e.payload.granularity});return await t.prisma.ingestionJob.upsert({where:{idempotencyKey:r},create:{organizationId:e.organizationId,platform:e.payload.platform,jobType:"DAILY_SYNC",status:"QUEUED",idempotencyKey:r,payload:e.payload,runAt:e.runAt??new Date,attempts:0,maxAttempts:8},update:{runAt:e.runAt??new Date,status:"QUEUED"},select:{id:!0,status:!0,runAt:!0,idempotencyKey:!0}})}function i(e){let t=Math.min(18e5,2**Math.min(e,10)*1e3+Math.floor(250*Math.random()));return new Date(Date.now()+t)}e.s(["DailySyncPayloadSchema",0,s,"buildIdempotencyKey",()=>n],23354),e.s(["computeNextRunAt",()=>i,"enqueueDailySync",()=>a],81897)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__a3d2c395._.js.map