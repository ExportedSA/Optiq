module.exports=[66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},75912,e=>{"use strict";e.i(55007);var t=e.i(66680),r=e.i(80608);let a="aes-256-gcm";function n(){let e=r.env.DATA_ENCRYPTION_KEY,t=Buffer.from(e,"base64");if(32!==t.length)throw Error("DATA_ENCRYPTION_KEY must be base64-encoded 32 bytes");return t}function s(e){let r=t.default.randomBytes(12),s=t.default.createCipheriv(a,n(),r),o=Buffer.concat([s.update(e,"utf8"),s.final()]),i=s.getAuthTag(),c={v:1,iv:r.toString("base64"),tag:i.toString("base64"),ct:o.toString("base64")};return Buffer.from(JSON.stringify(c),"utf8").toString("base64")}function o(e){let r=JSON.parse(Buffer.from(e,"base64").toString("utf8"));if(1!==r.v)throw Error("Unsupported encryption payload version");let s=Buffer.from(r.iv,"base64"),o=Buffer.from(r.tag,"base64"),i=Buffer.from(r.ct,"base64"),c=t.default.createDecipheriv(a,n(),s);return c.setAuthTag(o),Buffer.concat([c.update(i),c.final()]).toString("utf8")}function i(e){return s(JSON.stringify(e))}function c(e){return JSON.parse(o(e))}e.s(["decryptJson",()=>c,"decryptString",()=>o,"encryptJson",()=>i,"encryptString",()=>s])},85302,e=>{"use strict";e.i(55007);var t=e.i(68050),r=e.i(16336);async function a(){let e=await (0,t.getServerSession)(r.authOptions);if(!e?.user?.id)throw Error("UNAUTHENTICATED");return e}async function n(){let e=(await a()).user.activeOrgId;if(!e)throw Error("NO_ACTIVE_ORG");return e}e.s(["requireActiveOrgId",()=>n])},33405,(e,t,r)=>{t.exports=e.x("child_process",()=>require("child_process"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},46786,(e,t,r)=>{t.exports=e.x("os",()=>require("os"))},70722,(e,t,r)=>{t.exports=e.x("tty",()=>require("tty"))},46926,(e,t,r)=>{"use strict";t.exports=(e,t=process.argv)=>{let r=e.startsWith("-")?"":1===e.length?"-":"--",a=t.indexOf(r+e),n=t.indexOf("--");return -1!==a&&(-1===n||a<n)}},72743,(e,t,r)=>{"use strict";let a,n=e.r(46786),s=e.r(70722),o=e.r(46926),{env:i}=process;function c(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function u(e,t){if(0===a)return 0;if(o("color=16m")||o("color=full")||o("color=truecolor"))return 3;if(o("color=256"))return 2;if(e&&!t&&void 0===a)return 0;let r=a||0;if("dumb"===i.TERM)return r;{let e=n.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}}o("no-color")||o("no-colors")||o("color=false")||o("color=never")?a=0:(o("color")||o("colors")||o("color=true")||o("color=always"))&&(a=1),"FORCE_COLOR"in i&&(a="true"===i.FORCE_COLOR?1:"false"===i.FORCE_COLOR?0:0===i.FORCE_COLOR.length?1:Math.min(parseInt(i.FORCE_COLOR,10),3)),t.exports={supportsColor:function(e){return c(u(e,e&&e.isTTY))},stdout:c(u(!0,s.isatty(1))),stderr:c(u(!0,s.isatty(2)))}},12057,(e,t,r)=>{t.exports=e.x("node:util",()=>require("node:util"))},63356,e=>{"use strict";e.i(55007);var t=e.i(80268),r=e.i(80608),a=e.i(60806),n=e.i(75912);class s{oauth;constructor(){this.oauth=new t.OAuth2Client({clientId:r.env.GOOGLE_OAUTH_CLIENT_ID,clientSecret:r.env.GOOGLE_OAUTH_CLIENT_SECRET,redirectUri:r.env.GOOGLE_OAUTH_REDIRECT_URI})}buildAuthUrl(e){return this.oauth.generateAuthUrl({access_type:"offline",prompt:"consent",scope:["https://www.googleapis.com/auth/adwords"],include_granted_scopes:!0,state:e})}async exchangeCode(e){let{tokens:t}=await this.oauth.getToken(e);return{access_token:t.access_token??"",expires_in:t.expiry_date?Math.max(0,Math.floor((t.expiry_date-Date.now())/1e3)):void 0,scope:t.scope??void 0,refresh_token:t.refresh_token??void 0,token_type:t.token_type??void 0}}async refreshAccessToken(e){this.oauth.setCredentials({refresh_token:e});let{credentials:t}=await this.oauth.refreshAccessToken();return{access_token:t.access_token??"",expires_in:t.expiry_date?Math.max(0,Math.floor((t.expiry_date-Date.now())/1e3)):void 0,scope:t.scope??void 0,token_type:t.token_type??void 0}}async getValidAccessToken(e){let t=await a.prisma.integrationConnection.findFirst({where:{organizationId:e.organizationId,platformCode:"GOOGLE_ADS",externalAccountId:e.customerId,status:"CONNECTED"},select:{refreshTokenEnc:!0,accessTokenEnc:!0,accessTokenExpiresAt:!0}});if(!t)throw Error("GOOGLE_ADS_NOT_CONNECTED");let r=Date.now(),s=t.accessTokenExpiresAt?.getTime()??0;if(t.accessTokenEnc&&s-r>6e4)return{accessToken:(0,n.decryptString)(t.accessTokenEnc)};if(!t.refreshTokenEnc)throw Error("GOOGLE_ADS_NO_REFRESH_TOKEN");let o=(0,n.decryptString)(t.refreshTokenEnc),i=await this.refreshAccessToken(o);if(!i.access_token)throw Error("GOOGLE_OAUTH_REFRESH_FAILED");let c=i.expires_in?new Date(Date.now()+1e3*i.expires_in):null;return await a.prisma.integrationConnection.updateMany({where:{organizationId:e.organizationId,platformCode:"GOOGLE_ADS",externalAccountId:e.customerId},data:{accessTokenEnc:(0,n.encryptString)(i.access_token),accessTokenExpiresAt:c}}),{accessToken:i.access_token}}async fetchWithRetry(e,t,r=0){let a=await fetch(e,t);if(429!==a.status&&503!==a.status||r>=6)return a;let n=a.headers.get("retry-after"),s=n?1e3*Number.parseInt(n,10):0,o=Math.min(3e4,2**r*500+Math.floor(250*Math.random()));return await new Promise(e=>setTimeout(e,Math.max(s,o))),this.fetchWithRetry(e,t,r+1)}async googleAdsSearch(e){let t=`https://googleads.googleapis.com/v16/customers/${e.customerId}/googleAds:searchStream`,a={authorization:`Bearer ${e.accessToken}`,"developer-token":r.env.GOOGLE_ADS_DEVELOPER_TOKEN,"content-type":"application/json"};r.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID&&(a["login-customer-id"]=r.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID);let n=await this.fetchWithRetry(t,{method:"POST",headers:a,body:JSON.stringify({query:e.query})});if(!n.ok){let e=await n.text().catch(()=>"");throw Error(`GOOGLE_ADS_API_ERROR_${n.status}:${e}`)}return await n.json()}async fetchDailyCampaignMetrics(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,customerId:e.customerId}),r=`
      SELECT
        segments.date,
        campaign.id,
        campaign.name,
        metrics.impressions,
        metrics.clicks,
        metrics.conversions,
        metrics.cost_micros
      FROM campaign
      WHERE segments.date BETWEEN '${e.startDate}' AND '${e.endDate}'
    `,a=await this.googleAdsSearch({customerId:e.customerId,accessToken:t,query:r}),n=[];for(let e of a){let t=e?.results;if(t)for(let e of t)n.push({date:String(e?.segments?.date),campaignId:String(e?.campaign?.id),campaignName:String(e?.campaign?.name??""),impressions:BigInt(e?.metrics?.impressions??0),clicks:BigInt(e?.metrics?.clicks??0),conversions:BigInt(e?.metrics?.conversions??0),costMicros:BigInt(e?.metrics?.costMicros??e?.metrics?.cost_micros??0)})}return n}async fetchDailyAdMetrics(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,customerId:e.customerId}),r=`
      SELECT
        segments.date,
        campaign.id,
        campaign.name,
        ad_group_ad.ad.id,
        ad_group_ad.ad.name,
        metrics.impressions,
        metrics.clicks,
        metrics.conversions,
        metrics.cost_micros
      FROM ad_group_ad
      WHERE segments.date BETWEEN '${e.startDate}' AND '${e.endDate}'
    `,a=await this.googleAdsSearch({customerId:e.customerId,accessToken:t,query:r}),n=[];for(let e of a){let t=e?.results;if(t)for(let e of t)n.push({date:String(e?.segments?.date),campaignId:String(e?.campaign?.id),campaignName:String(e?.campaign?.name??""),adId:String(e?.adGroupAd?.ad?.id??e?.ad_group_ad?.ad?.id),adName:String(e?.adGroupAd?.ad?.name??e?.ad_group_ad?.ad?.name??""),impressions:BigInt(e?.metrics?.impressions??0),clicks:BigInt(e?.metrics?.clicks??0),conversions:BigInt(e?.metrics?.conversions??0),costMicros:BigInt(e?.metrics?.costMicros??e?.metrics?.cost_micros??0)})}return n}}e.s(["GoogleAdsService",()=>s])},83564,e=>{"use strict";var t=e.i(56884),r=e.i(42064),a=e.i(1824),n=e.i(99326),s=e.i(18794),o=e.i(83629),i=e.i(41446),c=e.i(61251),u=e.i(5708),l=e.i(59092),d=e.i(99563),p=e.i(39870),h=e.i(8016),g=e.i(7624),f=e.i(70065),m=e.i(36141),E=e.i(93695);e.i(58762);var _=e.i(24378),O=e.i(70081),R=e.i(85302),v=e.i(63356),A=e.i(75912);async function T(e){let t=await (0,R.requireActiveOrgId)(),r=new URL(e.url).searchParams.get("customerId");if(!r)return O.NextResponse.json({error:"missing_customerId"},{status:400});let a=(0,A.encryptJson)({orgId:t,customerId:r,ts:Date.now()}),n=new v.GoogleAdsService().buildAuthUrl(a);return O.NextResponse.redirect(n)}e.s(["GET",()=>T],33298);var w=e.i(33298);let y=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/integrations/google-ads/oauth/start/route",pathname:"/api/integrations/google-ads/oauth/start",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/integrations/google-ads/oauth/start/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:C,workUnitAsyncStorage:I,serverHooks:x}=y;function S(){return(0,a.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:I})}async function N(e,t,a){y.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let O="/api/integrations/google-ads/oauth/start/route";O=O.replace(/\/index$/,"")||"/";let R=await y.prepare(e,t,{srcPage:O,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:A,nextConfig:T,parsedUrl:w,isDraftMode:C,prerenderManifest:I,routerServerContext:x,isOnDemandRevalidate:S,revalidateOnlyGenerated:N,resolvedPathname:k,clientReferenceManifest:D,serverActionsManifest:b}=R,M=(0,c.normalizeAppPath)(O),G=!!(I.dynamicRoutes[M]||I.routes[k]),L=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,w,!1):t.end("This page could not be found"),null);if(G&&!C){let e=!!I.routes[k],t=I.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await L();throw new E.NoFallbackError}}let P=null;!G||y.isDev||C||(P="/index"===(P=k)?"/":P);let U=!0===y.isDev||!G,q=G&&!U;b&&D&&(0,o.setReferenceManifestsSingleton)({page:O,clientReferenceManifest:D,serverActionsManifest:b,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:b})});let B=e.method||"GET",H=(0,s.getTracer)(),F=H.getActiveScopeSpan(),$={params:A,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>y.onRequestError(e,t,a,x)},sharedContext:{buildId:v}},j=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),z=l.NextRequestAdapter.fromNodeNextRequest(j,(0,l.signalFromNodeResponse)(t));try{let o=async e=>y.handle(z,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${B} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${O}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var s,c;let u=async({previousCacheEntry:r})=>{try{if(!i&&S&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(n);e.fetchMetrics=$.renderOpts.fetchMetrics;let c=$.renderOpts.pendingWaitUntil;c&&a.waitUntil&&(a.waitUntil(c),c=void 0);let u=$.renderOpts.collectedTags;if(!G)return await (0,h.sendResponse)(j,K,s,$.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[m.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,a=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:_.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await y.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:S})},x),t}},l=await y.handleResponse({req:e,nextConfig:T,cacheKey:P,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:i});if(!G)return null;if((null==l||null==(s=l.value)?void 0:s.kind)!==_.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(c=l.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",S?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(l.value.headers);return i&&G||d.delete(m.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,f.getCacheControlHeader)(l.cacheControl)),await (0,h.sendResponse)(j,K,new Response(l.value.body,{headers:d,status:l.value.status||200})),null};F?await c(F):await H.withPropagatedContext(e.headers,()=>H.trace(d.BaseServerSpan.handleRequest,{spanName:`${B} ${O}`,kind:s.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},c))}catch(t){if(t instanceof E.NoFallbackError||await y.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:S})}),G)throw t;return await (0,h.sendResponse)(j,K,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>S,"routeModule",()=>y,"serverHooks",()=>x,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>I],83564)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__4091623a._.js.map