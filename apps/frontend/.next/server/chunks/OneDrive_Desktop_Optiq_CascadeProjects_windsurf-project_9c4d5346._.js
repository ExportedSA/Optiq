module.exports=[25881,(e,t,n)=>{"use strict";t.exports=e.r(13493).vendored["react-rsc"].ReactServerDOMTurbopackServer},86040,(e,t,n)=>{"use strict";Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"registerServerReference",{enumerable:!0,get:function(){return i.registerServerReference}});let i=e.r(25881)},67650,(e,t,n)=>{"use strict";function i(e){for(let t=0;t<e.length;t++){let n=e[t];if("function"!=typeof n)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof n}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"ensureServerEntryExports",{enumerable:!0,get:function(){return i}})},38478,39063,12329,e=>{"use strict";e.i(55007);var t=e.i(60806);let n={spendThresholdMicros:BigInt(5e7),targetCpaMicros:BigInt(25e6),cpaTolerancePercent:50,minImpressions:1e3,minCtrPercent:.5,rollingWindowDays:7};function i(e){return Number(e)/1e6}function r(e,t){return t===BigInt(0)?null:Number(e)/Number(t)}function s(e,t){return t===BigInt(0)?0:Number(e)/Number(t)*100}function a(e,t,n){let r=i(e),s=i(t.spendThresholdMicros);if("zero_conversions_high_spend"===n)return r>=5*s?"critical":r>=2*s?"high":r>=s?"medium":"low";if("cpa_above_target"===n){if(r>=3*s)return"high";if(r>=s)return"medium"}return"low"}function o(e,t){let n=t??new Date;n.setHours(23,59,59,999);let i=new Date(n);return i.setDate(i.getDate()-e+1),i.setHours(0,0,0,0),{start:i,end:n,days:e}}function d(e,t,n,i){let r=i.toISOString().split("T")[0];return`${e}_${t}_${n}_${r}`}function c(e,t){switch(e){case"zero_conversions_high_spend":return`Consider pausing this ${t.entityType.replace("_"," ")} or reviewing targeting. Spent $${i(t.spendMicros).toFixed(2)} with no conversions.`;case"cpa_above_target":let n=r(t.spendMicros,t.conversions);return`CPA of $${n?.toFixed(2)??"N/A"} exceeds target. Review ad creative, landing page, or audience targeting.`;case"low_ctr_high_spend":let a=s(t.clicks,t.impressions);return`CTR of ${a.toFixed(2)}% is below threshold. Consider refreshing creative or adjusting targeting.`;case"declining_performance":return"Performance has declined over the analysis period. Review recent changes and consider optimization.";default:return`Review this ${t.entityType.replace("_"," ")} for potential optimization opportunities.`}}e.s(["DEFAULT_WASTE_CONFIG",0,n,"computeCpa",()=>r,"computeCtr",()=>s,"determineWasteLevel",()=>a,"microsToDollars",()=>i],39063);class l{config;constructor(e={}){this.config={...n,...e}}async evaluateOrganization(e){let t=o(e.windowDays??this.config.rollingWindowDays,e.endDate),[n,i,r]=await Promise.all([this.evaluateAdAccounts(e.organizationId,t),this.evaluateCampaigns(e.organizationId,t),this.evaluateAds(e.organizationId,t)]),s=[...n,...i,...r],a=s.reduce((e,t)=>e+t.spendMicros,BigInt(0)),d={none:0,low:0,medium:0,high:0,critical:0},c={zero_conversions_high_spend:0,cpa_above_target:0,low_ctr_high_spend:0,declining_performance:0},l={ad_account:0,campaign:0,ad:0};for(let e of s)d[e.level]++,c[e.reason]++,l[e.entityType]++;return{organizationId:e.organizationId,windowStart:t.start,windowEnd:t.end,totalWastedSpendMicros:a,alerts:s,byLevel:d,byReason:c,byEntityType:l}}async evaluateAdAccounts(e,n){let i=await t.prisma.dailyAdAccountMetric.groupBy({by:["adAccountId"],where:{organizationId:e,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),r=[];for(let s of i){let i=await t.prisma.adAccount.findUnique({where:{id:s.adAccountId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!i)continue;let a={entityId:s.adAccountId,entityName:i.name,entityType:"ad_account",platformCode:i.platform.code,impressions:s._sum.impressions??BigInt(0),clicks:s._sum.clicks??BigInt(0),spendMicros:s._sum.spendMicros??BigInt(0),conversions:s._sum.conversions??BigInt(0),revenueMicros:s._sum.revenueMicros??BigInt(0)},o=this.detectWaste(a,n,e);r.push(...o)}return r}async evaluateCampaigns(e,n){let i=await t.prisma.dailyCampaignMetric.groupBy({by:["campaignId"],where:{organizationId:e,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),r=[];for(let s of i){let i=await t.prisma.campaign.findUnique({where:{id:s.campaignId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!i)continue;let a={entityId:s.campaignId,entityName:i.name,entityType:"campaign",platformCode:i.platform.code,impressions:s._sum.impressions??BigInt(0),clicks:s._sum.clicks??BigInt(0),spendMicros:s._sum.spendMicros??BigInt(0),conversions:s._sum.conversions??BigInt(0),revenueMicros:s._sum.revenueMicros??BigInt(0)},o=this.detectWaste(a,n,e);r.push(...o)}return r}async evaluateAds(e,n){let i=await t.prisma.dailyAdMetric.groupBy({by:["adId"],where:{organizationId:e,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),r=[];for(let s of i){let i=await t.prisma.ad.findUnique({where:{id:s.adId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!i)continue;let a={entityId:s.adId,entityName:i.name??`Ad ${s.adId}`,entityType:"ad",platformCode:i.platform.code,impressions:s._sum.impressions??BigInt(0),clicks:s._sum.clicks??BigInt(0),spendMicros:s._sum.spendMicros??BigInt(0),conversions:s._sum.conversions??BigInt(0),revenueMicros:s._sum.revenueMicros??BigInt(0)},o=this.detectWaste(a,n,e);r.push(...o)}return r}detectWaste(e,t,n){let s=[];if(e.spendMicros>=this.config.spendThresholdMicros&&e.conversions===BigInt(0)){let r="zero_conversions_high_spend",o=a(e.spendMicros,this.config,r);s.push({id:d(e.entityType,e.entityId,r,t.end),entityType:e.entityType,entityId:e.entityId,entityName:e.entityName,organizationId:n,platformCode:e.platformCode,reason:r,level:o,spendMicros:e.spendMicros,conversions:0,cpa:null,targetCpa:i(this.config.targetCpaMicros),windowStart:t.start,windowEnd:t.end,message:`${e.entityName} spent $${i(e.spendMicros).toFixed(2)} with zero conversions in the last ${t.days} days.`,recommendation:c(r,e)})}if(e.conversions>BigInt(0)){let o=r(e.spendMicros,e.conversions),l=i(this.config.targetCpaMicros),u=l*(1+this.config.cpaTolerancePercent/100);if(null!==o&&o>1e6*u){let i="cpa_above_target",r=a(e.spendMicros,this.config,i),u=e.spendMicros-BigInt(Math.round(1e6*l*Number(e.conversions)));s.push({id:d(e.entityType,e.entityId,i,t.end),entityType:e.entityType,entityId:e.entityId,entityName:e.entityName,organizationId:n,platformCode:e.platformCode,reason:i,level:r,spendMicros:u>BigInt(0)?u:e.spendMicros,conversions:Number(e.conversions),cpa:o/1e6,targetCpa:l,windowStart:t.start,windowEnd:t.end,message:`${e.entityName} has CPA of $${(o/1e6).toFixed(2)} vs target of $${l.toFixed(2)} (${((o/1e6/l-1)*100).toFixed(0)}% over).`,recommendation:c(i,e)})}}return s}async evaluateCampaign(e){let n=o(e.windowDays??this.config.rollingWindowDays,e.endDate),i=await t.prisma.dailyCampaignMetric.aggregate({where:{organizationId:e.organizationId,campaignId:e.campaignId,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),r=await t.prisma.campaign.findUnique({where:{id:e.campaignId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!r)return[];let s={entityId:e.campaignId,entityName:r.name,entityType:"campaign",platformCode:r.platform.code,impressions:i._sum.impressions??BigInt(0),clicks:i._sum.clicks??BigInt(0),spendMicros:i._sum.spendMicros??BigInt(0),conversions:i._sum.conversions??BigInt(0),revenueMicros:i._sum.revenueMicros??BigInt(0)};return this.detectWaste(s,n,e.organizationId)}async evaluateAd(e){let n=o(e.windowDays??this.config.rollingWindowDays,e.endDate),i=await t.prisma.dailyAdMetric.aggregate({where:{organizationId:e.organizationId,adId:e.adId,date:{gte:n.start,lte:n.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),r=await t.prisma.ad.findUnique({where:{id:e.adId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!r)return[];let s={entityId:e.adId,entityName:r.name??`Ad ${e.adId}`,entityType:"ad",platformCode:r.platform.code,impressions:i._sum.impressions??BigInt(0),clicks:i._sum.clicks??BigInt(0),spendMicros:i._sum.spendMicros??BigInt(0),conversions:i._sum.conversions??BigInt(0),revenueMicros:i._sum.revenueMicros??BigInt(0)};return this.detectWaste(s,n,e.organizationId)}getConfig(){return{...this.config}}withConfig(e){return new l({...this.config,...e})}}let u=new l;e.s(["wasteEvaluator",0,u],12329),e.s([],38478)},15137,e=>{"use strict";var t=e.i(56884),n=e.i(42064),i=e.i(1824),r=e.i(99326),s=e.i(18794),a=e.i(83629),o=e.i(41446),d=e.i(61251),c=e.i(5708),l=e.i(59092),u=e.i(99563),p=e.i(39870),g=e.i(8016),m=e.i(7624),v=e.i(70065),h=e.i(36141),f=e.i(93695);e.i(58762);var w=e.i(24378),y=e.i(86040),_=e.i(70081),I=e.i(68050),R=e.i(46989),M=e.i(16336);e.i(38478);var C=e.i(12329),E=e.i(39063),b=e.i(67650);let T=R.z.object({windowDays:R.z.coerce.number().int().min(1).max(90).default(7)});async function A(e,t){let n=await (0,I.getServerSession)(M.authOptions),i=n?.user?.activeOrgId;if(!i)return _.NextResponse.json({error:"unauthorized"},{status:401});let{id:r}=await t.params,s=new URL(e.url),a=T.safeParse({windowDays:s.searchParams.get("windowDays")??void 0});if(!a.success)return _.NextResponse.json({error:"invalid_params"},{status:400});try{let e,t=(await C.wasteEvaluator.evaluateOrganization({organizationId:i,windowDays:a.data.windowDays})).alerts.find(e=>e.id===r);if(!t)return _.NextResponse.json({error:"not_found"},{status:404});let n=(0,E.microsToDollars)(BigInt(t.spendMicros)),s={window:{start:t.windowStart.toISOString(),end:t.windowEnd.toISOString(),days:a.data.windowDays},evidence:{reason:t.reason,level:t.level,entityType:t.entityType,entityId:t.entityId,platformCode:t.platformCode,spend_usd:n,conversions:t.conversions,cpa_usd:t.cpa,target_cpa_usd:t.targetCpa},message:t.message,recommendation:t.recommendation,debug:{generatedAt:new Date().toISOString()}};return _.NextResponse.json({alert:{...t,spendMicros:t.spendMicros.toString(),windowStart:t.windowStart.toISOString(),windowEnd:t.windowEnd.toISOString()},explainability:s,recommendedActions:(e="critical"===t.level||"high"===t.level?"high":"medium"===t.level?"medium":"low","zero_conversions_high_spend"===t.reason?[{key:"pause",title:"Pause or stop spend",description:`Pause this ${t.entityType.replace("_"," ")} until conversion tracking and targeting are validated.`,severity:e},{key:"targeting_review",title:"Review targeting",description:"Tighten audience/keywords, exclude low-intent placements, and verify geo/device targeting.",severity:"medium"},{key:"landing_page_check",title:"Check landing page",description:"Confirm the landing page loads fast, matches the ad promise, and the conversion event fires.",severity:"medium"}]:"cpa_above_target"===t.reason?[{key:"reduce_budget",title:"Reduce budget",description:"Reduce budget while you iterate on performance drivers to bring CPA back under target.",severity:e},{key:"creative_refresh",title:"Creative refresh",description:"Test new creatives and messages to improve conversion rate.",severity:"medium"},{key:"landing_page_check",title:"Landing page check",description:"Audit the landing page and funnel steps for drop-offs or tracking issues.",severity:"medium"}]:"low_ctr_high_spend"===t.reason?[{key:"creative_refresh",title:"Creative refresh",description:"Improve hook/headline/thumbnail and test multiple variants.",severity:e},{key:"targeting_review",title:"Targeting review",description:"Refine targeting and exclude poor placements to raise CTR.",severity:"medium"}]:[{key:"targeting_review",title:"Investigate",description:"Review recent changes and isolate what caused the performance regression.",severity:e}])})}catch(e){return console.error("waste alert detail error",e),_.NextResponse.json({error:"server_error"},{status:500})}}(0,b.ensureServerEntryExports)([A]),(0,y.registerServerReference)(A,"60019b61bd901375123ac472173974b868451a559a",null),e.s(["GET",()=>A],21064);var x=e.i(21064);let S=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/waste/alerts/[id]/route",pathname:"/api/waste/alerts/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/waste/alerts/[id]/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:k,workUnitAsyncStorage:N,serverHooks:B}=S;function O(){return(0,i.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:N})}async function D(e,t,i){S.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/waste/alerts/[id]/route";y=y.replace(/\/index$/,"")||"/";let _=await S.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!_)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:I,params:R,nextConfig:M,parsedUrl:C,isDraftMode:E,prerenderManifest:b,routerServerContext:T,isOnDemandRevalidate:A,revalidateOnlyGenerated:x,resolvedPathname:k,clientReferenceManifest:N,serverActionsManifest:B}=_,O=(0,d.normalizeAppPath)(y),D=!!(b.dynamicRoutes[O]||b.routes[k]),P=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,C,!1):t.end("This page could not be found"),null);if(D&&!E){let e=!!b.routes[k],t=b.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(M.experimental.adapterPath)return await P();throw new f.NoFallbackError}}let $=null;!D||S.isDev||E||($="/index"===($=k)?"/":$);let z=!0===S.isDev||!D,U=D&&!z;B&&N&&(0,a.setReferenceManifestsSingleton)({page:y,clientReferenceManifest:N,serverActionsManifest:B,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:B})});let j=e.method||"GET",q=(0,s.getTracer)(),H=q.getActiveScopeSpan(),F={params:R,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!M.experimental.authInterrupts},cacheComponents:!!M.cacheComponents,supportsDynamicResponse:z,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:M.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,i)=>S.onRequestError(e,t,i,T)},sharedContext:{buildId:I}},W=new c.NodeNextRequest(e),L=new c.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(W,(0,l.signalFromNodeResponse)(t));try{let a=async e=>S.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=q.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=n.get("next.route");if(i){let t=`${j} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${y}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),d=async r=>{var s,d;let c=async({previousCacheEntry:n})=>{try{if(!o&&A&&x&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(r);e.fetchMetrics=F.renderOpts.fetchMetrics;let d=F.renderOpts.pendingWaitUntil;d&&i.waitUntil&&(i.waitUntil(d),d=void 0);let c=F.renderOpts.collectedTags;if(!D)return await (0,g.sendResponse)(W,L,s,F.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[h.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,i=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:i}}}}catch(t){throw(null==n?void 0:n.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})},T),t}},l=await S.handleResponse({req:e,nextConfig:M,cacheKey:$,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:x,responseGenerator:c,waitUntil:i.waitUntil,isMinimalMode:o});if(!D)return null;if((null==l||null==(s=l.value)?void 0:s.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&D||u.delete(h.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,v.getCacheControlHeader)(l.cacheControl)),await (0,g.sendResponse)(W,L,new Response(l.value.body,{headers:u,status:l.value.status||200})),null};H?await d(H):await q.withPropagatedContext(e.headers,()=>q.trace(u.BaseServerSpan.handleRequest,{spanName:`${j} ${y}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},d))}catch(t){if(t instanceof f.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})}),D)throw t;return await (0,g.sendResponse)(W,L,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>O,"routeModule",()=>S,"serverHooks",()=>B,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>N],15137)}];

//# sourceMappingURL=OneDrive_Desktop_Optiq_CascadeProjects_windsurf-project_9c4d5346._.js.map