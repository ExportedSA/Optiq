{"version":3,"sources":["../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/jobs/alerts-engine.ts"],"sourcesContent":["/**\r\n * Alerts Engine Job\r\n * \r\n * Evaluates rollups against workspace targets and creates alert events.\r\n * \r\n * Features:\r\n * - Evaluates CPA, ROAS, spend thresholds against targets\r\n * - Detects anomalies (sudden drops, spikes)\r\n * - Creates AlertEvent records for breaches\r\n * - Deduplicates alerts (no spam within cooldown period)\r\n * - Supports multiple alert rule types\r\n */\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { appLogger } from \"@/lib/observability\";\r\n\r\nexport interface AlertsEngineResult {\r\n  startedAt: Date;\r\n  completedAt: Date;\r\n  organizationsProcessed: number;\r\n  rulesEvaluated: number;\r\n  alertsCreated: number;\r\n  alertsSkipped: number;\r\n}\r\n\r\nexport interface AlertsEngineOptions {\r\n  /** Specific organization to process */\r\n  organizationId?: string;\r\n  /** Number of days to look back for rollups */\r\n  lookbackDays?: number;\r\n  /** Force evaluation even if recently evaluated */\r\n  force?: boolean;\r\n}\r\n\r\nconst DEFAULT_LOOKBACK_DAYS = 7;\r\nconst ALERT_COOLDOWN_HOURS = 24; // Don't create duplicate alerts within this period\r\nconst MICROS_PER_UNIT = 1_000_000;\r\n\r\n/**\r\n * Run the alerts engine\r\n */\r\nexport async function runAlertsEngine(options?: AlertsEngineOptions): Promise<AlertsEngineResult> {\r\n  const logger = appLogger.child({ job: \"alerts-engine\" });\r\n  const startedAt = new Date();\r\n\r\n  const lookbackDays = options?.lookbackDays ?? DEFAULT_LOOKBACK_DAYS;\r\n\r\n  logger.info(\"Starting alerts engine\", {\r\n    lookbackDays,\r\n    organizationId: options?.organizationId,\r\n  });\r\n\r\n  let organizationsProcessed = 0;\r\n  let rulesEvaluated = 0;\r\n  let alertsCreated = 0;\r\n  let alertsSkipped = 0;\r\n\r\n  // Get organizations to process\r\n  const organizations = await prisma.organization.findMany({\r\n    where: options?.organizationId ? { id: options.organizationId } : {},\r\n    include: {\r\n      settings: true,\r\n      subscription: true,\r\n    },\r\n  });\r\n\r\n  for (const org of organizations) {\r\n    // Check if alerts are enabled for this plan\r\n    const alertsEnabled = org.subscription?.alertsEnabled ?? false;\r\n    if (!alertsEnabled && !options?.force) {\r\n      logger.debug(`Alerts not enabled for org ${org.id}, skipping`);\r\n      continue;\r\n    }\r\n\r\n    organizationsProcessed++;\r\n\r\n    // Get alert settings from organization settings\r\n    const alertSettings = (org.settings?.alertSettings as AlertSettings) ?? getDefaultAlertSettings();\r\n    const trackingSettings = (org.settings?.trackingSettings as TrackingSettings) ?? {};\r\n\r\n    // Get active alert rules for this organization\r\n    const alertRules = await prisma.alertRule.findMany({\r\n      where: {\r\n        organizationId: org.id,\r\n        status: \"ACTIVE\",\r\n      },\r\n    });\r\n\r\n    // If no custom rules, use default rules based on settings\r\n    const rulesToEvaluate = alertRules.length > 0 \r\n      ? alertRules \r\n      : createDefaultRules(org.id, alertSettings, trackingSettings);\r\n\r\n    for (const rule of rulesToEvaluate) {\r\n      rulesEvaluated++;\r\n\r\n      try {\r\n        const result = await evaluateRule(org.id, rule, lookbackDays, logger);\r\n        alertsCreated += result.created;\r\n        alertsSkipped += result.skipped;\r\n\r\n        // Update last evaluated timestamp\r\n        if ('id' in rule && rule.id) {\r\n          await prisma.alertRule.update({\r\n            where: { id: rule.id },\r\n            data: { lastEvaluatedAt: new Date() },\r\n          });\r\n        }\r\n      } catch (error) {\r\n        logger.error(`Failed to evaluate rule ${rule.type}`, error as Error, {\r\n          organizationId: org.id,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  const completedAt = new Date();\r\n\r\n  logger.info(\"Alerts engine completed\", {\r\n    organizationsProcessed,\r\n    rulesEvaluated,\r\n    alertsCreated,\r\n    alertsSkipped,\r\n    durationMs: completedAt.getTime() - startedAt.getTime(),\r\n  });\r\n\r\n  return {\r\n    startedAt,\r\n    completedAt,\r\n    organizationsProcessed,\r\n    rulesEvaluated,\r\n    alertsCreated,\r\n    alertsSkipped,\r\n  };\r\n}\r\n\r\ninterface AlertSettings {\r\n  wasteDetection?: {\r\n    enabled: boolean;\r\n    thresholdLow: number;\r\n    thresholdMedium: number;\r\n    thresholdHigh: number;\r\n  };\r\n  cpaThreshold?: {\r\n    enabled: boolean;\r\n    targetCpa: number;\r\n    warningPercent: number;\r\n    criticalPercent: number;\r\n  };\r\n  performanceDrop?: {\r\n    enabled: boolean;\r\n    conversionDropThreshold: number;\r\n    comparisonWindow: number;\r\n  };\r\n  frequency?: string;\r\n  channels?: {\r\n    inApp: boolean;\r\n    email: boolean;\r\n  };\r\n}\r\n\r\ninterface TrackingSettings {\r\n  targetCpa?: number;\r\n  targetRoas?: number;\r\n}\r\n\r\ninterface RuleConfig {\r\n  type: string;\r\n  severity: \"INFO\" | \"WARNING\" | \"CRITICAL\";\r\n  config: Record<string, unknown>;\r\n}\r\n\r\nfunction getDefaultAlertSettings(): AlertSettings {\r\n  return {\r\n    wasteDetection: {\r\n      enabled: true,\r\n      thresholdLow: 50,\r\n      thresholdMedium: 200,\r\n      thresholdHigh: 500,\r\n    },\r\n    cpaThreshold: {\r\n      enabled: true,\r\n      targetCpa: 50,\r\n      warningPercent: 20,\r\n      criticalPercent: 50,\r\n    },\r\n    performanceDrop: {\r\n      enabled: true,\r\n      conversionDropThreshold: 30,\r\n      comparisonWindow: 7,\r\n    },\r\n    frequency: \"daily\",\r\n    channels: {\r\n      inApp: true,\r\n      email: false,\r\n    },\r\n  };\r\n}\r\n\r\nfunction createDefaultRules(\r\n  organizationId: string,\r\n  alertSettings: AlertSettings,\r\n  trackingSettings: TrackingSettings\r\n): RuleConfig[] {\r\n  const rules: RuleConfig[] = [];\r\n\r\n  // CPA threshold rule\r\n  if (alertSettings.cpaThreshold?.enabled) {\r\n    const targetCpa = trackingSettings.targetCpa ?? alertSettings.cpaThreshold.targetCpa ?? 50;\r\n    rules.push({\r\n      type: \"CPA_SPIKE\",\r\n      severity: \"WARNING\",\r\n      config: {\r\n        targetCpa,\r\n        warningThreshold: targetCpa * (1 + (alertSettings.cpaThreshold.warningPercent ?? 20) / 100),\r\n        criticalThreshold: targetCpa * (1 + (alertSettings.cpaThreshold.criticalPercent ?? 50) / 100),\r\n      },\r\n    });\r\n  }\r\n\r\n  // ROAS drop rule\r\n  if (trackingSettings.targetRoas) {\r\n    rules.push({\r\n      type: \"ROAS_DROP\",\r\n      severity: \"WARNING\",\r\n      config: {\r\n        targetRoas: trackingSettings.targetRoas,\r\n        warningThreshold: trackingSettings.targetRoas * 0.8,\r\n        criticalThreshold: trackingSettings.targetRoas * 0.5,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Waste detection rule\r\n  if (alertSettings.wasteDetection?.enabled) {\r\n    rules.push({\r\n      type: \"SPEND_THRESHOLD\",\r\n      severity: \"WARNING\",\r\n      config: {\r\n        thresholdLow: alertSettings.wasteDetection.thresholdLow,\r\n        thresholdMedium: alertSettings.wasteDetection.thresholdMedium,\r\n        thresholdHigh: alertSettings.wasteDetection.thresholdHigh,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Conversion drop rule\r\n  if (alertSettings.performanceDrop?.enabled) {\r\n    rules.push({\r\n      type: \"CONVERSION_DROP\",\r\n      severity: \"WARNING\",\r\n      config: {\r\n        dropThreshold: alertSettings.performanceDrop.conversionDropThreshold,\r\n        comparisonWindow: alertSettings.performanceDrop.comparisonWindow,\r\n      },\r\n    });\r\n  }\r\n\r\n  return rules;\r\n}\r\n\r\nasync function evaluateRule(\r\n  organizationId: string,\r\n  rule: RuleConfig | { id: string; type: string; severity: string; config: unknown },\r\n  lookbackDays: number,\r\n  logger: typeof appLogger\r\n): Promise<{ created: number; skipped: number }> {\r\n  const ruleType = rule.type;\r\n  const config = (typeof rule.config === 'object' ? rule.config : {}) as Record<string, unknown>;\r\n\r\n  switch (ruleType) {\r\n    case \"CPA_SPIKE\":\r\n      return evaluateCpaRule(organizationId, rule, config, lookbackDays, logger);\r\n    case \"ROAS_DROP\":\r\n      return evaluateRoasRule(organizationId, rule, config, lookbackDays, logger);\r\n    case \"SPEND_THRESHOLD\":\r\n      return evaluateSpendRule(organizationId, rule, config, lookbackDays, logger);\r\n    case \"CONVERSION_DROP\":\r\n      return evaluateConversionDropRule(organizationId, rule, config, lookbackDays, logger);\r\n    default:\r\n      logger.warn(`Unknown rule type: ${ruleType}`);\r\n      return { created: 0, skipped: 0 };\r\n  }\r\n}\r\n\r\n/**\r\n * Evaluate CPA threshold rule\r\n */\r\nasync function evaluateCpaRule(\r\n  organizationId: string,\r\n  rule: RuleConfig | { id: string; type: string; severity: string; config: unknown },\r\n  config: Record<string, unknown>,\r\n  lookbackDays: number,\r\n  logger: typeof appLogger\r\n): Promise<{ created: number; skipped: number }> {\r\n  let created = 0;\r\n  let skipped = 0;\r\n\r\n  const targetCpa = (config.targetCpa as number) ?? 50;\r\n  const warningThreshold = (config.warningThreshold as number) ?? targetCpa * 1.2;\r\n  const criticalThreshold = (config.criticalThreshold as number) ?? targetCpa * 1.5;\r\n\r\n  // Get recent rollups at campaign level\r\n  const endDate = new Date();\r\n  const startDate = new Date(endDate.getTime() - lookbackDays * 24 * 60 * 60 * 1000);\r\n\r\n  const rollups = await prisma.dailyRollup.findMany({\r\n    where: {\r\n      organizationId,\r\n      grain: \"CAMPAIGN\",\r\n      date: { gte: startDate, lte: endDate },\r\n      conversions: { gt: 0 },\r\n    },\r\n    include: {\r\n      campaign: { select: { id: true, name: true } },\r\n    },\r\n  });\r\n\r\n  // Group by campaign and calculate average CPA\r\n  const campaignMetrics = new Map<string, { name: string; totalSpend: number; totalConversions: number }>();\r\n\r\n  for (const rollup of rollups) {\r\n    if (!rollup.campaignId) continue;\r\n\r\n    const existing = campaignMetrics.get(rollup.campaignId) || {\r\n      name: rollup.campaign?.name ?? \"Unknown Campaign\",\r\n      totalSpend: 0,\r\n      totalConversions: 0,\r\n    };\r\n\r\n    existing.totalSpend += Number(rollup.spendMicros) / MICROS_PER_UNIT;\r\n    existing.totalConversions += rollup.conversions;\r\n    campaignMetrics.set(rollup.campaignId, existing);\r\n  }\r\n\r\n  for (const [campaignId, metrics] of campaignMetrics) {\r\n    if (metrics.totalConversions === 0) continue;\r\n\r\n    const cpa = metrics.totalSpend / metrics.totalConversions;\r\n\r\n    if (cpa > warningThreshold) {\r\n      const severity = cpa > criticalThreshold ? \"CRITICAL\" : \"WARNING\";\r\n      const result = await createAlertIfNotDuplicate(\r\n        organizationId,\r\n        rule,\r\n        severity,\r\n        `CPA Alert: ${metrics.name}`,\r\n        `Campaign \"${metrics.name}\" has CPA of $${cpa.toFixed(2)} which exceeds target of $${targetCpa.toFixed(2)} (${((cpa / targetCpa - 1) * 100).toFixed(0)}% over)`,\r\n        {\r\n          campaignId,\r\n          campaignName: metrics.name,\r\n          cpa,\r\n          targetCpa,\r\n          threshold: cpa > criticalThreshold ? criticalThreshold : warningThreshold,\r\n          spend: metrics.totalSpend,\r\n          conversions: metrics.totalConversions,\r\n        },\r\n        logger\r\n      );\r\n\r\n      if (result.created) created++;\r\n      else skipped++;\r\n    }\r\n  }\r\n\r\n  return { created, skipped };\r\n}\r\n\r\n/**\r\n * Evaluate ROAS threshold rule\r\n */\r\nasync function evaluateRoasRule(\r\n  organizationId: string,\r\n  rule: RuleConfig | { id: string; type: string; severity: string; config: unknown },\r\n  config: Record<string, unknown>,\r\n  lookbackDays: number,\r\n  logger: typeof appLogger\r\n): Promise<{ created: number; skipped: number }> {\r\n  let created = 0;\r\n  let skipped = 0;\r\n\r\n  const targetRoas = (config.targetRoas as number) ?? 3.0;\r\n  const warningThreshold = (config.warningThreshold as number) ?? targetRoas * 0.8;\r\n  const criticalThreshold = (config.criticalThreshold as number) ?? targetRoas * 0.5;\r\n\r\n  const endDate = new Date();\r\n  const startDate = new Date(endDate.getTime() - lookbackDays * 24 * 60 * 60 * 1000);\r\n\r\n  const rollups = await prisma.dailyRollup.findMany({\r\n    where: {\r\n      organizationId,\r\n      grain: \"CAMPAIGN\",\r\n      date: { gte: startDate, lte: endDate },\r\n      spendMicros: { gt: 0 },\r\n    },\r\n    include: {\r\n      campaign: { select: { id: true, name: true } },\r\n    },\r\n  });\r\n\r\n  const campaignMetrics = new Map<string, { name: string; totalSpend: number; totalRevenue: number }>();\r\n\r\n  for (const rollup of rollups) {\r\n    if (!rollup.campaignId) continue;\r\n\r\n    const existing = campaignMetrics.get(rollup.campaignId) || {\r\n      name: rollup.campaign?.name ?? \"Unknown Campaign\",\r\n      totalSpend: 0,\r\n      totalRevenue: 0,\r\n    };\r\n\r\n    existing.totalSpend += Number(rollup.spendMicros) / MICROS_PER_UNIT;\r\n    existing.totalRevenue += Number(rollup.conversionValue) / MICROS_PER_UNIT;\r\n    campaignMetrics.set(rollup.campaignId, existing);\r\n  }\r\n\r\n  for (const [campaignId, metrics] of campaignMetrics) {\r\n    if (metrics.totalSpend === 0) continue;\r\n\r\n    const roas = metrics.totalRevenue / metrics.totalSpend;\r\n\r\n    if (roas < warningThreshold) {\r\n      const severity = roas < criticalThreshold ? \"CRITICAL\" : \"WARNING\";\r\n      const result = await createAlertIfNotDuplicate(\r\n        organizationId,\r\n        rule,\r\n        severity,\r\n        `ROAS Alert: ${metrics.name}`,\r\n        `Campaign \"${metrics.name}\" has ROAS of ${roas.toFixed(2)}x which is below target of ${targetRoas.toFixed(2)}x`,\r\n        {\r\n          campaignId,\r\n          campaignName: metrics.name,\r\n          roas,\r\n          targetRoas,\r\n          threshold: roas < criticalThreshold ? criticalThreshold : warningThreshold,\r\n          spend: metrics.totalSpend,\r\n          revenue: metrics.totalRevenue,\r\n        },\r\n        logger\r\n      );\r\n\r\n      if (result.created) created++;\r\n      else skipped++;\r\n    }\r\n  }\r\n\r\n  return { created, skipped };\r\n}\r\n\r\n/**\r\n * Evaluate spend threshold rule (waste detection)\r\n */\r\nasync function evaluateSpendRule(\r\n  organizationId: string,\r\n  rule: RuleConfig | { id: string; type: string; severity: string; config: unknown },\r\n  config: Record<string, unknown>,\r\n  lookbackDays: number,\r\n  logger: typeof appLogger\r\n): Promise<{ created: number; skipped: number }> {\r\n  let created = 0;\r\n  let skipped = 0;\r\n\r\n  const thresholdHigh = (config.thresholdHigh as number) ?? 500;\r\n\r\n  const endDate = new Date();\r\n  const startDate = new Date(endDate.getTime() - lookbackDays * 24 * 60 * 60 * 1000);\r\n\r\n  // Find campaigns with high spend but zero conversions\r\n  const rollups = await prisma.dailyRollup.findMany({\r\n    where: {\r\n      organizationId,\r\n      grain: \"CAMPAIGN\",\r\n      date: { gte: startDate, lte: endDate },\r\n      conversions: 0,\r\n    },\r\n    include: {\r\n      campaign: { select: { id: true, name: true } },\r\n    },\r\n  });\r\n\r\n  const campaignSpend = new Map<string, { name: string; totalSpend: number }>();\r\n\r\n  for (const rollup of rollups) {\r\n    if (!rollup.campaignId) continue;\r\n\r\n    const existing = campaignSpend.get(rollup.campaignId) || {\r\n      name: rollup.campaign?.name ?? \"Unknown Campaign\",\r\n      totalSpend: 0,\r\n    };\r\n\r\n    existing.totalSpend += Number(rollup.spendMicros) / MICROS_PER_UNIT;\r\n    campaignSpend.set(rollup.campaignId, existing);\r\n  }\r\n\r\n  for (const [campaignId, metrics] of campaignSpend) {\r\n    if (metrics.totalSpend >= thresholdHigh) {\r\n      const result = await createAlertIfNotDuplicate(\r\n        organizationId,\r\n        rule,\r\n        \"CRITICAL\",\r\n        `Waste Alert: ${metrics.name}`,\r\n        `Campaign \"${metrics.name}\" spent $${metrics.totalSpend.toFixed(2)} with zero conversions in the last ${lookbackDays} days`,\r\n        {\r\n          campaignId,\r\n          campaignName: metrics.name,\r\n          spend: metrics.totalSpend,\r\n          conversions: 0,\r\n          wasteType: \"zero_conversions\",\r\n        },\r\n        logger\r\n      );\r\n\r\n      if (result.created) created++;\r\n      else skipped++;\r\n    }\r\n  }\r\n\r\n  return { created, skipped };\r\n}\r\n\r\n/**\r\n * Evaluate conversion drop rule\r\n */\r\nasync function evaluateConversionDropRule(\r\n  organizationId: string,\r\n  rule: RuleConfig | { id: string; type: string; severity: string; config: unknown },\r\n  config: Record<string, unknown>,\r\n  lookbackDays: number,\r\n  logger: typeof appLogger\r\n): Promise<{ created: number; skipped: number }> {\r\n  let created = 0;\r\n  let skipped = 0;\r\n\r\n  const dropThreshold = (config.dropThreshold as number) ?? 30; // 30% drop\r\n  const comparisonWindow = (config.comparisonWindow as number) ?? 7;\r\n\r\n  const endDate = new Date();\r\n  const currentStart = new Date(endDate.getTime() - comparisonWindow * 24 * 60 * 60 * 1000);\r\n  const previousStart = new Date(currentStart.getTime() - comparisonWindow * 24 * 60 * 60 * 1000);\r\n\r\n  // Get current period conversions\r\n  const currentRollups = await prisma.dailyRollup.findMany({\r\n    where: {\r\n      organizationId,\r\n      grain: \"ORGANIZATION\",\r\n      date: { gte: currentStart, lte: endDate },\r\n    },\r\n  });\r\n\r\n  // Get previous period conversions\r\n  const previousRollups = await prisma.dailyRollup.findMany({\r\n    where: {\r\n      organizationId,\r\n      grain: \"ORGANIZATION\",\r\n      date: { gte: previousStart, lt: currentStart },\r\n    },\r\n  });\r\n\r\n  const currentConversions = currentRollups.reduce((sum, r) => sum + r.conversions, 0);\r\n  const previousConversions = previousRollups.reduce((sum, r) => sum + r.conversions, 0);\r\n\r\n  if (previousConversions > 0) {\r\n    const dropPercent = ((previousConversions - currentConversions) / previousConversions) * 100;\r\n\r\n    if (dropPercent >= dropThreshold) {\r\n      const result = await createAlertIfNotDuplicate(\r\n        organizationId,\r\n        rule,\r\n        dropPercent >= 50 ? \"CRITICAL\" : \"WARNING\",\r\n        \"Conversion Drop Alert\",\r\n        `Conversions dropped ${dropPercent.toFixed(0)}% compared to previous ${comparisonWindow} days (${currentConversions.toFixed(0)} vs ${previousConversions.toFixed(0)})`,\r\n        {\r\n          currentConversions,\r\n          previousConversions,\r\n          dropPercent,\r\n          comparisonWindow,\r\n        },\r\n        logger\r\n      );\r\n\r\n      if (result.created) created++;\r\n      else skipped++;\r\n    }\r\n  }\r\n\r\n  return { created, skipped };\r\n}\r\n\r\n/**\r\n * Create alert if not a duplicate within cooldown period\r\n */\r\nasync function createAlertIfNotDuplicate(\r\n  organizationId: string,\r\n  rule: RuleConfig | { id: string; type: string; severity: string; config: unknown },\r\n  severity: \"INFO\" | \"WARNING\" | \"CRITICAL\",\r\n  title: string,\r\n  message: string,\r\n  context: Record<string, unknown>,\r\n  logger: typeof appLogger\r\n): Promise<{ created: boolean }> {\r\n  const cooldownStart = new Date(Date.now() - ALERT_COOLDOWN_HOURS * 60 * 60 * 1000);\r\n\r\n  // Check for recent duplicate\r\n  const existingAlert = await prisma.alertEvent.findFirst({\r\n    where: {\r\n      organizationId,\r\n      title,\r\n      triggeredAt: { gte: cooldownStart },\r\n      status: { in: [\"TRIGGERED\", \"ACKNOWLEDGED\"] },\r\n    },\r\n  });\r\n\r\n  if (existingAlert) {\r\n    logger.debug(`Skipping duplicate alert: ${title}`);\r\n    return { created: false };\r\n  }\r\n\r\n  // Get or create alert rule\r\n  let alertRuleId: string;\r\n\r\n  if ('id' in rule && rule.id) {\r\n    alertRuleId = rule.id;\r\n  } else {\r\n    // Find or create a default rule for this type\r\n    const existingRule = await prisma.alertRule.findFirst({\r\n      where: {\r\n        organizationId,\r\n        type: rule.type as any,\r\n        status: \"ACTIVE\",\r\n      },\r\n    });\r\n\r\n    if (existingRule) {\r\n      alertRuleId = existingRule.id;\r\n    } else {\r\n      const newRule = await prisma.alertRule.create({\r\n        data: {\r\n          organizationId,\r\n          name: `Auto: ${rule.type}`,\r\n          type: rule.type as any,\r\n          severity: severity as any,\r\n          status: \"ACTIVE\",\r\n          config: rule.config as any,\r\n        },\r\n      });\r\n      alertRuleId = newRule.id;\r\n    }\r\n  }\r\n\r\n  // Create the alert event\r\n  await prisma.alertEvent.create({\r\n    data: {\r\n      organizationId,\r\n      alertRuleId,\r\n      status: \"TRIGGERED\",\r\n      severity: severity as any,\r\n      title,\r\n      message,\r\n      context: context as any,\r\n      triggeredAt: new Date(),\r\n    },\r\n  });\r\n\r\n  logger.info(`Created alert: ${title}`, { organizationId, severity });\r\n\r\n  // Create in-app notification\r\n  try {\r\n    const members = await prisma.membership.findMany({\r\n      where: { organizationId, role: { in: [\"OWNER\", \"ADMIN\"] } },\r\n      select: { userId: true },\r\n    });\r\n\r\n    for (const member of members) {\r\n      await prisma.inAppNotification.create({\r\n        data: {\r\n          organizationId,\r\n          userId: member.userId,\r\n          title,\r\n          message,\r\n          priority: severity === \"CRITICAL\" ? \"high\" : severity === \"WARNING\" ? \"medium\" : \"normal\",\r\n          status: \"pending\",\r\n          metadata: context as any,\r\n        },\r\n      });\r\n    }\r\n  } catch (error) {\r\n    logger.warn(\"Failed to create in-app notifications\", { error });\r\n  }\r\n\r\n  return { created: true };\r\n}\r\n\r\n/**\r\n * Get alert inbox for an organization\r\n */\r\nexport async function getAlertInbox(params: {\r\n  organizationId: string;\r\n  status?: (\"TRIGGERED\" | \"ACKNOWLEDGED\" | \"RESOLVED\" | \"DISMISSED\")[];\r\n  severity?: (\"INFO\" | \"WARNING\" | \"CRITICAL\")[];\r\n  limit?: number;\r\n  offset?: number;\r\n}): Promise<{\r\n  alerts: Array<{\r\n    id: string;\r\n    title: string;\r\n    message: string;\r\n    severity: string;\r\n    status: string;\r\n    triggeredAt: Date;\r\n    acknowledgedAt: Date | null;\r\n    resolvedAt: Date | null;\r\n    context: unknown;\r\n    rule: { id: string; name: string; type: string } | null;\r\n  }>;\r\n  total: number;\r\n}> {\r\n  const where = {\r\n    organizationId: params.organizationId,\r\n    ...(params.status ? { status: { in: params.status } } : {}),\r\n    ...(params.severity ? { severity: { in: params.severity } } : {}),\r\n  };\r\n\r\n  const [alerts, total] = await Promise.all([\r\n    prisma.alertEvent.findMany({\r\n      where,\r\n      include: {\r\n        alertRule: {\r\n          select: { id: true, name: true, type: true },\r\n        },\r\n      },\r\n      orderBy: { triggeredAt: \"desc\" },\r\n      take: params.limit ?? 50,\r\n      skip: params.offset ?? 0,\r\n    }),\r\n    prisma.alertEvent.count({ where }),\r\n  ]);\r\n\r\n  return {\r\n    alerts: alerts.map((a) => ({\r\n      id: a.id,\r\n      title: a.title,\r\n      message: a.message,\r\n      severity: a.severity,\r\n      status: a.status,\r\n      triggeredAt: a.triggeredAt,\r\n      acknowledgedAt: a.acknowledgedAt,\r\n      resolvedAt: a.resolvedAt,\r\n      context: a.context,\r\n      rule: a.alertRule ? {\r\n        id: a.alertRule.id,\r\n        name: a.alertRule.name,\r\n        type: a.alertRule.type,\r\n      } : null,\r\n    })),\r\n    total,\r\n  };\r\n}\r\n\r\n/**\r\n * Acknowledge an alert\r\n */\r\nexport async function acknowledgeAlert(params: {\r\n  alertId: string;\r\n  userId: string;\r\n}): Promise<void> {\r\n  await prisma.alertEvent.update({\r\n    where: { id: params.alertId },\r\n    data: {\r\n      status: \"ACKNOWLEDGED\",\r\n      acknowledgedAt: new Date(),\r\n      acknowledgedBy: params.userId,\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Resolve an alert\r\n */\r\nexport async function resolveAlert(params: {\r\n  alertId: string;\r\n  userId: string;\r\n}): Promise<void> {\r\n  await prisma.alertEvent.update({\r\n    where: { id: params.alertId },\r\n    data: {\r\n      status: \"RESOLVED\",\r\n      resolvedAt: new Date(),\r\n      resolvedBy: params.userId,\r\n    },\r\n  });\r\n}\r\n\r\n/**\r\n * Dismiss an alert\r\n */\r\nexport async function dismissAlert(params: {\r\n  alertId: string;\r\n  userId: string;\r\n}): Promise<void> {\r\n  await prisma.alertEvent.update({\r\n    where: { id: params.alertId },\r\n    data: {\r\n      status: \"DISMISSED\",\r\n      dismissedAt: new Date(),\r\n      dismissedBy: params.userId,\r\n    },\r\n  });\r\n}\r\n"],"names":[],"mappings":"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"}