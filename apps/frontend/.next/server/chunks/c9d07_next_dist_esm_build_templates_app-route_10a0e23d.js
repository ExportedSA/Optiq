module.exports=[65523,e=>{"use strict";var t=e.i(56884),a=e.i(42064),n=e.i(1824),i=e.i(99326),r=e.i(18794),o=e.i(83629),s=e.i(41446),l=e.i(61251),d=e.i(5708),u=e.i(59092),p=e.i(99563),c=e.i(39870),g=e.i(8016),h=e.i(7624),m=e.i(70065),v=e.i(36141),w=e.i(93695);e.i(58762);var R=e.i(24378),f=e.i(70081),A=e.i(68050),S=e.i(46989),x=e.i(16336),C=e.i(60806);e.i(55007);let E=S.z.object({dateRange:S.z.string().optional(),grain:S.z.enum(["ORGANIZATION","PLATFORM","CAMPAIGN","ADSET","AD"]).optional(),attributionModel:S.z.enum(["FIRST_TOUCH","LAST_TOUCH","LINEAR","TIME_DECAY","POSITION_BASED"]).optional(),minWasteSpend:S.z.string().optional(),severity:S.z.enum(["low","medium","high"]).optional(),limit:S.z.string().optional()});async function y(e){try{let a,n,i=await (0,A.getServerSession)(x.authOptions);if(!i?.user?.id)return f.NextResponse.json({error:"Unauthorized"},{status:401});let r=i.user.activeOrgId;if(!r)return f.NextResponse.json({error:"No active organization"},{status:400});let{searchParams:o}=new URL(e.url),s={dateRange:o.get("dateRange")||void 0,grain:o.get("grain")||void 0,attributionModel:o.get("attributionModel")||void 0,minWasteSpend:o.get("minWasteSpend")||void 0,severity:o.get("severity")||void 0,limit:o.get("limit")||void 0},l=E.safeParse(s);if(!l.success)return f.NextResponse.json({error:"Invalid query parameters",details:l.error.issues},{status:400});let{dateRange:d,grain:u,attributionModel:p,minWasteSpend:c,severity:g,limit:h}=l.data;if(d){let[e,t]=d.split(",");e&&t&&(a=new Date(e),n=new Date(t))}else n=new Date,(a=new Date).setDate(a.getDate()-30);let m=await C.prisma.organizationSettings.findUnique({where:{organizationId:r},select:{trackingSettings:!0}}),v=m?.trackingSettings,w=v?.targetCpa,R=v?.targetRoas,S=c?BigInt(Math.round(1e6*parseFloat(c))):BigInt(0),y=await C.prisma.dailyRollup.findMany({where:{organizationId:r,date:{gte:a,lte:n},wasteSpendMicros:{gt:S},...u?{grain:u}:{},...p?{attributionModel:p}:{}},include:{platform:{select:{id:!0,name:!0,code:!0}},campaign:{select:{id:!0,name:!0}}},orderBy:[{wasteSpendMicros:"desc"},{date:"desc"}],take:h?parseInt(h):100}),b=[];for(let e of y){var t;let a,n,i=Number(e.wasteSpendMicros)/1e6,r=Number(e.spendMicros)/1e6,o=function(e){let t,a,{date:n,spendMicros:i,conversions:r,cpa:o,roas:s,attributionModel:l,targetCpa:d,targetRoas:u}=e,p=Number(i)/1e6,c=[];if(0===r)t="no_conversions",p>1e3?(a="high",c.push("Pause this campaign immediately to stop wasting budget"),c.push("Review targeting and ad creative"),c.push("Consider A/B testing different audiences")):p>100?(a="medium",c.push("Monitor closely - consider pausing if no conversions within 24 hours"),c.push("Review landing page experience")):(a="low",c.push("Give it more time to gather data"),c.push("Ensure tracking is properly configured"));else if(d&&o&&o>d){t="high_cpa";let e=(o-d)/d*100;e>100?(a="high",c.push(`CPA is ${e.toFixed(0)}% above target - pause immediately`),c.push("Review bid strategy and targeting")):e>50?(a="medium",c.push(`CPA is ${e.toFixed(0)}% above target`),c.push("Lower bids or tighten targeting")):(a="low",c.push(`CPA is ${e.toFixed(0)}% above target`),c.push("Monitor and optimize gradually"))}else if(u&&s&&s<u){t="low_roas";let e=(u-s)/u*100;e>50?(a="high",c.push(`ROAS is ${e.toFixed(0)}% below target`),c.push("Pause low-performing ad sets"),c.push("Focus budget on high-ROAS campaigns")):e>25?(a="medium",c.push(`ROAS is ${e.toFixed(0)}% below target`),c.push("Optimize for higher-value conversions")):(a="low",c.push(`ROAS is ${e.toFixed(0)}% below target`),c.push("Continue monitoring performance"))}else t="no_conversions",a="low",c.push("No specific issues detected");return{reason:t,period:{startDate:n.toISOString().split("T")[0],endDate:n.toISOString().split("T")[0]},metrics:{spend:p,conversions:r,cpa:o||void 0,roas:s||void 0,targetCpa:d,targetRoas:u},attribution:{model:l},thresholds:{minConversions:1,maxCpa:d,minRoas:u},severity:a,recommendations:c}}({date:e.date,spendMicros:e.spendMicros,conversions:e.conversions,cpa:e.cpa,roas:e.roas,attributionModel:e.attributionModel,targetCpa:w,targetRoas:R}),s=(t=function(e,t,a){let n=0;return e>1e4?n+=40:e>1e3?n+=30:e>100?n+=20:e>10&&(n+=10),a>90?n+=40:a>75?n+=30:a>50?n+=20:a>25&&(n+=10),t>1e4?n+=20:t>1e3?n+=15:t>100?n+=10:t>10&&(n+=5),Math.min(100,n)}(i,r,e.wastePct))>=70?"high":t>=40?"medium":"low";if(!g||s===g){switch(o.severity=s,e.grain){case"ORGANIZATION":a="organization",n="Organization Total";break;case"PLATFORM":a="platform",n=e.platform?.name||"Unknown Platform";break;case"CAMPAIGN":a="campaign",n=e.campaign?.name||"Unknown Campaign";break;case"ADSET":a="adset",n=`Adset ${e.adsetId||"Unknown"}`;break;case"AD":a="ad",n=`Ad ${e.adId||"Unknown"}`;break;default:a="organization",n="Unknown"}b.push({id:e.id,type:a,name:n,grain:e.grain,date:e.date,wasteSpend:i,totalSpend:r,wastePct:e.wastePct,explanation:o})}}let O={totalWasteEntities:b.length,totalWasteSpend:b.reduce((e,t)=>e+t.wasteSpend,0),averageWastePct:b.length>0?b.reduce((e,t)=>e+t.wastePct,0)/b.length:0,bySeverity:{high:b.filter(e=>"high"===e.explanation.severity).length,medium:b.filter(e=>"medium"===e.explanation.severity).length,low:b.filter(e=>"low"===e.explanation.severity).length},byReason:{no_conversions:b.filter(e=>"no_conversions"===e.explanation.reason).length,high_cpa:b.filter(e=>"high_cpa"===e.explanation.reason).length,low_roas:b.filter(e=>"low_roas"===e.explanation.reason).length}};return f.NextResponse.json({success:!0,dateRange:{startDate:a?.toISOString().split("T")[0],endDate:n?.toISOString().split("T")[0]},summary:O,entities:b})}catch(e){return console.error("Failed to get waste entities:",e),f.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",()=>y,"runtime",0,"nodejs"],34595);var b=e.i(34595);let O=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/waste/route",pathname:"/api/waste",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/waste/route.ts",nextConfigOutput:"",userland:b}),{workAsyncStorage:T,workUnitAsyncStorage:N,serverHooks:P}=O;function I(){return(0,n.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:N})}async function M(e,t,n){O.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/waste/route";f=f.replace(/\/index$/,"")||"/";let A=await O.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!A)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:S,params:x,nextConfig:C,parsedUrl:E,isDraftMode:y,prerenderManifest:b,routerServerContext:T,isOnDemandRevalidate:N,revalidateOnlyGenerated:P,resolvedPathname:I,clientReferenceManifest:M,serverActionsManifest:_}=A,D=(0,l.normalizeAppPath)(f),k=!!(b.dynamicRoutes[D]||b.routes[I]),U=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,E,!1):t.end("This page could not be found"),null);if(k&&!y){let e=!!b.routes[I],t=b.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await U();throw new w.NoFallbackError}}let F=null;!k||O.isDev||y||(F="/index"===(F=I)?"/":F);let H=!0===O.isDev||!k,q=k&&!H;_&&M&&(0,o.setReferenceManifestsSingleton)({page:f,clientReferenceManifest:M,serverActionsManifest:_,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:_})});let $=e.method||"GET",j=(0,r.getTracer)(),z=j.getActiveScopeSpan(),L={params:x,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n)=>O.onRequestError(e,t,n,T)},sharedContext:{buildId:S}},B=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let o=async e=>O.handle(K,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${f}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var r,l;let d=async({previousCacheEntry:a})=>{try{if(!s&&N&&P&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!k)return await (0,g.sendResponse)(B,G,r,L.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[v.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==a?void 0:a.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:N})},T),t}},u=await O.handleResponse({req:e,nextConfig:C,cacheKey:F,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:P,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:s});if(!k)return null;if((null==u||null==(r=u.value)?void 0:r.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&k||p.delete(v.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,g.sendResponse)(B,G,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};z?await l(z):await j.withPropagatedContext(e.headers,()=>j.trace(p.BaseServerSpan.handleRequest,{spanName:`${$} ${f}`,kind:r.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:N})}),k)throw t;return await (0,g.sendResponse)(B,G,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>I,"routeModule",()=>O,"serverHooks",()=>P,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>N],65523)}];

//# sourceMappingURL=c9d07_next_dist_esm_build_templates_app-route_10a0e23d.js.map