module.exports=[63060,e=>{"use strict";var t=e.i(56884),r=e.i(42064),n=e.i(1824),i=e.i(99326),a=e.i(18794),o=e.i(83629),s=e.i(41446),l=e.i(61251),d=e.i(5708),u=e.i(59092),c=e.i(99563),p=e.i(39870),h=e.i(8016),m=e.i(7624),g=e.i(70065),f=e.i(36141),R=e.i(93695);e.i(58762);var v=e.i(24378),w=e.i(70081),I=e.i(46989),C=e.i(60806);e.i(55007);var A=e.i(54799);let x=process.env.IP_HASH_SALT||"optiq-default-salt-change-in-production";var E=e.i(37474);async function S(e,t=1){let r=(0,E.getRedis)(),n=`ratelimit:track:${e}`,i=Date.now();try{if(!r)return{allowed:!0,limit:1e4,remaining:1e4,resetAt:new Date(i+6e4)};let e=await r.incrby(n,t);e===t&&await r.expire(n,60);let a=Math.max(0,1e4-e),o=new Date(i+6e4);return{allowed:e<=1e4,limit:1e4,remaining:a,resetAt:o}}catch(e){return console.error("Rate limit check failed:",e),{allowed:!0,limit:1e4,remaining:1e4,resetAt:new Date(i+6e4)}}}e.i(25330);var y=e.i(96685);async function b(e,t=30){let r=y.appLogger.child({fn:"createAttributionCandidates"}),n=await C.prisma.trackingEvent.findUnique({where:{id:e},select:{id:!0,siteId:!0,anonId:!0,occurredAt:!0,type:!0}});if(!n)throw Error(`Conversion event not found: ${e}`);if("CONVERSION"!==n.type)throw Error(`Event ${e} is not a CONVERSION event`);let i=new Date(n.occurredAt);i.setDate(i.getDate()-t),r.debug("Finding touchpoints for conversion",{conversionId:n.id,anonId:n.anonId,lookbackStart:i.toISOString(),lookbackEnd:n.occurredAt.toISOString()});let a=await C.prisma.touchPoint.findMany({where:{siteId:n.siteId,anonId:n.anonId,occurredAt:{gte:i,lte:n.occurredAt}},orderBy:{occurredAt:"asc"},select:{id:!0,occurredAt:!0,platformCode:!0,campaignId:!0}});if(r.debug(`Found ${a.length} touchpoints for conversion`,{conversionId:n.id,touchPointCount:a.length}),0===a.length)return{conversionId:n.id,touchPointsFound:0,linksCreated:0};let o=0;for(let e of["FIRST_TOUCH","LAST_TOUCH","LINEAR","TIME_DECAY","POSITION_BASED"])for(let t=0;t<a.length;t++){let i=a[t];try{await C.prisma.attributionLink.create({data:{siteId:n.siteId,conversionId:n.id,touchPointId:i.id,model:e,weight:0,position:t+1,touchPointCount:a.length}}),o++}catch(t){"P2002"===t.code?r.debug("Attribution link already exists",{conversionId:n.id,touchPointId:i.id,model:e}):r.error("Failed to create attribution link",t,{conversionId:n.id,touchPointId:i.id,model:e})}}return r.info("Created attribution link candidates",{conversionId:n.id,touchPointsFound:a.length,linksCreated:o}),{conversionId:n.id,touchPointsFound:a.length,linksCreated:o}}let O=I.z.object({publicKey:I.z.string().min(1),eventId:I.z.string().min(8).max(128),type:I.z.enum(["PAGE_VIEW","CONVERSION","CUSTOM"]),name:I.z.string().min(1).max(200).optional(),url:I.z.string().url(),path:I.z.string().min(1).max(2048),referrer:I.z.string().url().optional().nullable(),title:I.z.string().max(512).optional().nullable(),occurredAt:I.z.string().datetime().optional(),anonId:I.z.string().min(8).max(128).optional(),sessionId:I.z.string().min(8).max(128).optional(),utmSource:I.z.string().max(200).optional().nullable(),utmMedium:I.z.string().max(200).optional().nullable(),utmCampaign:I.z.string().max(200).optional().nullable(),utmTerm:I.z.string().max(200).optional().nullable(),utmContent:I.z.string().max(200).optional().nullable(),properties:I.z.record(I.z.string(),I.z.unknown()).optional(),value:I.z.number().optional()}),N=I.z.object({publicKey:I.z.string().min(1),events:I.z.array(O).min(1).max(100)});async function P(e){let t=e.headers.get("origin")??void 0,r=e.headers.get("user-agent")??void 0,n=function(e){let t=e.headers,r=t.get("x-forwarded-for");if(r){let e=r.split(",").map(e=>e.trim());if(e[0])return e[0]}let n=t.get("x-real-ip");if(n)return n;let i=t.get("cf-connecting-ip");if(i)return i;let a=t.get("true-client-ip");if(a)return a;let o=t.get("x-client-ip");return o||null}(e),i=n?function(e){let t,r;if(!e)return"";let n=((r=(t=e.replace(/^\[|\]$/g,"")).match(/^::ffff:(\d+\.\d+\.\d+\.\d+)$/i))&&(t=r[1]),t=t.toLowerCase()),i=(0,A.createHash)("sha256");return i.update(x),i.update(n),i.digest("hex")}(n):void 0;try{let n,a,o=await e.json().catch(()=>null);if(!o)return w.NextResponse.json({error:"Invalid JSON"},{status:400,headers:T(t)});let s=N.safeParse(o);if(s.success)n=s.data.events,a=s.data.publicKey;else{let e=O.safeParse(o);if(!e.success)return w.NextResponse.json({error:"Validation failed",details:e.error.issues},{status:400,headers:T(t)});n=[e.data],a=e.data.publicKey}let l=await C.prisma.trackingSite.findUnique({where:{publicKey:a},select:{id:!0,domain:!0,organizationId:!0}});if(!l)return w.NextResponse.json({error:"Invalid public key"},{status:401,headers:T(t)});if(t)try{let e=new URL(t).hostname.toLowerCase(),r=l.domain.toLowerCase();if(e!==r&&!e.endsWith(`.${r}`))return w.NextResponse.json({error:"Origin not allowed"},{status:403,headers:T(t)})}catch{return w.NextResponse.json({error:"Invalid origin"},{status:400,headers:T(t)})}let d=await S(l.id,n.length);if(!d.allowed)return w.NextResponse.json({error:"Rate limit exceeded",limit:d.limit,resetAt:d.resetAt},{status:429,headers:{...T(t),"X-RateLimit-Limit":d.limit.toString(),"X-RateLimit-Remaining":d.remaining.toString(),"X-RateLimit-Reset":d.resetAt.toISOString()}});let u=0,c=0,p=[];for(let e of n)try{let t=e.occurredAt?new Date(e.occurredAt):new Date,n=e.anonId||`anon_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a=e.sessionId||`sess_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o="CONVERSION"===e.type&&e.value?BigInt(Math.round(1e6*e.value)):void 0,s=await C.prisma.trackingEvent.create({data:{siteId:l.id,eventId:e.eventId,type:e.type,name:e.name,occurredAt:t,url:e.url,path:e.path,referrer:e.referrer,title:e.title,utmSource:e.utmSource,utmMedium:e.utmMedium,utmCampaign:e.utmCampaign,utmTerm:e.utmTerm,utmContent:e.utmContent,anonId:n,sessionId:a,userAgent:r,ipHash:i,valueMicros:o,properties:e.properties}});u++,"CONVERSION"===e.type&&p.push(s.id)}catch(e){"P2002"===e.code?c++:console.error("Failed to create tracking event:",e)}return p.length>0&&Promise.all(p.map(e=>b(e).catch(t=>console.error(`Failed to create attribution candidates for ${e}:`,t)))).catch(e=>console.error("Attribution candidate creation failed:",e)),w.NextResponse.json({success:!0,accepted:u,deduped:c,total:n.length},{status:200,headers:{...T(t),"X-RateLimit-Limit":d.limit.toString(),"X-RateLimit-Remaining":d.remaining.toString(),"X-RateLimit-Reset":d.resetAt.toISOString()}})}catch(e){return console.error("Tracking endpoint error:",e),w.NextResponse.json({error:"Internal server error"},{status:500,headers:T(t)})}}function T(e){return{"Access-Control-Allow-Origin":e??"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}}async function k(e){let t=e.headers.get("origin")??"*";return new w.NextResponse(null,{status:204,headers:{...T(t),"Access-Control-Max-Age":"86400"}})}e.s(["OPTIONS",()=>k,"POST",()=>P],5232);var _=e.i(5232);let D=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/track/route",pathname:"/api/track",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/track/route.ts",nextConfigOutput:"",userland:_}),{workAsyncStorage:M,workUnitAsyncStorage:z,serverHooks:H}=D;function L(){return(0,n.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:z})}async function U(e,t,n){D.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/track/route";w=w.replace(/\/index$/,"")||"/";let I=await D.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!I)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:C,params:A,nextConfig:x,parsedUrl:E,isDraftMode:S,prerenderManifest:y,routerServerContext:b,isOnDemandRevalidate:O,revalidateOnlyGenerated:N,resolvedPathname:P,clientReferenceManifest:T,serverActionsManifest:k}=I,_=(0,l.normalizeAppPath)(w),M=!!(y.dynamicRoutes[_]||y.routes[P]),z=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,E,!1):t.end("This page could not be found"),null);if(M&&!S){let e=!!y.routes[P],t=y.dynamicRoutes[_];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await z();throw new R.NoFallbackError}}let H=null;!M||D.isDev||S||(H="/index"===(H=P)?"/":H);let L=!0===D.isDev||!M,U=M&&!L;k&&T&&(0,o.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:T,serverActionsManifest:k,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:k})});let $=e.method||"GET",j=(0,a.getTracer)(),q=j.getActiveScopeSpan(),F={params:A,prerenderManifest:y,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>D.onRequestError(e,t,n,b)},sharedContext:{buildId:C}},K=new d.NodeNextRequest(e),V=new d.NodeNextResponse(t),X=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let o=async e=>D.handle(X,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${w}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var a,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&O&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(i);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=F.renderOpts.collectedTags;if(!M)return await (0,h.sendResponse)(K,V,a,F.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:O})},b),t}},u=await D.handleResponse({req:e,nextConfig:x,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:s});if(!M)return null;if((null==u||null==(a=u.value)?void 0:a.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",O?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&M||c.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(K,V,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};q?await l(q):await j.withPropagatedContext(e.headers,()=>j.trace(c.BaseServerSpan.handleRequest,{spanName:`${$} ${w}`,kind:a.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof R.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:O})}),M)throw t;return await (0,h.sendResponse)(K,V,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>L,"routeModule",()=>D,"serverHooks",()=>H,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>z],63060)}];

//# sourceMappingURL=c9d07_next_dist_esm_build_templates_app-route_299ba2af.js.map