module.exports=[93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},55007,(e,t,r)=>{},60806,e=>{"use strict";e.i(55007);var t=e.i(29173);let r=globalThis.prisma??new t.PrismaClient({log:["error","warn"]});e.s(["prisma",0,r])},66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},62794,e=>{"use strict";var t=e.i(70081),r=e.i(54799);function a(e,a){let n=process.env.CRON_SECRET;if(!n)return console.error("CRON_SECRET environment variable is not configured"),{authorized:!1,response:t.NextResponse.json({error:"Cron authentication not configured"},{status:503})};let o=e.headers.get("authorization");if(!o)return console.warn(`Cron job unauthorized: missing auth header${a?` (${a})`:""}`),{authorized:!1,response:t.NextResponse.json({error:"Unauthorized: Missing authorization header"},{status:401})};let[i,s]=o.split(" ");return"Bearer"===i&&s?!function(e,t){try{let a=Buffer.from(e,"utf8"),n=Buffer.from(t,"utf8");if(a.length!==n.length){let e=Buffer.alloc(a.length);return(0,r.timingSafeEqual)(a,e),!1}return(0,r.timingSafeEqual)(a,n)}catch(e){return console.error("Error during constant-time comparison:",e),!1}}(s,n)?(console.warn(`Cron job unauthorized: invalid token${a?` (${a})`:""}`),{authorized:!1,response:t.NextResponse.json({error:"Unauthorized: Invalid credentials"},{status:401})}):{authorized:!0}:(console.warn(`Cron job unauthorized: invalid auth format${a?` (${a})`:""}`),{authorized:!1,response:t.NextResponse.json({error:"Unauthorized: Invalid authorization format"},{status:401})})}e.s(["verifyCronAuth",()=>a])},65643,e=>{"use strict";var t=e.i(56884),r=e.i(42064),a=e.i(1824),n=e.i(99326),o=e.i(18794),i=e.i(83629),s=e.i(41446),l=e.i(61251),d=e.i(5708),u=e.i(59092),c=e.i(99563),p=e.i(39870),g=e.i(8016),f=e.i(7624),h=e.i(70065),m=e.i(36141),v=e.i(93695);e.i(58762);var x=e.i(24378),R=e.i(70081),w=e.i(62794),C=e.i(37474);e.i(25330);var E=e.i(96685);e.i(55007);var y=e.i(60806);async function A(e,t){let r=E.appLogger.child({alert:"cpa-spike"}),a=0,n=await y.prisma.organizationSettings.findUnique({where:{organizationId:e}});if(!n?.trackingSettings)return r.debug("No tracking settings found",{organizationId:e}),0;let o=n.trackingSettings,i=o?.targetCpa;if(!i)return r.debug("No target CPA configured",{organizationId:e}),0;for(let n of(await y.prisma.dailyRollup.findMany({where:{organizationId:e,date:{gte:t.from,lte:t.to},grain:"CAMPAIGN",cpa:{not:null},conversions:{gt:0}},include:{campaign:{select:{name:!0}},platform:{select:{name:!0}}}}))){if(!n.cpa)continue;let t=(n.cpa-i)/i*100,o=null,s=0;t>100?(o="CRITICAL",s=100):t>50?(o="WARNING",s=50):t>25&&(o="INFO",s=25),o&&await I({organizationId:e,type:"CPA_SPIKE",severity:o,title:`CPA Spike: ${n.campaign?.name||"Unknown Campaign"}`,message:`CPA of $${n.cpa.toFixed(2)} is ${t.toFixed(0)}% above target of $${i.toFixed(2)}`,context:{campaignId:n.campaignId,campaignName:n.campaign?.name,platformName:n.platform?.name,actualCpa:n.cpa,targetCpa:i,exceedancePct:t,thresholdPct:s,date:n.date.toISOString(),spend:Number(n.spendMicros)/1e6,conversions:n.conversions},dedupeKey:`cpa-spike-${n.campaignId}-${n.date.toISOString().split("T")[0]}`})&&(a++,r.info("CPA spike alert triggered",{campaignId:n.campaignId,cpa:n.cpa,targetCpa:i,exceedancePct:t}))}return a}async function N(e,t){let r=E.appLogger.child({alert:"spend-threshold"}),a=0;for(let n of(await y.prisma.dailyRollup.findMany({where:{organizationId:e,date:{gte:t.from,lte:t.to},grain:"CAMPAIGN",conversions:0,spendMicros:{gt:0}},include:{campaign:{select:{name:!0}},platform:{select:{name:!0}}}}))){let t=Number(n.spendMicros)/1e6,o=null,i=0;t>1e3?(o="CRITICAL",i=1e3):t>500?(o="WARNING",i=500):t>100&&(o="INFO",i=100),o&&await I({organizationId:e,type:"SPEND_THRESHOLD",severity:o,title:`Wasted Spend: ${n.campaign?.name||"Unknown Campaign"}`,message:`Spent $${t.toFixed(2)} with zero conversions`,context:{campaignId:n.campaignId,campaignName:n.campaign?.name,platformName:n.platform?.name,spend:t,threshold:i,conversions:0,date:n.date.toISOString()},dedupeKey:`spend-threshold-${n.campaignId}-${n.date.toISOString().split("T")[0]}`})&&(a++,r.info("Spend threshold alert triggered",{campaignId:n.campaignId,spend:t,threshold:i}))}return a}async function I(e){let{organizationId:t,type:r,severity:a,title:n,message:o,context:i,dedupeKey:s}=e;if(await y.prisma.alertEvent.findFirst({where:{organizationId:t,title:n,status:{in:["TRIGGERED","ACKNOWLEDGED"]},triggeredAt:{gte:new Date(Date.now()-864e5)}}}))return!1;let l=await y.prisma.alertRule.findFirst({where:{organizationId:t,type:r,status:"ACTIVE"}});return l||(l=await y.prisma.alertRule.create({data:{organizationId:t,name:`${r} Alert`,type:r,severity:a,status:"ACTIVE",config:{}}})),await y.prisma.alertEvent.create({data:{organizationId:t,alertRuleId:l.id,severity:a,title:n,message:o,context:i,status:"TRIGGERED"}}),!0}async function b(e){let t=E.appLogger.child({job:"alert-evaluation"}),r=0,a=0,n=0,o=new Date,i=new Date(Date.now()-6048e5);try{for(let s of(await y.prisma.organization.findMany({where:e?{id:e}:{},select:{id:!0}})))try{let e=await A(s.id,{from:i,to:o});r+=e,a++;let t=await N(s.id,{from:i,to:o});r+=t,a++}catch(e){n++,t.error("Failed to evaluate alerts for organization",{organizationId:s.id,error:e})}t.info("Alert evaluation completed",{alertsTriggered:r,alertsEvaluated:a,errors:n})}catch(e){throw t.error("Alert evaluation failed",e),e}return{alertsTriggered:r,alertsEvaluated:a,errors:n}}let S="alerts-evaluation";async function _(e){let t=(0,w.verifyCronAuth)(e,S);if(!t.authorized)return t.response;E.appLogger.info("Starting alerts evaluation cron job");let r=await (0,C.withJobLock)(S,async()=>{let e=await b();return E.appLogger.info("Alerts evaluation completed",{alertsTriggered:e.alertsTriggered,alertsEvaluated:e.alertsEvaluated,errors:e.errors}),e},{ttlSeconds:300,bufferSeconds:60});return r.skipped?R.NextResponse.json({success:!0,skipped:!0,message:"Job already running"}):r.error?R.NextResponse.json({success:!1,error:r.error.message},{status:500}):r.executed&&r.result?R.NextResponse.json({success:!0,data:r.result}):R.NextResponse.json({success:!1,error:"Job execution failed"},{status:500})}e.s(["GET",()=>_,"maxDuration",0,300,"runtime",0,"nodejs"],38557);var k=e.i(38557);let j=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/cron/alerts-evaluation/route",pathname:"/api/cron/alerts-evaluation",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/cron/alerts-evaluation/route.ts",nextConfigOutput:"",userland:k}),{workAsyncStorage:P,workUnitAsyncStorage:T,serverHooks:O}=j;function D(){return(0,a.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:T})}async function $(e,t,a){j.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/cron/alerts-evaluation/route";R=R.replace(/\/index$/,"")||"/";let w=await j.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:C,params:E,nextConfig:y,parsedUrl:A,isDraftMode:N,prerenderManifest:I,routerServerContext:b,isOnDemandRevalidate:S,revalidateOnlyGenerated:_,resolvedPathname:k,clientReferenceManifest:P,serverActionsManifest:T}=w,O=(0,l.normalizeAppPath)(R),D=!!(I.dynamicRoutes[O]||I.routes[k]),$=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,A,!1):t.end("This page could not be found"),null);if(D&&!N){let e=!!I.routes[k],t=I.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await $();throw new v.NoFallbackError}}let q=null;!D||j.isDev||N||(q="/index"===(q=k)?"/":q);let M=!0===j.isDev||!D,z=D&&!M;T&&P&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:P,serverActionsManifest:T,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:T})});let U=e.method||"GET",H=(0,o.getTracer)(),F=H.getActiveScopeSpan(),L={params:E,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>j.onRequestError(e,t,a,b)},sharedContext:{buildId:C}},G=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),B=u.NextRequestAdapter.fromNodeNextRequest(G,(0,u.signalFromNodeResponse)(t));try{let i=async e=>j.handle(B,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${R}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var o,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&S&&_&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!D)return await (0,g.sendResponse)(G,K,o,L.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await j.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:S})},b),t}},u=await j.handleResponse({req:e,nextConfig:y,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:_,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!D)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",S?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&D||c.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,g.sendResponse)(G,K,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};F?await l(F):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${U} ${R}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await j.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:S})}),D)throw t;return await (0,g.sendResponse)(G,K,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>D,"routeModule",()=>j,"serverHooks",()=>O,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>T],65643)},20992,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__ef1c557e._.js","server/chunks/[root-of-the-server]__68c1b7d0._.js"].map(t=>e.l(t))).then(()=>t(8588)))},91559,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__ed38bb72._.js","server/chunks/OneDrive_Desktop_Optiq_CascadeProjects_windsurf-project_c2af6329._.js","server/chunks/c9d07_zod_v4_classic_external_0506f14c.js"].map(t=>e.l(t))).then(()=>t(94238)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__40c4e6f1._.js.map