module.exports=[52639,t=>{"use strict";t.i(55007);var e=t.i(60806);t.i(25330);var i=t.i(96685);async function n(t){let e=i.appLogger.child({job:"touchpoint-derivation"}),n=new Date,o=t?.batchSize??1e3,d=t?.endDate??new Date,l=t?.startDate??new Date(d.getTime()-6048e5);e.info("Starting TouchPoint derivation",{siteId:t?.siteId,startDate:l.toISOString(),endDate:d.toISOString(),batchSize:o});let u=0,s=0,m=0,g=0;try{for(let i of(await r(t?.siteId))){e.info(`Processing site: ${i.id}`,{siteName:i.name});let t=!0,n=null;for(;t;){let r=await c(i.id,l,d,o,n);if(0===r.length){t=!1;break}for(let t of(e.debug(`Processing ${r.length} events for site ${i.id}`),r))try{let e=await a(t);u++,e.created?s++:m++,n=t.occurredAt}catch(n){g++,e.error(`Failed to derive TouchPoint from event ${t.id}`,n,{siteId:i.id,eventId:t.id})}r.length<o&&(t=!1)}}}catch(t){throw e.error("TouchPoint derivation job failed",t),t}let f=new Date;return e.info("TouchPoint derivation completed",{eventsProcessed:u,touchPointsCreated:s,touchPointsSkipped:m,errors:g,durationMs:f.getTime()-n.getTime()}),{startedAt:n,completedAt:f,eventsProcessed:u,touchPointsCreated:s,touchPointsSkipped:m,errors:g}}async function r(t){if(t){let i=await e.prisma.trackingSite.findUnique({where:{id:t},select:{id:!0,name:!0}});return i?[i]:[]}return e.prisma.trackingSite.findMany({select:{id:!0,name:!0}})}async function c(t,i,n,r,c){return e.prisma.trackingEvent.findMany({where:{siteId:t,type:"PAGE_VIEW",occurredAt:{gte:c??i,lte:n}},select:{id:!0,siteId:!0,anonId:!0,sessionId:!0,occurredAt:!0,url:!0,referrer:!0,utmSource:!0,utmMedium:!0,utmCampaign:!0,utmTerm:!0,utmContent:!0},orderBy:{occurredAt:"asc"},take:r})}async function a(t){let i=function(t){try{let e=new URL(t);return{gclid:e.searchParams.get("gclid"),fbclid:e.searchParams.get("fbclid"),ttclid:e.searchParams.get("ttclid"),msclkid:e.searchParams.get("msclkid"),clickId:e.searchParams.get("clickid")??e.searchParams.get("click_id")??null}}catch{return{gclid:null,fbclid:null,ttclid:null,msclkid:null,clickId:null}}}(t.url),n=!!(i.gclid||i.fbclid||i.ttclid||i.msclkid||i.clickId),r=i.gclid?"GOOGLE_ADS":i.fbclid?"META":i.ttclid?"TIKTOK":i.msclkid?"LINKEDIN":null;if(!(t.utmSource||t.utmMedium||t.utmCampaign||n))return{created:!1};let c=null;if(r&&t.utmCampaign){let i=await e.prisma.campaign.findFirst({where:{platform:{code:r},name:{contains:t.utmCampaign,mode:"insensitive"}},select:{id:!0}});c=i?.id??null}try{return await e.prisma.touchPoint.create({data:{siteId:t.siteId,anonId:t.anonId,sessionId:t.sessionId,occurredAt:t.occurredAt,landingUrl:t.url,referrer:t.referrer,utmSource:t.utmSource,utmMedium:t.utmMedium,utmCampaign:t.utmCampaign,utmTerm:t.utmTerm,utmContent:t.utmContent,gclid:i.gclid,fbclid:i.fbclid,ttclid:i.ttclid,msclkid:i.msclkid,clickId:i.clickId,platformCode:r,campaignId:c}}),{created:!0}}catch(t){if("P2002"===t.code)return{created:!1};throw t}}async function o(t){let r=i.appLogger.child({job:"touchpoint-rebuild"});r.info("Rebuilding TouchPoints",{siteId:t.siteId,startDate:t.startDate.toISOString(),endDate:t.endDate.toISOString()});let c=await e.prisma.touchPoint.deleteMany({where:{...t.siteId?{siteId:t.siteId}:{},occurredAt:{gte:t.startDate,lte:t.endDate}}});return r.info(`Deleted ${c.count} existing TouchPoints`),n({siteId:t.siteId,startDate:t.startDate,endDate:t.endDate,force:!0})}async function d(t){let i=t?{siteId:t}:{},[n,r,c,a,o,d]=await Promise.all([e.prisma.trackingEvent.count({where:{...i,type:"PAGE_VIEW"}}),e.prisma.touchPoint.count({where:i}),e.prisma.touchPoint.count({where:{...i,OR:[{gclid:{not:null}},{fbclid:{not:null}},{ttclid:{not:null}},{msclkid:{not:null}},{clickId:{not:null}}]}}),e.prisma.touchPoint.count({where:{...i,OR:[{utmSource:{not:null}},{utmMedium:{not:null}},{utmCampaign:{not:null}}]}}),e.prisma.touchPoint.count({where:{...i,campaignId:{not:null}}}),e.prisma.touchPoint.groupBy({by:["platformCode"],where:i,_count:!0})]),l={};for(let t of d)t.platformCode&&(l[t.platformCode]=t._count);return{totalEvents:n,totalTouchPoints:r,touchPointsWithClickIds:c,touchPointsWithUTMs:a,touchPointsLinkedToCampaigns:o,platformBreakdown:l}}t.s(["getTouchPointStats",()=>d,"rebuildTouchPoints",()=>o,"runTouchPointDerivation",()=>n],52639)}];

//# sourceMappingURL=1c0b7_windsurf-project_apps_frontend_src_lib_jobs_touchpoint-derivation_ts_32aaffd8._.js.map