module.exports=[8819,e=>{"use strict";var t=e.i(60806);e.i(25330);var a=e.i(96685);async function n(e){let n=a.appLogger.child({job:"alerts-engine"}),r=new Date,o=e?.lookbackDays??7;n.info("Starting alerts engine",{lookbackDays:o,organizationId:e?.organizationId});let s=0,d=0,l=0,c=0;for(let a of(await t.prisma.organization.findMany({where:e?.organizationId?{id:e.organizationId}:{},include:{settings:!0,subscription:!0}}))){if(!a.subscription?.alertsEnabled&&!e?.force){n.debug(`Alerts not enabled for org ${a.id}, skipping`);continue}s++;let r=a.settings?.alertSettings??{wasteDetection:{enabled:!0,thresholdLow:50,thresholdMedium:200,thresholdHigh:500},cpaThreshold:{enabled:!0,targetCpa:50,warningPercent:20,criticalPercent:50},performanceDrop:{enabled:!0,conversionDropThreshold:30,comparisonWindow:7},frequency:"daily",channels:{inApp:!0,email:!1}},p=a.settings?.trackingSettings??{},g=await t.prisma.alertRule.findMany({where:{organizationId:a.id,status:"ACTIVE"}});for(let e of g.length>0?g:function(e,t,a){let n=[];if(t.cpaThreshold?.enabled){let e=a.targetCpa??t.cpaThreshold.targetCpa??50;n.push({type:"CPA_SPIKE",severity:"WARNING",config:{targetCpa:e,warningThreshold:e*(1+(t.cpaThreshold.warningPercent??20)/100),criticalThreshold:e*(1+(t.cpaThreshold.criticalPercent??50)/100)}})}return a.targetRoas&&n.push({type:"ROAS_DROP",severity:"WARNING",config:{targetRoas:a.targetRoas,warningThreshold:.8*a.targetRoas,criticalThreshold:.5*a.targetRoas}}),t.wasteDetection?.enabled&&n.push({type:"SPEND_THRESHOLD",severity:"WARNING",config:{thresholdLow:t.wasteDetection.thresholdLow,thresholdMedium:t.wasteDetection.thresholdMedium,thresholdHigh:t.wasteDetection.thresholdHigh}}),t.performanceDrop?.enabled&&n.push({type:"CONVERSION_DROP",severity:"WARNING",config:{dropThreshold:t.performanceDrop.conversionDropThreshold,comparisonWindow:t.performanceDrop.comparisonWindow}}),n}(a.id,r,p)){d++;try{let r=await i(a.id,e,o,n);l+=r.created,c+=r.skipped,"id"in e&&e.id&&await t.prisma.alertRule.update({where:{id:e.id},data:{lastEvaluatedAt:new Date}})}catch(t){n.error(`Failed to evaluate rule ${e.type}`,t,{organizationId:a.id})}}}let p=new Date;return n.info("Alerts engine completed",{organizationsProcessed:s,rulesEvaluated:d,alertsCreated:l,alertsSkipped:c,durationMs:p.getTime()-r.getTime()}),{startedAt:r,completedAt:p,organizationsProcessed:s,rulesEvaluated:d,alertsCreated:l,alertsSkipped:c}}async function i(e,t,a,n){let i=t.type,l="object"==typeof t.config?t.config:{};switch(i){case"CPA_SPIKE":return r(e,t,l,a,n);case"ROAS_DROP":return o(e,t,l,a,n);case"SPEND_THRESHOLD":return s(e,t,l,a,n);case"CONVERSION_DROP":return d(e,t,l,a,n);default:return n.warn(`Unknown rule type: ${i}`),{created:0,skipped:0}}}async function r(e,a,n,i,r){let o=0,s=0,d=n.targetCpa??50,c=n.warningThreshold??1.2*d,p=n.criticalThreshold??1.5*d,g=new Date,u=new Date(g.getTime()-24*i*36e5),m=await t.prisma.dailyRollup.findMany({where:{organizationId:e,grain:"CAMPAIGN",date:{gte:u,lte:g},conversions:{gt:0}},include:{campaign:{select:{id:!0,name:!0}}}}),h=new Map;for(let e of m){if(!e.campaignId)continue;let t=h.get(e.campaignId)||{name:e.campaign?.name??"Unknown Campaign",totalSpend:0,totalConversions:0};t.totalSpend+=Number(e.spendMicros)/1e6,t.totalConversions+=e.conversions,h.set(e.campaignId,t)}for(let[t,n]of h){if(0===n.totalConversions)continue;let i=n.totalSpend/n.totalConversions;if(i>c){let g=i>p?"CRITICAL":"WARNING";(await l(e,a,g,`CPA Alert: ${n.name}`,`Campaign "${n.name}" has CPA of $${i.toFixed(2)} which exceeds target of $${d.toFixed(2)} (${((i/d-1)*100).toFixed(0)}% over)`,{campaignId:t,campaignName:n.name,cpa:i,targetCpa:d,threshold:i>p?p:c,spend:n.totalSpend,conversions:n.totalConversions},r)).created?o++:s++}}return{created:o,skipped:s}}async function o(e,a,n,i,r){let o=0,s=0,d=n.targetRoas??3,c=n.warningThreshold??.8*d,p=n.criticalThreshold??.5*d,g=new Date,u=new Date(g.getTime()-24*i*36e5),m=await t.prisma.dailyRollup.findMany({where:{organizationId:e,grain:"CAMPAIGN",date:{gte:u,lte:g},spendMicros:{gt:0}},include:{campaign:{select:{id:!0,name:!0}}}}),h=new Map;for(let e of m){if(!e.campaignId)continue;let t=h.get(e.campaignId)||{name:e.campaign?.name??"Unknown Campaign",totalSpend:0,totalRevenue:0};t.totalSpend+=Number(e.spendMicros)/1e6,t.totalRevenue+=Number(e.conversionValue)/1e6,h.set(e.campaignId,t)}for(let[t,n]of h){if(0===n.totalSpend)continue;let i=n.totalRevenue/n.totalSpend;if(i<c){let g=i<p?"CRITICAL":"WARNING";(await l(e,a,g,`ROAS Alert: ${n.name}`,`Campaign "${n.name}" has ROAS of ${i.toFixed(2)}x which is below target of ${d.toFixed(2)}x`,{campaignId:t,campaignName:n.name,roas:i,targetRoas:d,threshold:i<p?p:c,spend:n.totalSpend,revenue:n.totalRevenue},r)).created?o++:s++}}return{created:o,skipped:s}}async function s(e,a,n,i,r){let o=0,s=0,d=n.thresholdHigh??500,c=new Date,p=new Date(c.getTime()-24*i*36e5),g=await t.prisma.dailyRollup.findMany({where:{organizationId:e,grain:"CAMPAIGN",date:{gte:p,lte:c},conversions:0},include:{campaign:{select:{id:!0,name:!0}}}}),u=new Map;for(let e of g){if(!e.campaignId)continue;let t=u.get(e.campaignId)||{name:e.campaign?.name??"Unknown Campaign",totalSpend:0};t.totalSpend+=Number(e.spendMicros)/1e6,u.set(e.campaignId,t)}for(let[t,n]of u)n.totalSpend>=d&&((await l(e,a,"CRITICAL",`Waste Alert: ${n.name}`,`Campaign "${n.name}" spent $${n.totalSpend.toFixed(2)} with zero conversions in the last ${i} days`,{campaignId:t,campaignName:n.name,spend:n.totalSpend,conversions:0,wasteType:"zero_conversions"},r)).created?o++:s++);return{created:o,skipped:s}}async function d(e,a,n,i,r){let o=0,s=0,d=n.dropThreshold??30,c=n.comparisonWindow??7,p=new Date,g=new Date(p.getTime()-24*c*36e5),u=new Date(g.getTime()-24*c*36e5),m=await t.prisma.dailyRollup.findMany({where:{organizationId:e,grain:"ORGANIZATION",date:{gte:g,lte:p}}}),h=await t.prisma.dailyRollup.findMany({where:{organizationId:e,grain:"ORGANIZATION",date:{gte:u,lt:g}}}),w=m.reduce((e,t)=>e+t.conversions,0),f=h.reduce((e,t)=>e+t.conversions,0);if(f>0){let t=(f-w)/f*100;t>=d&&((await l(e,a,t>=50?"CRITICAL":"WARNING","Conversion Drop Alert",`Conversions dropped ${t.toFixed(0)}% compared to previous ${c} days (${w.toFixed(0)} vs ${f.toFixed(0)})`,{currentConversions:w,previousConversions:f,dropPercent:t,comparisonWindow:c},r)).created?o++:s++)}return{created:o,skipped:s}}async function l(e,a,n,i,r,o,s){let d,l=new Date(Date.now()-864e5);if(await t.prisma.alertEvent.findFirst({where:{organizationId:e,title:i,triggeredAt:{gte:l},status:{in:["TRIGGERED","ACKNOWLEDGED"]}}}))return s.debug(`Skipping duplicate alert: ${i}`),{created:!1};if("id"in a&&a.id)d=a.id;else{let i=await t.prisma.alertRule.findFirst({where:{organizationId:e,type:a.type,status:"ACTIVE"}});d=i?i.id:(await t.prisma.alertRule.create({data:{organizationId:e,name:`Auto: ${a.type}`,type:a.type,severity:n,status:"ACTIVE",config:a.config}})).id}await t.prisma.alertEvent.create({data:{organizationId:e,alertRuleId:d,status:"TRIGGERED",severity:n,title:i,message:r,context:o,triggeredAt:new Date}}),s.info(`Created alert: ${i}`,{organizationId:e,severity:n});try{for(let a of(await t.prisma.membership.findMany({where:{organizationId:e,role:{in:["OWNER","ADMIN"]}},select:{userId:!0}})))await t.prisma.inAppNotification.create({data:{organizationId:e,userId:a.userId,title:i,message:r,priority:"CRITICAL"===n?"high":"WARNING"===n?"medium":"normal",status:"pending",metadata:o}})}catch(e){s.warn("Failed to create in-app notifications",{error:e})}return{created:!0}}async function c(e){let a={organizationId:e.organizationId,...e.status?{status:{in:e.status}}:{},...e.severity?{severity:{in:e.severity}}:{}},[n,i]=await Promise.all([t.prisma.alertEvent.findMany({where:a,include:{alertRule:{select:{id:!0,name:!0,type:!0}}},orderBy:{triggeredAt:"desc"},take:e.limit??50,skip:e.offset??0}),t.prisma.alertEvent.count({where:a})]);return{alerts:n.map(e=>({id:e.id,title:e.title,message:e.message,severity:e.severity,status:e.status,triggeredAt:e.triggeredAt,acknowledgedAt:e.acknowledgedAt,resolvedAt:e.resolvedAt,context:e.context,rule:e.alertRule?{id:e.alertRule.id,name:e.alertRule.name,type:e.alertRule.type}:null})),total:i}}async function p(e){await t.prisma.alertEvent.update({where:{id:e.alertId},data:{status:"ACKNOWLEDGED",acknowledgedAt:new Date,acknowledgedBy:e.userId}})}async function g(e){await t.prisma.alertEvent.update({where:{id:e.alertId},data:{status:"RESOLVED",resolvedAt:new Date,resolvedBy:e.userId}})}async function u(e){await t.prisma.alertEvent.update({where:{id:e.alertId},data:{status:"DISMISSED",dismissedAt:new Date,dismissedBy:e.userId}})}e.s(["acknowledgeAlert",()=>p,"dismissAlert",()=>u,"getAlertInbox",()=>c,"resolveAlert",()=>g,"runAlertsEngine",()=>n])}];

//# sourceMappingURL=1c0b7_windsurf-project_apps_frontend_src_lib_jobs_alerts-engine_ts_9951ce20._.js.map