module.exports=[15988,e=>{"use strict";e.i(55007);var t=e.i(60806);e.i(25330);var a=e.i(96685),n=e.i(79443);async function i(e){let i=a.appLogger.child({integration:"google-ads-refresh"}),r=await t.prisma.integrationConnection.findUnique({where:{id:e}});if(!r||"GOOGLE_ADS"!==r.platformCode)throw Error("Invalid Google Ads connection");if(!r.refreshTokenEnc)throw Error("No refresh token available");let o=(0,n.decryptToken)(r.refreshTokenEnc),s=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({client_id:process.env.GOOGLE_CLIENT_ID,client_secret:process.env.GOOGLE_CLIENT_SECRET,refresh_token:o,grant_type:"refresh_token"})});if(!s.ok){let a=await s.text();throw i.error("Failed to refresh Google Ads token",{error:a}),await t.prisma.integrationConnection.update({where:{id:e},data:{status:"ERROR"}}),Error("Failed to refresh token")}let d=await s.json(),c=d.access_token,p=d.expires_in||3600,l=new Date(Date.now()+1e3*p),m=(0,n.encryptToken)(c);return await t.prisma.integrationConnection.update({where:{id:e},data:{accessTokenEnc:m,accessTokenExpiresAt:l,status:"CONNECTED",updatedAt:new Date}}),i.info("Refreshed Google Ads token",{connectionId:e}),{accessToken:c,expiresAt:l}}async function r(e){let i=a.appLogger.child({integration:"meta-refresh"}),r=await t.prisma.integrationConnection.findUnique({where:{id:e}});if(!r||"META"!==r.platformCode)throw Error("Invalid Meta connection");if(!r.accessTokenEnc)throw Error("No access token available");let o=(0,n.decryptToken)(r.accessTokenEnc),s=await fetch(`https://graph.facebook.com/v18.0/oauth/access_token?grant_type=fb_exchange_token&client_id=${process.env.META_APP_ID}&client_secret=${process.env.META_APP_SECRET}&fb_exchange_token=${o}`);if(!s.ok){let a=await s.text();throw i.error("Failed to refresh Meta token",{error:a}),await t.prisma.integrationConnection.update({where:{id:e},data:{status:"ERROR"}}),Error("Failed to refresh token")}let d=await s.json(),c=d.access_token,p=d.expires_in||5184e3,l=new Date(Date.now()+1e3*p),m=(0,n.encryptToken)(c);return await t.prisma.integrationConnection.update({where:{id:e},data:{accessTokenEnc:m,accessTokenExpiresAt:l,status:"CONNECTED",updatedAt:new Date}}),i.info("Refreshed Meta token",{connectionId:e}),{accessToken:c,expiresAt:l}}async function o(e){let a=await t.prisma.integrationConnection.findUnique({where:{id:e}});if(!a)throw Error("Connection not found");if("CONNECTED"!==a.status)throw Error("Connection is not active");if(!a.accessTokenEnc)throw Error("No access token available");let o=new Date,s=a.accessTokenExpiresAt;if(!s||s.getTime()-o.getTime()<3e5){if("GOOGLE_ADS"===a.platformCode){let{accessToken:t}=await i(e);return t}else if("META"===a.platformCode){let{accessToken:t}=await r(e);return t}}return(0,n.decryptToken)(a.accessTokenEnc)}async function s(e,t,n,i,r="CAMPAIGN"){let o,c=a.appLogger.child({integration:"meta-ads-client"}),p=n.toISOString().split("T")[0],l=i.toISOString().split("T")[0];switch(r){case"CAMPAIGN":o="campaign";break;case"ADSET":o="adset";break;case"AD":o="ad"}let m=new URL(`https://graph.facebook.com/v18.0/${t}/insights`);m.searchParams.set("access_token",e),m.searchParams.set("level",o),m.searchParams.set("fields","campaign_id,campaign_name,adset_id,adset_name,ad_id,ad_name,impressions,clicks,spend"),m.searchParams.set("time_range",JSON.stringify({since:p,until:l})),m.searchParams.set("time_increment","1"),m.searchParams.set("limit","1000");let g=[],u=m.toString();for(;u;){c.debug("Fetching Meta insights",{adAccountId:t,level:o,url:u});let e=await fetch(u);if(!e.ok){let t=await e.text();if(c.error("Meta API error",{status:e.status,error:t}),429===e.status){let t=e.headers.get("retry-after"),a=t?1e3*parseInt(t):6e4;c.warn("Rate limited, waiting",{delayMs:a}),await d(a);continue}throw Error(`Meta API error: ${e.status} ${t}`)}let a=await e.json();for(let e of a.data){let t={date:e.date_start,grain:r,entityExternalId:"",entityName:"",impressions:parseInt(e.impressions||"0"),clicks:parseInt(e.clicks||"0"),spendMicros:Math.round(1e6*parseFloat(e.spend||"0"))};switch(r){case"CAMPAIGN":t.entityExternalId=e.campaign_id||"",t.entityName=e.campaign_name||"",t.campaignExternalId=e.campaign_id,t.campaignName=e.campaign_name;break;case"ADSET":t.entityExternalId=e.adset_id||"",t.entityName=e.adset_name||"",t.campaignExternalId=e.campaign_id,t.campaignName=e.campaign_name,t.adsetExternalId=e.adset_id,t.adsetName=e.adset_name;break;case"AD":t.entityExternalId=e.ad_id||"",t.entityName=e.ad_name||"",t.campaignExternalId=e.campaign_id,t.campaignName=e.campaign_name,t.adsetExternalId=e.adset_id,t.adsetName=e.adset_name,t.adExternalId=e.ad_id,t.adName=e.ad_name}g.push(t)}(u=a.paging?.next)&&await d(200)}return c.info("Fetched Meta cost data",{adAccountId:t,grain:r,records:g.length}),g}function d(e){return new Promise(t=>setTimeout(t,e))}async function c(e,t=3,a=1e3){let n;for(let i=0;i<t;i++)try{return await e()}catch(e){if(n=e,i<t-1){let e=a*Math.pow(2,i);await d(e)}}throw n}async function p(e,t,n,i,r,o="CAMPAIGN"){let s,d,c=a.appLogger.child({integration:"google-ads-client"}),m=i.toISOString().split("T")[0].replace(/-/g,""),g=r.toISOString().split("T")[0].replace(/-/g,"");switch(o){case"CAMPAIGN":s=`
        SELECT
          segments.date,
          campaign.id,
          campaign.name,
          metrics.impressions,
          metrics.clicks,
          metrics.cost_micros
        FROM campaign
        WHERE segments.date BETWEEN '${m}' AND '${g}'
          AND campaign.status != 'REMOVED'
      `;break;case"ADGROUP":s=`
        SELECT
          segments.date,
          campaign.id,
          campaign.name,
          ad_group.id,
          ad_group.name,
          metrics.impressions,
          metrics.clicks,
          metrics.cost_micros
        FROM ad_group
        WHERE segments.date BETWEEN '${m}' AND '${g}'
          AND ad_group.status != 'REMOVED'
      `;break;case"AD":s=`
        SELECT
          segments.date,
          campaign.id,
          campaign.name,
          ad_group.id,
          ad_group.name,
          ad_group_ad.ad.id,
          ad_group_ad.ad.name,
          metrics.impressions,
          metrics.clicks,
          metrics.cost_micros
        FROM ad_group_ad
        WHERE segments.date BETWEEN '${m}' AND '${g}'
          AND ad_group_ad.status != 'REMOVED'
      `}let u=`https://googleads.googleapis.com/v16/customers/${n}/googleAds:search`,f=[];do{c.debug("Fetching Google Ads report",{customerId:n,grain:o});let a={query:s};d&&(a.pageToken=d);let i=await fetch(u,{method:"POST",headers:{Authorization:`Bearer ${e}`,"developer-token":t,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok){let e=await i.text();if(c.error("Google Ads API error",{status:i.status,error:e}),429===i.status){let e=i.headers.get("retry-after"),t=e?1e3*parseInt(e):6e4;c.warn("Rate limited, waiting",{delayMs:t}),await l(t);continue}throw Error(`Google Ads API error: ${i.status} ${e}`)}let r=await i.json();for(let e of r.results||[]){let t={date:e.segments?.date||"",grain:o,entityExternalId:"",entityName:"",impressions:parseInt(e.metrics?.impressions||"0"),clicks:parseInt(e.metrics?.clicks||"0"),spendMicros:parseInt(e.metrics?.costMicros||"0")};switch(o){case"CAMPAIGN":t.entityExternalId=e.campaign?.id?.toString()||"",t.entityName=e.campaign?.name||"",t.campaignExternalId=e.campaign?.id?.toString(),t.campaignName=e.campaign?.name;break;case"ADGROUP":t.entityExternalId=e.adGroup?.id?.toString()||"",t.entityName=e.adGroup?.name||"",t.campaignExternalId=e.campaign?.id?.toString(),t.campaignName=e.campaign?.name,t.adGroupExternalId=e.adGroup?.id?.toString(),t.adGroupName=e.adGroup?.name;break;case"AD":t.entityExternalId=e.adGroupAd?.ad?.id?.toString()||"",t.entityName=e.adGroupAd?.ad?.name||"",t.campaignExternalId=e.campaign?.id?.toString(),t.campaignName=e.campaign?.name,t.adGroupExternalId=e.adGroup?.id?.toString(),t.adGroupName=e.adGroup?.name,t.adExternalId=e.adGroupAd?.ad?.id?.toString(),t.adName=e.adGroupAd?.ad?.name}f.push(t)}(d=r.nextPageToken)&&await l(1e4)}while(d)return c.info("Fetched Google Ads cost data",{customerId:n,grain:o,records:f.length}),f}function l(e){return new Promise(t=>setTimeout(t,e))}async function m(e,t=3,a=1e3){let n;for(let i=0;i<t;i++)try{return await e()}catch(e){if(n=e,i<t-1){let e=a*Math.pow(2,i);await l(e)}}throw n}let g=["CAMPAIGN","ADSET","AD"];async function u(e){let n=a.appLogger.child({job:"daily-sync"}),i=new Date,r=new Date;r.setDate(r.getDate()-1),r.setHours(0,0,0,0);let o=e?.fromDate||r,s=e?.toDate||r,d=e?.grains||g;n.info("Starting daily sync",{organizationId:e?.organizationId,fromDate:o.toISOString(),toDate:s.toISOString(),platformCode:e?.platformCode,grains:d});let c=0,p=0,l=0,m=0,u=0,E=[];try{for(let a of(await t.prisma.organization.findMany({where:e?.organizationId?{id:e.organizationId}:{},select:{id:!0,name:!0}}))){n.info("Processing organization",{organizationId:a.id,name:a.name});let i=await t.prisma.integrationConnection.findMany({where:{organizationId:a.id,status:"CONNECTED",...e?.platformCode?{platformCode:e.platformCode}:{}},include:{organization:{select:{id:!0,name:!0}}}});for(let e of(n.info("Found connections",{organizationId:a.id,count:i.length}),i))try{let t=await w(e.organizationId,e.platformCode,o,s,d);E.push(t.id),n.info("Processing connection",{connectionId:e.id,platform:e.platformCode,accountId:e.externalAccountId,jobId:t.id}),await h(t.id,"RUNNING");let a=await f(e.id,e.platformCode,e.externalAccountId,o,s,d);l+=a.created,m+=a.updated,p++,await h(t.id,"SUCCEEDED",{costFactsCreated:a.created,costFactsUpdated:a.updated}),n.info("Connection synced successfully",{connectionId:e.id,created:a.created,updated:a.updated})}catch(a){u++,n.error("Failed to sync connection",{connectionId:e.id,platform:e.platformCode,error:a});let t=E[E.length-1];t&&await h(t,"FAILED",void 0,a.message)}c++}}catch(e){throw n.error("Daily sync failed",e),e}let I=new Date;return n.info("Daily sync completed",{organizationsProcessed:c,connectionsProcessed:p,costFactsCreated:l,costFactsUpdated:m,errors:u,durationMs:I.getTime()-i.getTime()}),{startedAt:i,completedAt:I,organizationsProcessed:c,connectionsProcessed:p,costFactsCreated:l,costFactsUpdated:m,errors:u,jobIds:E}}async function f(e,n,i,r,d,l){let g=a.appLogger.child({connectionId:e,platform:n}),u=0,f=0,w=await o(e),h=await t.prisma.integrationConnection.findUnique({where:{id:e}});if(!h)throw Error("Connection not found");let I=await t.prisma.platform.findFirst({where:{code:n}});if(!I)throw Error(`Platform not found: ${n}`);let A=await t.prisma.adAccount.findFirst({where:{organizationId:h.organizationId,platformId:I.id,externalId:i}});if(!A)throw Error(`Ad account not found: ${i}`);for(let e of l){g.debug("Syncing grain",{grain:e});let t=[];if("META"===n){if("ADGROUP"===e){g.debug("Skipping ADGROUP grain for Meta (not supported)");continue}t=await c(()=>s(w,i,r,d,e))}else if("GOOGLE_ADS"===n){let a=process.env.GOOGLE_ADS_DEVELOPER_TOKEN;if(!a)throw Error("GOOGLE_ADS_DEVELOPER_TOKEN not configured");let n="ADSET"===e?"ADGROUP":e;if("CAMPAIGN"!==n&&"ADGROUP"!==n&&"AD"!==n){g.debug("Skipping unsupported grain for Google Ads",{grain:e});continue}t=await m(()=>p(w,a,i,r,d,n))}else{g.warn("Unsupported platform",{platformCode:n});continue}for(let a of t)(await E(h.organizationId,I.id,A.id,e,a)).created?u++:f++;g.info("Grain synced",{grain:e,records:t.length})}return{created:u,updated:f}}async function E(e,a,n,i,r){let o=new Date(r.date);o.setHours(0,0,0,0);let s=await t.prisma.costFact.findFirst({where:{organizationId:e,platformId:a,adAccountId:n,date:o,grain:i,entityExternalId:r.entityExternalId,publisherPlatform:null}}),d={organizationId:e,platformId:a,adAccountId:n,date:o,grain:i,entityExternalId:r.entityExternalId,entityName:r.entityName,campaignExternalId:r.campaignExternalId,campaignName:r.campaignName,adsetExternalId:r.adsetExternalId||r.adGroupExternalId,adsetName:r.adsetName||r.adGroupName,adExternalId:r.adExternalId,adName:r.adName,publisherPlatform:null,impressions:BigInt(r.impressions),clicks:BigInt(r.clicks),spendMicros:BigInt(r.spendMicros),conversions:BigInt(0),revenueMicros:BigInt(0)};return s?(await t.prisma.costFact.update({where:{id:s.id},data:{...d,updatedAt:new Date}}),{created:!1}):(await t.prisma.costFact.create({data:d}),{created:!0})}async function w(e,a,n,i,r){let o=`daily-sync-${e}-${a}-${n.toISOString().split("T")[0]}-${i.toISOString().split("T")[0]}`;return{id:(await t.prisma.ingestionJob.create({data:{organizationId:e,platform:a,jobType:"DAILY_SYNC",status:"QUEUED",idempotencyKey:o,payload:{fromDate:n.toISOString(),toDate:i.toISOString(),grains:r}}})).id}}async function h(e,a,n,i){await t.prisma.ingestionJob.update({where:{id:e},data:{status:a,...n?{payload:n}:{},...i?{lastError:i}:{},attempts:{increment:1},updatedAt:new Date}})}e.s(["runDailySync",()=>u],15988)}];

//# sourceMappingURL=1c0b7_windsurf-project_apps_frontend_src_lib_jobs_run-daily-sync_ts_f6ba7409._.js.map