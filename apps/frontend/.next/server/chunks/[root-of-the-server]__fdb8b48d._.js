module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},49719,(e,t,r)=>{t.exports=e.x("assert",()=>require("assert"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},87769,(e,t,r)=>{t.exports=e.x("node:events",()=>require("node:events"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},62562,(e,t,r)=>{t.exports=e.x("module",()=>require("module"))},50227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},48934,e=>{e.v({name:"thread-stream",version:"3.1.0",description:"A streaming way to send data to a Node.js Worker Thread",main:"index.js",types:"index.d.ts",dependencies:{"real-require":"^0.2.0"},devDependencies:{"@types/node":"^20.1.0","@types/tap":"^15.0.0","@yao-pkg/pkg":"^5.11.5",desm:"^1.3.0",fastbench:"^1.0.1",husky:"^9.0.6","pino-elasticsearch":"^8.0.0","sonic-boom":"^4.0.1",standard:"^17.0.0",tap:"^16.2.0","ts-node":"^10.8.0",typescript:"^5.3.2","why-is-node-running":"^2.2.2"},scripts:{build:"tsc --noEmit",test:'standard && npm run build && npm run transpile && tap "test/**/*.test.*js" && tap --ts test/*.test.*ts',"test:ci":"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts","test:ci:js":'tap --no-check-coverage --timeout=120 --coverage-report=lcovonly "test/**/*.test.*js"',"test:ci:ts":'tap --ts --no-check-coverage --coverage-report=lcovonly "test/**/*.test.*ts"',"test:yarn":'npm run transpile && tap "test/**/*.test.js" --no-check-coverage',transpile:"sh ./test/ts/transpile.sh",prepare:"husky install"},standard:{ignore:["test/ts/**/*","test/syntax-error.mjs"]},repository:{type:"git",url:"git+https://github.com/mcollina/thread-stream.git"},keywords:["worker","thread","threads","stream"],author:"Matteo Collina <hello@matteocollina.com>",license:"MIT",bugs:{url:"https://github.com/mcollina/thread-stream/issues"},homepage:"https://github.com/mcollina/thread-stream#readme"})},37702,(e,t,r)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},60526,(e,t,r)=>{t.exports=e.x("node:os",()=>require("node:os"))},77652,(e,t,r)=>{t.exports=e.x("node:diagnostics_channel",()=>require("node:diagnostics_channel"))},21517,(e,t,r)=>{t.exports=e.x("http",()=>require("http"))},24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},6461,(e,t,r)=>{t.exports=e.x("zlib",()=>require("zlib"))},45706,(e,t,r)=>{t.exports=e.x("querystring",()=>require("querystring"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},75912,e=>{"use strict";e.i(55007);var t=e.i(66680),r=e.i(80608);let a="aes-256-gcm";function s(){let e=r.env.DATA_ENCRYPTION_KEY,t=Buffer.from(e,"base64");if(32!==t.length)throw Error("DATA_ENCRYPTION_KEY must be base64-encoded 32 bytes");return t}function n(e){let r=t.default.randomBytes(12),n=t.default.createCipheriv(a,s(),r),i=Buffer.concat([n.update(e,"utf8"),n.final()]),o=n.getAuthTag(),c={v:1,iv:r.toString("base64"),tag:o.toString("base64"),ct:i.toString("base64")};return Buffer.from(JSON.stringify(c),"utf8").toString("base64")}function i(e){let r=JSON.parse(Buffer.from(e,"base64").toString("utf8"));if(1!==r.v)throw Error("Unsupported encryption payload version");let n=Buffer.from(r.iv,"base64"),i=Buffer.from(r.tag,"base64"),o=Buffer.from(r.ct,"base64"),c=t.default.createDecipheriv(a,s(),n);return c.setAuthTag(i),Buffer.concat([c.update(o),c.final()]).toString("utf8")}function o(e){return n(JSON.stringify(e))}function c(e){return JSON.parse(i(e))}e.s(["decryptJson",()=>c,"decryptString",()=>i,"encryptJson",()=>o,"encryptString",()=>n])},33108,e=>{"use strict";e.i(55007);var t=e.i(80608),r=e.i(60806),a=e.i(75912);class s{baseUrl;constructor(){this.baseUrl=`https://graph.facebook.com/${t.env.META_API_VERSION}`}buildAuthUrl(e){let r=new URL("https://www.facebook.com/v20.0/dialog/oauth");return r.searchParams.set("client_id",t.env.META_APP_ID),r.searchParams.set("redirect_uri",t.env.META_OAUTH_REDIRECT_URI),r.searchParams.set("scope","ads_read,read_insights,business_management"),r.searchParams.set("response_type","code"),r.searchParams.set("state",e),r.toString()}async exchangeCode(e){let r=new URL(`${this.baseUrl}/oauth/access_token`);r.searchParams.set("client_id",t.env.META_APP_ID),r.searchParams.set("client_secret",t.env.META_APP_SECRET),r.searchParams.set("redirect_uri",t.env.META_OAUTH_REDIRECT_URI),r.searchParams.set("code",e);let a=await fetch(r,{method:"GET"}),s=await a.json().catch(()=>null);if(!a.ok||!s?.access_token)throw Error(`META_OAUTH_EXCHANGE_FAILED_${a.status}:${JSON.stringify(s)}`);return{access_token:String(s.access_token),token_type:s.token_type?String(s.token_type):void 0,expires_in:s.expires_in?Number(s.expires_in):void 0}}async exchangeForLongLivedToken(e){let r=new URL(`${this.baseUrl}/oauth/access_token`);r.searchParams.set("grant_type","fb_exchange_token"),r.searchParams.set("client_id",t.env.META_APP_ID),r.searchParams.set("client_secret",t.env.META_APP_SECRET),r.searchParams.set("fb_exchange_token",e);let a=await fetch(r,{method:"GET"}),s=await a.json().catch(()=>null);if(!a.ok||!s?.access_token)throw Error(`META_OAUTH_LONG_LIVED_FAILED_${a.status}:${JSON.stringify(s)}`);return{access_token:String(s.access_token),token_type:s.token_type?String(s.token_type):void 0,expires_in:s.expires_in?Number(s.expires_in):void 0}}async getValidAccessToken(e){let t=await r.prisma.metaAdsCredential.findUnique({where:{organizationId_adAccountId:{organizationId:e.organizationId,adAccountId:e.metaAdAccountId}},select:{accessTokenEnc:!0,accessTokenExpiresAt:!0}});if(!t)throw Error("META_ADS_NOT_CONNECTED");let s=Date.now();if((t.accessTokenExpiresAt?.getTime()??0)-s>6048e5)return{accessToken:(0,a.decryptString)(t.accessTokenEnc)};let n=(0,a.decryptString)(t.accessTokenEnc),i=await this.exchangeForLongLivedToken(n),o=i.expires_in?new Date(Date.now()+1e3*i.expires_in):null;return await r.prisma.metaAdsCredential.update({where:{organizationId_adAccountId:{organizationId:e.organizationId,adAccountId:e.metaAdAccountId}},data:{accessTokenEnc:(0,a.encryptString)(i.access_token),accessTokenExpiresAt:o},select:{id:!0}}),{accessToken:i.access_token}}async fetchWithRetry(e,t=0){let r=await fetch(e,{method:"GET"});if(429!==r.status&&503!==r.status||t>=6)return r;let a=r.headers.get("retry-after"),s=a?1e3*Number.parseInt(a,10):0,n=Math.min(3e4,2**t*500+Math.floor(250*Math.random()));return await new Promise(e=>setTimeout(e,Math.max(s,n))),this.fetchWithRetry(e,t+1)}async fetchDailyCampaignInsights(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,metaAdAccountId:e.metaAdAccountId}),r=new URL(`${this.baseUrl}/${e.metaAdAccountId}/insights`);r.searchParams.set("fields","date_start,campaign_id,campaign_name,impressions,clicks,spend,actions,publisher_platform"),r.searchParams.set("level","campaign"),r.searchParams.set("time_increment","1"),r.searchParams.set("time_range",JSON.stringify({since:e.startDate,until:e.endDate})),r.searchParams.set("breakdowns","publisher_platform"),r.searchParams.set("access_token",t);let a=await this.fetchWithRetry(r.toString()),s=await a.json().catch(()=>null);if(!a.ok)throw Error(`META_API_ERROR_${a.status}:${JSON.stringify(s)}`);return(s?.data??[]).map(n)}async fetchDailyAdInsights(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,metaAdAccountId:e.metaAdAccountId}),r=new URL(`${this.baseUrl}/${e.metaAdAccountId}/insights`);r.searchParams.set("fields","date_start,campaign_id,campaign_name,ad_id,ad_name,impressions,clicks,spend,actions,publisher_platform"),r.searchParams.set("level","ad"),r.searchParams.set("time_increment","1"),r.searchParams.set("time_range",JSON.stringify({since:e.startDate,until:e.endDate})),r.searchParams.set("breakdowns","publisher_platform"),r.searchParams.set("access_token",t);let a=await this.fetchWithRetry(r.toString()),s=await a.json().catch(()=>null);if(!a.ok)throw Error(`META_API_ERROR_${a.status}:${JSON.stringify(s)}`);return(s?.data??[]).map(n)}}function n(e){let t;return{date:String(e?.date_start),publisherPlatform:String(e?.publisher_platform??"facebook"),campaignId:String(e?.campaign_id),campaignName:String(e?.campaign_name??""),adId:e?.ad_id?String(e.ad_id):void 0,adName:e?.ad_name?String(e.ad_name):void 0,impressions:BigInt(e?.impressions??0),clicks:BigInt(e?.clicks??0),spendMicros:Number.isFinite(t=Number(e?.spend??0))?BigInt(Math.round(1e6*t)):0n,conversions:function(e){if(!Array.isArray(e))return 0n;let t=new Set(["purchase","offsite_conversion.purchase","omni_purchase","complete_registration","lead"]),r=0n;for(let a of e){let e=a?.action_type,s=a?.value;e&&t.has(e)&&(r+=BigInt(Number(s??0)))}return r}(e?.actions)}}e.s(["MetaAdsService",()=>s])},53156,e=>{"use strict";e.i(55007);var t=e.i(80608),r=e.i(60806),a=e.i(75912);class s{baseUrl;constructor(){this.baseUrl=t.env.TIKTOK_API_BASE_URL}buildAuthUrl(e){let r=new URL("https://www.tiktok.com/v2/auth/authorize/");return r.searchParams.set("client_key",t.env.TIKTOK_APP_ID),r.searchParams.set("redirect_uri",t.env.TIKTOK_OAUTH_REDIRECT_URI),r.searchParams.set("response_type","code"),r.searchParams.set("scope","ads.read,reporting.read"),r.searchParams.set("state",e.state),r.toString()}async exchangeCode(e){let r=new URL("/open_api/v1.3/oauth2/access_token/",this.baseUrl),a=await fetch(r,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:t.env.TIKTOK_APP_ID,secret:t.env.TIKTOK_APP_SECRET,auth_code:e,grant_type:"authorization_code"})}),s=await a.json().catch(()=>null);if(!a.ok||!s||0!==s.code||!s.data)throw Error(`TIKTOK_OAUTH_EXCHANGE_FAILED_${a.status}:${JSON.stringify(s)}`);return s.data}async refreshToken(e){let r=new URL("/open_api/v1.3/oauth2/refresh_token/",this.baseUrl),a=await fetch(r,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:t.env.TIKTOK_APP_ID,secret:t.env.TIKTOK_APP_SECRET,refresh_token:e,grant_type:"refresh_token"})}),s=await a.json().catch(()=>null);if(!a.ok||!s||0!==s.code||!s.data)throw Error(`TIKTOK_OAUTH_REFRESH_FAILED_${a.status}:${JSON.stringify(s)}`);return s.data}async getValidAccessToken(e){let t=await r.prisma.tikTokAdsCredential.findUnique({where:{organizationId_advertiserId:{organizationId:e.organizationId,advertiserId:e.advertiserId}},select:{accessTokenEnc:!0,refreshTokenEnc:!0,accessTokenExpiresAt:!0,refreshTokenExpiresAt:!0}});if(!t)throw Error("TIKTOK_ADS_NOT_CONNECTED");let s=Date.now(),n=t.accessTokenExpiresAt?.getTime()??0;if(t.accessTokenEnc&&n-s>6e4)return{accessToken:(0,a.decryptString)(t.accessTokenEnc)};let i=t.refreshTokenExpiresAt?.getTime()??0;if(i&&i-s<=0)throw Error("TIKTOK_REFRESH_TOKEN_EXPIRED");let o=(0,a.decryptString)(t.refreshTokenEnc),c=await this.refreshToken(o),d=new Date(Date.now()+1e3*c.expires_in),p=new Date(Date.now()+1e3*c.refresh_expires_in);return await r.prisma.tikTokAdsCredential.update({where:{organizationId_advertiserId:{organizationId:e.organizationId,advertiserId:e.advertiserId}},data:{accessTokenEnc:(0,a.encryptString)(c.access_token),refreshTokenEnc:(0,a.encryptString)(c.refresh_token),accessTokenExpiresAt:d,refreshTokenExpiresAt:p},select:{id:!0}}),{accessToken:c.access_token}}async fetchWithRetry(e,t,r=0){let a=await fetch(e,t);if(429!==a.status&&503!==a.status||r>=6)return a;let s=a.headers.get("retry-after"),n=s?1e3*Number.parseInt(s,10):0,i=Math.min(3e4,2**r*500+Math.floor(250*Math.random()));return await new Promise(e=>setTimeout(e,Math.max(n,i))),this.fetchWithRetry(e,t,r+1)}async fetchDailyCampaignReport(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,advertiserId:e.advertiserId}),r=new URL("/open_api/v1.3/report/integrated/get/",this.baseUrl),a={advertiser_id:e.advertiserId,report_type:"BASIC",dimensions:["stat_time_day","campaign_id"],metrics:["spend","impressions","clicks","conversion"],start_date:e.startDate,end_date:e.endDate,page:1,page_size:1e3},s=await this.fetchWithRetry(r.toString(),{method:"POST",headers:{"content-type":"application/json","access-token":t},body:JSON.stringify(a)}),n=await s.json().catch(()=>null);if(!s.ok||!n||0!==n.code)throw Error(`TIKTOK_REPORT_ERROR_${s.status}:${JSON.stringify(n)}`);return(n.data?.list??[]).map(i)}async fetchDailyAdReport(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,advertiserId:e.advertiserId}),r=new URL("/open_api/v1.3/report/integrated/get/",this.baseUrl),a={advertiser_id:e.advertiserId,report_type:"BASIC",dimensions:["stat_time_day","campaign_id","ad_id"],metrics:["spend","impressions","clicks","conversion"],start_date:e.startDate,end_date:e.endDate,page:1,page_size:1e3},s=await this.fetchWithRetry(r.toString(),{method:"POST",headers:{"content-type":"application/json","access-token":t},body:JSON.stringify(a)}),n=await s.json().catch(()=>null);if(!s.ok||!n||0!==n.code)throw Error(`TIKTOK_REPORT_ERROR_${s.status}:${JSON.stringify(n)}`);return(n.data?.list??[]).map(o)}}function n(e){let t=Number(e??0);return Number.isFinite(t)?BigInt(Math.round(1e6*t)):0n}function i(e){return{date:String(e?.dimensions?.stat_time_day??e?.stat_time_day),campaignId:String(e?.dimensions?.campaign_id??e?.campaign_id),campaignName:String(e?.dimensions?.campaign_name??""),impressions:BigInt(e?.metrics?.impressions??e?.impressions??0),clicks:BigInt(e?.metrics?.clicks??e?.clicks??0),conversions:BigInt(e?.metrics?.conversion??e?.conversion??0),spendMicros:n(e?.metrics?.spend??e?.spend??0)}}function o(e){return{date:String(e?.dimensions?.stat_time_day??e?.stat_time_day),campaignId:String(e?.dimensions?.campaign_id??e?.campaign_id),campaignName:String(e?.dimensions?.campaign_name??""),adId:String(e?.dimensions?.ad_id??e?.ad_id),adName:e?.dimensions?.ad_name?String(e.dimensions.ad_name):void 0,impressions:BigInt(e?.metrics?.impressions??e?.impressions??0),clicks:BigInt(e?.metrics?.clicks??e?.clicks??0),conversions:BigInt(e?.metrics?.conversion??e?.conversion??0),spendMicros:n(e?.metrics?.spend??e?.spend??0)}}e.s(["TikTokAdsService",()=>s])},81897,23354,e=>{"use strict";e.i(55007);var t=e.i(60806),r=e.i(46989);let a=r.z.object({platform:r.z.enum(["GOOGLE_ADS","META","TIKTOK"]),externalAccountId:r.z.string().min(1),startDate:r.z.string().regex(/^\d{4}-\d{2}-\d{2}$/),endDate:r.z.string().regex(/^\d{4}-\d{2}-\d{2}$/),granularity:r.z.enum(["campaign","ad"])});function s(e){return["daily-sync",e.organizationId,e.platform,e.externalAccountId,e.startDate,e.endDate,e.granularity].join(":")}async function n(e){let r=s({organizationId:e.organizationId,platform:e.payload.platform,externalAccountId:e.payload.externalAccountId,startDate:e.payload.startDate,endDate:e.payload.endDate,granularity:e.payload.granularity});return await t.prisma.ingestionJob.upsert({where:{idempotencyKey:r},create:{organizationId:e.organizationId,platform:e.payload.platform,jobType:"DAILY_SYNC",status:"QUEUED",idempotencyKey:r,payload:e.payload,runAt:e.runAt??new Date,attempts:0,maxAttempts:8},update:{runAt:e.runAt??new Date,status:"QUEUED"},select:{id:!0,status:!0,runAt:!0,idempotencyKey:!0}})}function i(e){let t=Math.min(18e5,2**Math.min(e,10)*1e3+Math.floor(250*Math.random()));return new Date(Date.now()+t)}e.s(["DailySyncPayloadSchema",0,a,"buildIdempotencyKey",()=>s],23354),e.s(["computeNextRunAt",()=>i,"enqueueDailySync",()=>n],81897)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__fdb8b48d._.js.map