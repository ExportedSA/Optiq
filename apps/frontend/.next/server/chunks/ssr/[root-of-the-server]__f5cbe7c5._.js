module.exports=[93695,(a,b,c)=>{b.exports=a.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},11858,a=>{a.n(a.i(35669))},69622,a=>{a.n(a.i(56257))},37698,a=>{a.n(a.i(36758))},15207,a=>{a.n(a.i(68742))},7240,a=>{a.n(a.i(83422))},2392,a=>{a.n(a.i(80810))},88372,51601,a=>{"use strict";a.i(36822);var b=a.i(10701);let c={spendThresholdMicros:BigInt(5e7),targetCpaMicros:BigInt(25e6),cpaTolerancePercent:50,minImpressions:1e3,minCtrPercent:.5,rollingWindowDays:7};function d(a){return Number(a)/1e6}function e(a,b){return b===BigInt(0)?null:Number(a)/Number(b)}function f(a,b,c){let e=d(a),f=d(b.spendThresholdMicros);if("zero_conversions_high_spend"===c)return e>=5*f?"critical":e>=2*f?"high":e>=f?"medium":"low";if("cpa_above_target"===c){if(e>=3*f)return"high";if(e>=f)return"medium"}return"low"}function g(a,b){let c=b??new Date;c.setHours(23,59,59,999);let d=new Date(c);return d.setDate(d.getDate()-a+1),d.setHours(0,0,0,0),{start:d,end:c,days:a}}function h(a,b,c,d){let e=d.toISOString().split("T")[0];return`${a}_${b}_${c}_${e}`}function i(a,b){switch(a){case"zero_conversions_high_spend":return`Consider pausing this ${b.entityType.replace("_"," ")} or reviewing targeting. Spent $${d(b.spendMicros).toFixed(2)} with no conversions.`;case"cpa_above_target":let c=e(b.spendMicros,b.conversions);return`CPA of $${c?.toFixed(2)??"N/A"} exceeds target. Review ad creative, landing page, or audience targeting.`;case"low_ctr_high_spend":var f,g;let h=(f=b.clicks,(g=b.impressions)===BigInt(0)?0:Number(f)/Number(g)*100);return`CTR of ${h.toFixed(2)}% is below threshold. Consider refreshing creative or adjusting targeting.`;case"declining_performance":return"Performance has declined over the analysis period. Review recent changes and consider optimization.";default:return`Review this ${b.entityType.replace("_"," ")} for potential optimization opportunities.`}}class j{config;constructor(a={}){this.config={...c,...a}}async evaluateOrganization(a){let b=g(a.windowDays??this.config.rollingWindowDays,a.endDate),[c,d,e]=await Promise.all([this.evaluateAdAccounts(a.organizationId,b),this.evaluateCampaigns(a.organizationId,b),this.evaluateAds(a.organizationId,b)]),f=[...c,...d,...e],h=f.reduce((a,b)=>a+b.spendMicros,BigInt(0)),i={none:0,low:0,medium:0,high:0,critical:0},j={zero_conversions_high_spend:0,cpa_above_target:0,low_ctr_high_spend:0,declining_performance:0},k={ad_account:0,campaign:0,ad:0};for(let a of f)i[a.level]++,j[a.reason]++,k[a.entityType]++;return{organizationId:a.organizationId,windowStart:b.start,windowEnd:b.end,totalWastedSpendMicros:h,alerts:f,byLevel:i,byReason:j,byEntityType:k}}async evaluateAdAccounts(a,c){let d=await b.prisma.dailyAdAccountMetric.groupBy({by:["adAccountId"],where:{organizationId:a,date:{gte:c.start,lte:c.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),e=[];for(let f of d){let d=await b.prisma.adAccount.findUnique({where:{id:f.adAccountId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!d)continue;let g={entityId:f.adAccountId,entityName:d.name,entityType:"ad_account",platformCode:d.platform.code,impressions:f._sum.impressions??BigInt(0),clicks:f._sum.clicks??BigInt(0),spendMicros:f._sum.spendMicros??BigInt(0),conversions:f._sum.conversions??BigInt(0),revenueMicros:f._sum.revenueMicros??BigInt(0)},h=this.detectWaste(g,c,a);e.push(...h)}return e}async evaluateCampaigns(a,c){let d=await b.prisma.dailyCampaignMetric.groupBy({by:["campaignId"],where:{organizationId:a,date:{gte:c.start,lte:c.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),e=[];for(let f of d){let d=await b.prisma.campaign.findUnique({where:{id:f.campaignId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!d)continue;let g={entityId:f.campaignId,entityName:d.name,entityType:"campaign",platformCode:d.platform.code,impressions:f._sum.impressions??BigInt(0),clicks:f._sum.clicks??BigInt(0),spendMicros:f._sum.spendMicros??BigInt(0),conversions:f._sum.conversions??BigInt(0),revenueMicros:f._sum.revenueMicros??BigInt(0)},h=this.detectWaste(g,c,a);e.push(...h)}return e}async evaluateAds(a,c){let d=await b.prisma.dailyAdMetric.groupBy({by:["adId"],where:{organizationId:a,date:{gte:c.start,lte:c.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),e=[];for(let f of d){let d=await b.prisma.ad.findUnique({where:{id:f.adId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!d)continue;let g={entityId:f.adId,entityName:d.name??`Ad ${f.adId}`,entityType:"ad",platformCode:d.platform.code,impressions:f._sum.impressions??BigInt(0),clicks:f._sum.clicks??BigInt(0),spendMicros:f._sum.spendMicros??BigInt(0),conversions:f._sum.conversions??BigInt(0),revenueMicros:f._sum.revenueMicros??BigInt(0)},h=this.detectWaste(g,c,a);e.push(...h)}return e}detectWaste(a,b,c){let g=[];if(a.spendMicros>=this.config.spendThresholdMicros&&a.conversions===BigInt(0)){let e="zero_conversions_high_spend",j=f(a.spendMicros,this.config,e);g.push({id:h(a.entityType,a.entityId,e,b.end),entityType:a.entityType,entityId:a.entityId,entityName:a.entityName,organizationId:c,platformCode:a.platformCode,reason:e,level:j,spendMicros:a.spendMicros,conversions:0,cpa:null,targetCpa:d(this.config.targetCpaMicros),windowStart:b.start,windowEnd:b.end,message:`${a.entityName} spent $${d(a.spendMicros).toFixed(2)} with zero conversions in the last ${b.days} days.`,recommendation:i(e,a)})}if(a.conversions>BigInt(0)){let j=e(a.spendMicros,a.conversions),k=d(this.config.targetCpaMicros),l=k*(1+this.config.cpaTolerancePercent/100);if(null!==j&&j>1e6*l){let d="cpa_above_target",e=f(a.spendMicros,this.config,d),l=a.spendMicros-BigInt(Math.round(1e6*k*Number(a.conversions)));g.push({id:h(a.entityType,a.entityId,d,b.end),entityType:a.entityType,entityId:a.entityId,entityName:a.entityName,organizationId:c,platformCode:a.platformCode,reason:d,level:e,spendMicros:l>BigInt(0)?l:a.spendMicros,conversions:Number(a.conversions),cpa:j/1e6,targetCpa:k,windowStart:b.start,windowEnd:b.end,message:`${a.entityName} has CPA of $${(j/1e6).toFixed(2)} vs target of $${k.toFixed(2)} (${((j/1e6/k-1)*100).toFixed(0)}% over).`,recommendation:i(d,a)})}}return g}async evaluateCampaign(a){let c=g(a.windowDays??this.config.rollingWindowDays,a.endDate),d=await b.prisma.dailyCampaignMetric.aggregate({where:{organizationId:a.organizationId,campaignId:a.campaignId,date:{gte:c.start,lte:c.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),e=await b.prisma.campaign.findUnique({where:{id:a.campaignId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!e)return[];let f={entityId:a.campaignId,entityName:e.name,entityType:"campaign",platformCode:e.platform.code,impressions:d._sum.impressions??BigInt(0),clicks:d._sum.clicks??BigInt(0),spendMicros:d._sum.spendMicros??BigInt(0),conversions:d._sum.conversions??BigInt(0),revenueMicros:d._sum.revenueMicros??BigInt(0)};return this.detectWaste(f,c,a.organizationId)}async evaluateAd(a){let c=g(a.windowDays??this.config.rollingWindowDays,a.endDate),d=await b.prisma.dailyAdMetric.aggregate({where:{organizationId:a.organizationId,adId:a.adId,date:{gte:c.start,lte:c.end}},_sum:{impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}}),e=await b.prisma.ad.findUnique({where:{id:a.adId},select:{id:!0,name:!0,platform:{select:{code:!0}}}});if(!e)return[];let f={entityId:a.adId,entityName:e.name??`Ad ${a.adId}`,entityType:"ad",platformCode:e.platform.code,impressions:d._sum.impressions??BigInt(0),clicks:d._sum.clicks??BigInt(0),spendMicros:d._sum.spendMicros??BigInt(0),conversions:d._sum.conversions??BigInt(0),revenueMicros:d._sum.revenueMicros??BigInt(0)};return this.detectWaste(f,c,a.organizationId)}getConfig(){return{...this.config}}withConfig(a){return new j({...this.config,...a})}}let k=new j;a.s(["wasteEvaluator",0,k],51601),a.s([],88372)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__f5cbe7c5._.js.map