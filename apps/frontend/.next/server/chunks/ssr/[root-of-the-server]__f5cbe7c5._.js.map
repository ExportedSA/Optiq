{"version":3,"sources":["../../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/waste/evaluator.ts","../../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/waste/types.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport type {\r\n  WasteConfig,\r\n  WasteAlert,\r\n  WasteAnalysis,\r\n  WasteLevel,\r\n  WasteReason,\r\n  EntityType,\r\n  AggregatedMetrics,\r\n} from \"./types\";\r\nimport {\r\n  DEFAULT_WASTE_CONFIG,\r\n  microsToDollars,\r\n  computeCpa,\r\n  computeCtr,\r\n  determineWasteLevel,\r\n} from \"./types\";\r\n\r\ntype RollingWindow = {\r\n  start: Date;\r\n  end: Date;\r\n  days: number;\r\n};\r\n\r\nfunction createRollingWindow(days: number, endDate?: Date): RollingWindow {\r\n  const end = endDate ?? new Date();\r\n  end.setHours(23, 59, 59, 999);\r\n\r\n  const start = new Date(end);\r\n  start.setDate(start.getDate() - days + 1);\r\n  start.setHours(0, 0, 0, 0);\r\n\r\n  return { start, end, days };\r\n}\r\n\r\nfunction generateAlertId(\r\n  entityType: EntityType,\r\n  entityId: string,\r\n  reason: WasteReason,\r\n  windowEnd: Date\r\n): string {\r\n  const dateStr = windowEnd.toISOString().split(\"T\")[0];\r\n  return `${entityType}_${entityId}_${reason}_${dateStr}`;\r\n}\r\n\r\nfunction buildRecommendation(reason: WasteReason, metrics: AggregatedMetrics): string {\r\n  switch (reason) {\r\n    case \"zero_conversions_high_spend\":\r\n      return `Consider pausing this ${metrics.entityType.replace(\"_\", \" \")} or reviewing targeting. Spent $${microsToDollars(metrics.spendMicros).toFixed(2)} with no conversions.`;\r\n\r\n    case \"cpa_above_target\":\r\n      const cpa = computeCpa(metrics.spendMicros, metrics.conversions);\r\n      return `CPA of $${cpa?.toFixed(2) ?? \"N/A\"} exceeds target. Review ad creative, landing page, or audience targeting.`;\r\n\r\n    case \"low_ctr_high_spend\":\r\n      const ctr = computeCtr(metrics.clicks, metrics.impressions);\r\n      return `CTR of ${ctr.toFixed(2)}% is below threshold. Consider refreshing creative or adjusting targeting.`;\r\n\r\n    case \"declining_performance\":\r\n      return `Performance has declined over the analysis period. Review recent changes and consider optimization.`;\r\n\r\n    default:\r\n      return `Review this ${metrics.entityType.replace(\"_\", \" \")} for potential optimization opportunities.`;\r\n  }\r\n}\r\n\r\nexport class WasteEvaluator {\r\n  private readonly config: WasteConfig;\r\n\r\n  constructor(config: Partial<WasteConfig> = {}) {\r\n    this.config = { ...DEFAULT_WASTE_CONFIG, ...config };\r\n  }\r\n\r\n  async evaluateOrganization(params: {\r\n    organizationId: string;\r\n    windowDays?: number;\r\n    endDate?: Date;\r\n  }): Promise<WasteAnalysis> {\r\n    const window = createRollingWindow(\r\n      params.windowDays ?? this.config.rollingWindowDays,\r\n      params.endDate\r\n    );\r\n\r\n    const [accountAlerts, campaignAlerts, adAlerts] = await Promise.all([\r\n      this.evaluateAdAccounts(params.organizationId, window),\r\n      this.evaluateCampaigns(params.organizationId, window),\r\n      this.evaluateAds(params.organizationId, window),\r\n    ]);\r\n\r\n    const alerts = [...accountAlerts, ...campaignAlerts, ...adAlerts];\r\n\r\n    const totalWastedSpendMicros = alerts.reduce(\r\n      (sum, a) => sum + a.spendMicros,\r\n      BigInt(0)\r\n    );\r\n\r\n    const byLevel: Record<WasteLevel, number> = {\r\n      none: 0,\r\n      low: 0,\r\n      medium: 0,\r\n      high: 0,\r\n      critical: 0,\r\n    };\r\n\r\n    const byReason: Record<WasteReason, number> = {\r\n      zero_conversions_high_spend: 0,\r\n      cpa_above_target: 0,\r\n      low_ctr_high_spend: 0,\r\n      declining_performance: 0,\r\n    };\r\n\r\n    const byEntityType: Record<EntityType, number> = {\r\n      ad_account: 0,\r\n      campaign: 0,\r\n      ad: 0,\r\n    };\r\n\r\n    for (const alert of alerts) {\r\n      byLevel[alert.level]++;\r\n      byReason[alert.reason]++;\r\n      byEntityType[alert.entityType]++;\r\n    }\r\n\r\n    return {\r\n      organizationId: params.organizationId,\r\n      windowStart: window.start,\r\n      windowEnd: window.end,\r\n      totalWastedSpendMicros,\r\n      alerts,\r\n      byLevel,\r\n      byReason,\r\n      byEntityType,\r\n    };\r\n  }\r\n\r\n  private async evaluateAdAccounts(\r\n    organizationId: string,\r\n    window: RollingWindow\r\n  ): Promise<WasteAlert[]> {\r\n    const metrics = await prisma.dailyAdAccountMetric.groupBy({\r\n      by: [\"adAccountId\"],\r\n      where: {\r\n        organizationId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    for (const m of metrics) {\r\n      const account = await prisma.adAccount.findUnique({\r\n        where: { id: m.adAccountId },\r\n        select: { id: true, name: true, platform: { select: { code: true } } },\r\n      });\r\n\r\n      if (!account) continue;\r\n\r\n      const aggregated: AggregatedMetrics = {\r\n        entityId: m.adAccountId,\r\n        entityName: account.name,\r\n        entityType: \"ad_account\",\r\n        platformCode: account.platform.code,\r\n        impressions: m._sum.impressions ?? BigInt(0),\r\n        clicks: m._sum.clicks ?? BigInt(0),\r\n        spendMicros: m._sum.spendMicros ?? BigInt(0),\r\n        conversions: m._sum.conversions ?? BigInt(0),\r\n        revenueMicros: m._sum.revenueMicros ?? BigInt(0),\r\n      };\r\n\r\n      const accountAlerts = this.detectWaste(aggregated, window, organizationId);\r\n      alerts.push(...accountAlerts);\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private async evaluateCampaigns(\r\n    organizationId: string,\r\n    window: RollingWindow\r\n  ): Promise<WasteAlert[]> {\r\n    const metrics = await prisma.dailyCampaignMetric.groupBy({\r\n      by: [\"campaignId\"],\r\n      where: {\r\n        organizationId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    for (const m of metrics) {\r\n      const campaign = await prisma.campaign.findUnique({\r\n        where: { id: m.campaignId },\r\n        select: { id: true, name: true, platform: { select: { code: true } } },\r\n      });\r\n\r\n      if (!campaign) continue;\r\n\r\n      const aggregated: AggregatedMetrics = {\r\n        entityId: m.campaignId,\r\n        entityName: campaign.name,\r\n        entityType: \"campaign\",\r\n        platformCode: campaign.platform.code,\r\n        impressions: m._sum.impressions ?? BigInt(0),\r\n        clicks: m._sum.clicks ?? BigInt(0),\r\n        spendMicros: m._sum.spendMicros ?? BigInt(0),\r\n        conversions: m._sum.conversions ?? BigInt(0),\r\n        revenueMicros: m._sum.revenueMicros ?? BigInt(0),\r\n      };\r\n\r\n      const campaignAlerts = this.detectWaste(aggregated, window, organizationId);\r\n      alerts.push(...campaignAlerts);\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private async evaluateAds(\r\n    organizationId: string,\r\n    window: RollingWindow\r\n  ): Promise<WasteAlert[]> {\r\n    const metrics = await prisma.dailyAdMetric.groupBy({\r\n      by: [\"adId\"],\r\n      where: {\r\n        organizationId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    for (const m of metrics) {\r\n      const ad = await prisma.ad.findUnique({\r\n        where: { id: m.adId },\r\n        select: { id: true, name: true, platform: { select: { code: true } } },\r\n      });\r\n\r\n      if (!ad) continue;\r\n\r\n      const aggregated: AggregatedMetrics = {\r\n        entityId: m.adId,\r\n        entityName: ad.name ?? `Ad ${m.adId}`,\r\n        entityType: \"ad\",\r\n        platformCode: ad.platform.code,\r\n        impressions: m._sum.impressions ?? BigInt(0),\r\n        clicks: m._sum.clicks ?? BigInt(0),\r\n        spendMicros: m._sum.spendMicros ?? BigInt(0),\r\n        conversions: m._sum.conversions ?? BigInt(0),\r\n        revenueMicros: m._sum.revenueMicros ?? BigInt(0),\r\n      };\r\n\r\n      const adAlerts = this.detectWaste(aggregated, window, organizationId);\r\n      alerts.push(...adAlerts);\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private detectWaste(\r\n    metrics: AggregatedMetrics,\r\n    window: RollingWindow,\r\n    organizationId: string\r\n  ): WasteAlert[] {\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    if (\r\n      metrics.spendMicros >= this.config.spendThresholdMicros &&\r\n      metrics.conversions === BigInt(0)\r\n    ) {\r\n      const reason: WasteReason = \"zero_conversions_high_spend\";\r\n      const level = determineWasteLevel(metrics.spendMicros, this.config, reason);\r\n\r\n      alerts.push({\r\n        id: generateAlertId(metrics.entityType, metrics.entityId, reason, window.end),\r\n        entityType: metrics.entityType,\r\n        entityId: metrics.entityId,\r\n        entityName: metrics.entityName,\r\n        organizationId,\r\n        platformCode: metrics.platformCode,\r\n        reason,\r\n        level,\r\n        spendMicros: metrics.spendMicros,\r\n        conversions: 0,\r\n        cpa: null,\r\n        targetCpa: microsToDollars(this.config.targetCpaMicros),\r\n        windowStart: window.start,\r\n        windowEnd: window.end,\r\n        message: `${metrics.entityName} spent $${microsToDollars(metrics.spendMicros).toFixed(2)} with zero conversions in the last ${window.days} days.`,\r\n        recommendation: buildRecommendation(reason, metrics),\r\n      });\r\n    }\r\n\r\n    if (metrics.conversions > BigInt(0)) {\r\n      const cpa = computeCpa(metrics.spendMicros, metrics.conversions);\r\n      const targetCpa = microsToDollars(this.config.targetCpaMicros);\r\n      const cpaThreshold = targetCpa * (1 + this.config.cpaTolerancePercent / 100);\r\n\r\n      if (cpa !== null && cpa > cpaThreshold * 1_000_000) {\r\n        const reason: WasteReason = \"cpa_above_target\";\r\n        const level = determineWasteLevel(metrics.spendMicros, this.config, reason);\r\n\r\n        const wastedSpend =\r\n          metrics.spendMicros - BigInt(Math.round(targetCpa * 1_000_000 * Number(metrics.conversions)));\r\n\r\n        alerts.push({\r\n          id: generateAlertId(metrics.entityType, metrics.entityId, reason, window.end),\r\n          entityType: metrics.entityType,\r\n          entityId: metrics.entityId,\r\n          entityName: metrics.entityName,\r\n          organizationId,\r\n          platformCode: metrics.platformCode,\r\n          reason,\r\n          level,\r\n          spendMicros: wastedSpend > BigInt(0) ? wastedSpend : metrics.spendMicros,\r\n          conversions: Number(metrics.conversions),\r\n          cpa: cpa / 1_000_000,\r\n          targetCpa,\r\n          windowStart: window.start,\r\n          windowEnd: window.end,\r\n          message: `${metrics.entityName} has CPA of $${(cpa / 1_000_000).toFixed(2)} vs target of $${targetCpa.toFixed(2)} (${((cpa / 1_000_000 / targetCpa - 1) * 100).toFixed(0)}% over).`,\r\n          recommendation: buildRecommendation(reason, metrics),\r\n        });\r\n      }\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  async evaluateCampaign(params: {\r\n    organizationId: string;\r\n    campaignId: string;\r\n    windowDays?: number;\r\n    endDate?: Date;\r\n  }): Promise<WasteAlert[]> {\r\n    const window = createRollingWindow(\r\n      params.windowDays ?? this.config.rollingWindowDays,\r\n      params.endDate\r\n    );\r\n\r\n    const metrics = await prisma.dailyCampaignMetric.aggregate({\r\n      where: {\r\n        organizationId: params.organizationId,\r\n        campaignId: params.campaignId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const campaign = await prisma.campaign.findUnique({\r\n      where: { id: params.campaignId },\r\n      select: { id: true, name: true, platform: { select: { code: true } } },\r\n    });\r\n\r\n    if (!campaign) return [];\r\n\r\n    const aggregated: AggregatedMetrics = {\r\n      entityId: params.campaignId,\r\n      entityName: campaign.name,\r\n      entityType: \"campaign\",\r\n      platformCode: campaign.platform.code,\r\n      impressions: metrics._sum.impressions ?? BigInt(0),\r\n      clicks: metrics._sum.clicks ?? BigInt(0),\r\n      spendMicros: metrics._sum.spendMicros ?? BigInt(0),\r\n      conversions: metrics._sum.conversions ?? BigInt(0),\r\n      revenueMicros: metrics._sum.revenueMicros ?? BigInt(0),\r\n    };\r\n\r\n    return this.detectWaste(aggregated, window, params.organizationId);\r\n  }\r\n\r\n  async evaluateAd(params: {\r\n    organizationId: string;\r\n    adId: string;\r\n    windowDays?: number;\r\n    endDate?: Date;\r\n  }): Promise<WasteAlert[]> {\r\n    const window = createRollingWindow(\r\n      params.windowDays ?? this.config.rollingWindowDays,\r\n      params.endDate\r\n    );\r\n\r\n    const metrics = await prisma.dailyAdMetric.aggregate({\r\n      where: {\r\n        organizationId: params.organizationId,\r\n        adId: params.adId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const ad = await prisma.ad.findUnique({\r\n      where: { id: params.adId },\r\n      select: { id: true, name: true, platform: { select: { code: true } } },\r\n    });\r\n\r\n    if (!ad) return [];\r\n\r\n    const aggregated: AggregatedMetrics = {\r\n      entityId: params.adId,\r\n      entityName: ad.name ?? `Ad ${params.adId}`,\r\n      entityType: \"ad\",\r\n      platformCode: ad.platform.code,\r\n      impressions: metrics._sum.impressions ?? BigInt(0),\r\n      clicks: metrics._sum.clicks ?? BigInt(0),\r\n      spendMicros: metrics._sum.spendMicros ?? BigInt(0),\r\n      conversions: metrics._sum.conversions ?? BigInt(0),\r\n      revenueMicros: metrics._sum.revenueMicros ?? BigInt(0),\r\n    };\r\n\r\n    return this.detectWaste(aggregated, window, params.organizationId);\r\n  }\r\n\r\n  getConfig(): WasteConfig {\r\n    return { ...this.config };\r\n  }\r\n\r\n  withConfig(config: Partial<WasteConfig>): WasteEvaluator {\r\n    return new WasteEvaluator({ ...this.config, ...config });\r\n  }\r\n}\r\n\r\nexport const wasteEvaluator = new WasteEvaluator();\r\n","import \"server-only\";\r\n\r\nexport type WasteLevel = \"none\" | \"low\" | \"medium\" | \"high\" | \"critical\";\r\n\r\nexport type WasteReason =\r\n  | \"zero_conversions_high_spend\"\r\n  | \"cpa_above_target\"\r\n  | \"low_ctr_high_spend\"\r\n  | \"declining_performance\";\r\n\r\nexport type EntityType = \"ad_account\" | \"campaign\" | \"ad\";\r\n\r\nexport interface WasteConfig {\r\n  spendThresholdMicros: bigint;\r\n  targetCpaMicros: bigint;\r\n  cpaTolerancePercent: number;\r\n  minImpressions: number;\r\n  minCtrPercent: number;\r\n  rollingWindowDays: number;\r\n}\r\n\r\nexport interface WasteAlert {\r\n  id: string;\r\n  entityType: EntityType;\r\n  entityId: string;\r\n  entityName: string;\r\n  organizationId: string;\r\n  platformCode: string;\r\n  reason: WasteReason;\r\n  level: WasteLevel;\r\n  spendMicros: bigint;\r\n  conversions: number;\r\n  cpa: number | null;\r\n  targetCpa: number | null;\r\n  windowStart: Date;\r\n  windowEnd: Date;\r\n  message: string;\r\n  recommendation: string;\r\n}\r\n\r\nexport interface WasteAnalysis {\r\n  organizationId: string;\r\n  windowStart: Date;\r\n  windowEnd: Date;\r\n  totalWastedSpendMicros: bigint;\r\n  alerts: WasteAlert[];\r\n  byLevel: Record<WasteLevel, number>;\r\n  byReason: Record<WasteReason, number>;\r\n  byEntityType: Record<EntityType, number>;\r\n}\r\n\r\nexport interface AggregatedMetrics {\r\n  entityId: string;\r\n  entityName: string;\r\n  entityType: EntityType;\r\n  platformCode: string;\r\n  impressions: bigint;\r\n  clicks: bigint;\r\n  spendMicros: bigint;\r\n  conversions: bigint;\r\n  revenueMicros: bigint;\r\n}\r\n\r\nexport const DEFAULT_WASTE_CONFIG: WasteConfig = {\r\n  spendThresholdMicros: BigInt(50_000_000),\r\n  targetCpaMicros: BigInt(25_000_000),\r\n  cpaTolerancePercent: 50,\r\n  minImpressions: 1000,\r\n  minCtrPercent: 0.5,\r\n  rollingWindowDays: 7,\r\n};\r\n\r\nexport function microsToDollars(micros: bigint): number {\r\n  return Number(micros) / 1_000_000;\r\n}\r\n\r\nexport function dollarsToMicros(dollars: number): bigint {\r\n  return BigInt(Math.round(dollars * 1_000_000));\r\n}\r\n\r\nexport function computeCpa(spendMicros: bigint, conversions: bigint): number | null {\r\n  if (conversions === BigInt(0)) return null;\r\n  return Number(spendMicros) / Number(conversions);\r\n}\r\n\r\nexport function computeCtr(clicks: bigint, impressions: bigint): number {\r\n  if (impressions === BigInt(0)) return 0;\r\n  return (Number(clicks) / Number(impressions)) * 100;\r\n}\r\n\r\nexport function determineWasteLevel(\r\n  spendMicros: bigint,\r\n  config: WasteConfig,\r\n  reason: WasteReason\r\n): WasteLevel {\r\n  const spendDollars = microsToDollars(spendMicros);\r\n  const thresholdDollars = microsToDollars(config.spendThresholdMicros);\r\n\r\n  if (reason === \"zero_conversions_high_spend\") {\r\n    if (spendDollars >= thresholdDollars * 5) return \"critical\";\r\n    if (spendDollars >= thresholdDollars * 2) return \"high\";\r\n    if (spendDollars >= thresholdDollars) return \"medium\";\r\n    return \"low\";\r\n  }\r\n\r\n  if (reason === \"cpa_above_target\") {\r\n    if (spendDollars >= thresholdDollars * 3) return \"high\";\r\n    if (spendDollars >= thresholdDollars) return \"medium\";\r\n    return \"low\";\r\n  }\r\n\r\n  return \"low\";\r\n}\r\n"],"names":[],"mappings":"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"}