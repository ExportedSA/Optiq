{"version":3,"sources":["../../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/app/analytics/client.tsx/__nextjs-internal-proxy.mjs","../../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/app/analytics/page.tsx","../../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/analytics/queries.ts"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const AnalyticsPageClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call AnalyticsPageClient() from the server but AnalyticsPageClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/app/analytics/client.tsx\",\n    \"AnalyticsPageClient\",\n);\n","import { getServerSession } from \"next-auth\";\r\nimport { redirect } from \"next/navigation\";\r\n\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { getSpendConversionTimeSeries, getDateRangeFromPreset } from \"@/lib/analytics\";\r\nimport { AnalyticsPageClient } from \"./client\";\r\n\r\nexport default async function AnalyticsPage() {\r\n  const session = await getServerSession(authOptions);\r\n  const orgId = session?.user?.activeOrgId;\r\n\r\n  if (!orgId) {\r\n    redirect(\"/app\");\r\n  }\r\n\r\n  const { start, end } = getDateRangeFromPreset(\"30d\");\r\n\r\n  const chartData = await getSpendConversionTimeSeries({\r\n    organizationId: orgId,\r\n    startDate: start,\r\n    endDate: end,\r\n  });\r\n\r\n  return (\r\n    <AnalyticsPageClient\r\n      initialData={chartData}\r\n      initialDateRange={{ start: start.toISOString(), end: end.toISOString() }}\r\n    />\r\n  );\r\n}\r\n","import \"server-only\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\nexport interface TimeSeriesPoint {\r\n  date: string;\r\n  spend: number;\r\n  conversions: number;\r\n  impressions: number;\r\n  clicks: number;\r\n  revenue: number;\r\n}\r\n\r\nexport interface PlatformTimeSeries {\r\n  platformCode: string;\r\n  platformName: string;\r\n  data: TimeSeriesPoint[];\r\n}\r\n\r\nexport interface ChartData {\r\n  total: TimeSeriesPoint[];\r\n  byPlatform: PlatformTimeSeries[];\r\n  summary: {\r\n    totalSpend: number;\r\n    totalConversions: number;\r\n    avgCpa: number | null;\r\n    totalRevenue: number;\r\n  };\r\n}\r\n\r\nexport async function getSpendConversionTimeSeries(params: {\r\n  organizationId: string;\r\n  startDate: Date;\r\n  endDate: Date;\r\n  platformCodes?: string[];\r\n}): Promise<ChartData> {\r\n  const whereBase: Record<string, unknown> = {\r\n    organizationId: params.organizationId,\r\n    date: { gte: params.startDate, lte: params.endDate },\r\n  };\r\n\r\n  if (params.platformCodes?.length) {\r\n    whereBase.platform = { code: { in: params.platformCodes } };\r\n  }\r\n\r\n  const dailyMetrics = await prisma.dailyAdAccountMetric.findMany({\r\n    where: whereBase,\r\n    select: {\r\n      date: true,\r\n      impressions: true,\r\n      clicks: true,\r\n      spendMicros: true,\r\n      conversions: true,\r\n      revenueMicros: true,\r\n      platform: { select: { code: true, name: true } },\r\n    },\r\n    orderBy: { date: \"asc\" },\r\n  });\r\n\r\n  const totalByDate = new Map<string, TimeSeriesPoint>();\r\n  const byPlatformDate = new Map<string, Map<string, TimeSeriesPoint>>();\r\n  const platformNames = new Map<string, string>();\r\n\r\n  for (const m of dailyMetrics) {\r\n    const dateStr = m.date.toISOString().split(\"T\")[0];\r\n    const spend = Number(m.spendMicros) / 1_000_000;\r\n    const conversions = Number(m.conversions);\r\n    const impressions = Number(m.impressions);\r\n    const clicks = Number(m.clicks);\r\n    const revenue = Number(m.revenueMicros) / 1_000_000;\r\n\r\n    if (!totalByDate.has(dateStr)) {\r\n      totalByDate.set(dateStr, {\r\n        date: dateStr,\r\n        spend: 0,\r\n        conversions: 0,\r\n        impressions: 0,\r\n        clicks: 0,\r\n        revenue: 0,\r\n      });\r\n    }\r\n    const total = totalByDate.get(dateStr)!;\r\n    total.spend += spend;\r\n    total.conversions += conversions;\r\n    total.impressions += impressions;\r\n    total.clicks += clicks;\r\n    total.revenue += revenue;\r\n\r\n    const platformCode = m.platform.code;\r\n    platformNames.set(platformCode, m.platform.name);\r\n\r\n    if (!byPlatformDate.has(platformCode)) {\r\n      byPlatformDate.set(platformCode, new Map());\r\n    }\r\n    const platformMap = byPlatformDate.get(platformCode)!;\r\n\r\n    if (!platformMap.has(dateStr)) {\r\n      platformMap.set(dateStr, {\r\n        date: dateStr,\r\n        spend: 0,\r\n        conversions: 0,\r\n        impressions: 0,\r\n        clicks: 0,\r\n        revenue: 0,\r\n      });\r\n    }\r\n    const platformPoint = platformMap.get(dateStr)!;\r\n    platformPoint.spend += spend;\r\n    platformPoint.conversions += conversions;\r\n    platformPoint.impressions += impressions;\r\n    platformPoint.clicks += clicks;\r\n    platformPoint.revenue += revenue;\r\n  }\r\n\r\n  const totalData = Array.from(totalByDate.values()).sort(\r\n    (a, b) => a.date.localeCompare(b.date)\r\n  );\r\n\r\n  const byPlatform: PlatformTimeSeries[] = [];\r\n  for (const [code, dateMap] of byPlatformDate) {\r\n    byPlatform.push({\r\n      platformCode: code,\r\n      platformName: platformNames.get(code) ?? code,\r\n      data: Array.from(dateMap.values()).sort((a, b) =>\r\n        a.date.localeCompare(b.date)\r\n      ),\r\n    });\r\n  }\r\n\r\n  const totalSpend = totalData.reduce((sum, p) => sum + p.spend, 0);\r\n  const totalConversions = totalData.reduce((sum, p) => sum + p.conversions, 0);\r\n  const totalRevenue = totalData.reduce((sum, p) => sum + p.revenue, 0);\r\n  const avgCpa = totalConversions > 0 ? totalSpend / totalConversions : null;\r\n\r\n  return {\r\n    total: totalData,\r\n    byPlatform,\r\n    summary: {\r\n      totalSpend,\r\n      totalConversions,\r\n      avgCpa,\r\n      totalRevenue,\r\n    },\r\n  };\r\n}\r\n\r\nexport type DateRangePreset = \"7d\" | \"14d\" | \"30d\" | \"90d\" | \"custom\";\r\n\r\nexport function getDateRangeFromPreset(preset: DateRangePreset): {\r\n  start: Date;\r\n  end: Date;\r\n} {\r\n  const end = new Date();\r\n  end.setHours(23, 59, 59, 999);\r\n\r\n  const start = new Date(end);\r\n\r\n  switch (preset) {\r\n    case \"7d\":\r\n      start.setDate(start.getDate() - 6);\r\n      break;\r\n    case \"14d\":\r\n      start.setDate(start.getDate() - 13);\r\n      break;\r\n    case \"30d\":\r\n      start.setDate(start.getDate() - 29);\r\n      break;\r\n    case \"90d\":\r\n      start.setDate(start.getDate() - 89);\r\n      break;\r\n    default:\r\n      start.setDate(start.getDate() - 29);\r\n  }\r\n\r\n  start.setHours(0, 0, 0, 0);\r\n\r\n  return { start, end };\r\n}\r\n"],"names":[],"mappings":"8VAEO,IAAM,EAAsB,CAAA,EAAA,AADnC,EAAA,CAAA,CAAA,OACmC,uBAAA,AAAuB,EACtD,WAAa,MAAM,AAAI,MAAM,oPAAsP,EACnR,uIACA,gFAHG,IAAM,EAAsB,CAAA,EAAA,AADnC,EAAA,CAAA,CAAA,OACmC,uBAAA,AAAuB,EACtD,WAAa,MAAM,AAAI,MAAM,oPAAsP,EACnR,mHACA,4JCLJ,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,MAEA,EAAA,EAAA,CAAA,CAAA,OCHA,EAAA,CAAA,CAAA,OAEA,IAAA,EAAA,EAAA,CAAA,CAAA,OA4BO,eAAe,EAA6B,CAKlD,EACC,IAAM,EAAqC,CACzC,eAAgB,EAAO,cAAc,CACrC,KAAM,CAAE,IAAK,EAAO,SAAS,CAAE,IAAK,EAAO,OAAO,AAAC,CACrD,CAEI,GAAO,aAAa,EAAE,QAAQ,CAChC,EAAU,QAAQ,CAAG,CAAE,KAAM,CAAE,GAAI,EAAO,aAAa,AAAC,EAAE,EAG5D,IAAM,EAAe,MAAM,EAAA,MAAM,CAAC,oBAAoB,CAAC,QAAQ,CAAC,CAC9D,MAAO,EACP,OAAQ,CACN,MAAM,EACN,aAAa,EACb,QAAQ,EACR,aAAa,EACb,aAAa,EACb,eAAe,EACf,SAAU,CAAE,OAAQ,CAAE,MAAM,EAAM,MAAM,CAAK,CAAE,CACjD,EACA,QAAS,CAAE,KAAM,KAAM,CACzB,GAEM,EAAc,IAAI,IAClB,EAAiB,IAAI,IACrB,EAAgB,IAAI,IAE1B,IAAK,IAAM,KAAK,EAAc,CAC5B,IAAM,EAAU,EAAE,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CAC5C,EAAQ,OAAO,EAAE,WAAW,EAAI,IAChC,EAAc,OAAO,EAAE,WAAW,EAClC,EAAc,OAAO,EAAE,WAAW,EAClC,EAAS,OAAO,EAAE,MAAM,EACxB,EAAU,OAAO,EAAE,aAAa,EAAI,GAEtC,CAAC,EAAY,GAAG,CAAC,IACnB,EAAY,GAAG,CADc,AACb,EAAS,CACvB,KAAM,EACN,MAAO,EACP,YAAa,EACb,YAAa,EACb,OAAQ,EACR,QAAS,CACX,GAEF,IAAM,EAAQ,EAAY,GAAG,CAAC,GAC9B,EAAM,KAAK,EAAI,EACf,EAAM,WAAW,EAAI,EACrB,EAAM,WAAW,EAAI,EACrB,EAAM,MAAM,EAAI,EAChB,EAAM,OAAO,EAAI,EAEjB,IAAM,EAAe,EAAE,QAAQ,CAAC,IAAI,CACpC,EAAc,GAAG,CAAC,EAAc,EAAE,QAAQ,CAAC,IAAI,EAE3C,AAAC,EAAe,GAAG,CAAC,IACtB,EAAe,GAAG,CAAC,EAAc,GADI,CACA,KAEvC,IAAM,EAAc,EAAe,GAAG,CAAC,EAEnC,CAAC,EAAY,GAAG,CAAC,IACnB,EAAY,GAAG,CAAC,AADa,EACJ,CACvB,KAAM,EACN,MAAO,EACP,YAAa,EACb,YAAa,EACb,OAAQ,EACR,QAAS,CACX,GAEF,IAAM,EAAgB,EAAY,GAAG,CAAC,GACtC,EAAc,KAAK,EAAI,EACvB,EAAc,WAAW,EAAI,EAC7B,EAAc,WAAW,EAAI,EAC7B,EAAc,MAAM,EAAI,EACxB,EAAc,OAAO,EAAI,CAC3B,CAEA,IAAM,EAAY,MAAM,IAAI,CAAC,EAAY,MAAM,IAAI,IAAI,CACrD,CAAC,EAAG,IAAM,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,IAAI,GAGjC,EAAmC,EAAE,CAC3C,IAAK,GAAM,CAAC,EAAM,EAAQ,GAAI,EAC5B,EAAW,IAAI,CAAC,CACd,KAF0C,QAE5B,EACd,aAAc,EAAc,GAAG,CAAC,IAAS,EACzC,KAAM,MAAM,IAAI,CAAC,EAAQ,MAAM,IAAI,IAAI,CAAC,CAAC,EAAG,IAC1C,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,IAAI,EAE/B,GAGF,IAAM,EAAa,EAAU,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,EAAE,KAAK,CAAE,GACzD,EAAmB,EAAU,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,EAAE,WAAW,CAAE,GACrE,EAAe,EAAU,MAAM,CAAC,CAAC,EAAK,IAAM,EAAM,EAAE,OAAO,CAAE,GAGnE,MAAO,CACL,MAAO,EACP,aACA,QAAS,YACP,EACA,mBACA,OARW,EAAmB,EAAI,EAAa,EAAmB,kBASlE,CACF,CACF,CACF,CD3IA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEe,eAAe,IAC5B,QAAM,EAAU,MAAM,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,EAAA,WAAW,EAC5C,EAAQ,GAAS,MAAM,WAEzB,CAAC,GACH,CAAA,EAAA,CADU,CACV,QAAA,AAAQ,EAAC,QAGX,GAAM,OAAE,CAAK,KAAE,CAAG,CAAE,EC0IpB,CADM,ADzIiB,ECyIX,IAAI,MACZ,QAAQ,CAAC,ED1IiC,CC0I7B,GAAI,GAAI,KAYrB,CAVE,EAAQ,IAAI,KAAK,IAUb,OAAO,CAAC,EAAM,OAAO,GAAK,IASpC,EAAM,QAAQ,CAAC,EAAG,EAAG,EAAG,GAEjB,OAAE,MAAO,CAAI,GD/Jd,EAAY,MAAM,EAA6B,CACnD,eAAgB,EAChB,UAAW,EACX,QAAS,CACX,GAEA,MACE,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,mBAAmB,CAAA,CAClB,YAAa,EACb,iBAAkB,CAAE,MAAO,EAAM,WAAW,GAAI,IAAK,EAAI,WAAW,EAAG,GAG7E","ignoreList":[0]}