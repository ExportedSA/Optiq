module.exports=[66680,(e,t,a)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},75912,e=>{"use strict";e.i(55007);var t=e.i(66680),a=e.i(80608);let r="aes-256-gcm";function n(){let e=a.env.DATA_ENCRYPTION_KEY,t=Buffer.from(e,"base64");if(32!==t.length)throw Error("DATA_ENCRYPTION_KEY must be base64-encoded 32 bytes");return t}function s(e){let a=t.default.randomBytes(12),s=t.default.createCipheriv(r,n(),a),i=Buffer.concat([s.update(e,"utf8"),s.final()]),o=s.getAuthTag(),c={v:1,iv:a.toString("base64"),tag:o.toString("base64"),ct:i.toString("base64")};return Buffer.from(JSON.stringify(c),"utf8").toString("base64")}function i(e){let a=JSON.parse(Buffer.from(e,"base64").toString("utf8"));if(1!==a.v)throw Error("Unsupported encryption payload version");let s=Buffer.from(a.iv,"base64"),i=Buffer.from(a.tag,"base64"),o=Buffer.from(a.ct,"base64"),c=t.default.createDecipheriv(r,n(),s);return c.setAuthTag(i),Buffer.concat([c.update(o),c.final()]).toString("utf8")}function o(e){return s(JSON.stringify(e))}function c(e){return JSON.parse(i(e))}e.s(["decryptJson",()=>c,"decryptString",()=>i,"encryptJson",()=>o,"encryptString",()=>s])},85302,e=>{"use strict";e.i(55007);var t=e.i(68050),a=e.i(16336);async function r(){let e=await (0,t.getServerSession)(a.authOptions);if(!e?.user?.id)throw Error("UNAUTHENTICATED");return e}async function n(){let e=(await r()).user.activeOrgId;if(!e)throw Error("NO_ACTIVE_ORG");return e}e.s(["requireActiveOrgId",()=>n])},33108,e=>{"use strict";e.i(55007);var t=e.i(80608),a=e.i(60806),r=e.i(75912);class n{baseUrl;constructor(){this.baseUrl=`https://graph.facebook.com/${t.env.META_API_VERSION}`}buildAuthUrl(e){let a=new URL("https://www.facebook.com/v20.0/dialog/oauth");return a.searchParams.set("client_id",t.env.META_APP_ID),a.searchParams.set("redirect_uri",t.env.META_OAUTH_REDIRECT_URI),a.searchParams.set("scope","ads_read,read_insights,business_management"),a.searchParams.set("response_type","code"),a.searchParams.set("state",e),a.toString()}async exchangeCode(e){let a=new URL(`${this.baseUrl}/oauth/access_token`);a.searchParams.set("client_id",t.env.META_APP_ID),a.searchParams.set("client_secret",t.env.META_APP_SECRET),a.searchParams.set("redirect_uri",t.env.META_OAUTH_REDIRECT_URI),a.searchParams.set("code",e);let r=await fetch(a,{method:"GET"}),n=await r.json().catch(()=>null);if(!r.ok||!n?.access_token)throw Error(`META_OAUTH_EXCHANGE_FAILED_${r.status}:${JSON.stringify(n)}`);return{access_token:String(n.access_token),token_type:n.token_type?String(n.token_type):void 0,expires_in:n.expires_in?Number(n.expires_in):void 0}}async exchangeForLongLivedToken(e){let a=new URL(`${this.baseUrl}/oauth/access_token`);a.searchParams.set("grant_type","fb_exchange_token"),a.searchParams.set("client_id",t.env.META_APP_ID),a.searchParams.set("client_secret",t.env.META_APP_SECRET),a.searchParams.set("fb_exchange_token",e);let r=await fetch(a,{method:"GET"}),n=await r.json().catch(()=>null);if(!r.ok||!n?.access_token)throw Error(`META_OAUTH_LONG_LIVED_FAILED_${r.status}:${JSON.stringify(n)}`);return{access_token:String(n.access_token),token_type:n.token_type?String(n.token_type):void 0,expires_in:n.expires_in?Number(n.expires_in):void 0}}async getValidAccessToken(e){let t=await a.prisma.integrationConnection.findFirst({where:{organizationId:e.organizationId,platformCode:"META",externalAccountId:e.metaAdAccountId,status:"CONNECTED"},select:{accessTokenEnc:!0,accessTokenExpiresAt:!0}});if(!t||!t.accessTokenEnc)throw Error("META_ADS_NOT_CONNECTED");let n=Date.now();if((t.accessTokenExpiresAt?.getTime()??0)-n>6048e5)return{accessToken:(0,r.decryptString)(t.accessTokenEnc)};let s=(0,r.decryptString)(t.accessTokenEnc),i=await this.exchangeForLongLivedToken(s),o=i.expires_in?new Date(Date.now()+1e3*i.expires_in):null;return await a.prisma.integrationConnection.updateMany({where:{organizationId:e.organizationId,platformCode:"META",externalAccountId:e.metaAdAccountId},data:{accessTokenEnc:(0,r.encryptString)(i.access_token),accessTokenExpiresAt:o}}),{accessToken:i.access_token}}async fetchWithRetry(e,t=0){let a=await fetch(e,{method:"GET"});if(429!==a.status&&503!==a.status||t>=6)return a;let r=a.headers.get("retry-after"),n=r?1e3*Number.parseInt(r,10):0,s=Math.min(3e4,2**t*500+Math.floor(250*Math.random()));return await new Promise(e=>setTimeout(e,Math.max(n,s))),this.fetchWithRetry(e,t+1)}async fetchDailyCampaignInsights(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,metaAdAccountId:e.metaAdAccountId}),a=new URL(`${this.baseUrl}/${e.metaAdAccountId}/insights`);a.searchParams.set("fields","date_start,campaign_id,campaign_name,impressions,clicks,spend,actions,publisher_platform"),a.searchParams.set("level","campaign"),a.searchParams.set("time_increment","1"),a.searchParams.set("time_range",JSON.stringify({since:e.startDate,until:e.endDate})),a.searchParams.set("breakdowns","publisher_platform"),a.searchParams.set("access_token",t);let r=await this.fetchWithRetry(a.toString()),n=await r.json().catch(()=>null);if(!r.ok)throw Error(`META_API_ERROR_${r.status}:${JSON.stringify(n)}`);return(n?.data??[]).map(s)}async fetchDailyAdInsights(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,metaAdAccountId:e.metaAdAccountId}),a=new URL(`${this.baseUrl}/${e.metaAdAccountId}/insights`);a.searchParams.set("fields","date_start,campaign_id,campaign_name,ad_id,ad_name,impressions,clicks,spend,actions,publisher_platform"),a.searchParams.set("level","ad"),a.searchParams.set("time_increment","1"),a.searchParams.set("time_range",JSON.stringify({since:e.startDate,until:e.endDate})),a.searchParams.set("breakdowns","publisher_platform"),a.searchParams.set("access_token",t);let r=await this.fetchWithRetry(a.toString()),n=await r.json().catch(()=>null);if(!r.ok)throw Error(`META_API_ERROR_${r.status}:${JSON.stringify(n)}`);return(n?.data??[]).map(s)}}function s(e){let t;return{date:String(e?.date_start),publisherPlatform:String(e?.publisher_platform??"facebook"),campaignId:String(e?.campaign_id),campaignName:String(e?.campaign_name??""),adId:e?.ad_id?String(e.ad_id):void 0,adName:e?.ad_name?String(e.ad_name):void 0,impressions:BigInt(e?.impressions??0),clicks:BigInt(e?.clicks??0),spendMicros:Number.isFinite(t=Number(e?.spend??0))?BigInt(Math.round(1e6*t)):0n,conversions:function(e){if(!Array.isArray(e))return 0n;let t=new Set(["purchase","offsite_conversion.purchase","omni_purchase","complete_registration","lead"]),a=0n;for(let r of e){let e=r?.action_type,n=r?.value;e&&t.has(e)&&(a+=BigInt(Number(n??0)))}return a}(e?.actions)}}e.s(["MetaAdsService",()=>n])},15354,e=>{"use strict";var t=e.i(56884),a=e.i(42064),r=e.i(1824),n=e.i(99326),s=e.i(18794),i=e.i(83629),o=e.i(41446),c=e.i(61251),d=e.i(5708),l=e.i(59092),u=e.i(99563),p=e.i(39870),h=e.i(8016),m=e.i(7624),f=e.i(70065),g=e.i(36141),_=e.i(93695);e.i(58762);var A=e.i(24378),E=e.i(70081),R=e.i(85302),v=e.i(75912),w=e.i(33108);async function T(e){let t=await (0,R.requireActiveOrgId)(),a=new URL(e.url).searchParams.get("adAccountId");if(!a)return E.NextResponse.json({error:"missing_adAccountId"},{status:400});let r=(0,v.encryptJson)({orgId:t,metaAdAccountId:a,ts:Date.now()}),n=new w.MetaAdsService().buildAuthUrl(r);return E.NextResponse.redirect(n)}e.s(["GET",()=>T],42730);var y=e.i(42730);let P=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/integrations/meta-ads/oauth/start/route",pathname:"/api/integrations/meta-ads/oauth/start",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/integrations/meta-ads/oauth/start/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:I,workUnitAsyncStorage:S,serverHooks:k}=P;function b(){return(0,r.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:S})}async function N(e,t,r){P.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/integrations/meta-ads/oauth/start/route";E=E.replace(/\/index$/,"")||"/";let R=await P.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:w,nextConfig:T,parsedUrl:y,isDraftMode:I,prerenderManifest:S,routerServerContext:k,isOnDemandRevalidate:b,revalidateOnlyGenerated:N,resolvedPathname:C,clientReferenceManifest:x,serverActionsManifest:O}=R,D=(0,c.normalizeAppPath)(E),M=!!(S.dynamicRoutes[D]||S.routes[C]),U=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,y,!1):t.end("This page could not be found"),null);if(M&&!I){let e=!!S.routes[C],t=S.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await U();throw new _.NoFallbackError}}let $=null;!M||P.isDev||I||($="/index"===($=C)?"/":$);let H=!0===P.isDev||!M,L=M&&!H;O&&x&&(0,i.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:x,serverActionsManifest:O,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:O})});let q=e.method||"GET",B=(0,s.getTracer)(),j=B.getActiveScopeSpan(),F={params:w,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>P.onRequestError(e,t,r,k)},sharedContext:{buildId:v}},J=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(J,(0,l.signalFromNodeResponse)(t));try{let i=async e=>P.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=B.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${q} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${E}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),c=async n=>{var s,c;let d=async({previousCacheEntry:a})=>{try{if(!o&&b&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let c=F.renderOpts.pendingWaitUntil;c&&r.waitUntil&&(r.waitUntil(c),c=void 0);let d=F.renderOpts.collectedTags;if(!M)return await (0,h.sendResponse)(J,G,s,F.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:A.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:b})},k),t}},l=await P.handleResponse({req:e,nextConfig:T,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:o});if(!M)return null;if((null==l||null==(s=l.value)?void 0:s.kind)!==A.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(c=l.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",b?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&M||u.delete(g.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(l.cacheControl)),await (0,h.sendResponse)(J,G,new Response(l.value.body,{headers:u,status:l.value.status||200})),null};j?await c(j):await B.withPropagatedContext(e.headers,()=>B.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${E}`,kind:s.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},c))}catch(t){if(t instanceof _.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:b})}),M)throw t;return await (0,h.sendResponse)(J,G,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>b,"routeModule",()=>P,"serverHooks",()=>k,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>S],15354)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__c5c7320c._.js.map