module.exports=[76646,e=>{"use strict";var t=e.i(56884),a=e.i(42064),r=e.i(1824),n=e.i(99326),i=e.i(18794),s=e.i(83629),o=e.i(41446),l=e.i(61251),c=e.i(5708),d=e.i(59092),u=e.i(99563),p=e.i(39870),g=e.i(8016),m=e.i(7624),h=e.i(70065),f=e.i(36141),v=e.i(93695);e.i(58762);var y=e.i(24378),w=e.i(86040),I=e.i(70081),M=e.i(68050),R=e.i(46989),A=e.i(16336);e.i(55007);var C=e.i(60806);function D(e){return Number(e)/1e6}function T(e,t){let a=Number(e.impressions),r=Number(e.clicks),n=D(e.spendMicros),i=Number(e.conversions),s=D(e.revenueMicros),o=i>0?n/i:null,l=0,c=n;if(0===i&&n>0)l=n,c=0;else if(t&&i>0&&null!==o){let e=D(t);o>e&&(l=n-e*i,c=e*i)}let d=n>0?l/n*100:0;return{impressions:a,clicks:r,spend:n,conversions:i,revenue:s,ctr:a>0?r/a*100:null,cpc:r>0?n/r:null,cpa:o,roas:n>0?s/n:null,conversionRate:r>0?i/r*100:null,wastedSpend:l,wastePercent:d,efficientSpend:c}}function P(e,t){let a=new Date(e);switch(t){case"day":{let e=new Date(a.getFullYear(),a.getMonth(),a.getDate()),t=new Date(e);return t.setDate(t.getDate()+1),t.setMilliseconds(-1),{start:e,end:t,label:e.toISOString().split("T")[0]}}case"week":{let e=a.getDay(),t=a.getDate()-e+(0===e?-6:1),r=new Date(a.getFullYear(),a.getMonth(),t),n=new Date(r);n.setDate(n.getDate()+7),n.setMilliseconds(-1);let i=Math.ceil(((r.getTime()-new Date(r.getFullYear(),0,1).getTime())/864e5+1)/7);return{start:r,end:n,label:`${r.getFullYear()}-W${String(i).padStart(2,"0")}`}}case"month":{let e=new Date(a.getFullYear(),a.getMonth(),1);return{start:e,end:new Date(a.getFullYear(),a.getMonth()+1,0,23,59,59,999),label:`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}}case"quarter":{let e=Math.floor(a.getMonth()/3),t=new Date(a.getFullYear(),3*e,1);return{start:t,end:new Date(a.getFullYear(),3*e+3,0,23,59,59,999),label:`${t.getFullYear()}-Q${e+1}`}}case"year":return{start:new Date(a.getFullYear(),0,1),end:new Date(a.getFullYear(),11,31,23,59,59,999),label:String(a.getFullYear())}}}let E=new Map,S=new class{ttlMs;constructor(e={}){this.ttlMs=e.ttlMs??3e5}get(e){let t=E.get(e);return t?new Date>t.expiresAt?(E.delete(e),null):t.data:null}set(e,t,a){let r=new Date,n=new Date(r.getTime()+(a??this.ttlMs));E.set(e,{key:e,data:t,computedAt:r,expiresAt:n})}invalidate(e){return E.delete(e)}invalidatePattern(e){let t=0,a=new RegExp(e.replace(/\*/g,".*"));for(let e of E.keys())a.test(e)&&(E.delete(e),t++);return t}invalidateOrganization(e){return this.invalidatePattern(`metrics:${e}:.*`)}clear(){E.clear()}size(){return E.size}prune(){let e=new Date,t=0;for(let[a,r]of E.entries())e>r.expiresAt&&(E.delete(a),t++);return t}getStats(){let e=null,t=null;for(let a of E.values())(!e||a.computedAt<e)&&(e=a.computedAt),(!t||a.computedAt>t)&&(t=a.computedAt);return{size:E.size,keys:Array.from(E.keys()),oldestEntry:e,newestEntry:t}}},k=BigInt(25e6),b=new class{config;cache;constructor(e={}){this.config={targetCpaMicros:e.targetCpaMicros??k,useCache:e.useCache??!0,cacheTtlMs:e.cacheTtlMs??3e5},this.cache=S}async aggregateByPeriod(e){var t;let a,r=(t={organizationId:e.filter.organizationId,entityLevel:e.entityLevel,entityId:null,granularity:e.granularity,dateRange:e.filter.dateRange},a=`${t.dateRange.start.toISOString().split("T")[0]}_${t.dateRange.end.toISOString().split("T")[0]}`,`metrics:${t.organizationId}:${t.entityLevel}:${t.entityId??"all"}:${t.granularity}:${a}`);if(this.config.useCache){let e=this.cache.get(r);if(e)return e}let n=await this.queryMetrics(e);return this.config.useCache&&this.cache.set(r,n,this.config.cacheTtlMs),n}async queryMetrics(e){let{filter:t,granularity:a,entityLevel:r}=e;switch(r){case"organization":return this.aggregateOrganization(t,a);case"platform":return this.aggregateByPlatform(t,a);case"ad_account":return this.aggregateByAdAccount(t,a);case"campaign":return this.aggregateByCampaign(t,a);case"ad":return this.aggregateByAd(t,a);default:return[]}}async aggregateOrganization(e,t){let a=await C.prisma.dailyAdAccountMetric.findMany({where:{organizationId:e.organizationId,date:{gte:e.dateRange.start,lte:e.dateRange.end},...e.platformCodes?.length?{platform:{code:{in:e.platformCodes}}}:{}},select:{date:!0,impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0}});return this.groupByPeriod(a,t,{entityLevel:"organization",entityId:e.organizationId,entityName:"Organization Total",platformCode:null})}async aggregateByPlatform(e,t){let a=await C.prisma.dailyAdAccountMetric.findMany({where:{organizationId:e.organizationId,date:{gte:e.dateRange.start,lte:e.dateRange.end},...e.platformCodes?.length?{platform:{code:{in:e.platformCodes}}}:{}},select:{date:!0,impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0,platform:{select:{code:!0,name:!0}}}}),r=new Map;for(let e of a){let t=e.platform.code;r.has(t)||r.set(t,[]),r.get(t).push(e)}let n=[];for(let[e,a]of r){let r=a[0]?.platform.name??e,i=this.groupByPeriod(a,t,{entityLevel:"platform",entityId:e,entityName:r,platformCode:e});n.push(...i)}return n.sort((e,t)=>e.periodStart.getTime()-t.periodStart.getTime())}async aggregateByAdAccount(e,t){let a=await C.prisma.dailyAdAccountMetric.findMany({where:{organizationId:e.organizationId,date:{gte:e.dateRange.start,lte:e.dateRange.end},...e.adAccountIds?.length?{adAccountId:{in:e.adAccountIds}}:{},...e.platformCodes?.length?{platform:{code:{in:e.platformCodes}}}:{}},select:{date:!0,adAccountId:!0,impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0,adAccount:{select:{name:!0}},platform:{select:{code:!0}}}}),r=new Map;for(let e of a)r.has(e.adAccountId)||r.set(e.adAccountId,[]),r.get(e.adAccountId).push(e);let n=[];for(let[e,a]of r){let r=a[0]?.adAccount.name??e,i=a[0]?.platform.code??null,s=this.groupByPeriod(a,t,{entityLevel:"ad_account",entityId:e,entityName:r,platformCode:i});n.push(...s)}return n.sort((e,t)=>e.periodStart.getTime()-t.periodStart.getTime())}async aggregateByCampaign(e,t){let a=await C.prisma.dailyCampaignMetric.findMany({where:{organizationId:e.organizationId,date:{gte:e.dateRange.start,lte:e.dateRange.end},...e.campaignIds?.length?{campaignId:{in:e.campaignIds}}:{},...e.adAccountIds?.length?{adAccountId:{in:e.adAccountIds}}:{},...e.platformCodes?.length?{platform:{code:{in:e.platformCodes}}}:{}},select:{date:!0,campaignId:!0,impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0,campaign:{select:{name:!0}},platform:{select:{code:!0}}}}),r=new Map;for(let e of a)r.has(e.campaignId)||r.set(e.campaignId,[]),r.get(e.campaignId).push(e);let n=[];for(let[e,a]of r){let r=a[0]?.campaign.name??e,i=a[0]?.platform.code??null,s=this.groupByPeriod(a,t,{entityLevel:"campaign",entityId:e,entityName:r,platformCode:i});n.push(...s)}return n.sort((e,t)=>e.periodStart.getTime()-t.periodStart.getTime())}async aggregateByAd(e,t){let a=await C.prisma.dailyAdMetric.findMany({where:{organizationId:e.organizationId,date:{gte:e.dateRange.start,lte:e.dateRange.end},...e.adIds?.length?{adId:{in:e.adIds}}:{},...e.campaignIds?.length?{campaignId:{in:e.campaignIds}}:{},...e.adAccountIds?.length?{adAccountId:{in:e.adAccountIds}}:{},...e.platformCodes?.length?{platform:{code:{in:e.platformCodes}}}:{}},select:{date:!0,adId:!0,impressions:!0,clicks:!0,spendMicros:!0,conversions:!0,revenueMicros:!0,ad:{select:{name:!0}},platform:{select:{code:!0}}}}),r=new Map;for(let e of a)r.has(e.adId)||r.set(e.adId,[]),r.get(e.adId).push(e);let n=[];for(let[e,a]of r){let r=a[0]?.ad.name??e,i=a[0]?.platform.code??null,s=this.groupByPeriod(a,t,{entityLevel:"ad",entityId:e,entityName:r,platformCode:i});n.push(...s)}return n.sort((e,t)=>e.periodStart.getTime()-t.periodStart.getTime())}groupByPeriod(e,t,a){let r=new Map;for(let a of e){let{label:e}=P(a.date,t);r.has(e)||r.set(e,{impressions:BigInt(0),clicks:BigInt(0),spendMicros:BigInt(0),conversions:BigInt(0),revenueMicros:BigInt(0)});let n=r.get(e);n.impressions+=a.impressions,n.clicks+=a.clicks,n.spendMicros+=a.spendMicros,n.conversions+=a.conversions,n.revenueMicros+=a.revenueMicros}let n=[];for(let[i,s]of r){let r=e.find(e=>{let{label:a}=P(e.date,t);return a===i})?.date;if(!r)continue;let{start:o,end:l}=P(r,t);n.push({period:i,periodStart:o,periodEnd:l,entityId:a.entityId,entityName:a.entityName,entityLevel:a.entityLevel,platformCode:a.platformCode,metrics:T(s,this.config.targetCpaMicros)})}return n.sort((e,t)=>e.periodStart.getTime()-t.periodStart.getTime())}async getSummary(e){let t,a=await this.aggregateTotal(e.filter,e.entityLevel);if(!e.comparePrevious)return{current:a,previous:null,change:null};let r=Math.ceil((e.filter.dateRange.end.getTime()-e.filter.dateRange.start.getTime())/864e5),n=new Date(e.filter.dateRange.start);n.setDate(n.getDate()-1);let i=new Date(n);i.setDate(i.getDate()-r+1);let s={...e.filter,dateRange:{start:i,end:n}},o=await this.aggregateTotal(s,e.entityLevel);return{current:a,previous:o,change:{impressions:(t=(e,t)=>0===t?100*(e>0):(e-t)/t*100)(a.impressions,o.impressions),clicks:t(a.clicks,o.clicks),spend:t(a.spend,o.spend),conversions:t(a.conversions,o.conversions),revenue:t(a.revenue,o.revenue),cpa:null!==a.cpa&&null!==o.cpa?t(a.cpa,o.cpa):null,roas:null!==a.roas&&null!==o.roas?t(a.roas,o.roas):null,wastePercent:a.wastePercent-o.wastePercent}}}async aggregateTotal(e,t){let a=await this.aggregateByPeriod({filter:e,granularity:"day",entityLevel:t}),r={impressions:BigInt(0),clicks:BigInt(0),spendMicros:BigInt(0),conversions:BigInt(0),revenueMicros:BigInt(0)};for(let e of a)r.impressions+=BigInt(Math.round(e.metrics.impressions)),r.clicks+=BigInt(Math.round(e.metrics.clicks)),r.spendMicros+=BigInt(Math.round(1e6*e.metrics.spend)),r.conversions+=BigInt(Math.round(e.metrics.conversions)),r.revenueMicros+=BigInt(Math.round(1e6*e.metrics.revenue));return T(r,this.config.targetCpaMicros)}invalidateCache(e){return this.cache.invalidateOrganization(e)}getConfig(){return{...this.config}}};e.i(38478);var x=e.i(12329),N=e.i(67650);let B=R.z.object({startDate:R.z.string().regex(/^\d{4}-\d{2}-\d{2}$/),endDate:R.z.string().regex(/^\d{4}-\d{2}-\d{2}$/),channels:R.z.string().optional(),granularity:R.z.enum(["day","week","month"]).default("day"),breakdown:R.z.enum(["platform","campaign","ad"]).default("campaign")});async function z(e){let t=await (0,M.getServerSession)(A.authOptions);if(!t?.user?.activeOrgId)return I.NextResponse.json({error:"unauthorized"},{status:401});let a=t.user.activeOrgId,r=new URL(e.url),n=B.safeParse({startDate:r.searchParams.get("startDate"),endDate:r.searchParams.get("endDate"),channels:r.searchParams.get("channels"),granularity:r.searchParams.get("granularity")??"day",breakdown:r.searchParams.get("breakdown")??"campaign"});if(!n.success)return I.NextResponse.json({error:"invalid_params"},{status:400});let{startDate:i,endDate:s,channels:o,granularity:l,breakdown:c}=n.data,d={start:new Date(i+"T00:00:00"),end:new Date(s+"T23:59:59.999")},u={organizationId:a,dateRange:d,platformCodes:o?o.split(",").filter(Boolean):void 0};try{let[e,t,r,n]=await Promise.all([b.getSummary({filter:u,entityLevel:"organization",comparePrevious:!0}),b.aggregateByPeriod({filter:u,granularity:l,entityLevel:"organization"}),b.aggregateByPeriod({filter:u,granularity:"day",entityLevel:c}),x.wasteEvaluator.evaluateOrganization({organizationId:a,windowDays:Math.ceil((d.end.getTime()-d.start.getTime())/864e5),endDate:d.end})]),i=n.alerts.reduce((e,t)=>e+Number(t.spendMicros)/1e6,0),s=e.current.spend>0?i/e.current.spend*100:0,o={spend:e.current.spend,revenue:e.current.revenue,roas:e.current.roas,cpa:e.current.cpa,conversions:e.current.conversions,impressions:e.current.impressions,clicks:e.current.clicks,wasteAmount:i,wastePercent:s,changes:e.change},p=t.map(e=>({date:e.period,spend:e.metrics.spend,revenue:e.metrics.revenue,conversions:e.metrics.conversions,roas:e.metrics.roas,cpa:e.metrics.cpa})),g=new Map;for(let e of r){let t=e.entityId??"unknown",a=g.get(t);a?(a.spend+=e.metrics.spend,a.revenue+=e.metrics.revenue,a.conversions+=e.metrics.conversions,a.impressions+=e.metrics.impressions,a.clicks+=e.metrics.clicks):g.set(t,{entityId:e.entityId??"unknown",entityName:e.entityName??"Unknown",platformCode:e.platformCode,spend:e.metrics.spend,revenue:e.metrics.revenue,conversions:e.metrics.conversions,impressions:e.metrics.impressions,clicks:e.metrics.clicks,roas:null,cpa:null})}let m=Array.from(g.values()).map(e=>({...e,roas:e.spend>0?e.revenue/e.spend:null,cpa:e.conversions>0?e.spend/e.conversions:null}));return m.sort((e,t)=>t.spend-e.spend),I.NextResponse.json({kpis:o,timeseries:p,breakdown:m.slice(0,50)})}catch(e){return console.error("ROI dashboard error:",e),I.NextResponse.json({error:"server_error"},{status:500})}}(0,N.ensureServerEntryExports)([z]),(0,w.registerServerReference)(z,"409b0cb07fb3fa33fe790227c484d4d4c5f14d7df3",null),e.s(["GET",()=>z],63190);var O=e.i(63190);let $=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/dashboard/roi/route",pathname:"/api/dashboard/roi",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/dashboard/roi/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:_,workUnitAsyncStorage:F,serverHooks:L}=$;function q(){return(0,r.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:F})}async function U(e,t,r){$.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/dashboard/roi/route";w=w.replace(/\/index$/,"")||"/";let I=await $.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!I)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:M,params:R,nextConfig:A,parsedUrl:C,isDraftMode:D,prerenderManifest:T,routerServerContext:P,isOnDemandRevalidate:E,revalidateOnlyGenerated:S,resolvedPathname:k,clientReferenceManifest:b,serverActionsManifest:x}=I,N=(0,l.normalizeAppPath)(w),B=!!(T.dynamicRoutes[N]||T.routes[k]),z=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,C,!1):t.end("This page could not be found"),null);if(B&&!D){let e=!!T.routes[k],t=T.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await z();throw new v.NoFallbackError}}let O=null;!B||$.isDev||D||(O="/index"===(O=k)?"/":O);let _=!0===$.isDev||!B,F=B&&!_;x&&b&&(0,s.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:b,serverActionsManifest:x,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:x})});let L=e.method||"GET",q=(0,i.getTracer)(),U=q.getActiveScopeSpan(),H={params:R,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:_,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>$.onRequestError(e,t,r,P)},sharedContext:{buildId:M}},j=new c.NodeNextRequest(e),Y=new c.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest(j,(0,d.signalFromNodeResponse)(t));try{let s=async e=>$.handle(K,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${L} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${w}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let c=async({previousCacheEntry:a})=>{try{if(!o&&E&&S&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=H.renderOpts.collectedTags;if(!B)return await (0,g.sendResponse)(j,Y,i,H.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,r=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await $.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:E})},P),t}},d=await $.handleResponse({req:e,nextConfig:A,cacheKey:O,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:S,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:o});if(!B)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",E?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),D&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&B||u.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)(j,Y,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};U?await l(U):await q.withPropagatedContext(e.headers,()=>q.trace(u.BaseServerSpan.handleRequest,{spanName:`${L} ${w}`,kind:i.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await $.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:E})}),B)throw t;return await (0,g.sendResponse)(j,Y,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>q,"routeModule",()=>$,"serverHooks",()=>L,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>F],76646)}];

//# sourceMappingURL=c9d07_next_dist_esm_build_templates_app-route_b1c756b0.js.map