module.exports=[86810,e=>{"use strict";e.i(55007);var i=e.i(60806);e.i(25330);var t=e.i(96685);async function a(e){let a=t.appLogger.child({job:"daily-rollups-v2"}),o=new Date;a.info("Starting daily rollups job",{organizationId:e.organizationId,fromDate:e.fromDate.toISOString(),toDate:e.toDate.toISOString(),attributionModel:e.attributionModel,rebuild:e.rebuild});let r=0,s=0,c=0,d=0;try{let t=await i.prisma.organization.findMany({where:e.organizationId?{id:e.organizationId}:{},select:{id:!0}}),o=new Date(e.fromDate);for(o.setHours(0,0,0,0);o<=e.toDate;){for(let i of(a.debug(`Processing date: ${o.toISOString()}`),t))try{let t=await n(i.id,o,e.attributionModel,e.rebuild||!1,a);s+=t.created,c+=t.updated}catch(e){d++,a.error(`Failed to process rollups for ${i.id} on ${o.toISOString()}`,e)}r++,o.setDate(o.getDate()+1)}}catch(e){throw a.error("Daily rollups job failed",e),e}let l=new Date;return a.info("Daily rollups job completed",{attributionModel:e.attributionModel,daysProcessed:r,rollupsCreated:s,rollupsUpdated:c,errors:d,durationMs:l.getTime()-o.getTime()}),{startedAt:o,completedAt:l,attributionModel:e.attributionModel,daysProcessed:r,rollupsCreated:s,rollupsUpdated:c,errors:d}}async function n(e,i,t,a,n){let c=0,d=0,l=await o(e,i),p=await r(e,i,t);for(let{grain:n,groupBy:o}of[{grain:"ORGANIZATION",groupBy:[]},{grain:"PLATFORM",groupBy:["platformId"]},{grain:"CAMPAIGN",groupBy:["platformId","campaignId"]},{grain:"ADSET",groupBy:["platformId","campaignId","adsetId"]},{grain:"AD",groupBy:["platformId","campaignId","adsetId","adId"]}]){let r=await s(e,i,n,o,l,p,t,a);c+=r.created,d+=r.updated}return{created:c,updated:d}}async function o(e,t){return i.prisma.dailyCampaignMetric.findMany({where:{organizationId:e,date:t},select:{platformId:!0,campaignId:!0,impressions:!0,clicks:!0,spendMicros:!0,campaign:{select:{id:!0,externalId:!0,name:!0}}}})}async function r(e,t,a){let n=new Date(t);n.setDate(n.getDate()+1);let o=await i.prisma.trackingEvent.findMany({where:{type:"CONVERSION",occurredAt:{gte:t,lt:n},site:{organizationId:e}},select:{id:!0,valueMicros:!0}});if(0===o.length)return[];let r=o.map(e=>e.id);return(await i.prisma.attributionLink.findMany({where:{conversionId:{in:r},model:a,weight:{gt:0}},include:{touchPoint:{select:{platformCode:!0,campaignId:!0}},conversion:{select:{valueMicros:!0}}}})).map(e=>{let i=o.find(i=>i.id===e.conversionId);return{platformCode:e.touchPoint.platformCode,campaignId:e.touchPoint.campaignId,conversions:e.weight,conversionValue:i?.valueMicros?BigInt(Math.round(Number(i.valueMicros)*e.weight)):BigInt(0)}})}async function s(e,i,t,a,n,o,r,s){let d=0,l=0,p=new Map;for(let e of n){let i=a.map(i=>"adsetId"===i||"adId"===i?e.campaign?.[i]||"null":e[i]||"null").join("|");p.has(i)||p.set(i,{platformId:e.platformId,campaignId:e.campaignId,adsetId:e.campaign?.adsetId,adId:e.campaign?.adId,impressions:BigInt(0),clicks:BigInt(0),spendMicros:BigInt(0),conversions:0,conversionValue:BigInt(0)});let t=p.get(i);t.impressions+=e.impressions,t.clicks+=e.clicks,t.spendMicros+=e.spendMicros}for(let e of o){let i=a.map(i=>"platformId"===i?e.platformCode||"null":e[i]||"null").join("|");if(p.has(i)){let t=p.get(i);t.conversions+=e.conversions,t.conversionValue+=e.conversionValue}}for(let[n,o]of p){let n=function(e,i,t,a,n){let o=Number(t)/1e6,r=Number(n)/1e6,s=e>0?Number(i)/Number(e)*100:null,c=i>0?o/Number(i):null,d=0===a?t:BigInt(0),l=o>0?Number(d)/Number(t)*100:0;return{cpa:a>0?o/a:null,roas:o>0?r/o:null,ctr:s,cpc:c,wasteSpendMicros:d,wastePct:l}}(o.impressions,o.clicks,o.spendMicros,o.conversions,o.conversionValue);(await c({organizationId:e,date:i,grain:t,platformId:a.includes("platformId")?o.platformId:null,campaignId:a.includes("campaignId")?o.campaignId:null,adsetId:a.includes("adsetId")?o.adsetId:null,adId:a.includes("adId")?o.adId:null,attributionModel:r,metrics:{...n,impressions:o.impressions,clicks:o.clicks,spendMicros:o.spendMicros,conversions:o.conversions,conversionValue:o.conversionValue},rebuild:s})).created?d++:l++}return{created:d,updated:l}}async function c(e){let{organizationId:t,date:a,grain:n,platformId:o,campaignId:r,adsetId:s,adId:c,attributionModel:d,metrics:l,rebuild:p}=e,u=await i.prisma.dailyRollup.findFirst({where:{organizationId:t,date:a,grain:n,platformId:o,campaignId:r,adsetId:s,adId:c,attributionModel:d}});return u&&!p?{created:!1}:(await i.prisma.dailyRollup.upsert({where:{organizationId_date_grain_platformId_campaignId_adsetId_adId_attributionModel:{organizationId:t,date:a,grain:n,platformId:o||"",campaignId:r||"",adsetId:s||"",adId:c||"",attributionModel:d}},create:{organizationId:t,date:a,grain:n,platformId:o,campaignId:r,adsetId:s,adId:c,attributionModel:d,impressions:l.impressions,clicks:l.clicks,spendMicros:l.spendMicros,conversions:l.conversions,conversionValue:l.conversionValue,attributedConversions:l.conversions,cpa:l.cpa,roas:l.roas,ctr:l.ctr,cpc:l.cpc,wasteSpendMicros:l.wasteSpendMicros,wastePct:l.wastePct},update:{impressions:l.impressions,clicks:l.clicks,spendMicros:l.spendMicros,conversions:l.conversions,conversionValue:l.conversionValue,attributedConversions:l.conversions,cpa:l.cpa,roas:l.roas,ctr:l.ctr,cpc:l.cpc,wasteSpendMicros:l.wasteSpendMicros,wastePct:l.wastePct,updatedAt:new Date}}),{created:!u})}e.s(["runDailyRollupsV2",()=>a])}];

//# sourceMappingURL=1c0b7_windsurf-project_apps_frontend_src_lib_jobs_daily-rollups-v2_ts_88003e79._.js.map