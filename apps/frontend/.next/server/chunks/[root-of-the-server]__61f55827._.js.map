{"version":3,"sources":["../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/prisma.ts","../../../../../../../../../../OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/cron/auth.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma: PrismaClient | undefined;\r\n};\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log: [\"error\", \"warn\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\r\n","/**\r\n * Cron Job Authentication Helper\r\n * \r\n * Provides secure authentication for cron job endpoints using:\r\n * - Bearer token authentication\r\n * - Constant-time comparison to prevent timing attacks\r\n * - Structured error responses\r\n */\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { timingSafeEqual } from \"crypto\";\r\n\r\n/**\r\n * Verify cron job authentication\r\n * \r\n * Checks for valid Authorization header with Bearer token matching CRON_SECRET.\r\n * Uses constant-time comparison to prevent timing attacks.\r\n * \r\n * @param request - The incoming request\r\n * @param jobName - Optional job name for logging\r\n * @returns Object with authorized status and optional error response\r\n */\r\nexport function verifyCronAuth(\r\n  request: Request,\r\n  jobName?: string\r\n): { authorized: true } | { authorized: false; response: NextResponse } {\r\n  const cronSecret = process.env.CRON_SECRET;\r\n\r\n  // Check if CRON_SECRET is configured\r\n  if (!cronSecret) {\r\n    console.error(\"CRON_SECRET environment variable is not configured\");\r\n    return {\r\n      authorized: false,\r\n      response: NextResponse.json(\r\n        { error: \"Cron authentication not configured\" },\r\n        { status: 503 }\r\n      ),\r\n    };\r\n  }\r\n\r\n  // Extract Authorization header\r\n  const authHeader = request.headers.get(\"authorization\");\r\n\r\n  if (!authHeader) {\r\n    console.warn(`Cron job unauthorized: missing auth header${jobName ? ` (${jobName})` : \"\"}`);\r\n    return {\r\n      authorized: false,\r\n      response: NextResponse.json(\r\n        { error: \"Unauthorized: Missing authorization header\" },\r\n        { status: 401 }\r\n      ),\r\n    };\r\n  }\r\n\r\n  // Check Bearer token format\r\n  const [scheme, token] = authHeader.split(\" \");\r\n\r\n  if (scheme !== \"Bearer\" || !token) {\r\n    console.warn(`Cron job unauthorized: invalid auth format${jobName ? ` (${jobName})` : \"\"}`);\r\n    return {\r\n      authorized: false,\r\n      response: NextResponse.json(\r\n        { error: \"Unauthorized: Invalid authorization format\" },\r\n        { status: 401 }\r\n      ),\r\n    };\r\n  }\r\n\r\n  // Constant-time comparison to prevent timing attacks\r\n  if (!constantTimeCompare(token, cronSecret)) {\r\n    console.warn(`Cron job unauthorized: invalid token${jobName ? ` (${jobName})` : \"\"}`);\r\n    return {\r\n      authorized: false,\r\n      response: NextResponse.json(\r\n        { error: \"Unauthorized: Invalid credentials\" },\r\n        { status: 401 }\r\n      ),\r\n    };\r\n  }\r\n\r\n  // Authentication successful\r\n  return { authorized: true };\r\n}\r\n\r\n/**\r\n * Constant-time string comparison\r\n * \r\n * Compares two strings in constant time to prevent timing attacks.\r\n * Both strings are converted to buffers and compared using crypto.timingSafeEqual.\r\n * \r\n * @param a - First string\r\n * @param b - Second string\r\n * @returns true if strings are equal, false otherwise\r\n */\r\nexport function constantTimeCompare(a: string, b: string): boolean {\r\n  try {\r\n    // Convert strings to buffers\r\n    const bufferA = Buffer.from(a, \"utf8\");\r\n    const bufferB = Buffer.from(b, \"utf8\");\r\n\r\n    // If lengths differ, still do a comparison to maintain constant time\r\n    // Compare against a dummy buffer of the same length as bufferA\r\n    if (bufferA.length !== bufferB.length) {\r\n      // Create a dummy buffer with same length as bufferA\r\n      const dummyBuffer = Buffer.alloc(bufferA.length);\r\n      timingSafeEqual(bufferA, dummyBuffer);\r\n      return false;\r\n    }\r\n\r\n    // Perform constant-time comparison\r\n    return timingSafeEqual(bufferA, bufferB);\r\n  } catch (error) {\r\n    // If any error occurs during comparison, return false\r\n    console.error(\"Error during constant-time comparison:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Middleware wrapper for cron routes\r\n * \r\n * Wraps a cron route handler with authentication.\r\n * \r\n * @param handler - The route handler function\r\n * @param jobName - Optional job name for logging\r\n * @returns Wrapped handler with authentication\r\n */\r\nexport function withCronAuth(\r\n  handler: (request: Request) => Promise<NextResponse>,\r\n  jobName?: string\r\n) {\r\n  return async (request: Request): Promise<NextResponse> => {\r\n    const auth = verifyCronAuth(request, jobName);\r\n    \r\n    if (!auth.authorized) {\r\n      return auth.response;\r\n    }\r\n\r\n    return handler(request);\r\n  };\r\n}\r\n"],"names":[],"mappings":"shCAAA,EAAA,CAAA,CAAA,OAEA,IAAA,EAAA,EAAA,CAAA,CAAA,OAMO,IAAM,EAJW,AAKtB,WAAgB,MAAM,EACtB,IAAI,EAAA,YAAY,CAAC,CACf,IAAK,CAAC,QAAS,OAAO,AACxB,wHCHF,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAYO,SAAS,EACd,CAAgB,CAChB,CAAgB,EAEhB,IAAM,EAAa,QAAQ,GAAG,CAAC,WAAW,CAG1C,GAAI,CAAC,EAEH,OADA,GADe,KACP,KAAK,CAAC,sDACP,CACL,YAAY,EACZ,SAAU,EAAA,YAAY,CAAC,IAAI,CACzB,CAAE,MAAO,oCAAqC,EAC9C,CAAE,OAAQ,GAAI,EAElB,EAIF,IAAM,EAAa,EAAQ,OAAO,CAAC,GAAG,CAAC,iBAEvC,GAAI,CAAC,EAEH,OADA,GADe,KACP,IAAI,CAAC,CAAC,0CAA0C,EAAE,EAAU,CAAC,EAAE,EAAE,EAAQ,CAAC,CAAC,CAAG,GAAA,CAAI,EACnF,CACL,WAAY,GACZ,SAAU,EAAA,YAAY,CAAC,IAAI,CACzB,CAAE,MAAO,4CAA6C,EACtD,CAAE,OAAQ,GAAI,EAElB,EAIF,GAAM,CAAC,EAAQ,EAAM,CAAG,EAAW,KAAK,CAAC,WAEzC,AAAe,WAAX,CAAuB,EAAC,EAYxB,CAAC,AAyBA,IArC8B,KAqCrB,AAAoB,CAAS,CAAE,CAAS,EACtD,GAAI,CAEF,IAAM,EAAU,OAAO,IAAI,CAAC,EAAG,QACzB,EAAU,OAAO,IAAI,CAAC,EAAG,QAI/B,GAAI,EAAQ,MAAM,GAAK,EAAQ,MAAM,CAAE,CAErC,IAAM,EAAc,OAAO,KAAK,CAAC,EAAQ,MAAM,EAE/C,MADA,CAAA,EAAA,EAAA,eAAA,AAAe,EAAC,EAAS,IAClB,CACT,CAGA,MAAO,CAAA,EAAA,EAAA,eAAA,AAAe,EAAC,EAAS,EAClC,CAAE,MAAO,EAAO,CAGd,OADA,QAAQ,KAAK,CAAC,yCAA0C,IACjD,CACT,CACF,EA/C2B,EAAO,IAC9B,QAAQ,CADmC,GAC/B,CAAC,CAAC,oCAAoC,EAAE,EAAU,CAAC,EAAE,EAAE,EAAQ,CAAC,CAAC,CAAG,GAAA,CAAI,EAC7E,CACL,YAAY,EACZ,SAAU,EAAA,YAAY,CAAC,IAAI,CACzB,CAAE,MAAO,mCAAoC,EAC7C,CAAE,OAAQ,GAAI,EAElB,GAIK,CAAE,YAAY,CAAK,GAvBxB,QAAQ,IAAI,CAAC,CAAC,0CAA0C,EAAE,EAAU,CAAC,EAAE,EAAE,EAAQ,CAAC,CAAC,CAAG,GAAA,CAAI,EACnF,CACL,YAAY,EACZ,SAAU,EAAA,YAAY,CAAC,IAAI,CACzB,CAAE,MAAO,4CAA6C,EACtD,CAAE,OAAQ,GAAI,EAElB,EAiBJ"}