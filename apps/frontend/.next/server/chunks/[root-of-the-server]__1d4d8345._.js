module.exports=[49719,(e,t,r)=>{t.exports=e.x("assert",()=>require("assert"))},21517,(e,t,r)=>{t.exports=e.x("http",()=>require("http"))},24836,(e,t,r)=>{t.exports=e.x("https",()=>require("https"))},6461,(e,t,r)=>{t.exports=e.x("zlib",()=>require("zlib"))},45706,(e,t,r)=>{t.exports=e.x("querystring",()=>require("querystring"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},55007,(e,t,r)=>{},60806,e=>{"use strict";e.i(55007);var t=e.i(29173);let r=globalThis.prisma??new t.PrismaClient({log:["error","warn"]});e.s(["prisma",0,r])},1466,91490,42960,37966,e=>{"use strict";let t={fatal:60,error:50,warn:40,info:30,debug:20,trace:10,silent:1/0};class r{name;level;bindings;constructor(e={},r={}){this.name=e.name??"optiq",this.level=t[e.level??"info"],this.bindings=r}shouldLog(e){return t[e]>=this.level}formatMessage(e,t,r,n){if(!this.shouldLog(e))return;let s=new Date().toISOString(),o=`[${s}] ${e.toUpperCase()} (${this.name})`;if("string"==typeof t)return void console[e](o,t,...void 0!==r?[r,...n||[]]:n||[]);let i={...this.bindings,...t};Object.keys(i).length>0?console[e](o,r||"",i,...n||[]):console[e](o,r||"",...n||[])}fatal(e,t,...r){this.formatMessage("error",e,t,r)}error(e,t,...r){this.formatMessage("error",e,t,r)}warn(e,t,...r){this.formatMessage("warn",e,t,r)}info(e,t,...r){this.formatMessage("info",e,t,r)}debug(e,t,...r){this.formatMessage("debug",e,t,r)}trace(e,t,...r){this.formatMessage("debug",e,t,r)}child(e){return new r({name:this.name,level:Object.keys(t).find(e=>t[e]===this.level)},{...this.bindings,...e})}}!function(e={}){new r(e)}();var n=e.i(46989);let s=n.z.enum(["GOOGLE_ADS","META","TIKTOK","LINKEDIN","X"]),o=n.z.string().regex(/^\d{4}-\d{2}-\d{2}$/);n.z.object({channel:s,date:o,campaign_id:n.z.string().min(1),campaign_name:n.z.string().min(1).optional(),adset_id:n.z.string().min(1).optional(),adset_name:n.z.string().min(1).optional(),ad_id:n.z.string().min(1).optional(),ad_name:n.z.string().min(1).optional(),spend_micros:n.z.bigint().nonnegative(),clicks:n.z.bigint().nonnegative(),impressions:n.z.bigint().nonnegative(),publisher_platform:n.z.string().min(1).optional()});let i={FREE:{tier:"FREE",name:"Free",description:"Get started with basic tracking",limits:{maxWorkspaces:1,maxConnectors:1,monthlyEventLimit:1e3,dataRetentionDays:7,attributionModels:["LAST_TOUCH"],alertsEnabled:!1,ssoEnabled:!1,prioritySupport:!1},pricing:{monthlyPriceCents:0,annualPriceCents:0,overageEventsPer10kCents:0,overageConnectorCents:0},features:["1 workspace","1 ad platform connector","1,000 events/month","Last-touch attribution","7-day data retention"]},STARTER:{tier:"STARTER",name:"Starter",description:"For small teams getting started with attribution",limits:{maxWorkspaces:1,maxConnectors:2,monthlyEventLimit:1e4,dataRetentionDays:14,attributionModels:["FIRST_TOUCH","LAST_TOUCH","LINEAR"],alertsEnabled:!1,ssoEnabled:!1,prioritySupport:!1},pricing:{monthlyPriceCents:4900,annualPriceCents:47e3,overageEventsPer10kCents:500,overageConnectorCents:1500},features:["1 workspace","2 ad platform connectors","10,000 events/month","First, last & linear attribution","14-day data retention","Email support"]},GROWTH:{tier:"GROWTH",name:"Growth",description:"For growing teams who need full attribution insights",limits:{maxWorkspaces:3,maxConnectors:10,monthlyEventLimit:1e5,dataRetentionDays:90,attributionModels:["FIRST_TOUCH","LAST_TOUCH","LINEAR","TIME_DECAY","POSITION_BASED"],alertsEnabled:!0,ssoEnabled:!1,prioritySupport:!1},pricing:{monthlyPriceCents:14900,annualPriceCents:143e3,overageEventsPer10kCents:400,overageConnectorCents:1e3},features:["3 workspaces","All ad platform connectors","100,000 events/month","All attribution models","90-day data retention","Waste & CPA alerts","Priority email support"],recommended:!0},SCALE:{tier:"SCALE",name:"Scale",description:"For enterprises with advanced needs",limits:{maxWorkspaces:-1,maxConnectors:-1,monthlyEventLimit:1e6,dataRetentionDays:365,attributionModels:["FIRST_TOUCH","LAST_TOUCH","LINEAR","TIME_DECAY","POSITION_BASED","DATA_DRIVEN"],alertsEnabled:!0,ssoEnabled:!0,prioritySupport:!0},pricing:{monthlyPriceCents:49900,annualPriceCents:479e3,overageEventsPer10kCents:300,overageConnectorCents:500},features:["Unlimited workspaces","Unlimited connectors","1,000,000+ events/month","All attribution models + data-driven","365-day data retention","Custom lookback windows","SSO/SAML (coming soon)","Dedicated support","SLA guarantee"]}};function a(e){return i[e]}function c(e){return i[e].limits}function l(e){return -1===e}function d(e,t,r){let n=Math.max(0,e.trackedEvents-t.monthlyEventLimit),s=l(t.maxConnectors)?0:Math.max(0,e.connectedAccounts-t.maxConnectors),o=Math.ceil(n/1e4)*r.overageEventsPer10kCents,i=s*r.overageConnectorCents;return{eventsOverage:n,connectorsOverage:s,eventsOverageCents:o,connectorsOverageCents:i,totalOverageCents:o+i}}function u(e,t){let r=[];return!l(t.maxWorkspaces)&&e.workspacesUsed>t.maxWorkspaces&&r.push(`Workspace limit exceeded (${e.workspacesUsed}/${t.maxWorkspaces})`),!l(t.maxConnectors)&&e.connectedAccounts>t.maxConnectors&&r.push(`Connector limit exceeded (${e.connectedAccounts}/${t.maxConnectors})`),e.trackedEvents>1.5*t.monthlyEventLimit&&r.push(`Event limit significantly exceeded (${e.trackedEvents}/${t.monthlyEventLimit})`),{withinLimits:0===r.length,violations:r}}function p(e,t){let r=["FREE","STARTER","GROWTH","SCALE"];return r.indexOf(t)>r.indexOf(e)}function E(e,t){let r=["FREE","STARTER","GROWTH","SCALE"];return r.indexOf(t)<r.indexOf(e)}function m(e){let t=["FREE","STARTER","GROWTH","SCALE"],r=t.indexOf(e);return r<t.length-1?t[r+1]:null}e.s(["PLAN_DEFINITIONS",0,i,"calculateOverages",()=>d,"canDowngrade",()=>E,"canUpgrade",()=>p,"checkLimits",()=>u,"getPlanDefinition",()=>a,"getPlanLimits",()=>c,"getUpgradePath",()=>m,"isUnlimited",()=>l],91490),e.s([],42960),e.i(54799);let _=n.z.enum(["development","staging","production"]);class g extends Error{details;constructor(e,t){super(e),this.name="EnvValidationError",this.details=t}}function T(e,t,r={}){let n=e.safeParse(t);if(n.success)return n.data;let s=new Set(r.redactKeys??[]),o={};for(let[e,r]of Object.entries(t))o[e]=s.has(e)?"[REDACTED]":r;let i=function(e){let t=e.flatten(),r=[];for(let[e,n]of Object.entries(t.fieldErrors))Array.isArray(n)&&n.length>0&&r.push(`  • ${e}: ${n.join(", ")}`);return t.formErrors.length>0&&r.push(`  • ${t.formErrors.join(", ")}`),{formErrors:t.formErrors,fieldErrors:t.fieldErrors,readableMessage:r.length>0?`
${r.join("\n")}`:"Unknown validation error"}}(n.error);throw new g(`
╔════════════════════════════════════════════════════════════════════════════╗
║ ENVIRONMENT CONFIGURATION ERROR                                            ║
╚════════════════════════════════════════════════════════════════════════════╝

Your application failed to start due to invalid or missing environment variables.

ERRORS:${i.readableMessage}

TROUBLESHOOTING:
  1. Copy .env.example to .env if you haven't already
  2. Fill in all required values in your .env file
  3. Ensure all values match the expected format (URLs, numbers, etc.)
  4. Check that sensitive values meet minimum length requirements

For more details, see .env.example in the project root.
`,{errors:i,snapshot:o})}function h(e){return{appEnv:e,isDevelopment:"development"===e,isStaging:"staging"===e,isProduction:"production"===e}}e.s(["AppEnvSchema",0,_,"buildEnvMeta",()=>h,"loadEnv",()=>T],37966),e.s([],1466)},80608,e=>{"use strict";var t=e.i(46989);e.i(1466);var r=e.i(37966);let n=t.z.object({APP_ENV:r.AppEnvSchema.default("development"),NODE_ENV:t.z.enum(["development","production","test"]).default("development"),DATABASE_URL:t.z.string().url().describe("PostgreSQL connection string"),NEXTAUTH_SECRET:t.z.string().min(32).describe("Secret for NextAuth session encryption (min 32 chars)"),NEXTAUTH_URL:t.z.string().url().optional().describe("Canonical URL of your site"),DATA_ENCRYPTION_KEY:t.z.string().min(32).describe("AES-256 key for encrypting sensitive data (32+ chars)"),GOOGLE_OAUTH_CLIENT_ID:t.z.string().min(1).describe("Google OAuth 2.0 Client ID"),GOOGLE_OAUTH_CLIENT_SECRET:t.z.string().min(1).describe("Google OAuth 2.0 Client Secret"),GOOGLE_OAUTH_REDIRECT_URI:t.z.string().url().describe("OAuth redirect URI for Google"),GOOGLE_ADS_DEVELOPER_TOKEN:t.z.string().min(1).describe("Google Ads API Developer Token"),GOOGLE_ADS_LOGIN_CUSTOMER_ID:t.z.string().min(1).optional().describe("Google Ads Manager Account ID (optional)"),META_APP_ID:t.z.string().min(1).describe("Meta App ID"),META_APP_SECRET:t.z.string().min(1).describe("Meta App Secret"),META_OAUTH_REDIRECT_URI:t.z.string().url().describe("OAuth redirect URI for Meta"),META_API_VERSION:t.z.string().min(1).default("v20.0").describe("Meta Graph API version"),TIKTOK_APP_ID:t.z.string().min(1).describe("TikTok App ID"),TIKTOK_APP_SECRET:t.z.string().min(1).describe("TikTok App Secret"),TIKTOK_OAUTH_REDIRECT_URI:t.z.string().url().describe("OAuth redirect URI for TikTok"),TIKTOK_API_BASE_URL:t.z.string().url().default("https://business-api.tiktok.com").describe("TikTok Business API base URL"),SMTP_HOST:t.z.string().optional().describe("SMTP server hostname"),SMTP_PORT:t.z.coerce.number().int().min(1).max(65535).optional().describe("SMTP server port"),SMTP_USER:t.z.string().optional().describe("SMTP username"),SMTP_PASSWORD:t.z.string().optional().describe("SMTP password"),SMTP_FROM_EMAIL:t.z.string().email().optional().describe("From email address for notifications"),SMTP_FROM_NAME:t.z.string().optional().describe("From name for notifications")}),s=(0,r.loadEnv)(n,{APP_ENV:process.env.APP_ENV,NODE_ENV:"production",DATABASE_URL:process.env.DATABASE_URL,NEXTAUTH_SECRET:process.env.NEXTAUTH_SECRET,NEXTAUTH_URL:process.env.NEXTAUTH_URL,DATA_ENCRYPTION_KEY:process.env.DATA_ENCRYPTION_KEY,GOOGLE_OAUTH_CLIENT_ID:process.env.GOOGLE_OAUTH_CLIENT_ID,GOOGLE_OAUTH_CLIENT_SECRET:process.env.GOOGLE_OAUTH_CLIENT_SECRET,GOOGLE_OAUTH_REDIRECT_URI:process.env.GOOGLE_OAUTH_REDIRECT_URI,GOOGLE_ADS_DEVELOPER_TOKEN:process.env.GOOGLE_ADS_DEVELOPER_TOKEN,GOOGLE_ADS_LOGIN_CUSTOMER_ID:process.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID,META_APP_ID:process.env.META_APP_ID,META_APP_SECRET:process.env.META_APP_SECRET,META_OAUTH_REDIRECT_URI:process.env.META_OAUTH_REDIRECT_URI,META_API_VERSION:process.env.META_API_VERSION,TIKTOK_APP_ID:process.env.TIKTOK_APP_ID,TIKTOK_APP_SECRET:process.env.TIKTOK_APP_SECRET,TIKTOK_OAUTH_REDIRECT_URI:process.env.TIKTOK_OAUTH_REDIRECT_URI,TIKTOK_API_BASE_URL:process.env.TIKTOK_API_BASE_URL,SMTP_HOST:process.env.SMTP_HOST,SMTP_PORT:process.env.SMTP_PORT,SMTP_USER:process.env.SMTP_USER,SMTP_PASSWORD:process.env.SMTP_PASSWORD,SMTP_FROM_EMAIL:process.env.SMTP_FROM_EMAIL,SMTP_FROM_NAME:process.env.SMTP_FROM_NAME},{redactKeys:["DATABASE_URL","NEXTAUTH_SECRET","DATA_ENCRYPTION_KEY","GOOGLE_OAUTH_CLIENT_SECRET","GOOGLE_ADS_DEVELOPER_TOKEN","META_APP_SECRET","TIKTOK_APP_SECRET","SMTP_PASSWORD"]}),o={...s,...(0,r.buildEnvMeta)(s.APP_ENV)};e.s(["env",0,o])},66680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},75912,e=>{"use strict";e.i(55007);var t=e.i(66680),r=e.i(80608);let n="aes-256-gcm";function s(){let e=r.env.DATA_ENCRYPTION_KEY,t=Buffer.from(e,"base64");if(32!==t.length)throw Error("DATA_ENCRYPTION_KEY must be base64-encoded 32 bytes");return t}function o(e){let r=t.default.randomBytes(12),o=t.default.createCipheriv(n,s(),r),i=Buffer.concat([o.update(e,"utf8"),o.final()]),a=o.getAuthTag(),c={v:1,iv:r.toString("base64"),tag:a.toString("base64"),ct:i.toString("base64")};return Buffer.from(JSON.stringify(c),"utf8").toString("base64")}function i(e){let r=JSON.parse(Buffer.from(e,"base64").toString("utf8"));if(1!==r.v)throw Error("Unsupported encryption payload version");let o=Buffer.from(r.iv,"base64"),i=Buffer.from(r.tag,"base64"),a=Buffer.from(r.ct,"base64"),c=t.default.createDecipheriv(n,s(),o);return c.setAuthTag(i),Buffer.concat([c.update(a),c.final()]).toString("utf8")}function a(e){return o(JSON.stringify(e))}function c(e){return JSON.parse(i(e))}e.s(["decryptJson",()=>c,"decryptString",()=>i,"encryptJson",()=>a,"encryptString",()=>o])},33405,(e,t,r)=>{t.exports=e.x("child_process",()=>require("child_process"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},46786,(e,t,r)=>{t.exports=e.x("os",()=>require("os"))},70722,(e,t,r)=>{t.exports=e.x("tty",()=>require("tty"))},46926,(e,t,r)=>{"use strict";t.exports=(e,t=process.argv)=>{let r=e.startsWith("-")?"":1===e.length?"-":"--",n=t.indexOf(r+e),s=t.indexOf("--");return -1!==n&&(-1===s||n<s)}},72743,(e,t,r)=>{"use strict";let n,s=e.r(46786),o=e.r(70722),i=e.r(46926),{env:a}=process;function c(e){return 0!==e&&{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function l(e,t){if(0===n)return 0;if(i("color=16m")||i("color=full")||i("color=truecolor"))return 3;if(i("color=256"))return 2;if(e&&!t&&void 0===n)return 0;let r=n||0;if("dumb"===a.TERM)return r;{let e=s.release().split(".");return Number(e[0])>=10&&Number(e[2])>=10586?Number(e[2])>=14931?3:2:1}}i("no-color")||i("no-colors")||i("color=false")||i("color=never")?n=0:(i("color")||i("colors")||i("color=true")||i("color=always"))&&(n=1),"FORCE_COLOR"in a&&(n="true"===a.FORCE_COLOR?1:"false"===a.FORCE_COLOR?0:0===a.FORCE_COLOR.length?1:Math.min(parseInt(a.FORCE_COLOR,10),3)),t.exports={supportsColor:function(e){return c(l(e,e&&e.isTTY))},stdout:c(l(!0,o.isatty(1))),stderr:c(l(!0,o.isatty(2)))}},12057,(e,t,r)=>{t.exports=e.x("node:util",()=>require("node:util"))},63356,e=>{"use strict";e.i(55007);var t=e.i(80268),r=e.i(80608),n=e.i(60806),s=e.i(75912);class o{oauth;constructor(){this.oauth=new t.OAuth2Client({clientId:r.env.GOOGLE_OAUTH_CLIENT_ID,clientSecret:r.env.GOOGLE_OAUTH_CLIENT_SECRET,redirectUri:r.env.GOOGLE_OAUTH_REDIRECT_URI})}buildAuthUrl(e){return this.oauth.generateAuthUrl({access_type:"offline",prompt:"consent",scope:["https://www.googleapis.com/auth/adwords"],include_granted_scopes:!0,state:e})}async exchangeCode(e){let{tokens:t}=await this.oauth.getToken(e);return{access_token:t.access_token??"",expires_in:t.expiry_date?Math.max(0,Math.floor((t.expiry_date-Date.now())/1e3)):void 0,scope:t.scope??void 0,refresh_token:t.refresh_token??void 0,token_type:t.token_type??void 0}}async refreshAccessToken(e){this.oauth.setCredentials({refresh_token:e});let{credentials:t}=await this.oauth.refreshAccessToken();return{access_token:t.access_token??"",expires_in:t.expiry_date?Math.max(0,Math.floor((t.expiry_date-Date.now())/1e3)):void 0,scope:t.scope??void 0,token_type:t.token_type??void 0}}async getValidAccessToken(e){let t=await n.prisma.googleAdsCredential.findUnique({where:{organizationId_customerId:{organizationId:e.organizationId,customerId:e.customerId}},select:{refreshTokenEnc:!0,accessTokenEnc:!0,accessTokenExpiresAt:!0}});if(!t)throw Error("GOOGLE_ADS_NOT_CONNECTED");let r=Date.now(),o=t.accessTokenExpiresAt?.getTime()??0;if(t.accessTokenEnc&&o-r>6e4)return{accessToken:(0,s.decryptString)(t.accessTokenEnc)};let i=(0,s.decryptString)(t.refreshTokenEnc),a=await this.refreshAccessToken(i);if(!a.access_token)throw Error("GOOGLE_OAUTH_REFRESH_FAILED");let c=a.expires_in?new Date(Date.now()+1e3*a.expires_in):null;return await n.prisma.googleAdsCredential.update({where:{organizationId_customerId:{organizationId:e.organizationId,customerId:e.customerId}},data:{accessTokenEnc:(0,s.encryptString)(a.access_token),accessTokenExpiresAt:c},select:{id:!0}}),{accessToken:a.access_token}}async fetchWithRetry(e,t,r=0){let n=await fetch(e,t);if(429!==n.status&&503!==n.status||r>=6)return n;let s=n.headers.get("retry-after"),o=s?1e3*Number.parseInt(s,10):0,i=Math.min(3e4,2**r*500+Math.floor(250*Math.random()));return await new Promise(e=>setTimeout(e,Math.max(o,i))),this.fetchWithRetry(e,t,r+1)}async googleAdsSearch(e){let t=`https://googleads.googleapis.com/v16/customers/${e.customerId}/googleAds:searchStream`,n={authorization:`Bearer ${e.accessToken}`,"developer-token":r.env.GOOGLE_ADS_DEVELOPER_TOKEN,"content-type":"application/json"};r.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID&&(n["login-customer-id"]=r.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID);let s=await this.fetchWithRetry(t,{method:"POST",headers:n,body:JSON.stringify({query:e.query})});if(!s.ok){let e=await s.text().catch(()=>"");throw Error(`GOOGLE_ADS_API_ERROR_${s.status}:${e}`)}return await s.json()}async fetchDailyCampaignMetrics(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,customerId:e.customerId}),r=`
      SELECT
        segments.date,
        campaign.id,
        campaign.name,
        metrics.impressions,
        metrics.clicks,
        metrics.conversions,
        metrics.cost_micros
      FROM campaign
      WHERE segments.date BETWEEN '${e.startDate}' AND '${e.endDate}'
    `,n=await this.googleAdsSearch({customerId:e.customerId,accessToken:t,query:r}),s=[];for(let e of n){let t=e?.results;if(t)for(let e of t)s.push({date:String(e?.segments?.date),campaignId:String(e?.campaign?.id),campaignName:String(e?.campaign?.name??""),impressions:BigInt(e?.metrics?.impressions??0),clicks:BigInt(e?.metrics?.clicks??0),conversions:BigInt(e?.metrics?.conversions??0),costMicros:BigInt(e?.metrics?.costMicros??e?.metrics?.cost_micros??0)})}return s}async fetchDailyAdMetrics(e){let{accessToken:t}=await this.getValidAccessToken({organizationId:e.organizationId,customerId:e.customerId}),r=`
      SELECT
        segments.date,
        campaign.id,
        campaign.name,
        ad_group_ad.ad.id,
        ad_group_ad.ad.name,
        metrics.impressions,
        metrics.clicks,
        metrics.conversions,
        metrics.cost_micros
      FROM ad_group_ad
      WHERE segments.date BETWEEN '${e.startDate}' AND '${e.endDate}'
    `,n=await this.googleAdsSearch({customerId:e.customerId,accessToken:t,query:r}),s=[];for(let e of n){let t=e?.results;if(t)for(let e of t)s.push({date:String(e?.segments?.date),campaignId:String(e?.campaign?.id),campaignName:String(e?.campaign?.name??""),adId:String(e?.adGroupAd?.ad?.id??e?.ad_group_ad?.ad?.id),adName:String(e?.adGroupAd?.ad?.name??e?.ad_group_ad?.ad?.name??""),impressions:BigInt(e?.metrics?.impressions??0),clicks:BigInt(e?.metrics?.clicks??0),conversions:BigInt(e?.metrics?.conversions??0),costMicros:BigInt(e?.metrics?.costMicros??e?.metrics?.cost_micros??0)})}return s}}e.s(["GoogleAdsService",()=>o])},89535,e=>{"use strict";var t=e.i(56884),r=e.i(42064),n=e.i(1824),s=e.i(99326),o=e.i(18794),i=e.i(83629),a=e.i(41446),c=e.i(61251),l=e.i(5708),d=e.i(59092),u=e.i(99563),p=e.i(39870),E=e.i(8016),m=e.i(7624),_=e.i(70065),g=e.i(36141),T=e.i(93695);e.i(58762);var h=e.i(24378),A=e.i(70081),f=e.i(60806),O=e.i(63356),R=e.i(75912);async function v(e){let t,r=new URL(e.url),n=r.searchParams.get("code"),s=r.searchParams.get("state");if(!n||!s)return A.NextResponse.json({error:"missing_code_or_state"},{status:400});try{t=(0,R.decryptJson)(s)}catch{return A.NextResponse.json({error:"invalid_state"},{status:400})}if(Date.now()-t.ts>6e5)return A.NextResponse.json({error:"state_expired"},{status:400});let o=new O.GoogleAdsService,i=await o.exchangeCode(n);if(!i.refresh_token)return A.NextResponse.json({error:"missing_refresh_token"},{status:400});let a=i.expires_in?new Date(Date.now()+1e3*i.expires_in):null;return await f.prisma.googleAdsCredential.upsert({where:{organizationId_customerId:{organizationId:t.orgId,customerId:t.customerId}},create:{organizationId:t.orgId,customerId:t.customerId,refreshTokenEnc:(0,R.encryptString)(i.refresh_token),accessTokenEnc:i.access_token?(0,R.encryptString)(i.access_token):null,accessTokenExpiresAt:a,scope:i.scope??"https://www.googleapis.com/auth/adwords"},update:{refreshTokenEnc:(0,R.encryptString)(i.refresh_token),accessTokenEnc:i.access_token?(0,R.encryptString)(i.access_token):null,accessTokenExpiresAt:a,scope:i.scope??"https://www.googleapis.com/auth/adwords"},select:{id:!0}}),A.NextResponse.redirect(new URL("/app",r.origin))}e.s(["GET",()=>v],94149);var S=e.i(94149);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/integrations/google-ads/oauth/callback/route",pathname:"/api/integrations/google-ads/oauth/callback",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/integrations/google-ads/oauth/callback/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:C,workUnitAsyncStorage:x,serverHooks:P}=I;function y(){return(0,n.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:x})}async function b(e,t,n){I.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let A="/api/integrations/google-ads/oauth/callback/route";A=A.replace(/\/index$/,"")||"/";let f=await I.prepare(e,t,{srcPage:A,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:O,params:R,nextConfig:v,parsedUrl:S,isDraftMode:C,prerenderManifest:x,routerServerContext:P,isOnDemandRevalidate:y,revalidateOnlyGenerated:b,resolvedPathname:k,clientReferenceManifest:w,serverActionsManifest:D}=f,N=(0,c.normalizeAppPath)(A),M=!!(x.dynamicRoutes[N]||x.routes[k]),L=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,S,!1):t.end("This page could not be found"),null);if(M&&!C){let e=!!x.routes[k],t=x.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await L();throw new T.NoFallbackError}}let U=null;!M||I.isDev||C||(U="/index"===(U=k)?"/":U);let G=!0===I.isDev||!M,H=M&&!G;D&&w&&(0,i.setReferenceManifestsSingleton)({page:A,clientReferenceManifest:w,serverActionsManifest:D,serverModuleMap:(0,a.createServerModuleMap)({serverActionsManifest:D})});let z=e.method||"GET",K=(0,o.getTracer)(),q=K.getActiveScopeSpan(),F={params:R,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:G,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>I.onRequestError(e,t,n,P)},sharedContext:{buildId:O}},B=new l.NodeNextRequest(e),j=new l.NodeNextResponse(t),$=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let i=async e=>I.handle($,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=K.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${z} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${z} ${A}`)}),a=!!(0,s.getRequestMeta)(e,"minimalMode"),c=async s=>{var o,c;let l=async({previousCacheEntry:r})=>{try{if(!a&&y&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(s);e.fetchMetrics=F.renderOpts.fetchMetrics;let c=F.renderOpts.pendingWaitUntil;c&&n.waitUntil&&(n.waitUntil(c),c=void 0);let l=F.renderOpts.collectedTags;if(!M)return await (0,E.sendResponse)(B,j,o,F.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(o.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:y})},P),t}},d=await I.handleResponse({req:e,nextConfig:v,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:y,revalidateOnlyGenerated:b,responseGenerator:l,waitUntil:n.waitUntil,isMinimalMode:a});if(!M)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});a||t.setHeader("x-nextjs-cache",y?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return a&&M||u.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,_.getCacheControlHeader)(d.cacheControl)),await (0,E.sendResponse)(B,j,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};q?await c(q):await K.withPropagatedContext(e.headers,()=>K.trace(u.BaseServerSpan.handleRequest,{spanName:`${z} ${A}`,kind:o.SpanKind.SERVER,attributes:{"http.method":z,"http.target":e.url}},c))}catch(t){if(t instanceof T.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:y})}),M)throw t;return await (0,E.sendResponse)(B,j,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>y,"routeModule",()=>I,"serverHooks",()=>P,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>x],89535)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__1d4d8345._.js.map