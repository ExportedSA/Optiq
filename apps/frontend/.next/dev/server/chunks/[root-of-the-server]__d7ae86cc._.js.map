{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/types/index.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/types/index.ts"],"sourcesContent":["export type HealthResponse = {\r\n  ok: true;\r\n};\r\n"],"names":[],"mappings":""}},
    {"offset": {"line": 125, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/utils/index.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/utils/index.ts"],"sourcesContent":["// Utility functions will be added here\r\nexport {};\r\n"],"names":[],"mappings":""}},
    {"offset": {"line": 132, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/logger-web.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/logger-web.ts"],"sourcesContent":["/**\r\n * Web Logger Implementation (Console-based)\r\n * \r\n * This logger provides a console-based implementation for browser/edge environments.\r\n * Compatible with Next.js App Router, React Server Components, and client-side code.\r\n */\r\n\r\nexport type LoggerOptions = {\r\n  name?: string;\r\n  level?: \"fatal\" | \"error\" | \"warn\" | \"info\" | \"debug\" | \"trace\" | \"silent\";\r\n};\r\n\r\nexport interface Logger {\r\n  fatal(obj: unknown, msg?: string, ...args: unknown[]): void;\r\n  fatal(msg: string, ...args: unknown[]): void;\r\n  error(obj: unknown, msg?: string, ...args: unknown[]): void;\r\n  error(msg: string, ...args: unknown[]): void;\r\n  warn(obj: unknown, msg?: string, ...args: unknown[]): void;\r\n  warn(msg: string, ...args: unknown[]): void;\r\n  info(obj: unknown, msg?: string, ...args: unknown[]): void;\r\n  info(msg: string, ...args: unknown[]): void;\r\n  debug(obj: unknown, msg?: string, ...args: unknown[]): void;\r\n  debug(msg: string, ...args: unknown[]): void;\r\n  trace(obj: unknown, msg?: string, ...args: unknown[]): void;\r\n  trace(msg: string, ...args: unknown[]): void;\r\n  child(bindings: Record<string, unknown>): Logger;\r\n}\r\n\r\nconst LOG_LEVELS = {\r\n  fatal: 60,\r\n  error: 50,\r\n  warn: 40,\r\n  info: 30,\r\n  debug: 20,\r\n  trace: 10,\r\n  silent: Infinity,\r\n} as const;\r\n\r\nclass ConsoleLogger implements Logger {\r\n  private name: string;\r\n  private level: number;\r\n  private bindings: Record<string, unknown>;\r\n\r\n  constructor(options: LoggerOptions = {}, bindings: Record<string, unknown> = {}) {\r\n    this.name = options.name ?? \"optiq\";\r\n    this.level = LOG_LEVELS[options.level ?? \"info\"];\r\n    this.bindings = bindings;\r\n  }\r\n\r\n  private shouldLog(level: keyof typeof LOG_LEVELS): boolean {\r\n    return LOG_LEVELS[level] >= this.level;\r\n  }\r\n\r\n  private formatMessage(level: string, obj: unknown, msg?: string, args?: unknown[]): void {\r\n    if (!this.shouldLog(level as keyof typeof LOG_LEVELS)) return;\r\n\r\n    const timestamp = new Date().toISOString();\r\n    const prefix = `[${timestamp}] ${level.toUpperCase()} (${this.name})`;\r\n\r\n    // If obj is a string, treat it as the message\r\n    if (typeof obj === \"string\") {\r\n      const allArgs = msg !== undefined ? [msg, ...((args as unknown[]) || [])] : (args as unknown[]) || [];\r\n      console[level as \"log\" | \"error\" | \"warn\" | \"info\" | \"debug\"](prefix, obj, ...allArgs);\r\n      return;\r\n    }\r\n\r\n    // Otherwise, obj is context data\r\n    const contextData = { ...this.bindings, ...(obj as Record<string, unknown>) };\r\n    const hasContext = Object.keys(contextData).length > 0;\r\n\r\n    if (hasContext) {\r\n      console[level as \"log\" | \"error\" | \"warn\" | \"info\" | \"debug\"](\r\n        prefix,\r\n        msg || \"\",\r\n        contextData,\r\n        ...((args as unknown[]) || [])\r\n      );\r\n    } else {\r\n      console[level as \"log\" | \"error\" | \"warn\" | \"info\" | \"debug\"](\r\n        prefix,\r\n        msg || \"\",\r\n        ...((args as unknown[]) || [])\r\n      );\r\n    }\r\n  }\r\n\r\n  fatal(obj: unknown, msg?: string, ...args: unknown[]): void {\r\n    this.formatMessage(\"error\", obj, msg, args);\r\n  }\r\n\r\n  error(obj: unknown, msg?: string, ...args: unknown[]): void {\r\n    this.formatMessage(\"error\", obj, msg, args);\r\n  }\r\n\r\n  warn(obj: unknown, msg?: string, ...args: unknown[]): void {\r\n    this.formatMessage(\"warn\", obj, msg, args);\r\n  }\r\n\r\n  info(obj: unknown, msg?: string, ...args: unknown[]): void {\r\n    this.formatMessage(\"info\", obj, msg, args);\r\n  }\r\n\r\n  debug(obj: unknown, msg?: string, ...args: unknown[]): void {\r\n    this.formatMessage(\"debug\", obj, msg, args);\r\n  }\r\n\r\n  trace(obj: unknown, msg?: string, ...args: unknown[]): void {\r\n    this.formatMessage(\"debug\", obj, msg, args);\r\n  }\r\n\r\n  child(bindings: Record<string, unknown>): Logger {\r\n    return new ConsoleLogger(\r\n      { name: this.name, level: Object.keys(LOG_LEVELS).find(k => LOG_LEVELS[k as keyof typeof LOG_LEVELS] === this.level) as any },\r\n      { ...this.bindings, ...bindings }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Create a console-based logger instance\r\n */\r\nexport function createLogger(options: LoggerOptions = {}): Logger {\r\n  return new ConsoleLogger(options);\r\n}\r\n\r\n/**\r\n * Create a child logger with additional context\r\n */\r\nexport function createChildLogger(\r\n  parent: Logger,\r\n  bindings: Record<string, unknown>,\r\n): Logger {\r\n  return parent.child(bindings);\r\n}\r\n\r\n/**\r\n * Default logger instance for convenience\r\n */\r\nexport const logger = createLogger();\r\n\r\n/**\r\n * Log levels for reference\r\n */\r\nexport const LogLevel = {\r\n  FATAL: \"fatal\",\r\n  ERROR: \"error\",\r\n  WARN: \"warn\",\r\n  INFO: \"info\",\r\n  DEBUG: \"debug\",\r\n  TRACE: \"trace\",\r\n} as const;\r\n\r\nexport type LogLevel = (typeof LogLevel)[keyof typeof LogLevel];\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 240, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/normalization/types.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/normalization/types.ts"],"sourcesContent":["import { z } from \"zod\";\r\n\r\nexport const ChannelSchema = z.enum([\"GOOGLE_ADS\", \"META\", \"TIKTOK\", \"LINKEDIN\", \"X\"]);\r\nexport type Channel = z.infer<typeof ChannelSchema>;\r\n\r\nexport const IsoDateSchema = z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/);\r\nexport type IsoDate = z.infer<typeof IsoDateSchema>;\r\n\r\nexport const NormalizedCostRowSchema = z.object({\r\n  channel: ChannelSchema,\r\n\r\n  date: IsoDateSchema,\r\n\r\n  campaign_id: z.string().min(1),\r\n  campaign_name: z.string().min(1).optional(),\r\n\r\n  adset_id: z.string().min(1).optional(),\r\n  adset_name: z.string().min(1).optional(),\r\n\r\n  ad_id: z.string().min(1).optional(),\r\n  ad_name: z.string().min(1).optional(),\r\n\r\n  spend_micros: z.bigint().nonnegative(),\r\n  clicks: z.bigint().nonnegative(),\r\n  impressions: z.bigint().nonnegative(),\r\n\r\n  publisher_platform: z.string().min(1).optional(),\r\n});\r\n\r\nexport type NormalizedCostRow = z.infer<typeof NormalizedCostRowSchema>;\r\n"],"names":[],"mappings":";;;;;;;;AAAA,OAAO,EAAE,CAAC,EAAE,MAAM,KAAK,CAAC;;AAEjB,MAAM,aAAa,GAAG,8PAAC,CAAC,IAAI,CAAC;IAAC,YAAY;IAAE,MAAM;IAAE,QAAQ;IAAE,UAAU;IAAE,GAAG;CAAC,CAAC,CAAC;AAGhF,MAAM,aAAa,GAAG,8PAAC,CAAC,MAAM,EAAE,CAAC,KAAK,CAAC,qBAAqB,CAAC,CAAC;AAG9D,MAAM,uBAAuB,GAAG,8PAAC,CAAC,MAAM,CAAC;IAC9C,OAAO,EAAE,aAAa;IAEtB,IAAI,EAAE,aAAa;IAEnB,WAAW,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC;IAC9B,aAAa,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;IAE3C,QAAQ,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;IACtC,UAAU,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;IAExC,KAAK,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;IACnC,OAAO,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;IAErC,YAAY,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,WAAW,EAAE;IACtC,MAAM,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,WAAW,EAAE;IAChC,WAAW,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,WAAW,EAAE;IAErC,kBAAkB,EAAE,8PAAC,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,QAAQ,EAAE;CACjD,CAAC,CAAC"}},
    {"offset": {"line": 276, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/normalization/mappers.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/normalization/mappers.ts"],"sourcesContent":["import type { NormalizedCostRow } from \"./types\";\r\nimport { NormalizedCostRowSchema } from \"./types\";\r\n\r\nfunction normalizeName(name: string | undefined | null): string | undefined {\r\n  if (!name) return undefined;\r\n  const v = name.trim().replace(/\\s+/g, \" \");\r\n  return v.length ? v : undefined;\r\n}\r\n\r\nfunction spendToMicros(value: unknown): bigint {\r\n  const n = Number(value ?? 0);\r\n  if (!Number.isFinite(n)) return 0n;\r\n  return BigInt(Math.round(n * 1_000_000));\r\n}\r\n\r\nexport type MetaInsightInput = {\r\n  date_start: string;\r\n  campaign_id?: string;\r\n  campaign_name?: string;\r\n  adset_id?: string;\r\n  adset_name?: string;\r\n  ad_id?: string;\r\n  ad_name?: string;\r\n  impressions?: string;\r\n  clicks?: string;\r\n  spend?: string;\r\n  publisher_platform?: string;\r\n};\r\n\r\nexport function mapMetaInsightToNormalized(row: MetaInsightInput): NormalizedCostRow {\r\n  const out: NormalizedCostRow = {\r\n    channel: \"META\",\r\n    date: row.date_start,\r\n    campaign_id: String(row.campaign_id ?? \"\"),\r\n    campaign_name: normalizeName(row.campaign_name),\r\n    adset_id: row.adset_id ? String(row.adset_id) : undefined,\r\n    adset_name: normalizeName(row.adset_name),\r\n    ad_id: row.ad_id ? String(row.ad_id) : undefined,\r\n    ad_name: normalizeName(row.ad_name),\r\n    impressions: BigInt(parseInt(row.impressions ?? \"0\", 10)),\r\n    clicks: BigInt(parseInt(row.clicks ?? \"0\", 10)),\r\n    spend_micros: spendToMicros(row.spend),\r\n    publisher_platform: normalizeName(row.publisher_platform),\r\n  };\r\n\r\n  return NormalizedCostRowSchema.parse(out);\r\n}\r\n\r\nexport type TikTokReportingRowInput = {\r\n  date: string;\r\n  campaignId: string;\r\n  campaignName?: string;\r\n  adId?: string;\r\n  adName?: string;\r\n  impressions: bigint;\r\n  clicks: bigint;\r\n  spendMicros: bigint;\r\n};\r\n\r\nexport function mapTikTokRowToNormalized(row: TikTokReportingRowInput): NormalizedCostRow {\r\n  const out: NormalizedCostRow = {\r\n    channel: \"TIKTOK\",\r\n    date: row.date,\r\n    campaign_id: row.campaignId,\r\n    campaign_name: normalizeName(row.campaignName),\r\n    ad_id: row.adId,\r\n    ad_name: normalizeName(row.adName),\r\n    impressions: row.impressions,\r\n    clicks: row.clicks,\r\n    spend_micros: row.spendMicros,\r\n  };\r\n\r\n  return NormalizedCostRowSchema.parse(out);\r\n}\r\n\r\nexport type GoogleAdsRowInput = {\r\n  date: string;\r\n  campaignId: string;\r\n  campaignName?: string;\r\n  adGroupId?: string;\r\n  adGroupName?: string;\r\n  adId?: string;\r\n  adName?: string;\r\n  impressions: bigint;\r\n  clicks: bigint;\r\n  spendMicros: bigint;\r\n};\r\n\r\nexport function mapGoogleAdsRowToNormalized(row: GoogleAdsRowInput): NormalizedCostRow {\r\n  const out: NormalizedCostRow = {\r\n    channel: \"GOOGLE_ADS\",\r\n    date: row.date,\r\n    campaign_id: row.campaignId,\r\n    campaign_name: normalizeName(row.campaignName),\r\n    adset_id: row.adGroupId,\r\n    adset_name: normalizeName(row.adGroupName),\r\n    ad_id: row.adId,\r\n    ad_name: normalizeName(row.adName),\r\n    impressions: row.impressions,\r\n    clicks: row.clicks,\r\n    spend_micros: row.spendMicros,\r\n  };\r\n\r\n  return NormalizedCostRowSchema.parse(out);\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 347, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/normalization/index.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/normalization/index.ts"],"sourcesContent":["export type { Channel, IsoDate, NormalizedCostRow } from \"./types\";\r\nexport { ChannelSchema, IsoDateSchema, NormalizedCostRowSchema } from \"./types\";\r\n\r\nexport type { MetaInsightInput, TikTokReportingRowInput, GoogleAdsRowInput } from \"./mappers\";\r\nexport { mapMetaInsightToNormalized, mapTikTokRowToNormalized, mapGoogleAdsRowToNormalized } from \"./mappers\";\r\n"],"names":[],"mappings":";AACA,OAAO,EAAE,aAAa,EAAE,aAAa,EAAE,uBAAuB,EAAE,MAAM,SAAS,CAAC;AAGhF,OAAO,EAAE,0BAA0B,EAAE,wBAAwB,EAAE,2BAA2B,EAAE,MAAM,WAAW,CAAC"}},
    {"offset": {"line": 356, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/pricing/types.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/pricing/types.ts"],"sourcesContent":["/**\r\n * Pricing & Plan Types\r\n * \r\n * Tiered pricing with usage-based overages:\r\n * - Starter: 1 workspace, 2 connectors, 10k events/mo, basic attribution, 14-day retention\r\n * - Growth: 3 workspaces, all connectors, 100k events/mo, all attribution, alerts, 90-day retention\r\n * - Scale: unlimited workspaces, 1M+ events/mo, custom lookback, SSO, priority support, 365-day retention\r\n */\r\n\r\nexport type PlanTier = \"FREE\" | \"STARTER\" | \"GROWTH\" | \"SCALE\";\r\n\r\nexport type AttributionModel =\r\n  | \"FIRST_TOUCH\"\r\n  | \"LAST_TOUCH\"\r\n  | \"LINEAR\"\r\n  | \"TIME_DECAY\"\r\n  | \"POSITION_BASED\"\r\n  | \"DATA_DRIVEN\";\r\n\r\nexport interface PlanLimits {\r\n  maxWorkspaces: number;\r\n  maxConnectors: number;\r\n  monthlyEventLimit: number;\r\n  dataRetentionDays: number;\r\n  attributionModels: AttributionModel[];\r\n  alertsEnabled: boolean;\r\n  ssoEnabled: boolean;\r\n  prioritySupport: boolean;\r\n}\r\n\r\nexport interface PlanPricing {\r\n  monthlyPriceCents: number;\r\n  annualPriceCents: number;\r\n  overageEventsPer10kCents: number;\r\n  overageConnectorCents: number;\r\n}\r\n\r\nexport interface PlanDefinition {\r\n  tier: PlanTier;\r\n  name: string;\r\n  description: string;\r\n  limits: PlanLimits;\r\n  pricing: PlanPricing;\r\n  features: string[];\r\n  recommended?: boolean;\r\n}\r\n\r\nexport const PLAN_DEFINITIONS: Record<PlanTier, PlanDefinition> = {\r\n  FREE: {\r\n    tier: \"FREE\",\r\n    name: \"Free\",\r\n    description: \"Get started with basic tracking\",\r\n    limits: {\r\n      maxWorkspaces: 1,\r\n      maxConnectors: 1,\r\n      monthlyEventLimit: 1000,\r\n      dataRetentionDays: 7,\r\n      attributionModels: [\"LAST_TOUCH\"],\r\n      alertsEnabled: false,\r\n      ssoEnabled: false,\r\n      prioritySupport: false,\r\n    },\r\n    pricing: {\r\n      monthlyPriceCents: 0,\r\n      annualPriceCents: 0,\r\n      overageEventsPer10kCents: 0,\r\n      overageConnectorCents: 0,\r\n    },\r\n    features: [\r\n      \"1 workspace\",\r\n      \"1 ad platform connector\",\r\n      \"1,000 events/month\",\r\n      \"Last-touch attribution\",\r\n      \"7-day data retention\",\r\n    ],\r\n  },\r\n\r\n  STARTER: {\r\n    tier: \"STARTER\",\r\n    name: \"Starter\",\r\n    description: \"For small teams getting started with attribution\",\r\n    limits: {\r\n      maxWorkspaces: 1,\r\n      maxConnectors: 2,\r\n      monthlyEventLimit: 10_000,\r\n      dataRetentionDays: 14,\r\n      attributionModels: [\"FIRST_TOUCH\", \"LAST_TOUCH\", \"LINEAR\"],\r\n      alertsEnabled: false,\r\n      ssoEnabled: false,\r\n      prioritySupport: false,\r\n    },\r\n    pricing: {\r\n      monthlyPriceCents: 4900,\r\n      annualPriceCents: 47000,\r\n      overageEventsPer10kCents: 500,\r\n      overageConnectorCents: 1500,\r\n    },\r\n    features: [\r\n      \"1 workspace\",\r\n      \"2 ad platform connectors\",\r\n      \"10,000 events/month\",\r\n      \"First, last & linear attribution\",\r\n      \"14-day data retention\",\r\n      \"Email support\",\r\n    ],\r\n  },\r\n\r\n  GROWTH: {\r\n    tier: \"GROWTH\",\r\n    name: \"Growth\",\r\n    description: \"For growing teams who need full attribution insights\",\r\n    limits: {\r\n      maxWorkspaces: 3,\r\n      maxConnectors: 10,\r\n      monthlyEventLimit: 100_000,\r\n      dataRetentionDays: 90,\r\n      attributionModels: [\r\n        \"FIRST_TOUCH\",\r\n        \"LAST_TOUCH\",\r\n        \"LINEAR\",\r\n        \"TIME_DECAY\",\r\n        \"POSITION_BASED\",\r\n      ],\r\n      alertsEnabled: true,\r\n      ssoEnabled: false,\r\n      prioritySupport: false,\r\n    },\r\n    pricing: {\r\n      monthlyPriceCents: 14900,\r\n      annualPriceCents: 143000,\r\n      overageEventsPer10kCents: 400,\r\n      overageConnectorCents: 1000,\r\n    },\r\n    features: [\r\n      \"3 workspaces\",\r\n      \"All ad platform connectors\",\r\n      \"100,000 events/month\",\r\n      \"All attribution models\",\r\n      \"90-day data retention\",\r\n      \"Waste & CPA alerts\",\r\n      \"Priority email support\",\r\n    ],\r\n    recommended: true,\r\n  },\r\n\r\n  SCALE: {\r\n    tier: \"SCALE\",\r\n    name: \"Scale\",\r\n    description: \"For enterprises with advanced needs\",\r\n    limits: {\r\n      maxWorkspaces: -1,\r\n      maxConnectors: -1,\r\n      monthlyEventLimit: 1_000_000,\r\n      dataRetentionDays: 365,\r\n      attributionModels: [\r\n        \"FIRST_TOUCH\",\r\n        \"LAST_TOUCH\",\r\n        \"LINEAR\",\r\n        \"TIME_DECAY\",\r\n        \"POSITION_BASED\",\r\n        \"DATA_DRIVEN\",\r\n      ],\r\n      alertsEnabled: true,\r\n      ssoEnabled: true,\r\n      prioritySupport: true,\r\n    },\r\n    pricing: {\r\n      monthlyPriceCents: 49900,\r\n      annualPriceCents: 479000,\r\n      overageEventsPer10kCents: 300,\r\n      overageConnectorCents: 500,\r\n    },\r\n    features: [\r\n      \"Unlimited workspaces\",\r\n      \"Unlimited connectors\",\r\n      \"1,000,000+ events/month\",\r\n      \"All attribution models + data-driven\",\r\n      \"365-day data retention\",\r\n      \"Custom lookback windows\",\r\n      \"SSO/SAML (coming soon)\",\r\n      \"Dedicated support\",\r\n      \"SLA guarantee\",\r\n    ],\r\n  },\r\n};\r\n\r\nexport function getPlanDefinition(tier: PlanTier): PlanDefinition {\r\n  return PLAN_DEFINITIONS[tier];\r\n}\r\n\r\nexport function getPlanLimits(tier: PlanTier): PlanLimits {\r\n  return PLAN_DEFINITIONS[tier].limits;\r\n}\r\n\r\nexport function isUnlimited(value: number): boolean {\r\n  return value === -1;\r\n}\r\n\r\nexport interface UsageSummary {\r\n  trackedEvents: number;\r\n  connectedAccounts: number;\r\n  workspacesUsed: number;\r\n}\r\n\r\nexport interface OverageCalculation {\r\n  eventsOverage: number;\r\n  connectorsOverage: number;\r\n  eventsOverageCents: number;\r\n  connectorsOverageCents: number;\r\n  totalOverageCents: number;\r\n}\r\n\r\nexport function calculateOverages(\r\n  usage: UsageSummary,\r\n  limits: PlanLimits,\r\n  pricing: PlanPricing\r\n): OverageCalculation {\r\n  const eventsOverage = Math.max(0, usage.trackedEvents - limits.monthlyEventLimit);\r\n  const connectorsOverage = isUnlimited(limits.maxConnectors)\r\n    ? 0\r\n    : Math.max(0, usage.connectedAccounts - limits.maxConnectors);\r\n\r\n  const eventsOverageUnits = Math.ceil(eventsOverage / 10_000);\r\n  const eventsOverageCents = eventsOverageUnits * pricing.overageEventsPer10kCents;\r\n  const connectorsOverageCents = connectorsOverage * pricing.overageConnectorCents;\r\n\r\n  return {\r\n    eventsOverage,\r\n    connectorsOverage,\r\n    eventsOverageCents,\r\n    connectorsOverageCents,\r\n    totalOverageCents: eventsOverageCents + connectorsOverageCents,\r\n  };\r\n}\r\n\r\nexport interface LimitCheckResult {\r\n  withinLimits: boolean;\r\n  violations: string[];\r\n}\r\n\r\nexport function checkLimits(\r\n  usage: UsageSummary,\r\n  limits: PlanLimits\r\n): LimitCheckResult {\r\n  const violations: string[] = [];\r\n\r\n  if (!isUnlimited(limits.maxWorkspaces) && usage.workspacesUsed > limits.maxWorkspaces) {\r\n    violations.push(`Workspace limit exceeded (${usage.workspacesUsed}/${limits.maxWorkspaces})`);\r\n  }\r\n\r\n  if (!isUnlimited(limits.maxConnectors) && usage.connectedAccounts > limits.maxConnectors) {\r\n    violations.push(`Connector limit exceeded (${usage.connectedAccounts}/${limits.maxConnectors})`);\r\n  }\r\n\r\n  if (usage.trackedEvents > limits.monthlyEventLimit * 1.5) {\r\n    violations.push(`Event limit significantly exceeded (${usage.trackedEvents}/${limits.monthlyEventLimit})`);\r\n  }\r\n\r\n  return {\r\n    withinLimits: violations.length === 0,\r\n    violations,\r\n  };\r\n}\r\n\r\nexport function canUpgrade(currentTier: PlanTier, targetTier: PlanTier): boolean {\r\n  const tierOrder: PlanTier[] = [\"FREE\", \"STARTER\", \"GROWTH\", \"SCALE\"];\r\n  return tierOrder.indexOf(targetTier) > tierOrder.indexOf(currentTier);\r\n}\r\n\r\nexport function canDowngrade(currentTier: PlanTier, targetTier: PlanTier): boolean {\r\n  const tierOrder: PlanTier[] = [\"FREE\", \"STARTER\", \"GROWTH\", \"SCALE\"];\r\n  return tierOrder.indexOf(targetTier) < tierOrder.indexOf(currentTier);\r\n}\r\n\r\nexport function getUpgradePath(currentTier: PlanTier): PlanTier | null {\r\n  const tierOrder: PlanTier[] = [\"FREE\", \"STARTER\", \"GROWTH\", \"SCALE\"];\r\n  const currentIndex = tierOrder.indexOf(currentTier);\r\n  if (currentIndex < tierOrder.length - 1) {\r\n    return tierOrder[currentIndex + 1];\r\n  }\r\n  return null;\r\n}\r\n"],"names":[],"mappings":"AAAA;;;;;;;GAOG;;;;;;;;;;;;;;;;;;;;AAwCI,MAAM,gBAAgB,GAAqC;IAChE,IAAI,EAAE;QACJ,IAAI,EAAE,MAAM;QACZ,IAAI,EAAE,MAAM;QACZ,WAAW,EAAE,iCAAiC;QAC9C,MAAM,EAAE;YACN,aAAa,EAAE,CAAC;YAChB,aAAa,EAAE,CAAC;YAChB,iBAAiB,EAAE,IAAI;YACvB,iBAAiB,EAAE,CAAC;YACpB,iBAAiB,EAAE;gBAAC,YAAY;aAAC;YACjC,aAAa,EAAE,KAAK;YACpB,UAAU,EAAE,KAAK;YACjB,eAAe,EAAE,KAAK;SACvB;QACD,OAAO,EAAE;YACP,iBAAiB,EAAE,CAAC;YACpB,gBAAgB,EAAE,CAAC;YACnB,wBAAwB,EAAE,CAAC;YAC3B,qBAAqB,EAAE,CAAC;SACzB;QACD,QAAQ,EAAE;YACR,aAAa;YACb,yBAAyB;YACzB,oBAAoB;YACpB,wBAAwB;YACxB,sBAAsB;SACvB;KACF;IAED,OAAO,EAAE;QACP,IAAI,EAAE,SAAS;QACf,IAAI,EAAE,SAAS;QACf,WAAW,EAAE,kDAAkD;QAC/D,MAAM,EAAE;YACN,aAAa,EAAE,CAAC;YAChB,aAAa,EAAE,CAAC;YAChB,iBAAiB,EAAE,MAAM;YACzB,iBAAiB,EAAE,EAAE;YACrB,iBAAiB,EAAE;gBAAC,aAAa;gBAAE,YAAY;gBAAE,QAAQ;aAAC;YAC1D,aAAa,EAAE,KAAK;YACpB,UAAU,EAAE,KAAK;YACjB,eAAe,EAAE,KAAK;SACvB;QACD,OAAO,EAAE;YACP,iBAAiB,EAAE,IAAI;YACvB,gBAAgB,EAAE,KAAK;YACvB,wBAAwB,EAAE,GAAG;YAC7B,qBAAqB,EAAE,IAAI;SAC5B;QACD,QAAQ,EAAE;YACR,aAAa;YACb,0BAA0B;YAC1B,qBAAqB;YACrB,kCAAkC;YAClC,uBAAuB;YACvB,eAAe;SAChB;KACF;IAED,MAAM,EAAE;QACN,IAAI,EAAE,QAAQ;QACd,IAAI,EAAE,QAAQ;QACd,WAAW,EAAE,sDAAsD;QACnE,MAAM,EAAE;YACN,aAAa,EAAE,CAAC;YAChB,aAAa,EAAE,EAAE;YACjB,iBAAiB,EAAE,OAAO;YAC1B,iBAAiB,EAAE,EAAE;YACrB,iBAAiB,EAAE;gBACjB,aAAa;gBACb,YAAY;gBACZ,QAAQ;gBACR,YAAY;gBACZ,gBAAgB;aACjB;YACD,aAAa,EAAE,IAAI;YACnB,UAAU,EAAE,KAAK;YACjB,eAAe,EAAE,KAAK;SACvB;QACD,OAAO,EAAE;YACP,iBAAiB,EAAE,KAAK;YACxB,gBAAgB,EAAE,MAAM;YACxB,wBAAwB,EAAE,GAAG;YAC7B,qBAAqB,EAAE,IAAI;SAC5B;QACD,QAAQ,EAAE;YACR,cAAc;YACd,4BAA4B;YAC5B,sBAAsB;YACtB,wBAAwB;YACxB,uBAAuB;YACvB,oBAAoB;YACpB,wBAAwB;SACzB;QACD,WAAW,EAAE,IAAI;KAClB;IAED,KAAK,EAAE;QACL,IAAI,EAAE,OAAO;QACb,IAAI,EAAE,OAAO;QACb,WAAW,EAAE,qCAAqC;QAClD,MAAM,EAAE;YACN,aAAa,EAAE,CAAC,CAAC;YACjB,aAAa,EAAE,CAAC,CAAC;YACjB,iBAAiB,EAAE,SAAS;YAC5B,iBAAiB,EAAE,GAAG;YACtB,iBAAiB,EAAE;gBACjB,aAAa;gBACb,YAAY;gBACZ,QAAQ;gBACR,YAAY;gBACZ,gBAAgB;gBAChB,aAAa;aACd;YACD,aAAa,EAAE,IAAI;YACnB,UAAU,EAAE,IAAI;YAChB,eAAe,EAAE,IAAI;SACtB;QACD,OAAO,EAAE;YACP,iBAAiB,EAAE,KAAK;YACxB,gBAAgB,EAAE,MAAM;YACxB,wBAAwB,EAAE,GAAG;YAC7B,qBAAqB,EAAE,GAAG;SAC3B;QACD,QAAQ,EAAE;YACR,sBAAsB;YACtB,sBAAsB;YACtB,yBAAyB;YACzB,sCAAsC;YACtC,wBAAwB;YACxB,yBAAyB;YACzB,wBAAwB;YACxB,mBAAmB;YACnB,eAAe;SAChB;KACF;CACF,CAAC;AAEI,SAAU,iBAAiB,CAAC,IAAc;IAC9C,OAAO,gBAAgB,CAAC,IAAI,CAAC,CAAC;AAChC,CAAC;AAEK,SAAU,aAAa,CAAC,IAAc;IAC1C,OAAO,gBAAgB,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC;AACvC,CAAC;AAEK,SAAU,WAAW,CAAC,KAAa;IACvC,OAAO,KAAK,KAAK,CAAC,CAAC,CAAC;AACtB,CAAC;AAgBK,SAAU,iBAAiB,CAC/B,KAAmB,EACnB,MAAkB,EAClB,OAAoB;IAEpB,MAAM,aAAa,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,CAAC,aAAa,GAAG,MAAM,CAAC,iBAAiB,CAAC,CAAC;IAClF,MAAM,iBAAiB,GAAG,WAAW,CAAC,MAAM,CAAC,aAAa,CAAC,GACvD,CAAC,GACD,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,KAAK,CAAC,iBAAiB,GAAG,MAAM,CAAC,aAAa,CAAC,CAAC;IAEhE,MAAM,kBAAkB,GAAG,IAAI,CAAC,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC,CAAC;IAC7D,MAAM,kBAAkB,GAAG,kBAAkB,GAAG,OAAO,CAAC,wBAAwB,CAAC;IACjF,MAAM,sBAAsB,GAAG,iBAAiB,GAAG,OAAO,CAAC,qBAAqB,CAAC;IAEjF,OAAO;QACL,aAAa;QACb,iBAAiB;QACjB,kBAAkB;QAClB,sBAAsB;QACtB,iBAAiB,EAAE,kBAAkB,GAAG,sBAAsB;KAC/D,CAAC;AACJ,CAAC;AAOK,SAAU,WAAW,CACzB,KAAmB,EACnB,MAAkB;IAElB,MAAM,UAAU,GAAa,EAAE,CAAC;IAEhC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,cAAc,GAAG,MAAM,CAAC,aAAa,EAAE,CAAC;QACtF,UAAU,CAAC,IAAI,CAAC,CAAA,0BAAA,EAA6B,KAAK,CAAC,cAAc,CAAA,CAAA,EAAI,MAAM,CAAC,aAAa,CAAA,CAAA,CAAG,CAAC,CAAC;IAChG,CAAC;IAED,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,iBAAiB,GAAG,MAAM,CAAC,aAAa,EAAE,CAAC;QACzF,UAAU,CAAC,IAAI,CAAC,CAAA,0BAAA,EAA6B,KAAK,CAAC,iBAAiB,CAAA,CAAA,EAAI,MAAM,CAAC,aAAa,CAAA,CAAA,CAAG,CAAC,CAAC;IACnG,CAAC;IAED,IAAI,KAAK,CAAC,aAAa,GAAG,MAAM,CAAC,iBAAiB,GAAG,GAAG,EAAE,CAAC;QACzD,UAAU,CAAC,IAAI,CAAC,CAAA,oCAAA,EAAuC,KAAK,CAAC,aAAa,CAAA,CAAA,EAAI,MAAM,CAAC,iBAAiB,CAAA,CAAA,CAAG,CAAC,CAAC;IAC7G,CAAC;IAED,OAAO;QACL,YAAY,EAAE,UAAU,CAAC,MAAM,KAAK,CAAC;QACrC,UAAU;KACX,CAAC;AACJ,CAAC;AAEK,SAAU,UAAU,CAAC,WAAqB,EAAE,UAAoB;IACpE,MAAM,SAAS,GAAe;QAAC,MAAM;QAAE,SAAS;QAAE,QAAQ;QAAE,OAAO;KAAC,CAAC;IACrE,OAAO,SAAS,CAAC,OAAO,CAAC,UAAU,CAAC,GAAG,SAAS,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;AACxE,CAAC;AAEK,SAAU,YAAY,CAAC,WAAqB,EAAE,UAAoB;IACtE,MAAM,SAAS,GAAe;QAAC,MAAM;QAAE,SAAS;QAAE,QAAQ;QAAE,OAAO;KAAC,CAAC;IACrE,OAAO,SAAS,CAAC,OAAO,CAAC,UAAU,CAAC,GAAG,SAAS,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;AACxE,CAAC;AAEK,SAAU,cAAc,CAAC,WAAqB;IAClD,MAAM,SAAS,GAAe;QAAC,MAAM;QAAE,SAAS;QAAE,QAAQ;QAAE,OAAO;KAAC,CAAC;IACrE,MAAM,YAAY,GAAG,SAAS,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC;IACpD,IAAI,YAAY,GAAG,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;QACxC,OAAO,SAAS,CAAC,YAAY,GAAG,CAAC,CAAC,CAAC;IACrC,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC"}},
    {"offset": {"line": 598, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/pricing/index.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/pricing/index.ts"],"sourcesContent":["export {\r\n  PLAN_DEFINITIONS,\r\n  getPlanDefinition,\r\n  getPlanLimits,\r\n  isUnlimited,\r\n  calculateOverages,\r\n  checkLimits,\r\n  canUpgrade,\r\n  canDowngrade,\r\n  getUpgradePath,\r\n} from \"./types\";\r\n\r\nexport type {\r\n  PlanTier,\r\n  AttributionModel,\r\n  PlanLimits,\r\n  PlanPricing,\r\n  PlanDefinition,\r\n  UsageSummary,\r\n  OverageCalculation,\r\n  LimitCheckResult,\r\n} from \"./types\";\r\n"],"names":[],"mappings":";AAAA,OAAO,EACL,gBAAgB,EAChB,iBAAiB,EACjB,aAAa,EACb,WAAW,EACX,iBAAiB,EACjB,WAAW,EACX,UAAU,EACV,YAAY,EACZ,cAAc,GACf,MAAM,SAAS,CAAC"}},
    {"offset": {"line": 605, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/middleware/request-context.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/middleware/request-context.ts"],"sourcesContent":["import { randomUUID } from \"crypto\";\r\n\r\n/**\r\n * Request context for correlation and tracing\r\n */\r\nexport interface RequestContext {\r\n  /** Unique request/trace ID */\r\n  traceId: string;\r\n  /** Request start timestamp */\r\n  startTime: number;\r\n  /** HTTP method */\r\n  method?: string;\r\n  /** Request path */\r\n  path?: string;\r\n  /** User ID if authenticated */\r\n  userId?: string;\r\n  /** Organization ID if in context */\r\n  organizationId?: string;\r\n}\r\n\r\n/**\r\n * Generate a new trace ID\r\n */\r\nexport function generateTraceId(): string {\r\n  return randomUUID();\r\n}\r\n\r\n/**\r\n * Create a new request context\r\n */\r\nexport function createRequestContext(\r\n  options: Partial<RequestContext> = {}\r\n): RequestContext {\r\n  return {\r\n    traceId: options.traceId || generateTraceId(),\r\n    startTime: options.startTime || Date.now(),\r\n    method: options.method,\r\n    path: options.path,\r\n    userId: options.userId,\r\n    organizationId: options.organizationId,\r\n  };\r\n}\r\n\r\n/**\r\n * Calculate request duration in milliseconds\r\n */\r\nexport function getRequestDuration(ctx: RequestContext): number {\r\n  return Date.now() - ctx.startTime;\r\n}\r\n\r\n/**\r\n * Extract trace ID from headers (supports common formats)\r\n */\r\nexport function extractTraceId(headers: Record<string, string | string[] | undefined>): string | undefined {\r\n  const headerNames = [\r\n    \"x-trace-id\",\r\n    \"x-request-id\",\r\n    \"x-correlation-id\",\r\n    \"traceparent\",\r\n  ];\r\n\r\n  for (const name of headerNames) {\r\n    const value = headers[name];\r\n    if (typeof value === \"string\" && value.length > 0) {\r\n      // For traceparent format (W3C), extract the trace-id portion\r\n      if (name === \"traceparent\") {\r\n        const parts = value.split(\"-\");\r\n        if (parts.length >= 2) {\r\n          return parts[1];\r\n        }\r\n      }\r\n      return value;\r\n    }\r\n  }\r\n\r\n  return undefined;\r\n}\r\n\r\n/**\r\n * Create response headers with trace ID\r\n */\r\nexport function createTraceHeaders(traceId: string): Record<string, string> {\r\n  return {\r\n    \"x-trace-id\": traceId,\r\n    \"x-request-id\": traceId,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA,OAAO,EAAE,UAAU,EAAE,MAAM,QAAQ,CAAC;;AAuB9B,SAAU,eAAe;IAC7B,WAAO,mHAAU,EAAE,CAAC;AACtB,CAAC;AAKK,SAAU,oBAAoB,CAClC,UAAmC,CAAA,CAAE;IAErC,OAAO;QACL,OAAO,EAAE,OAAO,CAAC,OAAO,IAAI,eAAe,EAAE;QAC7C,SAAS,EAAE,OAAO,CAAC,SAAS,IAAI,IAAI,CAAC,GAAG,EAAE;QAC1C,MAAM,EAAE,OAAO,CAAC,MAAM;QACtB,IAAI,EAAE,OAAO,CAAC,IAAI;QAClB,MAAM,EAAE,OAAO,CAAC,MAAM;QACtB,cAAc,EAAE,OAAO,CAAC,cAAc;KACvC,CAAC;AACJ,CAAC;AAKK,SAAU,kBAAkB,CAAC,GAAmB;IACpD,OAAO,IAAI,CAAC,GAAG,EAAE,GAAG,GAAG,CAAC,SAAS,CAAC;AACpC,CAAC;AAKK,SAAU,cAAc,CAAC,OAAsD;IACnF,MAAM,WAAW,GAAG;QAClB,YAAY;QACZ,cAAc;QACd,kBAAkB;QAClB,aAAa;KACd,CAAC;IAEF,KAAK,MAAM,IAAI,IAAI,WAAW,CAAE,CAAC;QAC/B,MAAM,KAAK,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC;QAC5B,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAClD,6DAA6D;YAC7D,IAAI,IAAI,KAAK,aAAa,EAAE,CAAC;gBAC3B,MAAM,KAAK,GAAG,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;gBAC/B,IAAI,KAAK,CAAC,MAAM,IAAI,CAAC,EAAE,CAAC;oBACtB,OAAO,KAAK,CAAC,CAAC,CAAC,CAAC;gBAClB,CAAC;YACH,CAAC;YACD,OAAO,KAAK,CAAC;QACf,CAAC;IACH,CAAC;IAED,OAAO,SAAS,CAAC;AACnB,CAAC;AAKK,SAAU,kBAAkB,CAAC,OAAe;IAChD,OAAO;QACL,YAAY,EAAE,OAAO;QACrB,cAAc,EAAE,OAAO;KACxB,CAAC;AACJ,CAAC"}},
    {"offset": {"line": 667, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/middleware/index.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/middleware/index.ts"],"sourcesContent":["export * from \"./request-context.js\";\r\n"],"names":[],"mappings":";AAAA,cAAc,sBAAsB,CAAC"}},
    {"offset": {"line": 674, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/env.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/env.ts"],"sourcesContent":["import { z } from \"zod\";\r\n\r\nexport const AppEnvSchema = z.enum([\"development\", \"staging\", \"production\"]);\r\nexport type AppEnv = z.infer<typeof AppEnvSchema>;\r\n\r\nexport type EnvLoadOptions = {\r\n  redactKeys?: string[];\r\n};\r\n\r\nexport class EnvValidationError extends Error {\r\n  public readonly details: unknown;\r\n\r\n  public constructor(message: string, details: unknown) {\r\n    super(message);\r\n    this.name = \"EnvValidationError\";\r\n    this.details = details;\r\n  }\r\n}\r\n\r\nfunction formatZodError(err: z.ZodError) {\r\n  const flat = err.flatten();\r\n  const messages: string[] = [];\r\n  \r\n  // Format field-specific errors\r\n  for (const [field, errors] of Object.entries(flat.fieldErrors)) {\r\n    if (Array.isArray(errors) && errors.length > 0) {\r\n      messages.push(`  • ${field}: ${errors.join(\", \")}`);\r\n    }\r\n  }\r\n  \r\n  // Format form-level errors\r\n  if (flat.formErrors.length > 0) {\r\n    messages.push(`  • ${flat.formErrors.join(\", \")}`);\r\n  }\r\n  \r\n  return {\r\n    formErrors: flat.formErrors,\r\n    fieldErrors: flat.fieldErrors,\r\n    readableMessage: messages.length > 0 \r\n      ? `\\n${messages.join(\"\\n\")}` \r\n      : \"Unknown validation error\",\r\n  };\r\n}\r\n\r\nexport function loadEnv<TSchema extends z.ZodTypeAny>(\r\n  schema: TSchema,\r\n  raw: Record<string, string | undefined>,\r\n  options: EnvLoadOptions = {},\r\n): z.infer<TSchema> {\r\n  const parsed = schema.safeParse(raw);\r\n  if (parsed.success) return parsed.data;\r\n\r\n  const redacted = new Set(options.redactKeys ?? []);\r\n  const snapshot: Record<string, string | undefined> = {};\r\n  for (const [k, v] of Object.entries(raw)) {\r\n    snapshot[k] = redacted.has(k) ? \"[REDACTED]\" : v;\r\n  }\r\n\r\n  const formatted = formatZodError(parsed.error);\r\n  const errorMessage = `\r\n╔════════════════════════════════════════════════════════════════════════════╗\r\n║ ENVIRONMENT CONFIGURATION ERROR                                            ║\r\n╚════════════════════════════════════════════════════════════════════════════╝\r\n\r\nYour application failed to start due to invalid or missing environment variables.\r\n\r\nERRORS:${formatted.readableMessage}\r\n\r\nTROUBLESHOOTING:\r\n  1. Copy .env.example to .env if you haven't already\r\n  2. Fill in all required values in your .env file\r\n  3. Ensure all values match the expected format (URLs, numbers, etc.)\r\n  4. Check that sensitive values meet minimum length requirements\r\n\r\nFor more details, see .env.example in the project root.\r\n`;\r\n\r\n  throw new EnvValidationError(errorMessage, {\r\n    errors: formatted,\r\n    snapshot,\r\n  });\r\n}\r\n\r\nexport function getRuntimeEnv(rawAppEnv: string | undefined): AppEnv {\r\n  const appEnv = rawAppEnv?.toLowerCase();\r\n  if (appEnv === \"production\") return \"production\";\r\n  if (appEnv === \"staging\") return \"staging\";\r\n  return \"development\";\r\n}\r\n\r\nexport function buildEnvMeta(appEnv: AppEnv) {\r\n  return {\r\n    appEnv,\r\n    isDevelopment: appEnv === \"development\",\r\n    isStaging: appEnv === \"staging\",\r\n    isProduction: appEnv === \"production\",\r\n  };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 769, "column": 0}, "map": {"version":3,"file":"turbopack:///[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/dist/index.js","sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/packages/shared/src/index.ts"],"sourcesContent":["export * from \"./types\";\r\nexport * from \"./utils\";\r\nexport * from \"./logger-web\";\r\nexport * from \"./normalization\";\r\nexport * from \"./pricing\";\r\nexport * from \"./middleware\";\r\n\r\nexport {\r\n  AppEnvSchema,\r\n  buildEnvMeta,\r\n  getRuntimeEnv,\r\n  loadEnv,\r\n  type AppEnv,\r\n  type EnvLoadOptions,\r\n} from \"./env\";\r\n"],"names":[],"mappings":";AAAA,cAAc,SAAS,CAAC;AACxB,cAAc,SAAS,CAAC;AACxB,cAAc,cAAc,CAAC;AAC7B,cAAc,iBAAiB,CAAC;AAChC,cAAc,WAAW,CAAC;AAC1B,cAAc,cAAc,CAAC;AAE7B,OAAO,EACL,YAAY,EACZ,YAAY,EACZ,aAAa,EACb,OAAO,GAGR,MAAM,OAAO,CAAC"}},
    {"offset": {"line": 788, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/env.ts"],"sourcesContent":["import { z } from \"zod\";\r\nimport { config } from \"dotenv\";\r\nimport path from \"path\";\r\n\r\n// Load .env from monorepo root\r\nconfig({ path: path.resolve(__dirname, \"../../../../.env\") });\r\n\r\nimport { AppEnvSchema, buildEnvMeta, loadEnv } from \"@optiq/shared\";\r\n\r\nconst EnvSchema = z.object({\r\n  // Application\r\n  APP_ENV: AppEnvSchema.default(\"development\"),\r\n  NODE_ENV: z.enum([\"development\", \"production\", \"test\"]).default(\"development\"),\r\n  \r\n  // Database\r\n  DATABASE_URL: z.string().url().describe(\"PostgreSQL connection string\"),\r\n  \r\n  // NextAuth\r\n  NEXTAUTH_SECRET: z.string().min(32).describe(\"Secret for NextAuth session encryption (min 32 chars)\"),\r\n  NEXTAUTH_URL: z.string().url().optional().describe(\"Canonical URL of your site\"),\r\n\r\n  // Data Encryption\r\n  DATA_ENCRYPTION_KEY: z.string().min(32).describe(\"AES-256 key for encrypting sensitive data (32+ chars)\"),\r\n\r\n  // Google OAuth & Ads\r\n  GOOGLE_OAUTH_CLIENT_ID: z.string().min(1).describe(\"Google OAuth 2.0 Client ID\"),\r\n  GOOGLE_OAUTH_CLIENT_SECRET: z.string().min(1).describe(\"Google OAuth 2.0 Client Secret\"),\r\n  GOOGLE_OAUTH_REDIRECT_URI: z.string().url().describe(\"OAuth redirect URI for Google\"),\r\n  GOOGLE_ADS_DEVELOPER_TOKEN: z.string().min(1).describe(\"Google Ads API Developer Token\"),\r\n  GOOGLE_ADS_LOGIN_CUSTOMER_ID: z.string().min(1).optional().describe(\"Google Ads Manager Account ID (optional)\"),\r\n\r\n  // Meta (Facebook) Ads\r\n  META_APP_ID: z.string().min(1).describe(\"Meta App ID\"),\r\n  META_APP_SECRET: z.string().min(1).describe(\"Meta App Secret\"),\r\n  META_OAUTH_REDIRECT_URI: z.string().url().describe(\"OAuth redirect URI for Meta\"),\r\n  META_API_VERSION: z.string().min(1).default(\"v20.0\").describe(\"Meta Graph API version\"),\r\n\r\n  // TikTok Ads\r\n  TIKTOK_APP_ID: z.string().min(1).describe(\"TikTok App ID\"),\r\n  TIKTOK_APP_SECRET: z.string().min(1).describe(\"TikTok App Secret\"),\r\n  TIKTOK_OAUTH_REDIRECT_URI: z.string().url().describe(\"OAuth redirect URI for TikTok\"),\r\n  TIKTOK_API_BASE_URL: z.string().url().default(\"https://business-api.tiktok.com\").describe(\"TikTok Business API base URL\"),\r\n  \r\n  // Stripe (Optional)\r\n  STRIPE_SECRET_KEY: z.string().startsWith(\"sk_\").optional().describe(\"Stripe secret key (must start with sk_)\"),\r\n  STRIPE_WEBHOOK_SECRET: z.string().startsWith(\"whsec_\").optional().describe(\"Stripe webhook signing secret (must start with whsec_)\"),\r\n  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().startsWith(\"pk_\").optional().describe(\"Stripe publishable key (must start with pk_)\"),\r\n  \r\n  // Email Notifications (Optional)\r\n  SMTP_HOST: z.string().optional().describe(\"SMTP server hostname\"),\r\n  SMTP_PORT: z.coerce.number().int().min(1).max(65535).optional().describe(\"SMTP server port\"),\r\n  SMTP_USER: z.string().optional().describe(\"SMTP username\"),\r\n  SMTP_PASSWORD: z.string().optional().describe(\"SMTP password\"),\r\n  SMTP_FROM_EMAIL: z.string().email().optional().describe(\"From email address for notifications\"),\r\n  SMTP_FROM_NAME: z.string().optional().describe(\"From name for notifications\"),\r\n});\r\n\r\nconst base = loadEnv(\r\n  EnvSchema,\r\n  {\r\n    APP_ENV: process.env.APP_ENV,\r\n    NODE_ENV: process.env.NODE_ENV,\r\n    DATABASE_URL: process.env.DATABASE_URL,\r\n    NEXTAUTH_SECRET: process.env.NEXTAUTH_SECRET,\r\n    NEXTAUTH_URL: process.env.NEXTAUTH_URL,\r\n    DATA_ENCRYPTION_KEY: process.env.DATA_ENCRYPTION_KEY,\r\n    GOOGLE_OAUTH_CLIENT_ID: process.env.GOOGLE_OAUTH_CLIENT_ID,\r\n    GOOGLE_OAUTH_CLIENT_SECRET: process.env.GOOGLE_OAUTH_CLIENT_SECRET,\r\n    GOOGLE_OAUTH_REDIRECT_URI: process.env.GOOGLE_OAUTH_REDIRECT_URI,\r\n    GOOGLE_ADS_DEVELOPER_TOKEN: process.env.GOOGLE_ADS_DEVELOPER_TOKEN,\r\n    GOOGLE_ADS_LOGIN_CUSTOMER_ID: process.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID,\r\n    META_APP_ID: process.env.META_APP_ID,\r\n    META_APP_SECRET: process.env.META_APP_SECRET,\r\n    META_OAUTH_REDIRECT_URI: process.env.META_OAUTH_REDIRECT_URI,\r\n    META_API_VERSION: process.env.META_API_VERSION,\r\n    TIKTOK_APP_ID: process.env.TIKTOK_APP_ID,\r\n    TIKTOK_APP_SECRET: process.env.TIKTOK_APP_SECRET,\r\n    TIKTOK_OAUTH_REDIRECT_URI: process.env.TIKTOK_OAUTH_REDIRECT_URI,\r\n    TIKTOK_API_BASE_URL: process.env.TIKTOK_API_BASE_URL,\r\n    STRIPE_SECRET_KEY: process.env.STRIPE_SECRET_KEY,\r\n    STRIPE_WEBHOOK_SECRET: process.env.STRIPE_WEBHOOK_SECRET,\r\n    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,\r\n    SMTP_HOST: process.env.SMTP_HOST,\r\n    SMTP_PORT: process.env.SMTP_PORT,\r\n    SMTP_USER: process.env.SMTP_USER,\r\n    SMTP_PASSWORD: process.env.SMTP_PASSWORD,\r\n    SMTP_FROM_EMAIL: process.env.SMTP_FROM_EMAIL,\r\n    SMTP_FROM_NAME: process.env.SMTP_FROM_NAME,\r\n  },\r\n  {\r\n    redactKeys: [\r\n      \"DATABASE_URL\",\r\n      \"NEXTAUTH_SECRET\",\r\n      \"DATA_ENCRYPTION_KEY\",\r\n      \"GOOGLE_OAUTH_CLIENT_SECRET\",\r\n      \"GOOGLE_ADS_DEVELOPER_TOKEN\",\r\n      \"META_APP_SECRET\",\r\n      \"TIKTOK_APP_SECRET\",\r\n      \"STRIPE_SECRET_KEY\",\r\n      \"STRIPE_WEBHOOK_SECRET\",\r\n      \"SMTP_PASSWORD\",\r\n    ],\r\n  },\r\n);\r\n\r\nexport const env = {\r\n  ...base,\r\n  ...buildEnvMeta(base.APP_ENV),\r\n} as const;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 905, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/prisma.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma: PrismaClient | undefined;\r\n};\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log: [\"error\", \"warn\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\r\n"],"names":[],"mappings":";;;;AAAA;AAEA;;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 931, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/password.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport argon2 from \"argon2\";\r\n\r\nexport async function hashPassword(password: string): Promise<string> {\r\n  return argon2.hash(password, {\r\n    type: argon2.argon2id,\r\n  });\r\n}\r\n\r\nexport async function verifyPassword(\r\n  hash: string,\r\n  password: string,\r\n): Promise<boolean> {\r\n  return argon2.verify(hash, password);\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AAEA;;;AAEO,eAAe,aAAa,QAAgB;IACjD,OAAO,gHAAM,CAAC,IAAI,CAAC,UAAU;QAC3B,MAAM,gHAAM,CAAC,QAAQ;IACvB;AACF;AAEO,eAAe,eACpB,IAAY,EACZ,QAAgB;IAEhB,OAAO,gHAAM,CAAC,MAAM,CAAC,MAAM;AAC7B"}},
    {"offset": {"line": 953, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/auth.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { PrismaAdapter } from \"@next-auth/prisma-adapter\";\r\nimport type { NextAuthOptions } from \"next-auth\";\r\nimport NextAuth from \"next-auth\";\r\nimport CredentialsProvider from \"next-auth/providers/credentials\";\r\n\r\nimport { env } from \"@/lib/env\";\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { verifyPassword } from \"@/lib/password\";\r\n\r\nexport const authOptions: NextAuthOptions = {\r\n  session: {\r\n    strategy: \"jwt\",\r\n  },\r\n  secret: env.NEXTAUTH_SECRET,\r\n  pages: {\r\n    signIn: \"/signin\",\r\n  },\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: \"Email and Password\",\r\n      credentials: {\r\n        email: { label: \"Email\", type: \"email\" },\r\n        password: { label: \"Password\", type: \"password\" },\r\n      },\r\n      authorize: async (credentials) => {\r\n        const email = credentials?.email?.trim().toLowerCase();\r\n        const password = credentials?.password;\r\n\r\n        if (!email || !password) return null;\r\n\r\n        const user = await prisma.user.findUnique({\r\n          where: { email },\r\n          select: {\r\n            id: true,\r\n            email: true,\r\n            name: true,\r\n            passwordHash: true,\r\n            activeOrgId: true,\r\n          },\r\n        });\r\n\r\n        if (!user?.passwordHash) return null;\r\n\r\n        const ok = await verifyPassword(user.passwordHash, password);\r\n        if (!ok) return null;\r\n\r\n        return {\r\n          id: user.id,\r\n          email: user.email,\r\n          name: user.name ?? undefined,\r\n          activeOrgId: user.activeOrgId ?? undefined,\r\n        };\r\n      },\r\n    }),\r\n  ],\r\n  callbacks: {\r\n    jwt: async ({ token, user }) => {\r\n      if (user) {\r\n        token.id = user.id;\r\n        token.activeOrgId = user.activeOrgId;\r\n      }\r\n      return token;\r\n    },\r\n    session: async ({ session, token }) => {\r\n      if (session.user) {\r\n        session.user.id = token.id as string;\r\n        session.user.activeOrgId = token.activeOrgId as string | undefined;\r\n      }\r\n      return session;\r\n    },\r\n  },\r\n};\r\n\r\nexport const authHandler = NextAuth(authOptions);\r\n"],"names":[],"mappings":";;;;;;AAAA;AAIA;AACA;AAEA;AACA;AACA;;;;;;;AAEO,MAAM,cAA+B;IAC1C,SAAS;QACP,UAAU;IACZ;IACA,QAAQ,wNAAG,CAAC,eAAe;IAC3B,OAAO;QACL,QAAQ;IACV;IACA,WAAW;QACT,IAAA,+OAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAQ;gBACvC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,WAAW,OAAO;gBAChB,MAAM,QAAQ,aAAa,OAAO,OAAO;gBACzC,MAAM,WAAW,aAAa;gBAE9B,IAAI,CAAC,SAAS,CAAC,UAAU,OAAO;gBAEhC,MAAM,OAAO,MAAM,8NAAM,CAAC,IAAI,CAAC,UAAU,CAAC;oBACxC,OAAO;wBAAE;oBAAM;oBACf,QAAQ;wBACN,IAAI;wBACJ,OAAO;wBACP,MAAM;wBACN,cAAc;wBACd,aAAa;oBACf;gBACF;gBAEA,IAAI,CAAC,MAAM,cAAc,OAAO;gBAEhC,MAAM,KAAK,MAAM,IAAA,wOAAc,EAAC,KAAK,YAAY,EAAE;gBACnD,IAAI,CAAC,IAAI,OAAO;gBAEhB,OAAO;oBACL,IAAI,KAAK,EAAE;oBACX,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI,IAAI;oBACnB,aAAa,KAAK,WAAW,IAAI;gBACnC;YACF;QACF;KACD;IACD,WAAW;QACT,KAAK,OAAO,EAAE,KAAK,EAAE,IAAI,EAAE;YACzB,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE;gBAClB,MAAM,WAAW,GAAG,KAAK,WAAW;YACtC;YACA,OAAO;QACT;QACA,SAAS,OAAO,EAAE,OAAO,EAAE,KAAK,EAAE;YAChC,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;gBAC1B,QAAQ,IAAI,CAAC,WAAW,GAAG,MAAM,WAAW;YAC9C;YACA,OAAO;QACT;IACF;AACF;AAEO,MAAM,cAAc,IAAA,4NAAQ,EAAC"}},
    {"offset": {"line": 1042, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/metrics/types.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nexport type TimeGranularity = \"day\" | \"week\" | \"month\" | \"quarter\" | \"year\";\r\n\r\nexport type EntityLevel = \"organization\" | \"platform\" | \"ad_account\" | \"campaign\" | \"ad\";\r\n\r\nexport interface DateRange {\r\n  start: Date;\r\n  end: Date;\r\n}\r\n\r\nexport interface MetricsFilter {\r\n  organizationId: string;\r\n  platformCodes?: string[];\r\n  adAccountIds?: string[];\r\n  campaignIds?: string[];\r\n  adIds?: string[];\r\n  dateRange: DateRange;\r\n}\r\n\r\nexport interface RawMetrics {\r\n  impressions: bigint;\r\n  clicks: bigint;\r\n  spendMicros: bigint;\r\n  conversions: bigint;\r\n  revenueMicros: bigint;\r\n}\r\n\r\nexport interface ComputedMetrics {\r\n  impressions: number;\r\n  clicks: number;\r\n  spend: number;\r\n  conversions: number;\r\n  revenue: number;\r\n  ctr: number | null;\r\n  cpc: number | null;\r\n  cpa: number | null;\r\n  roas: number | null;\r\n  conversionRate: number | null;\r\n}\r\n\r\nexport interface MetricsWithWaste extends ComputedMetrics {\r\n  wastedSpend: number;\r\n  wastePercent: number;\r\n  efficientSpend: number;\r\n}\r\n\r\nexport interface AggregatedMetricsRow {\r\n  period: string;\r\n  periodStart: Date;\r\n  periodEnd: Date;\r\n  entityId: string | null;\r\n  entityName: string | null;\r\n  entityLevel: EntityLevel;\r\n  platformCode: string | null;\r\n  metrics: MetricsWithWaste;\r\n}\r\n\r\nexport interface MetricsSummary {\r\n  current: MetricsWithWaste;\r\n  previous: MetricsWithWaste | null;\r\n  change: MetricsChange | null;\r\n}\r\n\r\nexport interface MetricsChange {\r\n  impressions: number;\r\n  clicks: number;\r\n  spend: number;\r\n  conversions: number;\r\n  revenue: number;\r\n  cpa: number | null;\r\n  roas: number | null;\r\n  wastePercent: number;\r\n}\r\n\r\nexport interface CacheKey {\r\n  type: \"metrics\";\r\n  organizationId: string;\r\n  entityLevel: EntityLevel;\r\n  entityId: string | null;\r\n  granularity: TimeGranularity;\r\n  dateRange: string;\r\n}\r\n\r\nexport interface CachedMetrics {\r\n  key: string;\r\n  data: AggregatedMetricsRow[];\r\n  computedAt: Date;\r\n  expiresAt: Date;\r\n}\r\n\r\nexport function microsToDollars(micros: bigint): number {\r\n  return Number(micros) / 1_000_000;\r\n}\r\n\r\nexport function computeMetrics(raw: RawMetrics, targetCpaMicros?: bigint): MetricsWithWaste {\r\n  const impressions = Number(raw.impressions);\r\n  const clicks = Number(raw.clicks);\r\n  const spend = microsToDollars(raw.spendMicros);\r\n  const conversions = Number(raw.conversions);\r\n  const revenue = microsToDollars(raw.revenueMicros);\r\n\r\n  const ctr = impressions > 0 ? (clicks / impressions) * 100 : null;\r\n  const cpc = clicks > 0 ? spend / clicks : null;\r\n  const cpa = conversions > 0 ? spend / conversions : null;\r\n  const roas = spend > 0 ? revenue / spend : null;\r\n  const conversionRate = clicks > 0 ? (conversions / clicks) * 100 : null;\r\n\r\n  let wastedSpend = 0;\r\n  let efficientSpend = spend;\r\n\r\n  if (conversions === 0 && spend > 0) {\r\n    wastedSpend = spend;\r\n    efficientSpend = 0;\r\n  } else if (targetCpaMicros && conversions > 0 && cpa !== null) {\r\n    const targetCpa = microsToDollars(targetCpaMicros);\r\n    if (cpa > targetCpa) {\r\n      wastedSpend = spend - targetCpa * conversions;\r\n      efficientSpend = targetCpa * conversions;\r\n    }\r\n  }\r\n\r\n  const wastePercent = spend > 0 ? (wastedSpend / spend) * 100 : 0;\r\n\r\n  return {\r\n    impressions,\r\n    clicks,\r\n    spend,\r\n    conversions,\r\n    revenue,\r\n    ctr,\r\n    cpc,\r\n    cpa,\r\n    roas,\r\n    conversionRate,\r\n    wastedSpend,\r\n    wastePercent,\r\n    efficientSpend,\r\n  };\r\n}\r\n\r\nexport function computeChange(\r\n  current: MetricsWithWaste,\r\n  previous: MetricsWithWaste\r\n): MetricsChange {\r\n  const pctChange = (curr: number, prev: number): number => {\r\n    if (prev === 0) return curr > 0 ? 100 : 0;\r\n    return ((curr - prev) / prev) * 100;\r\n  };\r\n\r\n  return {\r\n    impressions: pctChange(current.impressions, previous.impressions),\r\n    clicks: pctChange(current.clicks, previous.clicks),\r\n    spend: pctChange(current.spend, previous.spend),\r\n    conversions: pctChange(current.conversions, previous.conversions),\r\n    revenue: pctChange(current.revenue, previous.revenue),\r\n    cpa:\r\n      current.cpa !== null && previous.cpa !== null\r\n        ? pctChange(current.cpa, previous.cpa)\r\n        : null,\r\n    roas:\r\n      current.roas !== null && previous.roas !== null\r\n        ? pctChange(current.roas, previous.roas)\r\n        : null,\r\n    wastePercent: current.wastePercent - previous.wastePercent,\r\n  };\r\n}\r\n\r\nexport function buildCacheKey(params: {\r\n  organizationId: string;\r\n  entityLevel: EntityLevel;\r\n  entityId: string | null;\r\n  granularity: TimeGranularity;\r\n  dateRange: DateRange;\r\n}): string {\r\n  const dateStr = `${params.dateRange.start.toISOString().split(\"T\")[0]}_${params.dateRange.end.toISOString().split(\"T\")[0]}`;\r\n  return `metrics:${params.organizationId}:${params.entityLevel}:${params.entityId ?? \"all\"}:${params.granularity}:${dateStr}`;\r\n}\r\n\r\nexport function getPeriodBounds(\r\n  date: Date,\r\n  granularity: TimeGranularity\r\n): { start: Date; end: Date; label: string } {\r\n  const d = new Date(date);\r\n\r\n  switch (granularity) {\r\n    case \"day\": {\r\n      const start = new Date(d.getFullYear(), d.getMonth(), d.getDate());\r\n      const end = new Date(start);\r\n      end.setDate(end.getDate() + 1);\r\n      end.setMilliseconds(-1);\r\n      return { start, end, label: start.toISOString().split(\"T\")[0] };\r\n    }\r\n\r\n    case \"week\": {\r\n      const day = d.getDay();\r\n      const diff = d.getDate() - day + (day === 0 ? -6 : 1);\r\n      const start = new Date(d.getFullYear(), d.getMonth(), diff);\r\n      const end = new Date(start);\r\n      end.setDate(end.getDate() + 7);\r\n      end.setMilliseconds(-1);\r\n      const weekNum = Math.ceil(\r\n        ((start.getTime() - new Date(start.getFullYear(), 0, 1).getTime()) / 86400000 + 1) / 7\r\n      );\r\n      return { start, end, label: `${start.getFullYear()}-W${String(weekNum).padStart(2, \"0\")}` };\r\n    }\r\n\r\n    case \"month\": {\r\n      const start = new Date(d.getFullYear(), d.getMonth(), 1);\r\n      const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23, 59, 59, 999);\r\n      return {\r\n        start,\r\n        end,\r\n        label: `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, \"0\")}`,\r\n      };\r\n    }\r\n\r\n    case \"quarter\": {\r\n      const quarter = Math.floor(d.getMonth() / 3);\r\n      const start = new Date(d.getFullYear(), quarter * 3, 1);\r\n      const end = new Date(d.getFullYear(), quarter * 3 + 3, 0, 23, 59, 59, 999);\r\n      return { start, end, label: `${start.getFullYear()}-Q${quarter + 1}` };\r\n    }\r\n\r\n    case \"year\": {\r\n      const start = new Date(d.getFullYear(), 0, 1);\r\n      const end = new Date(d.getFullYear(), 11, 31, 23, 59, 59, 999);\r\n      return { start, end, label: String(d.getFullYear()) };\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1186, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/metrics/cache.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport type { AggregatedMetricsRow, CachedMetrics } from \"./types\";\r\n\r\nconst DEFAULT_TTL_MS = 5 * 60 * 1000;\r\n\r\nconst memoryCache = new Map<string, CachedMetrics>();\r\n\r\nexport interface CacheOptions {\r\n  ttlMs?: number;\r\n}\r\n\r\nexport class MetricsCache {\r\n  private readonly ttlMs: number;\r\n\r\n  constructor(options: CacheOptions = {}) {\r\n    this.ttlMs = options.ttlMs ?? DEFAULT_TTL_MS;\r\n  }\r\n\r\n  get(key: string): AggregatedMetricsRow[] | null {\r\n    const cached = memoryCache.get(key);\r\n\r\n    if (!cached) return null;\r\n\r\n    if (new Date() > cached.expiresAt) {\r\n      memoryCache.delete(key);\r\n      return null;\r\n    }\r\n\r\n    return cached.data;\r\n  }\r\n\r\n  set(key: string, data: AggregatedMetricsRow[], ttlMs?: number): void {\r\n    const now = new Date();\r\n    const expiresAt = new Date(now.getTime() + (ttlMs ?? this.ttlMs));\r\n\r\n    memoryCache.set(key, {\r\n      key,\r\n      data,\r\n      computedAt: now,\r\n      expiresAt,\r\n    });\r\n  }\r\n\r\n  invalidate(key: string): boolean {\r\n    return memoryCache.delete(key);\r\n  }\r\n\r\n  invalidatePattern(pattern: string): number {\r\n    let count = 0;\r\n    const regex = new RegExp(pattern.replace(/\\*/g, \".*\"));\r\n\r\n    for (const key of memoryCache.keys()) {\r\n      if (regex.test(key)) {\r\n        memoryCache.delete(key);\r\n        count++;\r\n      }\r\n    }\r\n\r\n    return count;\r\n  }\r\n\r\n  invalidateOrganization(organizationId: string): number {\r\n    return this.invalidatePattern(`metrics:${organizationId}:.*`);\r\n  }\r\n\r\n  clear(): void {\r\n    memoryCache.clear();\r\n  }\r\n\r\n  size(): number {\r\n    return memoryCache.size;\r\n  }\r\n\r\n  prune(): number {\r\n    const now = new Date();\r\n    let pruned = 0;\r\n\r\n    for (const [key, cached] of memoryCache.entries()) {\r\n      if (now > cached.expiresAt) {\r\n        memoryCache.delete(key);\r\n        pruned++;\r\n      }\r\n    }\r\n\r\n    return pruned;\r\n  }\r\n\r\n  getStats(): {\r\n    size: number;\r\n    keys: string[];\r\n    oldestEntry: Date | null;\r\n    newestEntry: Date | null;\r\n  } {\r\n    let oldest: Date | null = null;\r\n    let newest: Date | null = null;\r\n\r\n    for (const cached of memoryCache.values()) {\r\n      if (!oldest || cached.computedAt < oldest) oldest = cached.computedAt;\r\n      if (!newest || cached.computedAt > newest) newest = cached.computedAt;\r\n    }\r\n\r\n    return {\r\n      size: memoryCache.size,\r\n      keys: Array.from(memoryCache.keys()),\r\n      oldestEntry: oldest,\r\n      newestEntry: newest,\r\n    };\r\n  }\r\n}\r\n\r\nexport const metricsCache = new MetricsCache();\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAIA,MAAM,iBAAiB,IAAI,KAAK;AAEhC,MAAM,cAAc,IAAI;AAMjB,MAAM;IACM,MAAc;IAE/B,YAAY,UAAwB,CAAC,CAAC,CAAE;QACtC,IAAI,CAAC,KAAK,GAAG,QAAQ,KAAK,IAAI;IAChC;IAEA,IAAI,GAAW,EAAiC;QAC9C,MAAM,SAAS,YAAY,GAAG,CAAC;QAE/B,IAAI,CAAC,QAAQ,OAAO;QAEpB,IAAI,IAAI,SAAS,OAAO,SAAS,EAAE;YACjC,YAAY,MAAM,CAAC;YACnB,OAAO;QACT;QAEA,OAAO,OAAO,IAAI;IACpB;IAEA,IAAI,GAAW,EAAE,IAA4B,EAAE,KAAc,EAAQ;QACnE,MAAM,MAAM,IAAI;QAChB,MAAM,YAAY,IAAI,KAAK,IAAI,OAAO,KAAK,CAAC,SAAS,IAAI,CAAC,KAAK;QAE/D,YAAY,GAAG,CAAC,KAAK;YACnB;YACA;YACA,YAAY;YACZ;QACF;IACF;IAEA,WAAW,GAAW,EAAW;QAC/B,OAAO,YAAY,MAAM,CAAC;IAC5B;IAEA,kBAAkB,OAAe,EAAU;QACzC,IAAI,QAAQ;QACZ,MAAM,QAAQ,IAAI,OAAO,QAAQ,OAAO,CAAC,OAAO;QAEhD,KAAK,MAAM,OAAO,YAAY,IAAI,GAAI;YACpC,IAAI,MAAM,IAAI,CAAC,MAAM;gBACnB,YAAY,MAAM,CAAC;gBACnB;YACF;QACF;QAEA,OAAO;IACT;IAEA,uBAAuB,cAAsB,EAAU;QACrD,OAAO,IAAI,CAAC,iBAAiB,CAAC,CAAC,QAAQ,EAAE,eAAe,GAAG,CAAC;IAC9D;IAEA,QAAc;QACZ,YAAY,KAAK;IACnB;IAEA,OAAe;QACb,OAAO,YAAY,IAAI;IACzB;IAEA,QAAgB;QACd,MAAM,MAAM,IAAI;QAChB,IAAI,SAAS;QAEb,KAAK,MAAM,CAAC,KAAK,OAAO,IAAI,YAAY,OAAO,GAAI;YACjD,IAAI,MAAM,OAAO,SAAS,EAAE;gBAC1B,YAAY,MAAM,CAAC;gBACnB;YACF;QACF;QAEA,OAAO;IACT;IAEA,WAKE;QACA,IAAI,SAAsB;QAC1B,IAAI,SAAsB;QAE1B,KAAK,MAAM,UAAU,YAAY,MAAM,GAAI;YACzC,IAAI,CAAC,UAAU,OAAO,UAAU,GAAG,QAAQ,SAAS,OAAO,UAAU;YACrE,IAAI,CAAC,UAAU,OAAO,UAAU,GAAG,QAAQ,SAAS,OAAO,UAAU;QACvE;QAEA,OAAO;YACL,MAAM,YAAY,IAAI;YACtB,MAAM,MAAM,IAAI,CAAC,YAAY,IAAI;YACjC,aAAa;YACb,aAAa;QACf;IACF;AACF;AAEO,MAAM,eAAe,IAAI"}},
    {"offset": {"line": 1274, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/metrics/aggregator.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport type {\r\n  TimeGranularity,\r\n  EntityLevel,\r\n  DateRange,\r\n  MetricsFilter,\r\n  RawMetrics,\r\n  AggregatedMetricsRow,\r\n  MetricsSummary,\r\n  MetricsWithWaste,\r\n} from \"./types\";\r\nimport {\r\n  computeMetrics,\r\n  computeChange,\r\n  buildCacheKey,\r\n  getPeriodBounds,\r\n} from \"./types\";\r\nimport { MetricsCache, metricsCache } from \"./cache\";\r\n\r\nexport interface AggregatorConfig {\r\n  targetCpaMicros?: bigint;\r\n  useCache?: boolean;\r\n  cacheTtlMs?: number;\r\n}\r\n\r\nconst DEFAULT_TARGET_CPA_MICROS = BigInt(25_000_000);\r\n\r\nexport class MetricsAggregator {\r\n  private readonly config: Required<AggregatorConfig>;\r\n  private readonly cache: MetricsCache;\r\n\r\n  constructor(config: AggregatorConfig = {}) {\r\n    this.config = {\r\n      targetCpaMicros: config.targetCpaMicros ?? DEFAULT_TARGET_CPA_MICROS,\r\n      useCache: config.useCache ?? true,\r\n      cacheTtlMs: config.cacheTtlMs ?? 5 * 60 * 1000,\r\n    };\r\n    this.cache = metricsCache;\r\n  }\r\n\r\n  async aggregateByPeriod(params: {\r\n    filter: MetricsFilter;\r\n    granularity: TimeGranularity;\r\n    entityLevel: EntityLevel;\r\n  }): Promise<AggregatedMetricsRow[]> {\r\n    const cacheKey = buildCacheKey({\r\n      organizationId: params.filter.organizationId,\r\n      entityLevel: params.entityLevel,\r\n      entityId: null,\r\n      granularity: params.granularity,\r\n      dateRange: params.filter.dateRange,\r\n    });\r\n\r\n    if (this.config.useCache) {\r\n      const cached = this.cache.get(cacheKey);\r\n      if (cached) return cached;\r\n    }\r\n\r\n    const rows = await this.queryMetrics(params);\r\n\r\n    if (this.config.useCache) {\r\n      this.cache.set(cacheKey, rows, this.config.cacheTtlMs);\r\n    }\r\n\r\n    return rows;\r\n  }\r\n\r\n  private async queryMetrics(params: {\r\n    filter: MetricsFilter;\r\n    granularity: TimeGranularity;\r\n    entityLevel: EntityLevel;\r\n  }): Promise<AggregatedMetricsRow[]> {\r\n    const { filter, granularity, entityLevel } = params;\r\n\r\n    switch (entityLevel) {\r\n      case \"organization\":\r\n        return this.aggregateOrganization(filter, granularity);\r\n      case \"platform\":\r\n        return this.aggregateByPlatform(filter, granularity);\r\n      case \"ad_account\":\r\n        return this.aggregateByAdAccount(filter, granularity);\r\n      case \"campaign\":\r\n        return this.aggregateByCampaign(filter, granularity);\r\n      case \"ad\":\r\n        return this.aggregateByAd(filter, granularity);\r\n      default:\r\n        return [];\r\n    }\r\n  }\r\n\r\n  private async aggregateOrganization(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyAdAccountMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    return this.groupByPeriod(metrics, granularity, {\r\n      entityLevel: \"organization\",\r\n      entityId: filter.organizationId,\r\n      entityName: \"Organization Total\",\r\n      platformCode: null,\r\n    });\r\n  }\r\n\r\n  private async aggregateByPlatform(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyAdAccountMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n        platform: { select: { code: true, name: true } },\r\n      },\r\n    });\r\n\r\n    const byPlatform = new Map<string, typeof metrics>();\r\n    for (const m of metrics) {\r\n      const key = m.platform.code;\r\n      if (!byPlatform.has(key)) byPlatform.set(key, []);\r\n      byPlatform.get(key)!.push(m);\r\n    }\r\n\r\n    const results: AggregatedMetricsRow[] = [];\r\n    for (const [platformCode, platformMetrics] of byPlatform) {\r\n      const platformName = platformMetrics[0]?.platform.name ?? platformCode;\r\n      const rows = this.groupByPeriod(platformMetrics, granularity, {\r\n        entityLevel: \"platform\",\r\n        entityId: platformCode,\r\n        entityName: platformName,\r\n        platformCode,\r\n      });\r\n      results.push(...rows);\r\n    }\r\n\r\n    return results.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  private async aggregateByAdAccount(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyAdAccountMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.adAccountIds?.length ? { adAccountId: { in: filter.adAccountIds } } : {}),\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        adAccountId: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n        adAccount: { select: { name: true } },\r\n        platform: { select: { code: true } },\r\n      },\r\n    });\r\n\r\n    const byAccount = new Map<string, typeof metrics>();\r\n    for (const m of metrics) {\r\n      if (!byAccount.has(m.adAccountId)) byAccount.set(m.adAccountId, []);\r\n      byAccount.get(m.adAccountId)!.push(m);\r\n    }\r\n\r\n    const results: AggregatedMetricsRow[] = [];\r\n    for (const [accountId, accountMetrics] of byAccount) {\r\n      const accountName = accountMetrics[0]?.adAccount.name ?? accountId;\r\n      const platformCode = accountMetrics[0]?.platform.code ?? null;\r\n      const rows = this.groupByPeriod(accountMetrics, granularity, {\r\n        entityLevel: \"ad_account\",\r\n        entityId: accountId,\r\n        entityName: accountName,\r\n        platformCode,\r\n      });\r\n      results.push(...rows);\r\n    }\r\n\r\n    return results.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  private async aggregateByCampaign(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyCampaignMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.campaignIds?.length ? { campaignId: { in: filter.campaignIds } } : {}),\r\n        ...(filter.adAccountIds?.length ? { adAccountId: { in: filter.adAccountIds } } : {}),\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        campaignId: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n        campaign: { select: { name: true } },\r\n        platform: { select: { code: true } },\r\n      },\r\n    });\r\n\r\n    const byCampaign = new Map<string, typeof metrics>();\r\n    for (const m of metrics) {\r\n      if (!byCampaign.has(m.campaignId)) byCampaign.set(m.campaignId, []);\r\n      byCampaign.get(m.campaignId)!.push(m);\r\n    }\r\n\r\n    const results: AggregatedMetricsRow[] = [];\r\n    for (const [campaignId, campaignMetrics] of byCampaign) {\r\n      const campaignName = campaignMetrics[0]?.campaign.name ?? campaignId;\r\n      const platformCode = campaignMetrics[0]?.platform.code ?? null;\r\n      const rows = this.groupByPeriod(campaignMetrics, granularity, {\r\n        entityLevel: \"campaign\",\r\n        entityId: campaignId,\r\n        entityName: campaignName,\r\n        platformCode,\r\n      });\r\n      results.push(...rows);\r\n    }\r\n\r\n    return results.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  private async aggregateByAd(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyAdMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.adIds?.length ? { adId: { in: filter.adIds } } : {}),\r\n        ...(filter.campaignIds?.length ? { campaignId: { in: filter.campaignIds } } : {}),\r\n        ...(filter.adAccountIds?.length ? { adAccountId: { in: filter.adAccountIds } } : {}),\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        adId: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n        ad: { select: { name: true } },\r\n        platform: { select: { code: true } },\r\n      },\r\n    });\r\n\r\n    const byAd = new Map<string, typeof metrics>();\r\n    for (const m of metrics) {\r\n      if (!byAd.has(m.adId)) byAd.set(m.adId, []);\r\n      byAd.get(m.adId)!.push(m);\r\n    }\r\n\r\n    const results: AggregatedMetricsRow[] = [];\r\n    for (const [adId, adMetrics] of byAd) {\r\n      const adName = adMetrics[0]?.ad.name ?? adId;\r\n      const platformCode = adMetrics[0]?.platform.code ?? null;\r\n      const rows = this.groupByPeriod(adMetrics, granularity, {\r\n        entityLevel: \"ad\",\r\n        entityId: adId,\r\n        entityName: adName,\r\n        platformCode,\r\n      });\r\n      results.push(...rows);\r\n    }\r\n\r\n    return results.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  private groupByPeriod(\r\n    metrics: Array<{\r\n      date: Date;\r\n      impressions: bigint;\r\n      clicks: bigint;\r\n      spendMicros: bigint;\r\n      conversions: bigint;\r\n      revenueMicros: bigint;\r\n    }>,\r\n    granularity: TimeGranularity,\r\n    entity: {\r\n      entityLevel: EntityLevel;\r\n      entityId: string;\r\n      entityName: string;\r\n      platformCode: string | null;\r\n    }\r\n  ): AggregatedMetricsRow[] {\r\n    const byPeriod = new Map<string, RawMetrics>();\r\n\r\n    for (const m of metrics) {\r\n      const { label } = getPeriodBounds(m.date, granularity);\r\n\r\n      if (!byPeriod.has(label)) {\r\n        byPeriod.set(label, {\r\n          impressions: BigInt(0),\r\n          clicks: BigInt(0),\r\n          spendMicros: BigInt(0),\r\n          conversions: BigInt(0),\r\n          revenueMicros: BigInt(0),\r\n        });\r\n      }\r\n\r\n      const agg = byPeriod.get(label)!;\r\n      agg.impressions += m.impressions;\r\n      agg.clicks += m.clicks;\r\n      agg.spendMicros += m.spendMicros;\r\n      agg.conversions += m.conversions;\r\n      agg.revenueMicros += m.revenueMicros;\r\n    }\r\n\r\n    const rows: AggregatedMetricsRow[] = [];\r\n\r\n    for (const [period, raw] of byPeriod) {\r\n      const sampleDate = metrics.find((m) => {\r\n        const { label } = getPeriodBounds(m.date, granularity);\r\n        return label === period;\r\n      })?.date;\r\n\r\n      if (!sampleDate) continue;\r\n\r\n      const { start, end } = getPeriodBounds(sampleDate, granularity);\r\n\r\n      rows.push({\r\n        period,\r\n        periodStart: start,\r\n        periodEnd: end,\r\n        entityId: entity.entityId,\r\n        entityName: entity.entityName,\r\n        entityLevel: entity.entityLevel,\r\n        platformCode: entity.platformCode,\r\n        metrics: computeMetrics(raw, this.config.targetCpaMicros),\r\n      });\r\n    }\r\n\r\n    return rows.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  async getSummary(params: {\r\n    filter: MetricsFilter;\r\n    entityLevel: EntityLevel;\r\n    comparePrevious?: boolean;\r\n  }): Promise<MetricsSummary> {\r\n    const currentMetrics = await this.aggregateTotal(params.filter, params.entityLevel);\r\n\r\n    if (!params.comparePrevious) {\r\n      return { current: currentMetrics, previous: null, change: null };\r\n    }\r\n\r\n    const rangeDays = Math.ceil(\r\n      (params.filter.dateRange.end.getTime() - params.filter.dateRange.start.getTime()) /\r\n        (1000 * 60 * 60 * 24)\r\n    );\r\n\r\n    const previousEnd = new Date(params.filter.dateRange.start);\r\n    previousEnd.setDate(previousEnd.getDate() - 1);\r\n    const previousStart = new Date(previousEnd);\r\n    previousStart.setDate(previousStart.getDate() - rangeDays + 1);\r\n\r\n    const previousFilter: MetricsFilter = {\r\n      ...params.filter,\r\n      dateRange: { start: previousStart, end: previousEnd },\r\n    };\r\n\r\n    const previousMetrics = await this.aggregateTotal(previousFilter, params.entityLevel);\r\n\r\n    return {\r\n      current: currentMetrics,\r\n      previous: previousMetrics,\r\n      change: computeChange(currentMetrics, previousMetrics),\r\n    };\r\n  }\r\n\r\n  private async aggregateTotal(\r\n    filter: MetricsFilter,\r\n    entityLevel: EntityLevel\r\n  ): Promise<MetricsWithWaste> {\r\n    const rows = await this.aggregateByPeriod({\r\n      filter,\r\n      granularity: \"day\",\r\n      entityLevel,\r\n    });\r\n\r\n    const totals: RawMetrics = {\r\n      impressions: BigInt(0),\r\n      clicks: BigInt(0),\r\n      spendMicros: BigInt(0),\r\n      conversions: BigInt(0),\r\n      revenueMicros: BigInt(0),\r\n    };\r\n\r\n    for (const row of rows) {\r\n      totals.impressions += BigInt(Math.round(row.metrics.impressions));\r\n      totals.clicks += BigInt(Math.round(row.metrics.clicks));\r\n      totals.spendMicros += BigInt(Math.round(row.metrics.spend * 1_000_000));\r\n      totals.conversions += BigInt(Math.round(row.metrics.conversions));\r\n      totals.revenueMicros += BigInt(Math.round(row.metrics.revenue * 1_000_000));\r\n    }\r\n\r\n    return computeMetrics(totals, this.config.targetCpaMicros);\r\n  }\r\n\r\n  invalidateCache(organizationId: string): number {\r\n    return this.cache.invalidateOrganization(organizationId);\r\n  }\r\n\r\n  getConfig(): AggregatorConfig {\r\n    return { ...this.config };\r\n  }\r\n}\r\n\r\nexport const metricsAggregator = new MetricsAggregator();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1717, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/metrics/index.ts"],"sourcesContent":["export { MetricsAggregator, metricsAggregator } from \"./aggregator\";\r\nexport type { AggregatorConfig } from \"./aggregator\";\r\n\r\nexport { MetricsCache, metricsCache } from \"./cache\";\r\nexport type { CacheOptions } from \"./cache\";\r\n\r\nexport {\r\n  computeMetrics,\r\n  computeChange,\r\n  buildCacheKey,\r\n  getPeriodBounds,\r\n  microsToDollars,\r\n} from \"./types\";\r\n\r\nexport type {\r\n  TimeGranularity,\r\n  EntityLevel,\r\n  DateRange,\r\n  MetricsFilter,\r\n  RawMetrics,\r\n  ComputedMetrics,\r\n  MetricsWithWaste,\r\n  AggregatedMetricsRow,\r\n  MetricsSummary,\r\n  MetricsChange,\r\n  CacheKey,\r\n  CachedMetrics,\r\n} from \"./types\";\r\n"],"names":[],"mappings":";AAAA;AAGA;AAGA"}},
    {"offset": {"line": 1728, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/waste/types.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nexport type WasteLevel = \"none\" | \"low\" | \"medium\" | \"high\" | \"critical\";\r\n\r\nexport type WasteReason =\r\n  | \"zero_conversions_high_spend\"\r\n  | \"cpa_above_target\"\r\n  | \"low_ctr_high_spend\"\r\n  | \"declining_performance\";\r\n\r\nexport type EntityType = \"ad_account\" | \"campaign\" | \"ad\";\r\n\r\nexport interface WasteConfig {\r\n  spendThresholdMicros: bigint;\r\n  targetCpaMicros: bigint;\r\n  cpaTolerancePercent: number;\r\n  minImpressions: number;\r\n  minCtrPercent: number;\r\n  rollingWindowDays: number;\r\n}\r\n\r\nexport interface WasteAlert {\r\n  id: string;\r\n  entityType: EntityType;\r\n  entityId: string;\r\n  entityName: string;\r\n  organizationId: string;\r\n  platformCode: string;\r\n  reason: WasteReason;\r\n  level: WasteLevel;\r\n  spendMicros: bigint;\r\n  conversions: number;\r\n  cpa: number | null;\r\n  targetCpa: number | null;\r\n  windowStart: Date;\r\n  windowEnd: Date;\r\n  message: string;\r\n  recommendation: string;\r\n}\r\n\r\nexport interface WasteAnalysis {\r\n  organizationId: string;\r\n  windowStart: Date;\r\n  windowEnd: Date;\r\n  totalWastedSpendMicros: bigint;\r\n  alerts: WasteAlert[];\r\n  byLevel: Record<WasteLevel, number>;\r\n  byReason: Record<WasteReason, number>;\r\n  byEntityType: Record<EntityType, number>;\r\n}\r\n\r\nexport interface AggregatedMetrics {\r\n  entityId: string;\r\n  entityName: string;\r\n  entityType: EntityType;\r\n  platformCode: string;\r\n  impressions: bigint;\r\n  clicks: bigint;\r\n  spendMicros: bigint;\r\n  conversions: bigint;\r\n  revenueMicros: bigint;\r\n}\r\n\r\nexport const DEFAULT_WASTE_CONFIG: WasteConfig = {\r\n  spendThresholdMicros: BigInt(50_000_000),\r\n  targetCpaMicros: BigInt(25_000_000),\r\n  cpaTolerancePercent: 50,\r\n  minImpressions: 1000,\r\n  minCtrPercent: 0.5,\r\n  rollingWindowDays: 7,\r\n};\r\n\r\nexport function microsToDollars(micros: bigint): number {\r\n  return Number(micros) / 1_000_000;\r\n}\r\n\r\nexport function dollarsToMicros(dollars: number): bigint {\r\n  return BigInt(Math.round(dollars * 1_000_000));\r\n}\r\n\r\nexport function computeCpa(spendMicros: bigint, conversions: bigint): number | null {\r\n  if (conversions === BigInt(0)) return null;\r\n  return Number(spendMicros) / Number(conversions);\r\n}\r\n\r\nexport function computeCtr(clicks: bigint, impressions: bigint): number {\r\n  if (impressions === BigInt(0)) return 0;\r\n  return (Number(clicks) / Number(impressions)) * 100;\r\n}\r\n\r\nexport function determineWasteLevel(\r\n  spendMicros: bigint,\r\n  config: WasteConfig,\r\n  reason: WasteReason\r\n): WasteLevel {\r\n  const spendDollars = microsToDollars(spendMicros);\r\n  const thresholdDollars = microsToDollars(config.spendThresholdMicros);\r\n\r\n  if (reason === \"zero_conversions_high_spend\") {\r\n    if (spendDollars >= thresholdDollars * 5) return \"critical\";\r\n    if (spendDollars >= thresholdDollars * 2) return \"high\";\r\n    if (spendDollars >= thresholdDollars) return \"medium\";\r\n    return \"low\";\r\n  }\r\n\r\n  if (reason === \"cpa_above_target\") {\r\n    if (spendDollars >= thresholdDollars * 3) return \"high\";\r\n    if (spendDollars >= thresholdDollars) return \"medium\";\r\n    return \"low\";\r\n  }\r\n\r\n  return \"low\";\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AA+DO,MAAM,uBAAoC;IAC/C,sBAAsB,OAAO;IAC7B,iBAAiB,OAAO;IACxB,qBAAqB;IACrB,gBAAgB;IAChB,eAAe;IACf,mBAAmB;AACrB;AAEO,SAAS,gBAAgB,MAAc;IAC5C,OAAO,OAAO,UAAU;AAC1B;AAEO,SAAS,gBAAgB,OAAe;IAC7C,OAAO,OAAO,KAAK,KAAK,CAAC,UAAU;AACrC;AAEO,SAAS,WAAW,WAAmB,EAAE,WAAmB;IACjE,IAAI,gBAAgB,OAAO,IAAI,OAAO;IACtC,OAAO,OAAO,eAAe,OAAO;AACtC;AAEO,SAAS,WAAW,MAAc,EAAE,WAAmB;IAC5D,IAAI,gBAAgB,OAAO,IAAI,OAAO;IACtC,OAAO,AAAC,OAAO,UAAU,OAAO,eAAgB;AAClD;AAEO,SAAS,oBACd,WAAmB,EACnB,MAAmB,EACnB,MAAmB;IAEnB,MAAM,eAAe,gBAAgB;IACrC,MAAM,mBAAmB,gBAAgB,OAAO,oBAAoB;IAEpE,IAAI,WAAW,+BAA+B;QAC5C,IAAI,gBAAgB,mBAAmB,GAAG,OAAO;QACjD,IAAI,gBAAgB,mBAAmB,GAAG,OAAO;QACjD,IAAI,gBAAgB,kBAAkB,OAAO;QAC7C,OAAO;IACT;IAEA,IAAI,WAAW,oBAAoB;QACjC,IAAI,gBAAgB,mBAAmB,GAAG,OAAO;QACjD,IAAI,gBAAgB,kBAAkB,OAAO;QAC7C,OAAO;IACT;IAEA,OAAO;AACT"}},
    {"offset": {"line": 1786, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/waste/evaluator.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport type {\r\n  WasteConfig,\r\n  WasteAlert,\r\n  WasteAnalysis,\r\n  WasteLevel,\r\n  WasteReason,\r\n  EntityType,\r\n  AggregatedMetrics,\r\n} from \"./types\";\r\nimport {\r\n  DEFAULT_WASTE_CONFIG,\r\n  microsToDollars,\r\n  computeCpa,\r\n  computeCtr,\r\n  determineWasteLevel,\r\n} from \"./types\";\r\n\r\ntype RollingWindow = {\r\n  start: Date;\r\n  end: Date;\r\n  days: number;\r\n};\r\n\r\nfunction createRollingWindow(days: number, endDate?: Date): RollingWindow {\r\n  const end = endDate ?? new Date();\r\n  end.setHours(23, 59, 59, 999);\r\n\r\n  const start = new Date(end);\r\n  start.setDate(start.getDate() - days + 1);\r\n  start.setHours(0, 0, 0, 0);\r\n\r\n  return { start, end, days };\r\n}\r\n\r\nfunction generateAlertId(\r\n  entityType: EntityType,\r\n  entityId: string,\r\n  reason: WasteReason,\r\n  windowEnd: Date\r\n): string {\r\n  const dateStr = windowEnd.toISOString().split(\"T\")[0];\r\n  return `${entityType}_${entityId}_${reason}_${dateStr}`;\r\n}\r\n\r\nfunction buildRecommendation(reason: WasteReason, metrics: AggregatedMetrics): string {\r\n  switch (reason) {\r\n    case \"zero_conversions_high_spend\":\r\n      return `Consider pausing this ${metrics.entityType.replace(\"_\", \" \")} or reviewing targeting. Spent $${microsToDollars(metrics.spendMicros).toFixed(2)} with no conversions.`;\r\n\r\n    case \"cpa_above_target\":\r\n      const cpa = computeCpa(metrics.spendMicros, metrics.conversions);\r\n      return `CPA of $${cpa?.toFixed(2) ?? \"N/A\"} exceeds target. Review ad creative, landing page, or audience targeting.`;\r\n\r\n    case \"low_ctr_high_spend\":\r\n      const ctr = computeCtr(metrics.clicks, metrics.impressions);\r\n      return `CTR of ${ctr.toFixed(2)}% is below threshold. Consider refreshing creative or adjusting targeting.`;\r\n\r\n    case \"declining_performance\":\r\n      return `Performance has declined over the analysis period. Review recent changes and consider optimization.`;\r\n\r\n    default:\r\n      return `Review this ${metrics.entityType.replace(\"_\", \" \")} for potential optimization opportunities.`;\r\n  }\r\n}\r\n\r\nexport class WasteEvaluator {\r\n  private readonly config: WasteConfig;\r\n\r\n  constructor(config: Partial<WasteConfig> = {}) {\r\n    this.config = { ...DEFAULT_WASTE_CONFIG, ...config };\r\n  }\r\n\r\n  async evaluateOrganization(params: {\r\n    organizationId: string;\r\n    windowDays?: number;\r\n    endDate?: Date;\r\n  }): Promise<WasteAnalysis> {\r\n    const window = createRollingWindow(\r\n      params.windowDays ?? this.config.rollingWindowDays,\r\n      params.endDate\r\n    );\r\n\r\n    const [accountAlerts, campaignAlerts, adAlerts] = await Promise.all([\r\n      this.evaluateAdAccounts(params.organizationId, window),\r\n      this.evaluateCampaigns(params.organizationId, window),\r\n      this.evaluateAds(params.organizationId, window),\r\n    ]);\r\n\r\n    const alerts = [...accountAlerts, ...campaignAlerts, ...adAlerts];\r\n\r\n    const totalWastedSpendMicros = alerts.reduce(\r\n      (sum, a) => sum + a.spendMicros,\r\n      BigInt(0)\r\n    );\r\n\r\n    const byLevel: Record<WasteLevel, number> = {\r\n      none: 0,\r\n      low: 0,\r\n      medium: 0,\r\n      high: 0,\r\n      critical: 0,\r\n    };\r\n\r\n    const byReason: Record<WasteReason, number> = {\r\n      zero_conversions_high_spend: 0,\r\n      cpa_above_target: 0,\r\n      low_ctr_high_spend: 0,\r\n      declining_performance: 0,\r\n    };\r\n\r\n    const byEntityType: Record<EntityType, number> = {\r\n      ad_account: 0,\r\n      campaign: 0,\r\n      ad: 0,\r\n    };\r\n\r\n    for (const alert of alerts) {\r\n      byLevel[alert.level]++;\r\n      byReason[alert.reason]++;\r\n      byEntityType[alert.entityType]++;\r\n    }\r\n\r\n    return {\r\n      organizationId: params.organizationId,\r\n      windowStart: window.start,\r\n      windowEnd: window.end,\r\n      totalWastedSpendMicros,\r\n      alerts,\r\n      byLevel,\r\n      byReason,\r\n      byEntityType,\r\n    };\r\n  }\r\n\r\n  private async evaluateAdAccounts(\r\n    organizationId: string,\r\n    window: RollingWindow\r\n  ): Promise<WasteAlert[]> {\r\n    const metrics = await prisma.dailyAdAccountMetric.groupBy({\r\n      by: [\"adAccountId\"],\r\n      where: {\r\n        organizationId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    for (const m of metrics) {\r\n      const account = await prisma.adAccount.findUnique({\r\n        where: { id: m.adAccountId },\r\n        select: { id: true, name: true, platform: { select: { code: true } } },\r\n      });\r\n\r\n      if (!account) continue;\r\n\r\n      const aggregated: AggregatedMetrics = {\r\n        entityId: m.adAccountId,\r\n        entityName: account.name,\r\n        entityType: \"ad_account\",\r\n        platformCode: account.platform.code,\r\n        impressions: m._sum.impressions ?? BigInt(0),\r\n        clicks: m._sum.clicks ?? BigInt(0),\r\n        spendMicros: m._sum.spendMicros ?? BigInt(0),\r\n        conversions: m._sum.conversions ?? BigInt(0),\r\n        revenueMicros: m._sum.revenueMicros ?? BigInt(0),\r\n      };\r\n\r\n      const accountAlerts = this.detectWaste(aggregated, window, organizationId);\r\n      alerts.push(...accountAlerts);\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private async evaluateCampaigns(\r\n    organizationId: string,\r\n    window: RollingWindow\r\n  ): Promise<WasteAlert[]> {\r\n    const metrics = await prisma.dailyCampaignMetric.groupBy({\r\n      by: [\"campaignId\"],\r\n      where: {\r\n        organizationId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    for (const m of metrics) {\r\n      const campaign = await prisma.campaign.findUnique({\r\n        where: { id: m.campaignId },\r\n        select: { id: true, name: true, platform: { select: { code: true } } },\r\n      });\r\n\r\n      if (!campaign) continue;\r\n\r\n      const aggregated: AggregatedMetrics = {\r\n        entityId: m.campaignId,\r\n        entityName: campaign.name,\r\n        entityType: \"campaign\",\r\n        platformCode: campaign.platform.code,\r\n        impressions: m._sum.impressions ?? BigInt(0),\r\n        clicks: m._sum.clicks ?? BigInt(0),\r\n        spendMicros: m._sum.spendMicros ?? BigInt(0),\r\n        conversions: m._sum.conversions ?? BigInt(0),\r\n        revenueMicros: m._sum.revenueMicros ?? BigInt(0),\r\n      };\r\n\r\n      const campaignAlerts = this.detectWaste(aggregated, window, organizationId);\r\n      alerts.push(...campaignAlerts);\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private async evaluateAds(\r\n    organizationId: string,\r\n    window: RollingWindow\r\n  ): Promise<WasteAlert[]> {\r\n    const metrics = await prisma.dailyAdMetric.groupBy({\r\n      by: [\"adId\"],\r\n      where: {\r\n        organizationId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    for (const m of metrics) {\r\n      const ad = await prisma.ad.findUnique({\r\n        where: { id: m.adId },\r\n        select: { id: true, name: true, platform: { select: { code: true } } },\r\n      });\r\n\r\n      if (!ad) continue;\r\n\r\n      const aggregated: AggregatedMetrics = {\r\n        entityId: m.adId,\r\n        entityName: ad.name ?? `Ad ${m.adId}`,\r\n        entityType: \"ad\",\r\n        platformCode: ad.platform.code,\r\n        impressions: m._sum.impressions ?? BigInt(0),\r\n        clicks: m._sum.clicks ?? BigInt(0),\r\n        spendMicros: m._sum.spendMicros ?? BigInt(0),\r\n        conversions: m._sum.conversions ?? BigInt(0),\r\n        revenueMicros: m._sum.revenueMicros ?? BigInt(0),\r\n      };\r\n\r\n      const adAlerts = this.detectWaste(aggregated, window, organizationId);\r\n      alerts.push(...adAlerts);\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private detectWaste(\r\n    metrics: AggregatedMetrics,\r\n    window: RollingWindow,\r\n    organizationId: string\r\n  ): WasteAlert[] {\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    if (\r\n      metrics.spendMicros >= this.config.spendThresholdMicros &&\r\n      metrics.conversions === BigInt(0)\r\n    ) {\r\n      const reason: WasteReason = \"zero_conversions_high_spend\";\r\n      const level = determineWasteLevel(metrics.spendMicros, this.config, reason);\r\n\r\n      alerts.push({\r\n        id: generateAlertId(metrics.entityType, metrics.entityId, reason, window.end),\r\n        entityType: metrics.entityType,\r\n        entityId: metrics.entityId,\r\n        entityName: metrics.entityName,\r\n        organizationId,\r\n        platformCode: metrics.platformCode,\r\n        reason,\r\n        level,\r\n        spendMicros: metrics.spendMicros,\r\n        conversions: 0,\r\n        cpa: null,\r\n        targetCpa: microsToDollars(this.config.targetCpaMicros),\r\n        windowStart: window.start,\r\n        windowEnd: window.end,\r\n        message: `${metrics.entityName} spent $${microsToDollars(metrics.spendMicros).toFixed(2)} with zero conversions in the last ${window.days} days.`,\r\n        recommendation: buildRecommendation(reason, metrics),\r\n      });\r\n    }\r\n\r\n    if (metrics.conversions > BigInt(0)) {\r\n      const cpa = computeCpa(metrics.spendMicros, metrics.conversions);\r\n      const targetCpa = microsToDollars(this.config.targetCpaMicros);\r\n      const cpaThreshold = targetCpa * (1 + this.config.cpaTolerancePercent / 100);\r\n\r\n      if (cpa !== null && cpa > cpaThreshold * 1_000_000) {\r\n        const reason: WasteReason = \"cpa_above_target\";\r\n        const level = determineWasteLevel(metrics.spendMicros, this.config, reason);\r\n\r\n        const wastedSpend =\r\n          metrics.spendMicros - BigInt(Math.round(targetCpa * 1_000_000 * Number(metrics.conversions)));\r\n\r\n        alerts.push({\r\n          id: generateAlertId(metrics.entityType, metrics.entityId, reason, window.end),\r\n          entityType: metrics.entityType,\r\n          entityId: metrics.entityId,\r\n          entityName: metrics.entityName,\r\n          organizationId,\r\n          platformCode: metrics.platformCode,\r\n          reason,\r\n          level,\r\n          spendMicros: wastedSpend > BigInt(0) ? wastedSpend : metrics.spendMicros,\r\n          conversions: Number(metrics.conversions),\r\n          cpa: cpa / 1_000_000,\r\n          targetCpa,\r\n          windowStart: window.start,\r\n          windowEnd: window.end,\r\n          message: `${metrics.entityName} has CPA of $${(cpa / 1_000_000).toFixed(2)} vs target of $${targetCpa.toFixed(2)} (${((cpa / 1_000_000 / targetCpa - 1) * 100).toFixed(0)}% over).`,\r\n          recommendation: buildRecommendation(reason, metrics),\r\n        });\r\n      }\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  async evaluateCampaign(params: {\r\n    organizationId: string;\r\n    campaignId: string;\r\n    windowDays?: number;\r\n    endDate?: Date;\r\n  }): Promise<WasteAlert[]> {\r\n    const window = createRollingWindow(\r\n      params.windowDays ?? this.config.rollingWindowDays,\r\n      params.endDate\r\n    );\r\n\r\n    const metrics = await prisma.dailyCampaignMetric.aggregate({\r\n      where: {\r\n        organizationId: params.organizationId,\r\n        campaignId: params.campaignId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const campaign = await prisma.campaign.findUnique({\r\n      where: { id: params.campaignId },\r\n      select: { id: true, name: true, platform: { select: { code: true } } },\r\n    });\r\n\r\n    if (!campaign) return [];\r\n\r\n    const aggregated: AggregatedMetrics = {\r\n      entityId: params.campaignId,\r\n      entityName: campaign.name,\r\n      entityType: \"campaign\",\r\n      platformCode: campaign.platform.code,\r\n      impressions: metrics._sum.impressions ?? BigInt(0),\r\n      clicks: metrics._sum.clicks ?? BigInt(0),\r\n      spendMicros: metrics._sum.spendMicros ?? BigInt(0),\r\n      conversions: metrics._sum.conversions ?? BigInt(0),\r\n      revenueMicros: metrics._sum.revenueMicros ?? BigInt(0),\r\n    };\r\n\r\n    return this.detectWaste(aggregated, window, params.organizationId);\r\n  }\r\n\r\n  async evaluateAd(params: {\r\n    organizationId: string;\r\n    adId: string;\r\n    windowDays?: number;\r\n    endDate?: Date;\r\n  }): Promise<WasteAlert[]> {\r\n    const window = createRollingWindow(\r\n      params.windowDays ?? this.config.rollingWindowDays,\r\n      params.endDate\r\n    );\r\n\r\n    const metrics = await prisma.dailyAdMetric.aggregate({\r\n      where: {\r\n        organizationId: params.organizationId,\r\n        adId: params.adId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const ad = await prisma.ad.findUnique({\r\n      where: { id: params.adId },\r\n      select: { id: true, name: true, platform: { select: { code: true } } },\r\n    });\r\n\r\n    if (!ad) return [];\r\n\r\n    const aggregated: AggregatedMetrics = {\r\n      entityId: params.adId,\r\n      entityName: ad.name ?? `Ad ${params.adId}`,\r\n      entityType: \"ad\",\r\n      platformCode: ad.platform.code,\r\n      impressions: metrics._sum.impressions ?? BigInt(0),\r\n      clicks: metrics._sum.clicks ?? BigInt(0),\r\n      spendMicros: metrics._sum.spendMicros ?? BigInt(0),\r\n      conversions: metrics._sum.conversions ?? BigInt(0),\r\n      revenueMicros: metrics._sum.revenueMicros ?? BigInt(0),\r\n    };\r\n\r\n    return this.detectWaste(aggregated, window, params.organizationId);\r\n  }\r\n\r\n  getConfig(): WasteConfig {\r\n    return { ...this.config };\r\n  }\r\n\r\n  withConfig(config: Partial<WasteConfig>): WasteEvaluator {\r\n    return new WasteEvaluator({ ...this.config, ...config });\r\n  }\r\n}\r\n\r\nexport const wasteEvaluator = new WasteEvaluator();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2209, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/waste/index.ts"],"sourcesContent":["export { WasteEvaluator, wasteEvaluator } from \"./evaluator\";\r\n\r\nexport {\r\n  DEFAULT_WASTE_CONFIG,\r\n  microsToDollars,\r\n  dollarsToMicros,\r\n  computeCpa,\r\n  computeCtr,\r\n  determineWasteLevel,\r\n} from \"./types\";\r\n\r\nexport type {\r\n  WasteConfig,\r\n  WasteAlert,\r\n  WasteAnalysis,\r\n  WasteLevel,\r\n  WasteReason,\r\n  EntityType,\r\n  AggregatedMetrics,\r\n} from \"./types\";\r\n"],"names":[],"mappings":";AAAA;AAEA"}},
    {"offset": {"line": 2218, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/api/dashboard/roi/route.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { getServerSession } from \"next-auth\";\r\nimport { z } from \"zod\";\r\n\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { metricsAggregator } from \"@/lib/metrics\";\r\nimport { wasteEvaluator } from \"@/lib/waste\";\r\nimport type { TimeGranularity, EntityLevel } from \"@/lib/metrics\";\r\n\r\nconst QuerySchema = z.object({\r\n  startDate: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/),\r\n  endDate: z.string().regex(/^\\d{4}-\\d{2}-\\d{2}$/),\r\n  channels: z.string().optional(),\r\n  granularity: z.enum([\"day\", \"week\", \"month\"]).default(\"day\"),\r\n  breakdown: z.enum([\"platform\", \"campaign\", \"ad\"]).default(\"campaign\"),\r\n});\r\n\r\nexport async function GET(req: Request) {\r\n  const session = await getServerSession(authOptions);\r\n  if (!session?.user?.activeOrgId) {\r\n    return NextResponse.json({ error: \"unauthorized\" }, { status: 401 });\r\n  }\r\n\r\n  const orgId = session.user.activeOrgId;\r\n  const url = new URL(req.url);\r\n  const params = QuerySchema.safeParse({\r\n    startDate: url.searchParams.get(\"startDate\"),\r\n    endDate: url.searchParams.get(\"endDate\"),\r\n    channels: url.searchParams.get(\"channels\"),\r\n    granularity: url.searchParams.get(\"granularity\") ?? \"day\",\r\n    breakdown: url.searchParams.get(\"breakdown\") ?? \"campaign\",\r\n  });\r\n\r\n  if (!params.success) {\r\n    return NextResponse.json({ error: \"invalid_params\" }, { status: 400 });\r\n  }\r\n\r\n  const { startDate, endDate, channels, granularity, breakdown } = params.data;\r\n\r\n  const dateRange = {\r\n    start: new Date(startDate + \"T00:00:00\"),\r\n    end: new Date(endDate + \"T23:59:59.999\"),\r\n  };\r\n\r\n  const platformCodes = channels ? channels.split(\",\").filter(Boolean) : undefined;\r\n\r\n  const filter = {\r\n    organizationId: orgId,\r\n    dateRange,\r\n    platformCodes,\r\n  };\r\n\r\n  try {\r\n    const [summary, timeseries, breakdownData, wasteAnalysis] = await Promise.all([\r\n      metricsAggregator.getSummary({\r\n        filter,\r\n        entityLevel: \"organization\",\r\n        comparePrevious: true,\r\n      }),\r\n      metricsAggregator.aggregateByPeriod({\r\n        filter,\r\n        granularity: granularity as TimeGranularity,\r\n        entityLevel: \"organization\",\r\n      }),\r\n      metricsAggregator.aggregateByPeriod({\r\n        filter,\r\n        granularity: \"day\",\r\n        entityLevel: breakdown as EntityLevel,\r\n      }),\r\n      wasteEvaluator.evaluateOrganization({\r\n        organizationId: orgId,\r\n        windowDays: Math.ceil((dateRange.end.getTime() - dateRange.start.getTime()) / 86400000),\r\n        endDate: dateRange.end,\r\n      }),\r\n    ]);\r\n\r\n    const totalWaste = wasteAnalysis.alerts.reduce(\r\n      (sum, a) => sum + Number(a.spendMicros) / 1_000_000,\r\n      0\r\n    );\r\n\r\n    const wastePercent = summary.current.spend > 0\r\n      ? (totalWaste / summary.current.spend) * 100\r\n      : 0;\r\n\r\n    const kpis = {\r\n      spend: summary.current.spend,\r\n      revenue: summary.current.revenue,\r\n      roas: summary.current.roas,\r\n      cpa: summary.current.cpa,\r\n      conversions: summary.current.conversions,\r\n      impressions: summary.current.impressions,\r\n      clicks: summary.current.clicks,\r\n      wasteAmount: totalWaste,\r\n      wastePercent,\r\n      changes: summary.change,\r\n    };\r\n\r\n    const timeseriesData = timeseries.map((row) => ({\r\n      date: row.period,\r\n      spend: row.metrics.spend,\r\n      revenue: row.metrics.revenue,\r\n      conversions: row.metrics.conversions,\r\n      roas: row.metrics.roas,\r\n      cpa: row.metrics.cpa,\r\n    }));\r\n\r\n    const entityTotals = new Map<string, {\r\n      entityId: string;\r\n      entityName: string;\r\n      platformCode: string | null;\r\n      spend: number;\r\n      revenue: number;\r\n      conversions: number;\r\n      impressions: number;\r\n      clicks: number;\r\n      roas: number | null;\r\n      cpa: number | null;\r\n    }>();\r\n\r\n    for (const row of breakdownData) {\r\n      const key = row.entityId ?? \"unknown\";\r\n      const existing = entityTotals.get(key);\r\n      if (existing) {\r\n        existing.spend += row.metrics.spend;\r\n        existing.revenue += row.metrics.revenue;\r\n        existing.conversions += row.metrics.conversions;\r\n        existing.impressions += row.metrics.impressions;\r\n        existing.clicks += row.metrics.clicks;\r\n      } else {\r\n        entityTotals.set(key, {\r\n          entityId: row.entityId ?? \"unknown\",\r\n          entityName: row.entityName ?? \"Unknown\",\r\n          platformCode: row.platformCode,\r\n          spend: row.metrics.spend,\r\n          revenue: row.metrics.revenue,\r\n          conversions: row.metrics.conversions,\r\n          impressions: row.metrics.impressions,\r\n          clicks: row.metrics.clicks,\r\n          roas: null,\r\n          cpa: null,\r\n        });\r\n      }\r\n    }\r\n\r\n    const breakdownRows = Array.from(entityTotals.values()).map((e) => ({\r\n      ...e,\r\n      roas: e.spend > 0 ? e.revenue / e.spend : null,\r\n      cpa: e.conversions > 0 ? e.spend / e.conversions : null,\r\n    }));\r\n\r\n    breakdownRows.sort((a, b) => b.spend - a.spend);\r\n\r\n    return NextResponse.json({\r\n      kpis,\r\n      timeseries: timeseriesData,\r\n      breakdown: breakdownRows.slice(0, 50),\r\n    });\r\n  } catch (error) {\r\n    console.error(\"ROI dashboard error:\", error);\r\n    return NextResponse.json({ error: \"server_error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}