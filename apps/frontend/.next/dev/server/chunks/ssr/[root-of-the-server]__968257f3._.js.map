{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/metrics/types.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nexport type TimeGranularity = \"day\" | \"week\" | \"month\" | \"quarter\" | \"year\";\r\n\r\nexport type EntityLevel = \"organization\" | \"platform\" | \"ad_account\" | \"campaign\" | \"ad\";\r\n\r\nexport interface DateRange {\r\n  start: Date;\r\n  end: Date;\r\n}\r\n\r\nexport interface MetricsFilter {\r\n  organizationId: string;\r\n  platformCodes?: string[];\r\n  adAccountIds?: string[];\r\n  campaignIds?: string[];\r\n  adIds?: string[];\r\n  dateRange: DateRange;\r\n}\r\n\r\nexport interface RawMetrics {\r\n  impressions: bigint;\r\n  clicks: bigint;\r\n  spendMicros: bigint;\r\n  conversions: bigint;\r\n  revenueMicros: bigint;\r\n}\r\n\r\nexport interface ComputedMetrics {\r\n  impressions: number;\r\n  clicks: number;\r\n  spend: number;\r\n  conversions: number;\r\n  revenue: number;\r\n  ctr: number | null;\r\n  cpc: number | null;\r\n  cpa: number | null;\r\n  roas: number | null;\r\n  conversionRate: number | null;\r\n}\r\n\r\nexport interface MetricsWithWaste extends ComputedMetrics {\r\n  wastedSpend: number;\r\n  wastePercent: number;\r\n  efficientSpend: number;\r\n}\r\n\r\nexport interface AggregatedMetricsRow {\r\n  period: string;\r\n  periodStart: Date;\r\n  periodEnd: Date;\r\n  entityId: string | null;\r\n  entityName: string | null;\r\n  entityLevel: EntityLevel;\r\n  platformCode: string | null;\r\n  metrics: MetricsWithWaste;\r\n}\r\n\r\nexport interface MetricsSummary {\r\n  current: MetricsWithWaste;\r\n  previous: MetricsWithWaste | null;\r\n  change: MetricsChange | null;\r\n}\r\n\r\nexport interface MetricsChange {\r\n  impressions: number;\r\n  clicks: number;\r\n  spend: number;\r\n  conversions: number;\r\n  revenue: number;\r\n  cpa: number | null;\r\n  roas: number | null;\r\n  wastePercent: number;\r\n}\r\n\r\nexport interface CacheKey {\r\n  type: \"metrics\";\r\n  organizationId: string;\r\n  entityLevel: EntityLevel;\r\n  entityId: string | null;\r\n  granularity: TimeGranularity;\r\n  dateRange: string;\r\n}\r\n\r\nexport interface CachedMetrics {\r\n  key: string;\r\n  data: AggregatedMetricsRow[];\r\n  computedAt: Date;\r\n  expiresAt: Date;\r\n}\r\n\r\nexport function microsToDollars(micros: bigint): number {\r\n  return Number(micros) / 1_000_000;\r\n}\r\n\r\nexport function computeMetrics(raw: RawMetrics, targetCpaMicros?: bigint): MetricsWithWaste {\r\n  const impressions = Number(raw.impressions);\r\n  const clicks = Number(raw.clicks);\r\n  const spend = microsToDollars(raw.spendMicros);\r\n  const conversions = Number(raw.conversions);\r\n  const revenue = microsToDollars(raw.revenueMicros);\r\n\r\n  const ctr = impressions > 0 ? (clicks / impressions) * 100 : null;\r\n  const cpc = clicks > 0 ? spend / clicks : null;\r\n  const cpa = conversions > 0 ? spend / conversions : null;\r\n  const roas = spend > 0 ? revenue / spend : null;\r\n  const conversionRate = clicks > 0 ? (conversions / clicks) * 100 : null;\r\n\r\n  let wastedSpend = 0;\r\n  let efficientSpend = spend;\r\n\r\n  if (conversions === 0 && spend > 0) {\r\n    wastedSpend = spend;\r\n    efficientSpend = 0;\r\n  } else if (targetCpaMicros && conversions > 0 && cpa !== null) {\r\n    const targetCpa = microsToDollars(targetCpaMicros);\r\n    if (cpa > targetCpa) {\r\n      wastedSpend = spend - targetCpa * conversions;\r\n      efficientSpend = targetCpa * conversions;\r\n    }\r\n  }\r\n\r\n  const wastePercent = spend > 0 ? (wastedSpend / spend) * 100 : 0;\r\n\r\n  return {\r\n    impressions,\r\n    clicks,\r\n    spend,\r\n    conversions,\r\n    revenue,\r\n    ctr,\r\n    cpc,\r\n    cpa,\r\n    roas,\r\n    conversionRate,\r\n    wastedSpend,\r\n    wastePercent,\r\n    efficientSpend,\r\n  };\r\n}\r\n\r\nexport function computeChange(\r\n  current: MetricsWithWaste,\r\n  previous: MetricsWithWaste\r\n): MetricsChange {\r\n  const pctChange = (curr: number, prev: number): number => {\r\n    if (prev === 0) return curr > 0 ? 100 : 0;\r\n    return ((curr - prev) / prev) * 100;\r\n  };\r\n\r\n  return {\r\n    impressions: pctChange(current.impressions, previous.impressions),\r\n    clicks: pctChange(current.clicks, previous.clicks),\r\n    spend: pctChange(current.spend, previous.spend),\r\n    conversions: pctChange(current.conversions, previous.conversions),\r\n    revenue: pctChange(current.revenue, previous.revenue),\r\n    cpa:\r\n      current.cpa !== null && previous.cpa !== null\r\n        ? pctChange(current.cpa, previous.cpa)\r\n        : null,\r\n    roas:\r\n      current.roas !== null && previous.roas !== null\r\n        ? pctChange(current.roas, previous.roas)\r\n        : null,\r\n    wastePercent: current.wastePercent - previous.wastePercent,\r\n  };\r\n}\r\n\r\nexport function buildCacheKey(params: {\r\n  organizationId: string;\r\n  entityLevel: EntityLevel;\r\n  entityId: string | null;\r\n  granularity: TimeGranularity;\r\n  dateRange: DateRange;\r\n}): string {\r\n  const dateStr = `${params.dateRange.start.toISOString().split(\"T\")[0]}_${params.dateRange.end.toISOString().split(\"T\")[0]}`;\r\n  return `metrics:${params.organizationId}:${params.entityLevel}:${params.entityId ?? \"all\"}:${params.granularity}:${dateStr}`;\r\n}\r\n\r\nexport function getPeriodBounds(\r\n  date: Date,\r\n  granularity: TimeGranularity\r\n): { start: Date; end: Date; label: string } {\r\n  const d = new Date(date);\r\n\r\n  switch (granularity) {\r\n    case \"day\": {\r\n      const start = new Date(d.getFullYear(), d.getMonth(), d.getDate());\r\n      const end = new Date(start);\r\n      end.setDate(end.getDate() + 1);\r\n      end.setMilliseconds(-1);\r\n      return { start, end, label: start.toISOString().split(\"T\")[0] };\r\n    }\r\n\r\n    case \"week\": {\r\n      const day = d.getDay();\r\n      const diff = d.getDate() - day + (day === 0 ? -6 : 1);\r\n      const start = new Date(d.getFullYear(), d.getMonth(), diff);\r\n      const end = new Date(start);\r\n      end.setDate(end.getDate() + 7);\r\n      end.setMilliseconds(-1);\r\n      const weekNum = Math.ceil(\r\n        ((start.getTime() - new Date(start.getFullYear(), 0, 1).getTime()) / 86400000 + 1) / 7\r\n      );\r\n      return { start, end, label: `${start.getFullYear()}-W${String(weekNum).padStart(2, \"0\")}` };\r\n    }\r\n\r\n    case \"month\": {\r\n      const start = new Date(d.getFullYear(), d.getMonth(), 1);\r\n      const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23, 59, 59, 999);\r\n      return {\r\n        start,\r\n        end,\r\n        label: `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, \"0\")}`,\r\n      };\r\n    }\r\n\r\n    case \"quarter\": {\r\n      const quarter = Math.floor(d.getMonth() / 3);\r\n      const start = new Date(d.getFullYear(), quarter * 3, 1);\r\n      const end = new Date(d.getFullYear(), quarter * 3 + 3, 0, 23, 59, 59, 999);\r\n      return { start, end, label: `${start.getFullYear()}-Q${quarter + 1}` };\r\n    }\r\n\r\n    case \"year\": {\r\n      const start = new Date(d.getFullYear(), 0, 1);\r\n      const end = new Date(d.getFullYear(), 11, 31, 23, 59, 59, 999);\r\n      return { start, end, label: String(d.getFullYear()) };\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/metrics/cache.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport type { AggregatedMetricsRow, CachedMetrics } from \"./types\";\r\n\r\nconst DEFAULT_TTL_MS = 5 * 60 * 1000;\r\n\r\nconst memoryCache = new Map<string, CachedMetrics>();\r\n\r\nexport interface CacheOptions {\r\n  ttlMs?: number;\r\n}\r\n\r\nexport class MetricsCache {\r\n  private readonly ttlMs: number;\r\n\r\n  constructor(options: CacheOptions = {}) {\r\n    this.ttlMs = options.ttlMs ?? DEFAULT_TTL_MS;\r\n  }\r\n\r\n  get(key: string): AggregatedMetricsRow[] | null {\r\n    const cached = memoryCache.get(key);\r\n\r\n    if (!cached) return null;\r\n\r\n    if (new Date() > cached.expiresAt) {\r\n      memoryCache.delete(key);\r\n      return null;\r\n    }\r\n\r\n    return cached.data;\r\n  }\r\n\r\n  set(key: string, data: AggregatedMetricsRow[], ttlMs?: number): void {\r\n    const now = new Date();\r\n    const expiresAt = new Date(now.getTime() + (ttlMs ?? this.ttlMs));\r\n\r\n    memoryCache.set(key, {\r\n      key,\r\n      data,\r\n      computedAt: now,\r\n      expiresAt,\r\n    });\r\n  }\r\n\r\n  invalidate(key: string): boolean {\r\n    return memoryCache.delete(key);\r\n  }\r\n\r\n  invalidatePattern(pattern: string): number {\r\n    let count = 0;\r\n    const regex = new RegExp(pattern.replace(/\\*/g, \".*\"));\r\n\r\n    for (const key of memoryCache.keys()) {\r\n      if (regex.test(key)) {\r\n        memoryCache.delete(key);\r\n        count++;\r\n      }\r\n    }\r\n\r\n    return count;\r\n  }\r\n\r\n  invalidateOrganization(organizationId: string): number {\r\n    return this.invalidatePattern(`metrics:${organizationId}:.*`);\r\n  }\r\n\r\n  clear(): void {\r\n    memoryCache.clear();\r\n  }\r\n\r\n  size(): number {\r\n    return memoryCache.size;\r\n  }\r\n\r\n  prune(): number {\r\n    const now = new Date();\r\n    let pruned = 0;\r\n\r\n    for (const [key, cached] of memoryCache.entries()) {\r\n      if (now > cached.expiresAt) {\r\n        memoryCache.delete(key);\r\n        pruned++;\r\n      }\r\n    }\r\n\r\n    return pruned;\r\n  }\r\n\r\n  getStats(): {\r\n    size: number;\r\n    keys: string[];\r\n    oldestEntry: Date | null;\r\n    newestEntry: Date | null;\r\n  } {\r\n    let oldest: Date | null = null;\r\n    let newest: Date | null = null;\r\n\r\n    for (const cached of memoryCache.values()) {\r\n      if (!oldest || cached.computedAt < oldest) oldest = cached.computedAt;\r\n      if (!newest || cached.computedAt > newest) newest = cached.computedAt;\r\n    }\r\n\r\n    return {\r\n      size: memoryCache.size,\r\n      keys: Array.from(memoryCache.keys()),\r\n      oldestEntry: oldest,\r\n      newestEntry: newest,\r\n    };\r\n  }\r\n}\r\n\r\nexport const metricsCache = new MetricsCache();\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAIA,MAAM,iBAAiB,IAAI,KAAK;AAEhC,MAAM,cAAc,IAAI;AAMjB,MAAM;IACM,MAAc;IAE/B,YAAY,UAAwB,CAAC,CAAC,CAAE;QACtC,IAAI,CAAC,KAAK,GAAG,QAAQ,KAAK,IAAI;IAChC;IAEA,IAAI,GAAW,EAAiC;QAC9C,MAAM,SAAS,YAAY,GAAG,CAAC;QAE/B,IAAI,CAAC,QAAQ,OAAO;QAEpB,IAAI,IAAI,SAAS,OAAO,SAAS,EAAE;YACjC,YAAY,MAAM,CAAC;YACnB,OAAO;QACT;QAEA,OAAO,OAAO,IAAI;IACpB;IAEA,IAAI,GAAW,EAAE,IAA4B,EAAE,KAAc,EAAQ;QACnE,MAAM,MAAM,IAAI;QAChB,MAAM,YAAY,IAAI,KAAK,IAAI,OAAO,KAAK,CAAC,SAAS,IAAI,CAAC,KAAK;QAE/D,YAAY,GAAG,CAAC,KAAK;YACnB;YACA;YACA,YAAY;YACZ;QACF;IACF;IAEA,WAAW,GAAW,EAAW;QAC/B,OAAO,YAAY,MAAM,CAAC;IAC5B;IAEA,kBAAkB,OAAe,EAAU;QACzC,IAAI,QAAQ;QACZ,MAAM,QAAQ,IAAI,OAAO,QAAQ,OAAO,CAAC,OAAO;QAEhD,KAAK,MAAM,OAAO,YAAY,IAAI,GAAI;YACpC,IAAI,MAAM,IAAI,CAAC,MAAM;gBACnB,YAAY,MAAM,CAAC;gBACnB;YACF;QACF;QAEA,OAAO;IACT;IAEA,uBAAuB,cAAsB,EAAU;QACrD,OAAO,IAAI,CAAC,iBAAiB,CAAC,CAAC,QAAQ,EAAE,eAAe,GAAG,CAAC;IAC9D;IAEA,QAAc;QACZ,YAAY,KAAK;IACnB;IAEA,OAAe;QACb,OAAO,YAAY,IAAI;IACzB;IAEA,QAAgB;QACd,MAAM,MAAM,IAAI;QAChB,IAAI,SAAS;QAEb,KAAK,MAAM,CAAC,KAAK,OAAO,IAAI,YAAY,OAAO,GAAI;YACjD,IAAI,MAAM,OAAO,SAAS,EAAE;gBAC1B,YAAY,MAAM,CAAC;gBACnB;YACF;QACF;QAEA,OAAO;IACT;IAEA,WAKE;QACA,IAAI,SAAsB;QAC1B,IAAI,SAAsB;QAE1B,KAAK,MAAM,UAAU,YAAY,MAAM,GAAI;YACzC,IAAI,CAAC,UAAU,OAAO,UAAU,GAAG,QAAQ,SAAS,OAAO,UAAU;YACrE,IAAI,CAAC,UAAU,OAAO,UAAU,GAAG,QAAQ,SAAS,OAAO,UAAU;QACvE;QAEA,OAAO;YACL,MAAM,YAAY,IAAI;YACtB,MAAM,MAAM,IAAI,CAAC,YAAY,IAAI;YACjC,aAAa;YACb,aAAa;QACf;IACF;AACF;AAEO,MAAM,eAAe,IAAI"}},
    {"offset": {"line": 254, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/metrics/aggregator.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport type {\r\n  TimeGranularity,\r\n  EntityLevel,\r\n  DateRange,\r\n  MetricsFilter,\r\n  RawMetrics,\r\n  AggregatedMetricsRow,\r\n  MetricsSummary,\r\n  MetricsWithWaste,\r\n} from \"./types\";\r\nimport {\r\n  computeMetrics,\r\n  computeChange,\r\n  buildCacheKey,\r\n  getPeriodBounds,\r\n} from \"./types\";\r\nimport { MetricsCache, metricsCache } from \"./cache\";\r\n\r\nexport interface AggregatorConfig {\r\n  targetCpaMicros?: bigint;\r\n  useCache?: boolean;\r\n  cacheTtlMs?: number;\r\n}\r\n\r\nconst DEFAULT_TARGET_CPA_MICROS = BigInt(25_000_000);\r\n\r\nexport class MetricsAggregator {\r\n  private readonly config: Required<AggregatorConfig>;\r\n  private readonly cache: MetricsCache;\r\n\r\n  constructor(config: AggregatorConfig = {}) {\r\n    this.config = {\r\n      targetCpaMicros: config.targetCpaMicros ?? DEFAULT_TARGET_CPA_MICROS,\r\n      useCache: config.useCache ?? true,\r\n      cacheTtlMs: config.cacheTtlMs ?? 5 * 60 * 1000,\r\n    };\r\n    this.cache = metricsCache;\r\n  }\r\n\r\n  async aggregateByPeriod(params: {\r\n    filter: MetricsFilter;\r\n    granularity: TimeGranularity;\r\n    entityLevel: EntityLevel;\r\n  }): Promise<AggregatedMetricsRow[]> {\r\n    const cacheKey = buildCacheKey({\r\n      organizationId: params.filter.organizationId,\r\n      entityLevel: params.entityLevel,\r\n      entityId: null,\r\n      granularity: params.granularity,\r\n      dateRange: params.filter.dateRange,\r\n    });\r\n\r\n    if (this.config.useCache) {\r\n      const cached = this.cache.get(cacheKey);\r\n      if (cached) return cached;\r\n    }\r\n\r\n    const rows = await this.queryMetrics(params);\r\n\r\n    if (this.config.useCache) {\r\n      this.cache.set(cacheKey, rows, this.config.cacheTtlMs);\r\n    }\r\n\r\n    return rows;\r\n  }\r\n\r\n  private async queryMetrics(params: {\r\n    filter: MetricsFilter;\r\n    granularity: TimeGranularity;\r\n    entityLevel: EntityLevel;\r\n  }): Promise<AggregatedMetricsRow[]> {\r\n    const { filter, granularity, entityLevel } = params;\r\n\r\n    switch (entityLevel) {\r\n      case \"organization\":\r\n        return this.aggregateOrganization(filter, granularity);\r\n      case \"platform\":\r\n        return this.aggregateByPlatform(filter, granularity);\r\n      case \"ad_account\":\r\n        return this.aggregateByAdAccount(filter, granularity);\r\n      case \"campaign\":\r\n        return this.aggregateByCampaign(filter, granularity);\r\n      case \"ad\":\r\n        return this.aggregateByAd(filter, granularity);\r\n      default:\r\n        return [];\r\n    }\r\n  }\r\n\r\n  private async aggregateOrganization(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyAdAccountMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    return this.groupByPeriod(metrics, granularity, {\r\n      entityLevel: \"organization\",\r\n      entityId: filter.organizationId,\r\n      entityName: \"Organization Total\",\r\n      platformCode: null,\r\n    });\r\n  }\r\n\r\n  private async aggregateByPlatform(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyAdAccountMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n        platform: { select: { code: true, name: true } },\r\n      },\r\n    });\r\n\r\n    const byPlatform = new Map<string, typeof metrics>();\r\n    for (const m of metrics) {\r\n      const key = m.platform.code;\r\n      if (!byPlatform.has(key)) byPlatform.set(key, []);\r\n      byPlatform.get(key)!.push(m);\r\n    }\r\n\r\n    const results: AggregatedMetricsRow[] = [];\r\n    for (const [platformCode, platformMetrics] of byPlatform) {\r\n      const platformName = platformMetrics[0]?.platform.name ?? platformCode;\r\n      const rows = this.groupByPeriod(platformMetrics, granularity, {\r\n        entityLevel: \"platform\",\r\n        entityId: platformCode,\r\n        entityName: platformName,\r\n        platformCode,\r\n      });\r\n      results.push(...rows);\r\n    }\r\n\r\n    return results.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  private async aggregateByAdAccount(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyAdAccountMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.adAccountIds?.length ? { adAccountId: { in: filter.adAccountIds } } : {}),\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        adAccountId: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n        adAccount: { select: { name: true } },\r\n        platform: { select: { code: true } },\r\n      },\r\n    });\r\n\r\n    const byAccount = new Map<string, typeof metrics>();\r\n    for (const m of metrics) {\r\n      if (!byAccount.has(m.adAccountId)) byAccount.set(m.adAccountId, []);\r\n      byAccount.get(m.adAccountId)!.push(m);\r\n    }\r\n\r\n    const results: AggregatedMetricsRow[] = [];\r\n    for (const [accountId, accountMetrics] of byAccount) {\r\n      const accountName = accountMetrics[0]?.adAccount.name ?? accountId;\r\n      const platformCode = accountMetrics[0]?.platform.code ?? null;\r\n      const rows = this.groupByPeriod(accountMetrics, granularity, {\r\n        entityLevel: \"ad_account\",\r\n        entityId: accountId,\r\n        entityName: accountName,\r\n        platformCode,\r\n      });\r\n      results.push(...rows);\r\n    }\r\n\r\n    return results.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  private async aggregateByCampaign(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyCampaignMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.campaignIds?.length ? { campaignId: { in: filter.campaignIds } } : {}),\r\n        ...(filter.adAccountIds?.length ? { adAccountId: { in: filter.adAccountIds } } : {}),\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        campaignId: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n        campaign: { select: { name: true } },\r\n        platform: { select: { code: true } },\r\n      },\r\n    });\r\n\r\n    const byCampaign = new Map<string, typeof metrics>();\r\n    for (const m of metrics) {\r\n      if (!byCampaign.has(m.campaignId)) byCampaign.set(m.campaignId, []);\r\n      byCampaign.get(m.campaignId)!.push(m);\r\n    }\r\n\r\n    const results: AggregatedMetricsRow[] = [];\r\n    for (const [campaignId, campaignMetrics] of byCampaign) {\r\n      const campaignName = campaignMetrics[0]?.campaign.name ?? campaignId;\r\n      const platformCode = campaignMetrics[0]?.platform.code ?? null;\r\n      const rows = this.groupByPeriod(campaignMetrics, granularity, {\r\n        entityLevel: \"campaign\",\r\n        entityId: campaignId,\r\n        entityName: campaignName,\r\n        platformCode,\r\n      });\r\n      results.push(...rows);\r\n    }\r\n\r\n    return results.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  private async aggregateByAd(\r\n    filter: MetricsFilter,\r\n    granularity: TimeGranularity\r\n  ): Promise<AggregatedMetricsRow[]> {\r\n    const metrics = await prisma.dailyAdMetric.findMany({\r\n      where: {\r\n        organizationId: filter.organizationId,\r\n        date: { gte: filter.dateRange.start, lte: filter.dateRange.end },\r\n        ...(filter.adIds?.length ? { adId: { in: filter.adIds } } : {}),\r\n        ...(filter.campaignIds?.length ? { campaignId: { in: filter.campaignIds } } : {}),\r\n        ...(filter.adAccountIds?.length ? { adAccountId: { in: filter.adAccountIds } } : {}),\r\n        ...(filter.platformCodes?.length\r\n          ? { platform: { code: { in: filter.platformCodes as (\"GOOGLE_ADS\" | \"META\" | \"TIKTOK\" | \"LINKEDIN\")[] } } }\r\n          : {}),\r\n      },\r\n      select: {\r\n        date: true,\r\n        adId: true,\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n        ad: { select: { name: true } },\r\n        platform: { select: { code: true } },\r\n      },\r\n    });\r\n\r\n    const byAd = new Map<string, typeof metrics>();\r\n    for (const m of metrics) {\r\n      if (!byAd.has(m.adId)) byAd.set(m.adId, []);\r\n      byAd.get(m.adId)!.push(m);\r\n    }\r\n\r\n    const results: AggregatedMetricsRow[] = [];\r\n    for (const [adId, adMetrics] of byAd) {\r\n      const adName = adMetrics[0]?.ad.name ?? adId;\r\n      const platformCode = adMetrics[0]?.platform.code ?? null;\r\n      const rows = this.groupByPeriod(adMetrics, granularity, {\r\n        entityLevel: \"ad\",\r\n        entityId: adId,\r\n        entityName: adName,\r\n        platformCode,\r\n      });\r\n      results.push(...rows);\r\n    }\r\n\r\n    return results.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  private groupByPeriod(\r\n    metrics: Array<{\r\n      date: Date;\r\n      impressions: bigint;\r\n      clicks: bigint;\r\n      spendMicros: bigint;\r\n      conversions: bigint;\r\n      revenueMicros: bigint;\r\n    }>,\r\n    granularity: TimeGranularity,\r\n    entity: {\r\n      entityLevel: EntityLevel;\r\n      entityId: string;\r\n      entityName: string;\r\n      platformCode: string | null;\r\n    }\r\n  ): AggregatedMetricsRow[] {\r\n    const byPeriod = new Map<string, RawMetrics>();\r\n\r\n    for (const m of metrics) {\r\n      const { label } = getPeriodBounds(m.date, granularity);\r\n\r\n      if (!byPeriod.has(label)) {\r\n        byPeriod.set(label, {\r\n          impressions: BigInt(0),\r\n          clicks: BigInt(0),\r\n          spendMicros: BigInt(0),\r\n          conversions: BigInt(0),\r\n          revenueMicros: BigInt(0),\r\n        });\r\n      }\r\n\r\n      const agg = byPeriod.get(label)!;\r\n      agg.impressions += m.impressions;\r\n      agg.clicks += m.clicks;\r\n      agg.spendMicros += m.spendMicros;\r\n      agg.conversions += m.conversions;\r\n      agg.revenueMicros += m.revenueMicros;\r\n    }\r\n\r\n    const rows: AggregatedMetricsRow[] = [];\r\n\r\n    for (const [period, raw] of byPeriod) {\r\n      const sampleDate = metrics.find((m) => {\r\n        const { label } = getPeriodBounds(m.date, granularity);\r\n        return label === period;\r\n      })?.date;\r\n\r\n      if (!sampleDate) continue;\r\n\r\n      const { start, end } = getPeriodBounds(sampleDate, granularity);\r\n\r\n      rows.push({\r\n        period,\r\n        periodStart: start,\r\n        periodEnd: end,\r\n        entityId: entity.entityId,\r\n        entityName: entity.entityName,\r\n        entityLevel: entity.entityLevel,\r\n        platformCode: entity.platformCode,\r\n        metrics: computeMetrics(raw, this.config.targetCpaMicros),\r\n      });\r\n    }\r\n\r\n    return rows.sort((a, b) => a.periodStart.getTime() - b.periodStart.getTime());\r\n  }\r\n\r\n  async getSummary(params: {\r\n    filter: MetricsFilter;\r\n    entityLevel: EntityLevel;\r\n    comparePrevious?: boolean;\r\n  }): Promise<MetricsSummary> {\r\n    const currentMetrics = await this.aggregateTotal(params.filter, params.entityLevel);\r\n\r\n    if (!params.comparePrevious) {\r\n      return { current: currentMetrics, previous: null, change: null };\r\n    }\r\n\r\n    const rangeDays = Math.ceil(\r\n      (params.filter.dateRange.end.getTime() - params.filter.dateRange.start.getTime()) /\r\n        (1000 * 60 * 60 * 24)\r\n    );\r\n\r\n    const previousEnd = new Date(params.filter.dateRange.start);\r\n    previousEnd.setDate(previousEnd.getDate() - 1);\r\n    const previousStart = new Date(previousEnd);\r\n    previousStart.setDate(previousStart.getDate() - rangeDays + 1);\r\n\r\n    const previousFilter: MetricsFilter = {\r\n      ...params.filter,\r\n      dateRange: { start: previousStart, end: previousEnd },\r\n    };\r\n\r\n    const previousMetrics = await this.aggregateTotal(previousFilter, params.entityLevel);\r\n\r\n    return {\r\n      current: currentMetrics,\r\n      previous: previousMetrics,\r\n      change: computeChange(currentMetrics, previousMetrics),\r\n    };\r\n  }\r\n\r\n  private async aggregateTotal(\r\n    filter: MetricsFilter,\r\n    entityLevel: EntityLevel\r\n  ): Promise<MetricsWithWaste> {\r\n    const rows = await this.aggregateByPeriod({\r\n      filter,\r\n      granularity: \"day\",\r\n      entityLevel,\r\n    });\r\n\r\n    const totals: RawMetrics = {\r\n      impressions: BigInt(0),\r\n      clicks: BigInt(0),\r\n      spendMicros: BigInt(0),\r\n      conversions: BigInt(0),\r\n      revenueMicros: BigInt(0),\r\n    };\r\n\r\n    for (const row of rows) {\r\n      totals.impressions += BigInt(Math.round(row.metrics.impressions));\r\n      totals.clicks += BigInt(Math.round(row.metrics.clicks));\r\n      totals.spendMicros += BigInt(Math.round(row.metrics.spend * 1_000_000));\r\n      totals.conversions += BigInt(Math.round(row.metrics.conversions));\r\n      totals.revenueMicros += BigInt(Math.round(row.metrics.revenue * 1_000_000));\r\n    }\r\n\r\n    return computeMetrics(totals, this.config.targetCpaMicros);\r\n  }\r\n\r\n  invalidateCache(organizationId: string): number {\r\n    return this.cache.invalidateOrganization(organizationId);\r\n  }\r\n\r\n  getConfig(): AggregatorConfig {\r\n    return { ...this.config };\r\n  }\r\n}\r\n\r\nexport const metricsAggregator = new MetricsAggregator();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 697, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/metrics/index.ts"],"sourcesContent":["export { MetricsAggregator, metricsAggregator } from \"./aggregator\";\r\nexport type { AggregatorConfig } from \"./aggregator\";\r\n\r\nexport { MetricsCache, metricsCache } from \"./cache\";\r\nexport type { CacheOptions } from \"./cache\";\r\n\r\nexport {\r\n  computeMetrics,\r\n  computeChange,\r\n  buildCacheKey,\r\n  getPeriodBounds,\r\n  microsToDollars,\r\n} from \"./types\";\r\n\r\nexport type {\r\n  TimeGranularity,\r\n  EntityLevel,\r\n  DateRange,\r\n  MetricsFilter,\r\n  RawMetrics,\r\n  ComputedMetrics,\r\n  MetricsWithWaste,\r\n  AggregatedMetricsRow,\r\n  MetricsSummary,\r\n  MetricsChange,\r\n  CacheKey,\r\n  CachedMetrics,\r\n} from \"./types\";\r\n"],"names":[],"mappings":";AAAA;AAGA;AAGA"}},
    {"offset": {"line": 708, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/waste/types.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nexport type WasteLevel = \"none\" | \"low\" | \"medium\" | \"high\" | \"critical\";\r\n\r\nexport type WasteReason =\r\n  | \"zero_conversions_high_spend\"\r\n  | \"cpa_above_target\"\r\n  | \"low_ctr_high_spend\"\r\n  | \"declining_performance\";\r\n\r\nexport type EntityType = \"ad_account\" | \"campaign\" | \"ad\";\r\n\r\nexport interface WasteConfig {\r\n  spendThresholdMicros: bigint;\r\n  targetCpaMicros: bigint;\r\n  cpaTolerancePercent: number;\r\n  minImpressions: number;\r\n  minCtrPercent: number;\r\n  rollingWindowDays: number;\r\n}\r\n\r\nexport interface WasteAlert {\r\n  id: string;\r\n  entityType: EntityType;\r\n  entityId: string;\r\n  entityName: string;\r\n  organizationId: string;\r\n  platformCode: string;\r\n  reason: WasteReason;\r\n  level: WasteLevel;\r\n  spendMicros: bigint;\r\n  conversions: number;\r\n  cpa: number | null;\r\n  targetCpa: number | null;\r\n  windowStart: Date;\r\n  windowEnd: Date;\r\n  message: string;\r\n  recommendation: string;\r\n}\r\n\r\nexport interface WasteAnalysis {\r\n  organizationId: string;\r\n  windowStart: Date;\r\n  windowEnd: Date;\r\n  totalWastedSpendMicros: bigint;\r\n  alerts: WasteAlert[];\r\n  byLevel: Record<WasteLevel, number>;\r\n  byReason: Record<WasteReason, number>;\r\n  byEntityType: Record<EntityType, number>;\r\n}\r\n\r\nexport interface AggregatedMetrics {\r\n  entityId: string;\r\n  entityName: string;\r\n  entityType: EntityType;\r\n  platformCode: string;\r\n  impressions: bigint;\r\n  clicks: bigint;\r\n  spendMicros: bigint;\r\n  conversions: bigint;\r\n  revenueMicros: bigint;\r\n}\r\n\r\nexport const DEFAULT_WASTE_CONFIG: WasteConfig = {\r\n  spendThresholdMicros: BigInt(50_000_000),\r\n  targetCpaMicros: BigInt(25_000_000),\r\n  cpaTolerancePercent: 50,\r\n  minImpressions: 1000,\r\n  minCtrPercent: 0.5,\r\n  rollingWindowDays: 7,\r\n};\r\n\r\nexport function microsToDollars(micros: bigint): number {\r\n  return Number(micros) / 1_000_000;\r\n}\r\n\r\nexport function dollarsToMicros(dollars: number): bigint {\r\n  return BigInt(Math.round(dollars * 1_000_000));\r\n}\r\n\r\nexport function computeCpa(spendMicros: bigint, conversions: bigint): number | null {\r\n  if (conversions === BigInt(0)) return null;\r\n  return Number(spendMicros) / Number(conversions);\r\n}\r\n\r\nexport function computeCtr(clicks: bigint, impressions: bigint): number {\r\n  if (impressions === BigInt(0)) return 0;\r\n  return (Number(clicks) / Number(impressions)) * 100;\r\n}\r\n\r\nexport function determineWasteLevel(\r\n  spendMicros: bigint,\r\n  config: WasteConfig,\r\n  reason: WasteReason\r\n): WasteLevel {\r\n  const spendDollars = microsToDollars(spendMicros);\r\n  const thresholdDollars = microsToDollars(config.spendThresholdMicros);\r\n\r\n  if (reason === \"zero_conversions_high_spend\") {\r\n    if (spendDollars >= thresholdDollars * 5) return \"critical\";\r\n    if (spendDollars >= thresholdDollars * 2) return \"high\";\r\n    if (spendDollars >= thresholdDollars) return \"medium\";\r\n    return \"low\";\r\n  }\r\n\r\n  if (reason === \"cpa_above_target\") {\r\n    if (spendDollars >= thresholdDollars * 3) return \"high\";\r\n    if (spendDollars >= thresholdDollars) return \"medium\";\r\n    return \"low\";\r\n  }\r\n\r\n  return \"low\";\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AA+DO,MAAM,uBAAoC;IAC/C,sBAAsB,OAAO;IAC7B,iBAAiB,OAAO;IACxB,qBAAqB;IACrB,gBAAgB;IAChB,eAAe;IACf,mBAAmB;AACrB;AAEO,SAAS,gBAAgB,MAAc;IAC5C,OAAO,OAAO,UAAU;AAC1B;AAEO,SAAS,gBAAgB,OAAe;IAC7C,OAAO,OAAO,KAAK,KAAK,CAAC,UAAU;AACrC;AAEO,SAAS,WAAW,WAAmB,EAAE,WAAmB;IACjE,IAAI,gBAAgB,OAAO,IAAI,OAAO;IACtC,OAAO,OAAO,eAAe,OAAO;AACtC;AAEO,SAAS,WAAW,MAAc,EAAE,WAAmB;IAC5D,IAAI,gBAAgB,OAAO,IAAI,OAAO;IACtC,OAAO,AAAC,OAAO,UAAU,OAAO,eAAgB;AAClD;AAEO,SAAS,oBACd,WAAmB,EACnB,MAAmB,EACnB,MAAmB;IAEnB,MAAM,eAAe,gBAAgB;IACrC,MAAM,mBAAmB,gBAAgB,OAAO,oBAAoB;IAEpE,IAAI,WAAW,+BAA+B;QAC5C,IAAI,gBAAgB,mBAAmB,GAAG,OAAO;QACjD,IAAI,gBAAgB,mBAAmB,GAAG,OAAO;QACjD,IAAI,gBAAgB,kBAAkB,OAAO;QAC7C,OAAO;IACT;IAEA,IAAI,WAAW,oBAAoB;QACjC,IAAI,gBAAgB,mBAAmB,GAAG,OAAO;QACjD,IAAI,gBAAgB,kBAAkB,OAAO;QAC7C,OAAO;IACT;IAEA,OAAO;AACT"}},
    {"offset": {"line": 766, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/waste/evaluator.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport type {\r\n  WasteConfig,\r\n  WasteAlert,\r\n  WasteAnalysis,\r\n  WasteLevel,\r\n  WasteReason,\r\n  EntityType,\r\n  AggregatedMetrics,\r\n} from \"./types\";\r\nimport {\r\n  DEFAULT_WASTE_CONFIG,\r\n  microsToDollars,\r\n  computeCpa,\r\n  computeCtr,\r\n  determineWasteLevel,\r\n} from \"./types\";\r\n\r\ntype RollingWindow = {\r\n  start: Date;\r\n  end: Date;\r\n  days: number;\r\n};\r\n\r\nfunction createRollingWindow(days: number, endDate?: Date): RollingWindow {\r\n  const end = endDate ?? new Date();\r\n  end.setHours(23, 59, 59, 999);\r\n\r\n  const start = new Date(end);\r\n  start.setDate(start.getDate() - days + 1);\r\n  start.setHours(0, 0, 0, 0);\r\n\r\n  return { start, end, days };\r\n}\r\n\r\nfunction generateAlertId(\r\n  entityType: EntityType,\r\n  entityId: string,\r\n  reason: WasteReason,\r\n  windowEnd: Date\r\n): string {\r\n  const dateStr = windowEnd.toISOString().split(\"T\")[0];\r\n  return `${entityType}_${entityId}_${reason}_${dateStr}`;\r\n}\r\n\r\nfunction buildRecommendation(reason: WasteReason, metrics: AggregatedMetrics): string {\r\n  switch (reason) {\r\n    case \"zero_conversions_high_spend\":\r\n      return `Consider pausing this ${metrics.entityType.replace(\"_\", \" \")} or reviewing targeting. Spent $${microsToDollars(metrics.spendMicros).toFixed(2)} with no conversions.`;\r\n\r\n    case \"cpa_above_target\":\r\n      const cpa = computeCpa(metrics.spendMicros, metrics.conversions);\r\n      return `CPA of $${cpa?.toFixed(2) ?? \"N/A\"} exceeds target. Review ad creative, landing page, or audience targeting.`;\r\n\r\n    case \"low_ctr_high_spend\":\r\n      const ctr = computeCtr(metrics.clicks, metrics.impressions);\r\n      return `CTR of ${ctr.toFixed(2)}% is below threshold. Consider refreshing creative or adjusting targeting.`;\r\n\r\n    case \"declining_performance\":\r\n      return `Performance has declined over the analysis period. Review recent changes and consider optimization.`;\r\n\r\n    default:\r\n      return `Review this ${metrics.entityType.replace(\"_\", \" \")} for potential optimization opportunities.`;\r\n  }\r\n}\r\n\r\nexport class WasteEvaluator {\r\n  private readonly config: WasteConfig;\r\n\r\n  constructor(config: Partial<WasteConfig> = {}) {\r\n    this.config = { ...DEFAULT_WASTE_CONFIG, ...config };\r\n  }\r\n\r\n  async evaluateOrganization(params: {\r\n    organizationId: string;\r\n    windowDays?: number;\r\n    endDate?: Date;\r\n  }): Promise<WasteAnalysis> {\r\n    const window = createRollingWindow(\r\n      params.windowDays ?? this.config.rollingWindowDays,\r\n      params.endDate\r\n    );\r\n\r\n    const [accountAlerts, campaignAlerts, adAlerts] = await Promise.all([\r\n      this.evaluateAdAccounts(params.organizationId, window),\r\n      this.evaluateCampaigns(params.organizationId, window),\r\n      this.evaluateAds(params.organizationId, window),\r\n    ]);\r\n\r\n    const alerts = [...accountAlerts, ...campaignAlerts, ...adAlerts];\r\n\r\n    const totalWastedSpendMicros = alerts.reduce(\r\n      (sum, a) => sum + a.spendMicros,\r\n      BigInt(0)\r\n    );\r\n\r\n    const byLevel: Record<WasteLevel, number> = {\r\n      none: 0,\r\n      low: 0,\r\n      medium: 0,\r\n      high: 0,\r\n      critical: 0,\r\n    };\r\n\r\n    const byReason: Record<WasteReason, number> = {\r\n      zero_conversions_high_spend: 0,\r\n      cpa_above_target: 0,\r\n      low_ctr_high_spend: 0,\r\n      declining_performance: 0,\r\n    };\r\n\r\n    const byEntityType: Record<EntityType, number> = {\r\n      ad_account: 0,\r\n      campaign: 0,\r\n      ad: 0,\r\n    };\r\n\r\n    for (const alert of alerts) {\r\n      byLevel[alert.level]++;\r\n      byReason[alert.reason]++;\r\n      byEntityType[alert.entityType]++;\r\n    }\r\n\r\n    return {\r\n      organizationId: params.organizationId,\r\n      windowStart: window.start,\r\n      windowEnd: window.end,\r\n      totalWastedSpendMicros,\r\n      alerts,\r\n      byLevel,\r\n      byReason,\r\n      byEntityType,\r\n    };\r\n  }\r\n\r\n  private async evaluateAdAccounts(\r\n    organizationId: string,\r\n    window: RollingWindow\r\n  ): Promise<WasteAlert[]> {\r\n    const metrics = await prisma.dailyAdAccountMetric.groupBy({\r\n      by: [\"adAccountId\"],\r\n      where: {\r\n        organizationId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    for (const m of metrics) {\r\n      const account = await prisma.adAccount.findUnique({\r\n        where: { id: m.adAccountId },\r\n        select: { id: true, name: true, platform: { select: { code: true } } },\r\n      });\r\n\r\n      if (!account) continue;\r\n\r\n      const aggregated: AggregatedMetrics = {\r\n        entityId: m.adAccountId,\r\n        entityName: account.name,\r\n        entityType: \"ad_account\",\r\n        platformCode: account.platform.code,\r\n        impressions: m._sum.impressions ?? BigInt(0),\r\n        clicks: m._sum.clicks ?? BigInt(0),\r\n        spendMicros: m._sum.spendMicros ?? BigInt(0),\r\n        conversions: m._sum.conversions ?? BigInt(0),\r\n        revenueMicros: m._sum.revenueMicros ?? BigInt(0),\r\n      };\r\n\r\n      const accountAlerts = this.detectWaste(aggregated, window, organizationId);\r\n      alerts.push(...accountAlerts);\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private async evaluateCampaigns(\r\n    organizationId: string,\r\n    window: RollingWindow\r\n  ): Promise<WasteAlert[]> {\r\n    const metrics = await prisma.dailyCampaignMetric.groupBy({\r\n      by: [\"campaignId\"],\r\n      where: {\r\n        organizationId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    for (const m of metrics) {\r\n      const campaign = await prisma.campaign.findUnique({\r\n        where: { id: m.campaignId },\r\n        select: { id: true, name: true, platform: { select: { code: true } } },\r\n      });\r\n\r\n      if (!campaign) continue;\r\n\r\n      const aggregated: AggregatedMetrics = {\r\n        entityId: m.campaignId,\r\n        entityName: campaign.name,\r\n        entityType: \"campaign\",\r\n        platformCode: campaign.platform.code,\r\n        impressions: m._sum.impressions ?? BigInt(0),\r\n        clicks: m._sum.clicks ?? BigInt(0),\r\n        spendMicros: m._sum.spendMicros ?? BigInt(0),\r\n        conversions: m._sum.conversions ?? BigInt(0),\r\n        revenueMicros: m._sum.revenueMicros ?? BigInt(0),\r\n      };\r\n\r\n      const campaignAlerts = this.detectWaste(aggregated, window, organizationId);\r\n      alerts.push(...campaignAlerts);\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private async evaluateAds(\r\n    organizationId: string,\r\n    window: RollingWindow\r\n  ): Promise<WasteAlert[]> {\r\n    const metrics = await prisma.dailyAdMetric.groupBy({\r\n      by: [\"adId\"],\r\n      where: {\r\n        organizationId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    for (const m of metrics) {\r\n      const ad = await prisma.ad.findUnique({\r\n        where: { id: m.adId },\r\n        select: { id: true, name: true, platform: { select: { code: true } } },\r\n      });\r\n\r\n      if (!ad) continue;\r\n\r\n      const aggregated: AggregatedMetrics = {\r\n        entityId: m.adId,\r\n        entityName: ad.name ?? `Ad ${m.adId}`,\r\n        entityType: \"ad\",\r\n        platformCode: ad.platform.code,\r\n        impressions: m._sum.impressions ?? BigInt(0),\r\n        clicks: m._sum.clicks ?? BigInt(0),\r\n        spendMicros: m._sum.spendMicros ?? BigInt(0),\r\n        conversions: m._sum.conversions ?? BigInt(0),\r\n        revenueMicros: m._sum.revenueMicros ?? BigInt(0),\r\n      };\r\n\r\n      const adAlerts = this.detectWaste(aggregated, window, organizationId);\r\n      alerts.push(...adAlerts);\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  private detectWaste(\r\n    metrics: AggregatedMetrics,\r\n    window: RollingWindow,\r\n    organizationId: string\r\n  ): WasteAlert[] {\r\n    const alerts: WasteAlert[] = [];\r\n\r\n    if (\r\n      metrics.spendMicros >= this.config.spendThresholdMicros &&\r\n      metrics.conversions === BigInt(0)\r\n    ) {\r\n      const reason: WasteReason = \"zero_conversions_high_spend\";\r\n      const level = determineWasteLevel(metrics.spendMicros, this.config, reason);\r\n\r\n      alerts.push({\r\n        id: generateAlertId(metrics.entityType, metrics.entityId, reason, window.end),\r\n        entityType: metrics.entityType,\r\n        entityId: metrics.entityId,\r\n        entityName: metrics.entityName,\r\n        organizationId,\r\n        platformCode: metrics.platformCode,\r\n        reason,\r\n        level,\r\n        spendMicros: metrics.spendMicros,\r\n        conversions: 0,\r\n        cpa: null,\r\n        targetCpa: microsToDollars(this.config.targetCpaMicros),\r\n        windowStart: window.start,\r\n        windowEnd: window.end,\r\n        message: `${metrics.entityName} spent $${microsToDollars(metrics.spendMicros).toFixed(2)} with zero conversions in the last ${window.days} days.`,\r\n        recommendation: buildRecommendation(reason, metrics),\r\n      });\r\n    }\r\n\r\n    if (metrics.conversions > BigInt(0)) {\r\n      const cpa = computeCpa(metrics.spendMicros, metrics.conversions);\r\n      const targetCpa = microsToDollars(this.config.targetCpaMicros);\r\n      const cpaThreshold = targetCpa * (1 + this.config.cpaTolerancePercent / 100);\r\n\r\n      if (cpa !== null && cpa > cpaThreshold * 1_000_000) {\r\n        const reason: WasteReason = \"cpa_above_target\";\r\n        const level = determineWasteLevel(metrics.spendMicros, this.config, reason);\r\n\r\n        const wastedSpend =\r\n          metrics.spendMicros - BigInt(Math.round(targetCpa * 1_000_000 * Number(metrics.conversions)));\r\n\r\n        alerts.push({\r\n          id: generateAlertId(metrics.entityType, metrics.entityId, reason, window.end),\r\n          entityType: metrics.entityType,\r\n          entityId: metrics.entityId,\r\n          entityName: metrics.entityName,\r\n          organizationId,\r\n          platformCode: metrics.platformCode,\r\n          reason,\r\n          level,\r\n          spendMicros: wastedSpend > BigInt(0) ? wastedSpend : metrics.spendMicros,\r\n          conversions: Number(metrics.conversions),\r\n          cpa: cpa / 1_000_000,\r\n          targetCpa,\r\n          windowStart: window.start,\r\n          windowEnd: window.end,\r\n          message: `${metrics.entityName} has CPA of $${(cpa / 1_000_000).toFixed(2)} vs target of $${targetCpa.toFixed(2)} (${((cpa / 1_000_000 / targetCpa - 1) * 100).toFixed(0)}% over).`,\r\n          recommendation: buildRecommendation(reason, metrics),\r\n        });\r\n      }\r\n    }\r\n\r\n    return alerts;\r\n  }\r\n\r\n  async evaluateCampaign(params: {\r\n    organizationId: string;\r\n    campaignId: string;\r\n    windowDays?: number;\r\n    endDate?: Date;\r\n  }): Promise<WasteAlert[]> {\r\n    const window = createRollingWindow(\r\n      params.windowDays ?? this.config.rollingWindowDays,\r\n      params.endDate\r\n    );\r\n\r\n    const metrics = await prisma.dailyCampaignMetric.aggregate({\r\n      where: {\r\n        organizationId: params.organizationId,\r\n        campaignId: params.campaignId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const campaign = await prisma.campaign.findUnique({\r\n      where: { id: params.campaignId },\r\n      select: { id: true, name: true, platform: { select: { code: true } } },\r\n    });\r\n\r\n    if (!campaign) return [];\r\n\r\n    const aggregated: AggregatedMetrics = {\r\n      entityId: params.campaignId,\r\n      entityName: campaign.name,\r\n      entityType: \"campaign\",\r\n      platformCode: campaign.platform.code,\r\n      impressions: metrics._sum.impressions ?? BigInt(0),\r\n      clicks: metrics._sum.clicks ?? BigInt(0),\r\n      spendMicros: metrics._sum.spendMicros ?? BigInt(0),\r\n      conversions: metrics._sum.conversions ?? BigInt(0),\r\n      revenueMicros: metrics._sum.revenueMicros ?? BigInt(0),\r\n    };\r\n\r\n    return this.detectWaste(aggregated, window, params.organizationId);\r\n  }\r\n\r\n  async evaluateAd(params: {\r\n    organizationId: string;\r\n    adId: string;\r\n    windowDays?: number;\r\n    endDate?: Date;\r\n  }): Promise<WasteAlert[]> {\r\n    const window = createRollingWindow(\r\n      params.windowDays ?? this.config.rollingWindowDays,\r\n      params.endDate\r\n    );\r\n\r\n    const metrics = await prisma.dailyAdMetric.aggregate({\r\n      where: {\r\n        organizationId: params.organizationId,\r\n        adId: params.adId,\r\n        date: { gte: window.start, lte: window.end },\r\n      },\r\n      _sum: {\r\n        impressions: true,\r\n        clicks: true,\r\n        spendMicros: true,\r\n        conversions: true,\r\n        revenueMicros: true,\r\n      },\r\n    });\r\n\r\n    const ad = await prisma.ad.findUnique({\r\n      where: { id: params.adId },\r\n      select: { id: true, name: true, platform: { select: { code: true } } },\r\n    });\r\n\r\n    if (!ad) return [];\r\n\r\n    const aggregated: AggregatedMetrics = {\r\n      entityId: params.adId,\r\n      entityName: ad.name ?? `Ad ${params.adId}`,\r\n      entityType: \"ad\",\r\n      platformCode: ad.platform.code,\r\n      impressions: metrics._sum.impressions ?? BigInt(0),\r\n      clicks: metrics._sum.clicks ?? BigInt(0),\r\n      spendMicros: metrics._sum.spendMicros ?? BigInt(0),\r\n      conversions: metrics._sum.conversions ?? BigInt(0),\r\n      revenueMicros: metrics._sum.revenueMicros ?? BigInt(0),\r\n    };\r\n\r\n    return this.detectWaste(aggregated, window, params.organizationId);\r\n  }\r\n\r\n  getConfig(): WasteConfig {\r\n    return { ...this.config };\r\n  }\r\n\r\n  withConfig(config: Partial<WasteConfig>): WasteEvaluator {\r\n    return new WasteEvaluator({ ...this.config, ...config });\r\n  }\r\n}\r\n\r\nexport const wasteEvaluator = new WasteEvaluator();\r\n"],"names":[],"mappings":";;;;;;AAAA;AAEA;AAUA;;;;AAcA,SAAS,oBAAoB,IAAY,EAAE,OAAc;IACvD,MAAM,MAAM,WAAW,IAAI;IAC3B,IAAI,QAAQ,CAAC,IAAI,IAAI,IAAI;IAEzB,MAAM,QAAQ,IAAI,KAAK;IACvB,MAAM,OAAO,CAAC,MAAM,OAAO,KAAK,OAAO;IACvC,MAAM,QAAQ,CAAC,GAAG,GAAG,GAAG;IAExB,OAAO;QAAE;QAAO;QAAK;IAAK;AAC5B;AAEA,SAAS,gBACP,UAAsB,EACtB,QAAgB,EAChB,MAAmB,EACnB,SAAe;IAEf,MAAM,UAAU,UAAU,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;IACrD,OAAO,GAAG,WAAW,CAAC,EAAE,SAAS,CAAC,EAAE,OAAO,CAAC,EAAE,SAAS;AACzD;AAEA,SAAS,oBAAoB,MAAmB,EAAE,OAA0B;IAC1E,OAAQ;QACN,KAAK;YACH,OAAO,CAAC,sBAAsB,EAAE,QAAQ,UAAU,CAAC,OAAO,CAAC,KAAK,KAAK,gCAAgC,EAAE,IAAA,6OAAe,EAAC,QAAQ,WAAW,EAAE,OAAO,CAAC,GAAG,qBAAqB,CAAC;QAE/K,KAAK;YACH,MAAM,MAAM,IAAA,wOAAU,EAAC,QAAQ,WAAW,EAAE,QAAQ,WAAW;YAC/D,OAAO,CAAC,QAAQ,EAAE,KAAK,QAAQ,MAAM,MAAM,yEAAyE,CAAC;QAEvH,KAAK;YACH,MAAM,MAAM,IAAA,wOAAU,EAAC,QAAQ,MAAM,EAAE,QAAQ,WAAW;YAC1D,OAAO,CAAC,OAAO,EAAE,IAAI,OAAO,CAAC,GAAG,0EAA0E,CAAC;QAE7G,KAAK;YACH,OAAO,CAAC,mGAAmG,CAAC;QAE9G;YACE,OAAO,CAAC,YAAY,EAAE,QAAQ,UAAU,CAAC,OAAO,CAAC,KAAK,KAAK,0CAA0C,CAAC;IAC1G;AACF;AAEO,MAAM;IACM,OAAoB;IAErC,YAAY,SAA+B,CAAC,CAAC,CAAE;QAC7C,IAAI,CAAC,MAAM,GAAG;YAAE,GAAG,kPAAoB;YAAE,GAAG,MAAM;QAAC;IACrD;IAEA,MAAM,qBAAqB,MAI1B,EAA0B;QACzB,MAAM,SAAS,oBACb,OAAO,UAAU,IAAI,IAAI,CAAC,MAAM,CAAC,iBAAiB,EAClD,OAAO,OAAO;QAGhB,MAAM,CAAC,eAAe,gBAAgB,SAAS,GAAG,MAAM,QAAQ,GAAG,CAAC;YAClE,IAAI,CAAC,kBAAkB,CAAC,OAAO,cAAc,EAAE;YAC/C,IAAI,CAAC,iBAAiB,CAAC,OAAO,cAAc,EAAE;YAC9C,IAAI,CAAC,WAAW,CAAC,OAAO,cAAc,EAAE;SACzC;QAED,MAAM,SAAS;eAAI;eAAkB;eAAmB;SAAS;QAEjE,MAAM,yBAAyB,OAAO,MAAM,CAC1C,CAAC,KAAK,IAAM,MAAM,EAAE,WAAW,EAC/B,OAAO;QAGT,MAAM,UAAsC;YAC1C,MAAM;YACN,KAAK;YACL,QAAQ;YACR,MAAM;YACN,UAAU;QACZ;QAEA,MAAM,WAAwC;YAC5C,6BAA6B;YAC7B,kBAAkB;YAClB,oBAAoB;YACpB,uBAAuB;QACzB;QAEA,MAAM,eAA2C;YAC/C,YAAY;YACZ,UAAU;YACV,IAAI;QACN;QAEA,KAAK,MAAM,SAAS,OAAQ;YAC1B,OAAO,CAAC,MAAM,KAAK,CAAC;YACpB,QAAQ,CAAC,MAAM,MAAM,CAAC;YACtB,YAAY,CAAC,MAAM,UAAU,CAAC;QAChC;QAEA,OAAO;YACL,gBAAgB,OAAO,cAAc;YACrC,aAAa,OAAO,KAAK;YACzB,WAAW,OAAO,GAAG;YACrB;YACA;YACA;YACA;YACA;QACF;IACF;IAEA,MAAc,mBACZ,cAAsB,EACtB,MAAqB,EACE;QACvB,MAAM,UAAU,MAAM,4NAAM,CAAC,oBAAoB,CAAC,OAAO,CAAC;YACxD,IAAI;gBAAC;aAAc;YACnB,OAAO;gBACL;gBACA,MAAM;oBAAE,KAAK,OAAO,KAAK;oBAAE,KAAK,OAAO,GAAG;gBAAC;YAC7C;YACA,MAAM;gBACJ,aAAa;gBACb,QAAQ;gBACR,aAAa;gBACb,aAAa;gBACb,eAAe;YACjB;QACF;QAEA,MAAM,SAAuB,EAAE;QAE/B,KAAK,MAAM,KAAK,QAAS;YACvB,MAAM,UAAU,MAAM,4NAAM,CAAC,SAAS,CAAC,UAAU,CAAC;gBAChD,OAAO;oBAAE,IAAI,EAAE,WAAW;gBAAC;gBAC3B,QAAQ;oBAAE,IAAI;oBAAM,MAAM;oBAAM,UAAU;wBAAE,QAAQ;4BAAE,MAAM;wBAAK;oBAAE;gBAAE;YACvE;YAEA,IAAI,CAAC,SAAS;YAEd,MAAM,aAAgC;gBACpC,UAAU,EAAE,WAAW;gBACvB,YAAY,QAAQ,IAAI;gBACxB,YAAY;gBACZ,cAAc,QAAQ,QAAQ,CAAC,IAAI;gBACnC,aAAa,EAAE,IAAI,CAAC,WAAW,IAAI,OAAO;gBAC1C,QAAQ,EAAE,IAAI,CAAC,MAAM,IAAI,OAAO;gBAChC,aAAa,EAAE,IAAI,CAAC,WAAW,IAAI,OAAO;gBAC1C,aAAa,EAAE,IAAI,CAAC,WAAW,IAAI,OAAO;gBAC1C,eAAe,EAAE,IAAI,CAAC,aAAa,IAAI,OAAO;YAChD;YAEA,MAAM,gBAAgB,IAAI,CAAC,WAAW,CAAC,YAAY,QAAQ;YAC3D,OAAO,IAAI,IAAI;QACjB;QAEA,OAAO;IACT;IAEA,MAAc,kBACZ,cAAsB,EACtB,MAAqB,EACE;QACvB,MAAM,UAAU,MAAM,4NAAM,CAAC,mBAAmB,CAAC,OAAO,CAAC;YACvD,IAAI;gBAAC;aAAa;YAClB,OAAO;gBACL;gBACA,MAAM;oBAAE,KAAK,OAAO,KAAK;oBAAE,KAAK,OAAO,GAAG;gBAAC;YAC7C;YACA,MAAM;gBACJ,aAAa;gBACb,QAAQ;gBACR,aAAa;gBACb,aAAa;gBACb,eAAe;YACjB;QACF;QAEA,MAAM,SAAuB,EAAE;QAE/B,KAAK,MAAM,KAAK,QAAS;YACvB,MAAM,WAAW,MAAM,4NAAM,CAAC,QAAQ,CAAC,UAAU,CAAC;gBAChD,OAAO;oBAAE,IAAI,EAAE,UAAU;gBAAC;gBAC1B,QAAQ;oBAAE,IAAI;oBAAM,MAAM;oBAAM,UAAU;wBAAE,QAAQ;4BAAE,MAAM;wBAAK;oBAAE;gBAAE;YACvE;YAEA,IAAI,CAAC,UAAU;YAEf,MAAM,aAAgC;gBACpC,UAAU,EAAE,UAAU;gBACtB,YAAY,SAAS,IAAI;gBACzB,YAAY;gBACZ,cAAc,SAAS,QAAQ,CAAC,IAAI;gBACpC,aAAa,EAAE,IAAI,CAAC,WAAW,IAAI,OAAO;gBAC1C,QAAQ,EAAE,IAAI,CAAC,MAAM,IAAI,OAAO;gBAChC,aAAa,EAAE,IAAI,CAAC,WAAW,IAAI,OAAO;gBAC1C,aAAa,EAAE,IAAI,CAAC,WAAW,IAAI,OAAO;gBAC1C,eAAe,EAAE,IAAI,CAAC,aAAa,IAAI,OAAO;YAChD;YAEA,MAAM,iBAAiB,IAAI,CAAC,WAAW,CAAC,YAAY,QAAQ;YAC5D,OAAO,IAAI,IAAI;QACjB;QAEA,OAAO;IACT;IAEA,MAAc,YACZ,cAAsB,EACtB,MAAqB,EACE;QACvB,MAAM,UAAU,MAAM,4NAAM,CAAC,aAAa,CAAC,OAAO,CAAC;YACjD,IAAI;gBAAC;aAAO;YACZ,OAAO;gBACL;gBACA,MAAM;oBAAE,KAAK,OAAO,KAAK;oBAAE,KAAK,OAAO,GAAG;gBAAC;YAC7C;YACA,MAAM;gBACJ,aAAa;gBACb,QAAQ;gBACR,aAAa;gBACb,aAAa;gBACb,eAAe;YACjB;QACF;QAEA,MAAM,SAAuB,EAAE;QAE/B,KAAK,MAAM,KAAK,QAAS;YACvB,MAAM,KAAK,MAAM,4NAAM,CAAC,EAAE,CAAC,UAAU,CAAC;gBACpC,OAAO;oBAAE,IAAI,EAAE,IAAI;gBAAC;gBACpB,QAAQ;oBAAE,IAAI;oBAAM,MAAM;oBAAM,UAAU;wBAAE,QAAQ;4BAAE,MAAM;wBAAK;oBAAE;gBAAE;YACvE;YAEA,IAAI,CAAC,IAAI;YAET,MAAM,aAAgC;gBACpC,UAAU,EAAE,IAAI;gBAChB,YAAY,GAAG,IAAI,IAAI,CAAC,GAAG,EAAE,EAAE,IAAI,EAAE;gBACrC,YAAY;gBACZ,cAAc,GAAG,QAAQ,CAAC,IAAI;gBAC9B,aAAa,EAAE,IAAI,CAAC,WAAW,IAAI,OAAO;gBAC1C,QAAQ,EAAE,IAAI,CAAC,MAAM,IAAI,OAAO;gBAChC,aAAa,EAAE,IAAI,CAAC,WAAW,IAAI,OAAO;gBAC1C,aAAa,EAAE,IAAI,CAAC,WAAW,IAAI,OAAO;gBAC1C,eAAe,EAAE,IAAI,CAAC,aAAa,IAAI,OAAO;YAChD;YAEA,MAAM,WAAW,IAAI,CAAC,WAAW,CAAC,YAAY,QAAQ;YACtD,OAAO,IAAI,IAAI;QACjB;QAEA,OAAO;IACT;IAEQ,YACN,OAA0B,EAC1B,MAAqB,EACrB,cAAsB,EACR;QACd,MAAM,SAAuB,EAAE;QAE/B,IACE,QAAQ,WAAW,IAAI,IAAI,CAAC,MAAM,CAAC,oBAAoB,IACvD,QAAQ,WAAW,KAAK,OAAO,IAC/B;YACA,MAAM,SAAsB;YAC5B,MAAM,QAAQ,IAAA,iPAAmB,EAAC,QAAQ,WAAW,EAAE,IAAI,CAAC,MAAM,EAAE;YAEpE,OAAO,IAAI,CAAC;gBACV,IAAI,gBAAgB,QAAQ,UAAU,EAAE,QAAQ,QAAQ,EAAE,QAAQ,OAAO,GAAG;gBAC5E,YAAY,QAAQ,UAAU;gBAC9B,UAAU,QAAQ,QAAQ;gBAC1B,YAAY,QAAQ,UAAU;gBAC9B;gBACA,cAAc,QAAQ,YAAY;gBAClC;gBACA;gBACA,aAAa,QAAQ,WAAW;gBAChC,aAAa;gBACb,KAAK;gBACL,WAAW,IAAA,6OAAe,EAAC,IAAI,CAAC,MAAM,CAAC,eAAe;gBACtD,aAAa,OAAO,KAAK;gBACzB,WAAW,OAAO,GAAG;gBACrB,SAAS,GAAG,QAAQ,UAAU,CAAC,QAAQ,EAAE,IAAA,6OAAe,EAAC,QAAQ,WAAW,EAAE,OAAO,CAAC,GAAG,mCAAmC,EAAE,OAAO,IAAI,CAAC,MAAM,CAAC;gBACjJ,gBAAgB,oBAAoB,QAAQ;YAC9C;QACF;QAEA,IAAI,QAAQ,WAAW,GAAG,OAAO,IAAI;YACnC,MAAM,MAAM,IAAA,wOAAU,EAAC,QAAQ,WAAW,EAAE,QAAQ,WAAW;YAC/D,MAAM,YAAY,IAAA,6OAAe,EAAC,IAAI,CAAC,MAAM,CAAC,eAAe;YAC7D,MAAM,eAAe,YAAY,CAAC,IAAI,IAAI,CAAC,MAAM,CAAC,mBAAmB,GAAG,GAAG;YAE3E,IAAI,QAAQ,QAAQ,MAAM,eAAe,WAAW;gBAClD,MAAM,SAAsB;gBAC5B,MAAM,QAAQ,IAAA,iPAAmB,EAAC,QAAQ,WAAW,EAAE,IAAI,CAAC,MAAM,EAAE;gBAEpE,MAAM,cACJ,QAAQ,WAAW,GAAG,OAAO,KAAK,KAAK,CAAC,YAAY,YAAY,OAAO,QAAQ,WAAW;gBAE5F,OAAO,IAAI,CAAC;oBACV,IAAI,gBAAgB,QAAQ,UAAU,EAAE,QAAQ,QAAQ,EAAE,QAAQ,OAAO,GAAG;oBAC5E,YAAY,QAAQ,UAAU;oBAC9B,UAAU,QAAQ,QAAQ;oBAC1B,YAAY,QAAQ,UAAU;oBAC9B;oBACA,cAAc,QAAQ,YAAY;oBAClC;oBACA;oBACA,aAAa,cAAc,OAAO,KAAK,cAAc,QAAQ,WAAW;oBACxE,aAAa,OAAO,QAAQ,WAAW;oBACvC,KAAK,MAAM;oBACX;oBACA,aAAa,OAAO,KAAK;oBACzB,WAAW,OAAO,GAAG;oBACrB,SAAS,GAAG,QAAQ,UAAU,CAAC,aAAa,EAAE,CAAC,MAAM,SAAS,EAAE,OAAO,CAAC,GAAG,eAAe,EAAE,UAAU,OAAO,CAAC,GAAG,EAAE,EAAE,CAAC,CAAC,MAAM,YAAY,YAAY,CAAC,IAAI,GAAG,EAAE,OAAO,CAAC,GAAG,QAAQ,CAAC;oBACnL,gBAAgB,oBAAoB,QAAQ;gBAC9C;YACF;QACF;QAEA,OAAO;IACT;IAEA,MAAM,iBAAiB,MAKtB,EAAyB;QACxB,MAAM,SAAS,oBACb,OAAO,UAAU,IAAI,IAAI,CAAC,MAAM,CAAC,iBAAiB,EAClD,OAAO,OAAO;QAGhB,MAAM,UAAU,MAAM,4NAAM,CAAC,mBAAmB,CAAC,SAAS,CAAC;YACzD,OAAO;gBACL,gBAAgB,OAAO,cAAc;gBACrC,YAAY,OAAO,UAAU;gBAC7B,MAAM;oBAAE,KAAK,OAAO,KAAK;oBAAE,KAAK,OAAO,GAAG;gBAAC;YAC7C;YACA,MAAM;gBACJ,aAAa;gBACb,QAAQ;gBACR,aAAa;gBACb,aAAa;gBACb,eAAe;YACjB;QACF;QAEA,MAAM,WAAW,MAAM,4NAAM,CAAC,QAAQ,CAAC,UAAU,CAAC;YAChD,OAAO;gBAAE,IAAI,OAAO,UAAU;YAAC;YAC/B,QAAQ;gBAAE,IAAI;gBAAM,MAAM;gBAAM,UAAU;oBAAE,QAAQ;wBAAE,MAAM;oBAAK;gBAAE;YAAE;QACvE;QAEA,IAAI,CAAC,UAAU,OAAO,EAAE;QAExB,MAAM,aAAgC;YACpC,UAAU,OAAO,UAAU;YAC3B,YAAY,SAAS,IAAI;YACzB,YAAY;YACZ,cAAc,SAAS,QAAQ,CAAC,IAAI;YACpC,aAAa,QAAQ,IAAI,CAAC,WAAW,IAAI,OAAO;YAChD,QAAQ,QAAQ,IAAI,CAAC,MAAM,IAAI,OAAO;YACtC,aAAa,QAAQ,IAAI,CAAC,WAAW,IAAI,OAAO;YAChD,aAAa,QAAQ,IAAI,CAAC,WAAW,IAAI,OAAO;YAChD,eAAe,QAAQ,IAAI,CAAC,aAAa,IAAI,OAAO;QACtD;QAEA,OAAO,IAAI,CAAC,WAAW,CAAC,YAAY,QAAQ,OAAO,cAAc;IACnE;IAEA,MAAM,WAAW,MAKhB,EAAyB;QACxB,MAAM,SAAS,oBACb,OAAO,UAAU,IAAI,IAAI,CAAC,MAAM,CAAC,iBAAiB,EAClD,OAAO,OAAO;QAGhB,MAAM,UAAU,MAAM,4NAAM,CAAC,aAAa,CAAC,SAAS,CAAC;YACnD,OAAO;gBACL,gBAAgB,OAAO,cAAc;gBACrC,MAAM,OAAO,IAAI;gBACjB,MAAM;oBAAE,KAAK,OAAO,KAAK;oBAAE,KAAK,OAAO,GAAG;gBAAC;YAC7C;YACA,MAAM;gBACJ,aAAa;gBACb,QAAQ;gBACR,aAAa;gBACb,aAAa;gBACb,eAAe;YACjB;QACF;QAEA,MAAM,KAAK,MAAM,4NAAM,CAAC,EAAE,CAAC,UAAU,CAAC;YACpC,OAAO;gBAAE,IAAI,OAAO,IAAI;YAAC;YACzB,QAAQ;gBAAE,IAAI;gBAAM,MAAM;gBAAM,UAAU;oBAAE,QAAQ;wBAAE,MAAM;oBAAK;gBAAE;YAAE;QACvE;QAEA,IAAI,CAAC,IAAI,OAAO,EAAE;QAElB,MAAM,aAAgC;YACpC,UAAU,OAAO,IAAI;YACrB,YAAY,GAAG,IAAI,IAAI,CAAC,GAAG,EAAE,OAAO,IAAI,EAAE;YAC1C,YAAY;YACZ,cAAc,GAAG,QAAQ,CAAC,IAAI;YAC9B,aAAa,QAAQ,IAAI,CAAC,WAAW,IAAI,OAAO;YAChD,QAAQ,QAAQ,IAAI,CAAC,MAAM,IAAI,OAAO;YACtC,aAAa,QAAQ,IAAI,CAAC,WAAW,IAAI,OAAO;YAChD,aAAa,QAAQ,IAAI,CAAC,WAAW,IAAI,OAAO;YAChD,eAAe,QAAQ,IAAI,CAAC,aAAa,IAAI,OAAO;QACtD;QAEA,OAAO,IAAI,CAAC,WAAW,CAAC,YAAY,QAAQ,OAAO,cAAc;IACnE;IAEA,YAAyB;QACvB,OAAO;YAAE,GAAG,IAAI,CAAC,MAAM;QAAC;IAC1B;IAEA,WAAW,MAA4B,EAAkB;QACvD,OAAO,IAAI,eAAe;YAAE,GAAG,IAAI,CAAC,MAAM;YAAE,GAAG,MAAM;QAAC;IACxD;AACF;AAEO,MAAM,iBAAiB,IAAI"}},
    {"offset": {"line": 1189, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/waste/index.ts"],"sourcesContent":["export { WasteEvaluator, wasteEvaluator } from \"./evaluator\";\r\n\r\nexport {\r\n  DEFAULT_WASTE_CONFIG,\r\n  microsToDollars,\r\n  dollarsToMicros,\r\n  computeCpa,\r\n  computeCtr,\r\n  determineWasteLevel,\r\n} from \"./types\";\r\n\r\nexport type {\r\n  WasteConfig,\r\n  WasteAlert,\r\n  WasteAnalysis,\r\n  WasteLevel,\r\n  WasteReason,\r\n  EntityType,\r\n  AggregatedMetrics,\r\n} from \"./types\";\r\n"],"names":[],"mappings":";AAAA;AAEA"}},
    {"offset": {"line": 1198, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/dashboard/queries.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\nimport { metricsAggregator } from \"@/lib/metrics\";\r\nimport { wasteEvaluator } from \"@/lib/waste\";\r\nimport type { MetricsSummary } from \"@/lib/metrics\";\r\n\r\nconst MICROS_PER_UNIT = 1_000_000;\r\n\r\nexport interface DashboardKpis {\r\n  totalSpend: number;\r\n  totalConversions: number;\r\n  overallCpa: number | null;\r\n  wastedSpendPercent: number;\r\n  roas: number | null;\r\n  previousPeriod: {\r\n    totalSpend: number;\r\n    totalConversions: number;\r\n    overallCpa: number | null;\r\n    wastedSpendPercent: number;\r\n  } | null;\r\n  changes: {\r\n    spend: number;\r\n    conversions: number;\r\n    cpa: number | null;\r\n    wastedSpendPercent: number;\r\n  } | null;\r\n}\r\n\r\n/**\r\n * Get dashboard KPIs from daily_rollups (fast path)\r\n * Falls back to metrics aggregator if no rollups exist\r\n */\r\nexport async function getDashboardKpis(params: {\r\n  organizationId: string;\r\n  days?: number;\r\n}): Promise<DashboardKpis> {\r\n  const days = params.days ?? 30;\r\n  const endDate = new Date();\r\n  endDate.setHours(23, 59, 59, 999);\r\n\r\n  const startDate = new Date(endDate);\r\n  startDate.setDate(startDate.getDate() - days + 1);\r\n  startDate.setHours(0, 0, 0, 0);\r\n\r\n  // Try to get data from daily_rollups first (fast path)\r\n  const rollupKpis = await getDashboardKpisFromRollups(params.organizationId, startDate, endDate, days);\r\n  if (rollupKpis) {\r\n    return rollupKpis;\r\n  }\r\n\r\n  // Fall back to metrics aggregator (slower but works without rollups)\r\n  return getDashboardKpisFromMetrics(params.organizationId, startDate, endDate, days);\r\n}\r\n\r\n/**\r\n * Get KPIs from pre-aggregated daily_rollups\r\n */\r\nasync function getDashboardKpisFromRollups(\r\n  organizationId: string,\r\n  startDate: Date,\r\n  endDate: Date,\r\n  days: number\r\n): Promise<DashboardKpis | null> {\r\n  // Get current period rollups at organization level\r\n  const currentRollups = await prisma.dailyRollup.findMany({\r\n    where: {\r\n      organizationId,\r\n      grain: \"ORGANIZATION\",\r\n      date: { gte: startDate, lte: endDate },\r\n    },\r\n  });\r\n\r\n  if (currentRollups.length === 0) {\r\n    return null; // No rollups, fall back to metrics\r\n  }\r\n\r\n  // Aggregate current period\r\n  const current = aggregateRollups(currentRollups);\r\n\r\n  // Get previous period for comparison\r\n  const prevEndDate = new Date(startDate);\r\n  prevEndDate.setDate(prevEndDate.getDate() - 1);\r\n  const prevStartDate = new Date(prevEndDate);\r\n  prevStartDate.setDate(prevStartDate.getDate() - days + 1);\r\n\r\n  const previousRollups = await prisma.dailyRollup.findMany({\r\n    where: {\r\n      organizationId,\r\n      grain: \"ORGANIZATION\",\r\n      date: { gte: prevStartDate, lte: prevEndDate },\r\n    },\r\n  });\r\n\r\n  const previous = previousRollups.length > 0 ? aggregateRollups(previousRollups) : null;\r\n\r\n  // Calculate changes\r\n  const changes = previous ? {\r\n    spend: current.spend > 0 && previous.spend > 0 \r\n      ? ((current.spend - previous.spend) / previous.spend) * 100 \r\n      : 0,\r\n    conversions: current.conversions > 0 && previous.conversions > 0\r\n      ? ((current.conversions - previous.conversions) / previous.conversions) * 100\r\n      : 0,\r\n    cpa: current.cpa !== null && previous.cpa !== null && previous.cpa > 0\r\n      ? ((current.cpa - previous.cpa) / previous.cpa) * 100\r\n      : null,\r\n    wastedSpendPercent: current.wastedSpendPercent - previous.wastedSpendPercent,\r\n  } : null;\r\n\r\n  return {\r\n    totalSpend: current.spend,\r\n    totalConversions: current.conversions,\r\n    overallCpa: current.cpa,\r\n    wastedSpendPercent: current.wastedSpendPercent,\r\n    roas: current.roas,\r\n    previousPeriod: previous ? {\r\n      totalSpend: previous.spend,\r\n      totalConversions: previous.conversions,\r\n      overallCpa: previous.cpa,\r\n      wastedSpendPercent: previous.wastedSpendPercent,\r\n    } : null,\r\n    changes,\r\n  };\r\n}\r\n\r\n/**\r\n * Aggregate rollup records into summary metrics\r\n */\r\nfunction aggregateRollups(rollups: Array<{\r\n  spendMicros: bigint;\r\n  conversions: number;\r\n  conversionValue: bigint;\r\n  wasteSpendMicros: bigint;\r\n  cpa: number | null;\r\n  roas: number | null;\r\n}>): {\r\n  spend: number;\r\n  conversions: number;\r\n  revenue: number;\r\n  cpa: number | null;\r\n  roas: number | null;\r\n  wastedSpendPercent: number;\r\n} {\r\n  const totalSpendMicros = rollups.reduce((sum, r) => sum + Number(r.spendMicros), 0);\r\n  const totalConversions = rollups.reduce((sum, r) => sum + r.conversions, 0);\r\n  const totalRevenueMicros = rollups.reduce((sum, r) => sum + Number(r.conversionValue), 0);\r\n  const totalWasteMicros = rollups.reduce((sum, r) => sum + Number(r.wasteSpendMicros), 0);\r\n\r\n  const spend = totalSpendMicros / MICROS_PER_UNIT;\r\n  const revenue = totalRevenueMicros / MICROS_PER_UNIT;\r\n  const cpa = totalConversions > 0 ? spend / totalConversions : null;\r\n  const roas = spend > 0 ? revenue / spend : null;\r\n  const wastedSpendPercent = spend > 0 ? (totalWasteMicros / MICROS_PER_UNIT / spend) * 100 : 0;\r\n\r\n  return { spend, conversions: totalConversions, revenue, cpa, roas, wastedSpendPercent };\r\n}\r\n\r\n/**\r\n * Get KPIs from metrics aggregator (fallback)\r\n */\r\nasync function getDashboardKpisFromMetrics(\r\n  organizationId: string,\r\n  startDate: Date,\r\n  endDate: Date,\r\n  days: number\r\n): Promise<DashboardKpis> {\r\n  const summary = await metricsAggregator.getSummary({\r\n    filter: {\r\n      organizationId,\r\n      dateRange: { start: startDate, end: endDate },\r\n    },\r\n    entityLevel: \"organization\",\r\n    comparePrevious: true,\r\n  });\r\n\r\n  const wasteAnalysis = await wasteEvaluator.evaluateOrganization({\r\n    organizationId,\r\n    windowDays: days,\r\n    endDate,\r\n  });\r\n\r\n  const totalWastedSpend = wasteAnalysis.alerts.reduce(\r\n    (sum, a) => sum + Number(a.spendMicros) / MICROS_PER_UNIT,\r\n    0\r\n  );\r\n\r\n  const wastedSpendPercent =\r\n    summary.current.spend > 0\r\n      ? (totalWastedSpend / summary.current.spend) * 100\r\n      : 0;\r\n\r\n  let previousWastedPercent = 0;\r\n  if (summary.previous && summary.previous.spend > 0) {\r\n    const prevEndDate = new Date(startDate);\r\n    prevEndDate.setDate(prevEndDate.getDate() - 1);\r\n\r\n    const prevWasteAnalysis = await wasteEvaluator.evaluateOrganization({\r\n      organizationId,\r\n      windowDays: days,\r\n      endDate: prevEndDate,\r\n    });\r\n\r\n    const prevTotalWasted = prevWasteAnalysis.alerts.reduce(\r\n      (sum, a) => sum + Number(a.spendMicros) / MICROS_PER_UNIT,\r\n      0\r\n    );\r\n\r\n    previousWastedPercent =\r\n      summary.previous.spend > 0\r\n        ? (prevTotalWasted / summary.previous.spend) * 100\r\n        : 0;\r\n  }\r\n\r\n  return {\r\n    totalSpend: summary.current.spend,\r\n    totalConversions: summary.current.conversions,\r\n    overallCpa: summary.current.cpa,\r\n    wastedSpendPercent,\r\n    roas: summary.current.roas,\r\n    previousPeriod: summary.previous\r\n      ? {\r\n          totalSpend: summary.previous.spend,\r\n          totalConversions: summary.previous.conversions,\r\n          overallCpa: summary.previous.cpa,\r\n          wastedSpendPercent: previousWastedPercent,\r\n        }\r\n      : null,\r\n    changes: summary.change\r\n      ? {\r\n          spend: summary.change.spend,\r\n          conversions: summary.change.conversions,\r\n          cpa: summary.change.cpa,\r\n          wastedSpendPercent: wastedSpendPercent - previousWastedPercent,\r\n        }\r\n      : null,\r\n  };\r\n}\r\n\r\nexport async function getRecentActivity(params: {\r\n  organizationId: string;\r\n  limit?: number;\r\n}): Promise<\r\n  Array<{\r\n    id: string;\r\n    type: string;\r\n    description: string;\r\n    timestamp: Date;\r\n  }>\r\n> {\r\n  const jobs = await prisma.ingestionJob.findMany({\r\n    where: {\r\n      organizationId: params.organizationId,\r\n      status: { in: [\"SUCCEEDED\", \"FAILED\"] },\r\n    },\r\n    orderBy: { updatedAt: \"desc\" },\r\n    take: params.limit ?? 5,\r\n    select: {\r\n      id: true,\r\n      platform: true,\r\n      jobType: true,\r\n      status: true,\r\n      updatedAt: true,\r\n    },\r\n  });\r\n\r\n  return jobs.map((job: typeof jobs[number]) => ({\r\n    id: job.id,\r\n    type: job.status === \"SUCCEEDED\" ? \"success\" : \"error\",\r\n    description: `${job.platform} ${job.jobType.toLowerCase().replace(\"_\", \" \")} ${job.status.toLowerCase()}`,\r\n    timestamp: job.updatedAt,\r\n  }));\r\n}\r\n\r\nexport async function getTopWasteAlerts(params: {\r\n  organizationId: string;\r\n  limit?: number;\r\n}): Promise<\r\n  Array<{\r\n    id: string;\r\n    entityName: string;\r\n    entityType: string;\r\n    wastedSpend: number;\r\n    reason: string;\r\n    level: string;\r\n  }>\r\n> {\r\n  const analysis = await wasteEvaluator.evaluateOrganization({\r\n    organizationId: params.organizationId,\r\n    windowDays: 7,\r\n  });\r\n\r\n  return analysis.alerts\r\n    .sort((a, b) => Number(b.spendMicros) - Number(a.spendMicros))\r\n    .slice(0, params.limit ?? 5)\r\n    .map((alert) => ({\r\n      id: alert.id,\r\n      entityName: alert.entityName,\r\n      entityType: alert.entityType,\r\n      wastedSpend: Number(alert.spendMicros) / 1_000_000,\r\n      reason: alert.reason.replace(/_/g, \" \"),\r\n      level: alert.level,\r\n    }));\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1411, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/dashboard/index.ts"],"sourcesContent":["export {\r\n  getDashboardKpis,\r\n  getRecentActivity,\r\n  getTopWasteAlerts,\r\n} from \"./queries\";\r\n\r\nexport type { DashboardKpis } from \"./queries\";\r\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 1418, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/kpi-card.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const KpiCard = registerClientReference(\n    function() { throw new Error(\"Attempted to call KpiCard() from the server but KpiCard is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/kpi-card.tsx <module evaluation>\",\n    \"KpiCard\",\n);\nexport const KpiCardGrid = registerClientReference(\n    function() { throw new Error(\"Attempted to call KpiCardGrid() from the server but KpiCardGrid is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/kpi-card.tsx <module evaluation>\",\n    \"KpiCardGrid\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;;;AACvE;;AACO,MAAM,UAAU,IAAA,kVAAuB,EAC1C;IAAa,MAAM,IAAI,MAAM;AAA8N,GAC3P,6IACA;AAEG,MAAM,cAAc,IAAA,kVAAuB,EAC9C;IAAa,MAAM,IAAI,MAAM;AAAsO,GACnQ,6IACA","ignoreList":[0]}},
    {"offset": {"line": 1437, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/kpi-card.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const KpiCard = registerClientReference(\n    function() { throw new Error(\"Attempted to call KpiCard() from the server but KpiCard is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/kpi-card.tsx\",\n    \"KpiCard\",\n);\nexport const KpiCardGrid = registerClientReference(\n    function() { throw new Error(\"Attempted to call KpiCardGrid() from the server but KpiCardGrid is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/kpi-card.tsx\",\n    \"KpiCardGrid\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;;;AACvE;;AACO,MAAM,UAAU,IAAA,kVAAuB,EAC1C;IAAa,MAAM,IAAI,MAAM;AAA8N,GAC3P,yHACA;AAEG,MAAM,cAAc,IAAA,kVAAuB,EAC9C;IAAa,MAAM,IAAI,MAAM;AAAsO,GACnQ,yHACA","ignoreList":[0]}},
    {"offset": {"line": 1456, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 1464, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/timeseries-chart.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const TimeseriesChart = registerClientReference(\n    function() { throw new Error(\"Attempted to call TimeseriesChart() from the server but TimeseriesChart is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/timeseries-chart.tsx <module evaluation>\",\n    \"TimeseriesChart\",\n);\nexport const TimeseriesChartCard = registerClientReference(\n    function() { throw new Error(\"Attempted to call TimeseriesChartCard() from the server but TimeseriesChartCard is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/timeseries-chart.tsx <module evaluation>\",\n    \"TimeseriesChartCard\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;;;AACvE;;AACO,MAAM,kBAAkB,IAAA,kVAAuB,EAClD;IAAa,MAAM,IAAI,MAAM;AAA8O,GAC3Q,qJACA;AAEG,MAAM,sBAAsB,IAAA,kVAAuB,EACtD;IAAa,MAAM,IAAI,MAAM;AAAsP,GACnR,qJACA","ignoreList":[0]}},
    {"offset": {"line": 1483, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/timeseries-chart.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const TimeseriesChart = registerClientReference(\n    function() { throw new Error(\"Attempted to call TimeseriesChart() from the server but TimeseriesChart is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/timeseries-chart.tsx\",\n    \"TimeseriesChart\",\n);\nexport const TimeseriesChartCard = registerClientReference(\n    function() { throw new Error(\"Attempted to call TimeseriesChartCard() from the server but TimeseriesChartCard is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/timeseries-chart.tsx\",\n    \"TimeseriesChartCard\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;;;AACvE;;AACO,MAAM,kBAAkB,IAAA,kVAAuB,EAClD;IAAa,MAAM,IAAI,MAAM;AAA8O,GAC3Q,iIACA;AAEG,MAAM,sBAAsB,IAAA,kVAAuB,EACtD;IAAa,MAAM,IAAI,MAAM;AAAsP,GACnR,iIACA","ignoreList":[0]}},
    {"offset": {"line": 1502, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 1510, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/breakdown-table.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const BreakdownTable = registerClientReference(\n    function() { throw new Error(\"Attempted to call BreakdownTable() from the server but BreakdownTable is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/breakdown-table.tsx <module evaluation>\",\n    \"BreakdownTable\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,iBAAiB,IAAA,kVAAuB,EACjD;IAAa,MAAM,IAAI,MAAM;AAA4O,GACzQ,oJACA","ignoreList":[0]}},
    {"offset": {"line": 1524, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/breakdown-table.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const BreakdownTable = registerClientReference(\n    function() { throw new Error(\"Attempted to call BreakdownTable() from the server but BreakdownTable is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/breakdown-table.tsx\",\n    \"BreakdownTable\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,iBAAiB,IAAA,kVAAuB,EACjD;IAAa,MAAM,IAAI,MAAM;AAA4O,GACzQ,gIACA","ignoreList":[0]}},
    {"offset": {"line": 1538, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 1546, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/filters.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const DashboardFilters = registerClientReference(\n    function() { throw new Error(\"Attempted to call DashboardFilters() from the server but DashboardFilters is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/filters.tsx <module evaluation>\",\n    \"DashboardFilters\",\n);\nexport const getDefaultFilters = registerClientReference(\n    function() { throw new Error(\"Attempted to call getDefaultFilters() from the server but getDefaultFilters is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/filters.tsx <module evaluation>\",\n    \"getDefaultFilters\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;;;AACvE;;AACO,MAAM,mBAAmB,IAAA,kVAAuB,EACnD;IAAa,MAAM,IAAI,MAAM;AAAgP,GAC7Q,4IACA;AAEG,MAAM,oBAAoB,IAAA,kVAAuB,EACpD;IAAa,MAAM,IAAI,MAAM;AAAkP,GAC/Q,4IACA","ignoreList":[0]}},
    {"offset": {"line": 1565, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/filters.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const DashboardFilters = registerClientReference(\n    function() { throw new Error(\"Attempted to call DashboardFilters() from the server but DashboardFilters is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/filters.tsx\",\n    \"DashboardFilters\",\n);\nexport const getDefaultFilters = registerClientReference(\n    function() { throw new Error(\"Attempted to call getDefaultFilters() from the server but getDefaultFilters is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/filters.tsx\",\n    \"getDefaultFilters\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;;;AACvE;;AACO,MAAM,mBAAmB,IAAA,kVAAuB,EACnD;IAAa,MAAM,IAAI,MAAM;AAAgP,GAC7Q,wHACA;AAEG,MAAM,oBAAoB,IAAA,kVAAuB,EACpD;IAAa,MAAM,IAAI,MAAM;AAAkP,GAC/Q,wHACA","ignoreList":[0]}},
    {"offset": {"line": 1584, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 1592, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/components/dashboard/index.ts"],"sourcesContent":["export { KpiCard, KpiCardGrid } from \"./kpi-card\";\r\nexport type { KpiCardProps, TrendDirection } from \"./kpi-card\";\r\n\r\nexport { TimeseriesChart, TimeseriesChartCard } from \"./timeseries-chart\";\r\nexport type { TimeseriesPoint } from \"./timeseries-chart\";\r\n\r\nexport { BreakdownTable } from \"./breakdown-table\";\r\nexport type { BreakdownRow } from \"./breakdown-table\";\r\n\r\nexport { DashboardFilters, getDefaultFilters } from \"./filters\";\r\nexport type { FilterState } from \"./filters\";\r\n"],"names":[],"mappings":";AAAA;AAGA;AAGA;AAGA"}},
    {"offset": {"line": 1605, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/app/page.tsx"],"sourcesContent":["import { getServerSession } from \"next-auth\";\r\n\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { getDashboardKpis, getRecentActivity, getTopWasteAlerts } from \"@/lib/dashboard\";\r\nimport { KpiCard, KpiCardGrid } from \"@/components/dashboard\";\r\nimport type { TrendDirection } from \"@/components/dashboard\";\r\n\r\nfunction formatCurrency(value: number): string {\r\n  return new Intl.NumberFormat(\"en-US\", {\r\n    style: \"currency\",\r\n    currency: \"USD\",\r\n    minimumFractionDigits: 2,\r\n    maximumFractionDigits: 2,\r\n  }).format(value);\r\n}\r\n\r\nfunction formatNumber(value: number): string {\r\n  return new Intl.NumberFormat(\"en-US\").format(value);\r\n}\r\n\r\nfunction formatPercent(value: number): string {\r\n  return `${value.toFixed(1)}%`;\r\n}\r\n\r\nfunction getTrend(change: number | null, invert = false): TrendDirection {\r\n  if (change === null || change === 0) return \"neutral\";\r\n  const isUp = change > 0;\r\n  if (invert) return isUp ? \"down\" : \"up\";\r\n  return isUp ? \"up\" : \"down\";\r\n}\r\n\r\nexport default async function DashboardPage() {\r\n  const session = await getServerSession(authOptions);\r\n  const orgId = session?.user?.activeOrgId;\r\n\r\n  let kpis = null;\r\n  let recentActivity: Awaited<ReturnType<typeof getRecentActivity>> = [];\r\n  let wasteAlerts: Awaited<ReturnType<typeof getTopWasteAlerts>> = [];\r\n\r\n  if (orgId) {\r\n    try {\r\n      [kpis, recentActivity, wasteAlerts] = await Promise.all([\r\n        getDashboardKpis({ organizationId: orgId, days: 30 }),\r\n        getRecentActivity({ organizationId: orgId, limit: 5 }),\r\n        getTopWasteAlerts({ organizationId: orgId, limit: 5 }),\r\n      ]);\r\n    } catch (error) {\r\n      console.error(\"Failed to load dashboard data:\", error);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div>\r\n        <h1 className=\"text-2xl font-semibold tracking-tight\">Dashboard</h1>\r\n        <p className=\"mt-1 text-sm text-zinc-600\">\r\n          Welcome back, {session?.user?.name ?? session?.user?.email}\r\n        </p>\r\n      </div>\r\n\r\n      <KpiCardGrid>\r\n        <KpiCard\r\n          title=\"Total Spend\"\r\n          value={kpis ? formatCurrency(kpis.totalSpend) : \"$0.00\"}\r\n          change={kpis?.changes?.spend ?? null}\r\n          changeLabel=\"vs last period\"\r\n          trend={getTrend(kpis?.changes?.spend ?? null)}\r\n          icon={<SpendIcon />}\r\n        />\r\n        <KpiCard\r\n          title=\"Conversions\"\r\n          value={kpis ? formatNumber(kpis.totalConversions) : \"0\"}\r\n          change={kpis?.changes?.conversions ?? null}\r\n          changeLabel=\"vs last period\"\r\n          trend={getTrend(kpis?.changes?.conversions ?? null)}\r\n          icon={<ConversionIcon />}\r\n        />\r\n        <KpiCard\r\n          title=\"CPA\"\r\n          value={kpis?.overallCpa ? formatCurrency(kpis.overallCpa) : \"\"}\r\n          change={kpis?.changes?.cpa ?? null}\r\n          changeLabel=\"vs last period\"\r\n          trend={getTrend(kpis?.changes?.cpa ?? null, true)}\r\n          icon={<CpaIcon />}\r\n        />\r\n        <KpiCard\r\n          title=\"Wasted Spend\"\r\n          value={kpis ? formatPercent(kpis.wastedSpendPercent) : \"0.0%\"}\r\n          change={kpis?.changes?.wastedSpendPercent ?? null}\r\n          changeLabel=\"vs last period\"\r\n          trend={getTrend(kpis?.changes?.wastedSpendPercent ?? null, true)}\r\n          icon={<WasteIcon />}\r\n        />\r\n      </KpiCardGrid>\r\n\r\n      <div className=\"grid gap-4 lg:grid-cols-2\">\r\n        <div className=\"rounded-xl border border-zinc-200 bg-white p-6\">\r\n          <h2 className=\"text-sm font-medium text-zinc-900\">Recent Activity</h2>\r\n          {recentActivity.length > 0 ? (\r\n            <ul className=\"mt-4 space-y-3\">\r\n              {recentActivity.map((activity) => (\r\n                <li key={activity.id} className=\"flex items-start gap-3\">\r\n                  <span\r\n                    className={`mt-0.5 h-2 w-2 rounded-full ${\r\n                      activity.type === \"success\" ? \"bg-green-500\" : \"bg-red-500\"\r\n                    }`}\r\n                  />\r\n                  <div className=\"flex-1\">\r\n                    <p className=\"text-sm text-zinc-700\">{activity.description}</p>\r\n                    <p className=\"text-xs text-zinc-500\">\r\n                      {activity.timestamp.toLocaleString()}\r\n                    </p>\r\n                  </div>\r\n                </li>\r\n              ))}\r\n            </ul>\r\n          ) : (\r\n            <p className=\"mt-4 text-sm text-zinc-500\">No recent activity</p>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"rounded-xl border border-zinc-200 bg-white p-6\">\r\n          <h2 className=\"text-sm font-medium text-zinc-900\">Waste Alerts</h2>\r\n          {wasteAlerts.length > 0 ? (\r\n            <ul className=\"mt-4 space-y-3\">\r\n              {wasteAlerts.map((alert) => (\r\n                <li key={alert.id} className=\"flex items-start justify-between gap-3\">\r\n                  <div>\r\n                    <p className=\"text-sm font-medium text-zinc-700\">{alert.entityName}</p>\r\n                    <p className=\"text-xs text-zinc-500 capitalize\">{alert.reason}</p>\r\n                  </div>\r\n                  <span\r\n                    className={`rounded-full px-2 py-0.5 text-xs font-medium ${\r\n                      alert.level === \"critical\"\r\n                        ? \"bg-red-100 text-red-700\"\r\n                        : alert.level === \"high\"\r\n                        ? \"bg-orange-100 text-orange-700\"\r\n                        : \"bg-yellow-100 text-yellow-700\"\r\n                    }`}\r\n                  >\r\n                    {formatCurrency(alert.wastedSpend)}\r\n                  </span>\r\n                </li>\r\n              ))}\r\n            </ul>\r\n          ) : (\r\n            <p className=\"mt-4 text-sm text-zinc-500\">No waste alerts</p>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"rounded-xl border border-zinc-200 bg-white p-6\">\r\n        <h2 className=\"text-sm font-medium text-zinc-900\">Quick Actions</h2>\r\n        <div className=\"mt-4 flex flex-wrap gap-3\">\r\n          <a\r\n            href=\"/app/integrations\"\r\n            className=\"inline-flex items-center gap-2 rounded-lg border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-50\"\r\n          >\r\n            <span></span> Connect Ad Platform\r\n          </a>\r\n          <a\r\n            href=\"/app/campaigns\"\r\n            className=\"inline-flex items-center gap-2 rounded-lg border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-50\"\r\n          >\r\n            <span></span> View Campaigns\r\n          </a>\r\n          <a\r\n            href=\"/app/waste\"\r\n            className=\"inline-flex items-center gap-2 rounded-lg border border-zinc-200 px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-50\"\r\n          >\r\n            <span></span> Check Waste\r\n          </a>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction SpendIcon() {\r\n  return (\r\n    <svg className=\"h-5 w-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction ConversionIcon() {\r\n  return (\r\n    <svg className=\"h-5 w-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction CpaIcon() {\r\n  return (\r\n    <svg className=\"h-5 w-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z\" />\r\n    </svg>\r\n  );\r\n}\r\n\r\nfunction WasteIcon() {\r\n  return (\r\n    <svg className=\"h-5 w-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\r\n    </svg>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}