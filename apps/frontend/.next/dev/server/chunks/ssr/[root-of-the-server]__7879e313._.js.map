{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/analytics/queries.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport { prisma } from \"@/lib/prisma\";\r\n\r\nexport interface TimeSeriesPoint {\r\n  date: string;\r\n  spend: number;\r\n  conversions: number;\r\n  impressions: number;\r\n  clicks: number;\r\n  revenue: number;\r\n}\r\n\r\nexport interface PlatformTimeSeries {\r\n  platformCode: string;\r\n  platformName: string;\r\n  data: TimeSeriesPoint[];\r\n}\r\n\r\nexport interface ChartData {\r\n  total: TimeSeriesPoint[];\r\n  byPlatform: PlatformTimeSeries[];\r\n  summary: {\r\n    totalSpend: number;\r\n    totalConversions: number;\r\n    avgCpa: number | null;\r\n    totalRevenue: number;\r\n  };\r\n}\r\n\r\nexport async function getSpendConversionTimeSeries(params: {\r\n  organizationId: string;\r\n  startDate: Date;\r\n  endDate: Date;\r\n  platformCodes?: string[];\r\n}): Promise<ChartData> {\r\n  const whereBase: Record<string, unknown> = {\r\n    organizationId: params.organizationId,\r\n    date: { gte: params.startDate, lte: params.endDate },\r\n  };\r\n\r\n  if (params.platformCodes?.length) {\r\n    whereBase.platform = { code: { in: params.platformCodes } };\r\n  }\r\n\r\n  const dailyMetrics = await prisma.dailyAdAccountMetric.findMany({\r\n    where: whereBase,\r\n    select: {\r\n      date: true,\r\n      impressions: true,\r\n      clicks: true,\r\n      spendMicros: true,\r\n      conversions: true,\r\n      revenueMicros: true,\r\n      platform: { select: { code: true, name: true } },\r\n    },\r\n    orderBy: { date: \"asc\" },\r\n  });\r\n\r\n  const totalByDate = new Map<string, TimeSeriesPoint>();\r\n  const byPlatformDate = new Map<string, Map<string, TimeSeriesPoint>>();\r\n  const platformNames = new Map<string, string>();\r\n\r\n  for (const m of dailyMetrics) {\r\n    const dateStr = m.date.toISOString().split(\"T\")[0];\r\n    const spend = Number(m.spendMicros) / 1_000_000;\r\n    const conversions = Number(m.conversions);\r\n    const impressions = Number(m.impressions);\r\n    const clicks = Number(m.clicks);\r\n    const revenue = Number(m.revenueMicros) / 1_000_000;\r\n\r\n    if (!totalByDate.has(dateStr)) {\r\n      totalByDate.set(dateStr, {\r\n        date: dateStr,\r\n        spend: 0,\r\n        conversions: 0,\r\n        impressions: 0,\r\n        clicks: 0,\r\n        revenue: 0,\r\n      });\r\n    }\r\n    const total = totalByDate.get(dateStr)!;\r\n    total.spend += spend;\r\n    total.conversions += conversions;\r\n    total.impressions += impressions;\r\n    total.clicks += clicks;\r\n    total.revenue += revenue;\r\n\r\n    const platformCode = m.platform.code;\r\n    platformNames.set(platformCode, m.platform.name);\r\n\r\n    if (!byPlatformDate.has(platformCode)) {\r\n      byPlatformDate.set(platformCode, new Map());\r\n    }\r\n    const platformMap = byPlatformDate.get(platformCode)!;\r\n\r\n    if (!platformMap.has(dateStr)) {\r\n      platformMap.set(dateStr, {\r\n        date: dateStr,\r\n        spend: 0,\r\n        conversions: 0,\r\n        impressions: 0,\r\n        clicks: 0,\r\n        revenue: 0,\r\n      });\r\n    }\r\n    const platformPoint = platformMap.get(dateStr)!;\r\n    platformPoint.spend += spend;\r\n    platformPoint.conversions += conversions;\r\n    platformPoint.impressions += impressions;\r\n    platformPoint.clicks += clicks;\r\n    platformPoint.revenue += revenue;\r\n  }\r\n\r\n  const totalData = Array.from(totalByDate.values()).sort(\r\n    (a, b) => a.date.localeCompare(b.date)\r\n  );\r\n\r\n  const byPlatform: PlatformTimeSeries[] = [];\r\n  for (const [code, dateMap] of byPlatformDate) {\r\n    byPlatform.push({\r\n      platformCode: code,\r\n      platformName: platformNames.get(code) ?? code,\r\n      data: Array.from(dateMap.values()).sort((a, b) =>\r\n        a.date.localeCompare(b.date)\r\n      ),\r\n    });\r\n  }\r\n\r\n  const totalSpend = totalData.reduce((sum, p) => sum + p.spend, 0);\r\n  const totalConversions = totalData.reduce((sum, p) => sum + p.conversions, 0);\r\n  const totalRevenue = totalData.reduce((sum, p) => sum + p.revenue, 0);\r\n  const avgCpa = totalConversions > 0 ? totalSpend / totalConversions : null;\r\n\r\n  return {\r\n    total: totalData,\r\n    byPlatform,\r\n    summary: {\r\n      totalSpend,\r\n      totalConversions,\r\n      avgCpa,\r\n      totalRevenue,\r\n    },\r\n  };\r\n}\r\n\r\nexport type DateRangePreset = \"7d\" | \"14d\" | \"30d\" | \"90d\" | \"custom\";\r\n\r\nexport function getDateRangeFromPreset(preset: DateRangePreset): {\r\n  start: Date;\r\n  end: Date;\r\n} {\r\n  const end = new Date();\r\n  end.setHours(23, 59, 59, 999);\r\n\r\n  const start = new Date(end);\r\n\r\n  switch (preset) {\r\n    case \"7d\":\r\n      start.setDate(start.getDate() - 6);\r\n      break;\r\n    case \"14d\":\r\n      start.setDate(start.getDate() - 13);\r\n      break;\r\n    case \"30d\":\r\n      start.setDate(start.getDate() - 29);\r\n      break;\r\n    case \"90d\":\r\n      start.setDate(start.getDate() - 89);\r\n      break;\r\n    default:\r\n      start.setDate(start.getDate() - 29);\r\n  }\r\n\r\n  start.setHours(0, 0, 0, 0);\r\n\r\n  return { start, end };\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AAEA;;;AA4BO,eAAe,6BAA6B,MAKlD;IACC,MAAM,YAAqC;QACzC,gBAAgB,OAAO,cAAc;QACrC,MAAM;YAAE,KAAK,OAAO,SAAS;YAAE,KAAK,OAAO,OAAO;QAAC;IACrD;IAEA,IAAI,OAAO,aAAa,EAAE,QAAQ;QAChC,UAAU,QAAQ,GAAG;YAAE,MAAM;gBAAE,IAAI,OAAO,aAAa;YAAC;QAAE;IAC5D;IAEA,MAAM,eAAe,MAAM,4NAAM,CAAC,oBAAoB,CAAC,QAAQ,CAAC;QAC9D,OAAO;QACP,QAAQ;YACN,MAAM;YACN,aAAa;YACb,QAAQ;YACR,aAAa;YACb,aAAa;YACb,eAAe;YACf,UAAU;gBAAE,QAAQ;oBAAE,MAAM;oBAAM,MAAM;gBAAK;YAAE;QACjD;QACA,SAAS;YAAE,MAAM;QAAM;IACzB;IAEA,MAAM,cAAc,IAAI;IACxB,MAAM,iBAAiB,IAAI;IAC3B,MAAM,gBAAgB,IAAI;IAE1B,KAAK,MAAM,KAAK,aAAc;QAC5B,MAAM,UAAU,EAAE,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAClD,MAAM,QAAQ,OAAO,EAAE,WAAW,IAAI;QACtC,MAAM,cAAc,OAAO,EAAE,WAAW;QACxC,MAAM,cAAc,OAAO,EAAE,WAAW;QACxC,MAAM,SAAS,OAAO,EAAE,MAAM;QAC9B,MAAM,UAAU,OAAO,EAAE,aAAa,IAAI;QAE1C,IAAI,CAAC,YAAY,GAAG,CAAC,UAAU;YAC7B,YAAY,GAAG,CAAC,SAAS;gBACvB,MAAM;gBACN,OAAO;gBACP,aAAa;gBACb,aAAa;gBACb,QAAQ;gBACR,SAAS;YACX;QACF;QACA,MAAM,QAAQ,YAAY,GAAG,CAAC;QAC9B,MAAM,KAAK,IAAI;QACf,MAAM,WAAW,IAAI;QACrB,MAAM,WAAW,IAAI;QACrB,MAAM,MAAM,IAAI;QAChB,MAAM,OAAO,IAAI;QAEjB,MAAM,eAAe,EAAE,QAAQ,CAAC,IAAI;QACpC,cAAc,GAAG,CAAC,cAAc,EAAE,QAAQ,CAAC,IAAI;QAE/C,IAAI,CAAC,eAAe,GAAG,CAAC,eAAe;YACrC,eAAe,GAAG,CAAC,cAAc,IAAI;QACvC;QACA,MAAM,cAAc,eAAe,GAAG,CAAC;QAEvC,IAAI,CAAC,YAAY,GAAG,CAAC,UAAU;YAC7B,YAAY,GAAG,CAAC,SAAS;gBACvB,MAAM;gBACN,OAAO;gBACP,aAAa;gBACb,aAAa;gBACb,QAAQ;gBACR,SAAS;YACX;QACF;QACA,MAAM,gBAAgB,YAAY,GAAG,CAAC;QACtC,cAAc,KAAK,IAAI;QACvB,cAAc,WAAW,IAAI;QAC7B,cAAc,WAAW,IAAI;QAC7B,cAAc,MAAM,IAAI;QACxB,cAAc,OAAO,IAAI;IAC3B;IAEA,MAAM,YAAY,MAAM,IAAI,CAAC,YAAY,MAAM,IAAI,IAAI,CACrD,CAAC,GAAG,IAAM,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,IAAI;IAGvC,MAAM,aAAmC,EAAE;IAC3C,KAAK,MAAM,CAAC,MAAM,QAAQ,IAAI,eAAgB;QAC5C,WAAW,IAAI,CAAC;YACd,cAAc;YACd,cAAc,cAAc,GAAG,CAAC,SAAS;YACzC,MAAM,MAAM,IAAI,CAAC,QAAQ,MAAM,IAAI,IAAI,CAAC,CAAC,GAAG,IAC1C,EAAE,IAAI,CAAC,aAAa,CAAC,EAAE,IAAI;QAE/B;IACF;IAEA,MAAM,aAAa,UAAU,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,KAAK,EAAE;IAC/D,MAAM,mBAAmB,UAAU,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,WAAW,EAAE;IAC3E,MAAM,eAAe,UAAU,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,OAAO,EAAE;IACnE,MAAM,SAAS,mBAAmB,IAAI,aAAa,mBAAmB;IAEtE,OAAO;QACL,OAAO;QACP;QACA,SAAS;YACP;YACA;YACA;YACA;QACF;IACF;AACF;AAIO,SAAS,uBAAuB,MAAuB;IAI5D,MAAM,MAAM,IAAI;IAChB,IAAI,QAAQ,CAAC,IAAI,IAAI,IAAI;IAEzB,MAAM,QAAQ,IAAI,KAAK;IAEvB,OAAQ;QACN,KAAK;YACH,MAAM,OAAO,CAAC,MAAM,OAAO,KAAK;YAChC;QACF,KAAK;YACH,MAAM,OAAO,CAAC,MAAM,OAAO,KAAK;YAChC;QACF,KAAK;YACH,MAAM,OAAO,CAAC,MAAM,OAAO,KAAK;YAChC;QACF,KAAK;YACH,MAAM,OAAO,CAAC,MAAM,OAAO,KAAK;YAChC;QACF;YACE,MAAM,OAAO,CAAC,MAAM,OAAO,KAAK;IACpC;IAEA,MAAM,QAAQ,CAAC,GAAG,GAAG,GAAG;IAExB,OAAO;QAAE;QAAO;IAAI;AACtB"}},
    {"offset": {"line": 170, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/lib/analytics/index.ts"],"sourcesContent":["export {\r\n  getSpendConversionTimeSeries,\r\n  getDateRangeFromPreset,\r\n} from \"./queries\";\r\n\r\nexport type {\r\n  TimeSeriesPoint,\r\n  PlatformTimeSeries,\r\n  ChartData,\r\n  DateRangePreset,\r\n} from \"./queries\";\r\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 177, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/app/analytics/client.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const AnalyticsPageClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call AnalyticsPageClient() from the server but AnalyticsPageClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/app/analytics/client.tsx <module evaluation>\",\n    \"AnalyticsPageClient\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,sBAAsB,IAAA,kVAAuB,EACtD;IAAa,MAAM,IAAI,MAAM;AAAsP,GACnR,wIACA","ignoreList":[0]}},
    {"offset": {"line": 191, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/app/analytics/client.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const AnalyticsPageClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call AnalyticsPageClient() from the server but AnalyticsPageClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/app/analytics/client.tsx\",\n    \"AnalyticsPageClient\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;AACO,MAAM,sBAAsB,IAAA,kVAAuB,EACtD;IAAa,MAAM,IAAI,MAAM;AAAsP,GACnR,oHACA","ignoreList":[0]}},
    {"offset": {"line": 205, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 213, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/GGPC/OneDrive/Desktop/Optiq/CascadeProjects/windsurf-project/apps/frontend/src/app/app/analytics/page.tsx"],"sourcesContent":["import { getServerSession } from \"next-auth\";\r\nimport { redirect } from \"next/navigation\";\r\n\r\nimport { authOptions } from \"@/lib/auth\";\r\nimport { getSpendConversionTimeSeries, getDateRangeFromPreset } from \"@/lib/analytics\";\r\nimport { AnalyticsPageClient } from \"./client\";\r\n\r\nexport default async function AnalyticsPage() {\r\n  const session = await getServerSession(authOptions);\r\n  const orgId = session?.user?.activeOrgId;\r\n\r\n  if (!orgId) {\r\n    redirect(\"/app\");\r\n  }\r\n\r\n  const { start, end } = getDateRangeFromPreset(\"30d\");\r\n\r\n  const chartData = await getSpendConversionTimeSeries({\r\n    organizationId: orgId,\r\n    startDate: start,\r\n    endDate: end,\r\n  });\r\n\r\n  return (\r\n    <AnalyticsPageClient\r\n      initialData={chartData}\r\n      initialDateRange={{ start: start.toISOString(), end: end.toISOString() }}\r\n    />\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAAA;AACA;AAAA;AAEA;AACA;AAAA;AACA;;;;;;;AAEe,eAAe;IAC5B,MAAM,UAAU,MAAM,IAAA,mOAAgB,EAAC,+NAAW;IAClD,MAAM,QAAQ,SAAS,MAAM;IAE7B,IAAI,CAAC,OAAO;QACV,IAAA,2QAAQ,EAAC;IACX;IAEA,MAAM,EAAE,KAAK,EAAE,GAAG,EAAE,GAAG,IAAA,0PAAsB,EAAC;IAE9C,MAAM,YAAY,MAAM,IAAA,gQAA4B,EAAC;QACnD,gBAAgB;QAChB,WAAW;QACX,SAAS;IACX;IAEA,qBACE,wTAAC,8PAAmB;QAClB,aAAa;QACb,kBAAkB;YAAE,OAAO,MAAM,WAAW;YAAI,KAAK,IAAI,WAAW;QAAG;;;;;;AAG7E"}}]
}